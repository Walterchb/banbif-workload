<!doctype html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#051c2c" />
  <title>Proyectos | Capitales &amp; Control de Gestión</title>
  <link rel="icon" href="./favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root{
      --bg:#f3f5f8;
      --surface:#ffffff;
      --surface-2:#f8fafc;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --primary:#0b5fff;
      --primary-2:#0d9488;
      --danger:#dc2626;
      --warn:#d97706;
      --ok:#16a34a;
      --chip:#eef2ff;
      --radius:14px;
      --shadow:0 10px 30px rgba(2,8,23,.08);
      --hour-h:56px;
      --notif-alert-bg:color-mix(in srgb, #0ea5e9 9%, var(--surface));
      --notif-alert-border:color-mix(in srgb, #0284c7 42%, var(--line));
      --notif-alert-icon:color-mix(in srgb, #0369a1 78%, var(--text));
      --notif-alert-ring:rgba(239,68,68,.34);
      --notif-alert-dot:#ef4444;
    }
    html[data-theme="dark"]{
      --bg:#0b1220;
      --surface:#111a2e;
      --surface-2:#16233d;
      --text:#e5edf8;
      --muted:#9fb0c9;
      --line:#22314f;
      --primary:#4f8cff;
      --primary-2:#14b8a6;
      --danger:#f87171;
      --warn:#fbbf24;
      --ok:#22c55e;
      --chip:#1b2b4a;
      --shadow:0 10px 30px rgba(0,0,0,.28);
      --notif-alert-bg:color-mix(in srgb, #1d4ed8 18%, var(--surface));
      --notif-alert-border:color-mix(in srgb, #60a5fa 52%, var(--line));
      --notif-alert-icon:color-mix(in srgb, #bfdbfe 86%, var(--text));
      --notif-alert-ring:rgba(244,63,94,.38);
      --notif-alert-dot:#f43f5e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 480px at 120% -20%, rgba(11,95,255,.12), transparent 65%),
        radial-gradient(900px 480px at -20% -30%, rgba(13,148,136,.10), transparent 60%),
        var(--bg);
    }
    .app{max-width:1540px;margin:14px auto;padding:0 14px 18px;}
    .app.auth-reveal{
      opacity:0;
      transform:translateY(8px) scale(.998);
      filter:blur(1.2px);
      will-change:opacity,transform,filter;
    }
    .app.auth-reveal.is-visible{
      opacity:1;
      transform:translateY(0) scale(1);
      filter:blur(0);
      transition:opacity .32s ease, transform .32s ease, filter .32s ease;
    }
    .panel{
      background:var(--surface);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    /* Header */
    .top{
      padding:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
    }
    .logo{
      width:34px;height:34px;border-radius:10px;
      display:grid;place-items:center;
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
      color:#fff;font-weight:900;font-size:14px;letter-spacing:.2px;
      box-shadow:0 8px 18px rgba(11,95,255,.28);
    }
    .title{margin:0;font-size:21px;letter-spacing:-.3px}
    .subtitle{margin-top:2px;font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .actions .actions-icon-group{display:flex;gap:8px;align-items:center;min-width:0;}
    .btn, .ctrl, select, input{
      font:inherit;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--surface);
      color:var(--text);
      padding:8px 12px;
      border-radius:11px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition:.18s ease;
    }
    .btn:hover{transform:translateY(-1px); background:var(--surface-2)}
    .btn.primary{
      background:linear-gradient(135deg,var(--primary),#376fff);
      color:#fff;border-color:transparent;
    }
    .btn.primary:hover{filter:brightness(1.02)}
    .btn.icon{
      width:36px;height:36px;padding:0;display:grid;place-items:center;
    }
    .btn.danger{color:var(--danger);border-color:color-mix(in srgb, var(--danger) 45%, var(--line));}
    .btn.tab.active{
      background:var(--text); color:var(--surface);
      border-color:var(--text);
    }

    /* Controls */
    .controls{
      margin:0 14px 10px;
      padding:10px;
      background:var(--surface-2);
      border:1px solid var(--line);
      border-radius:0;
      display:flex;gap:8px;align-items:center;justify-content:flex-start;flex-wrap:nowrap;overflow-x:auto;overflow-y:hidden;scrollbar-gutter:stable both-edges;
    }
    #datePicker{width:122px;min-width:122px;text-align:center;font-variant-numeric:tabular-nums}

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .controls > .row{display:flex;gap:8px;align-items:center;flex-wrap:nowrap;flex:0 0 auto;white-space:nowrap}
    .controls > .row.filters{margin-left:auto}
    .controls > .row.filters .ctrl{min-width:108px}
    .seg{
      display:inline-flex;gap:4px;padding:4px;
      border:1px solid var(--line);border-radius:999px;background:var(--surface);
    }
    .seg .btn{border:none;border-radius:999px;padding:7px 11px}
    .ctrl{
      height:36px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:0 10px;
      background:var(--surface);
      color:var(--text);
      min-width:120px;
    }
    .ctrl.search{min-width:150px;width:170px}

    /* KPI */
    .kpi-band{
      margin:0 14px 10px;
      display:grid;grid-template-columns:repeat(4, minmax(180px, 1fr));gap:10px;
    }
    @media (max-width:1200px){ .kpi-band{grid-template-columns:repeat(2, minmax(180px, 1fr));} }
    @media (max-width:700px){
      .kpi-band{
        grid-template-columns:repeat(2, minmax(0, 1fr));
        gap:8px;
        align-items:stretch;
      }
      .kpi{
        padding:10px;
        min-height:96px;
        height:100%;
        display:grid;
        grid-template-columns:minmax(0,1fr) auto;
        column-gap:8px;
        align-items:start;
      }
      .kpi > div{min-width:0}
      .kpi .label{
        font-size:10px;
        letter-spacing:.25px;
        min-height:22px;
        line-height:1.12;
        display:flex;
        align-items:flex-start;
      }
      .kpi .val{font-size:20px;line-height:1;margin-top:2px}
      .kpi .sub{
        font-size:10px;
        min-height:20px;
        line-height:1.12;
        display:flex;
        align-items:flex-end;
      }
      .kpi .pill{
        font-size:10px;
        padding:3px 6px;
        white-space:nowrap;
        justify-self:end;
        align-self:start;
      }
    }

    .kpi{
      padding:12px;
      border:1px solid var(--line);
      background:var(--surface);
      border-radius:0;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .kpi .label{font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.3px}
    .kpi .val{font-size:24px;font-weight:900;letter-spacing:-.3px;margin-top:3px}
    .kpi .sub{font-size:11px;color:var(--muted);margin-top:2px}
    .pill{
      font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
      background:var(--chip);font-weight:700;
    }
    .pill.ok{color:var(--ok);border-color:color-mix(in srgb, var(--ok) 35%, var(--line));}
    .pill.warn{color:var(--warn);border-color:color-mix(in srgb, var(--warn) 38%, var(--line));}
    .pill.danger{color:var(--danger);border-color:color-mix(in srgb, var(--danger) 35%, var(--line));}

    /* Split */
    .split{
      margin:0 14px 10px;
      display:grid;grid-template-columns:1.3fr 1fr;gap:10px;
    }
    @media (max-width:1100px){ .split{grid-template-columns:1fr;} }
    .box{
      border:1px solid var(--line);
      border-radius:0;
      background:var(--surface);
      overflow:hidden;
    }
    .box .head{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:var(--surface-2);
      font-size:13px;
      font-weight:800;
      display:flex;justify-content:space-between;align-items:center;
    }
    .box .body{padding:10px 12px}
    .cards{
      display:grid;grid-template-columns:repeat(3,minmax(160px,1fr));gap:8px;
    }
    @media (max-width:900px){ .cards{grid-template-columns:1fr;} }
    .person{
      border:1px solid var(--line);border-radius:5px;padding:10px;background:var(--surface);
    }
    .person .n{font-size:13px;font-weight:800;margin-bottom:6px;display:flex;justify-content:space-between;gap:6px}
    .meter{
      width:100%;height:8px;border-radius:999px;background:var(--surface-2);overflow:hidden;border:1px solid var(--line);
    }
    .meter > span{display:block;height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-2));}
    .person .meta{margin-top:7px;font-size:11px;color:var(--muted)}
    .agenda{
      margin-top:8px;
      font-size:11px;
      line-height:1.25;
      overflow-wrap:anywhere;
    }
    .agenda.agenda-collapsed{
      max-height:44px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .more-inline-btn{
      appearance:none;
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:10px;
      font-weight:700;
      cursor:pointer;
      margin-left:4px;
      padding:0;
      line-height:1.1;
      text-decoration:none;
      white-space:nowrap;
    }
    .more-inline-btn:hover{color:var(--text); text-decoration:underline;}

    .prio-grid{
      display:grid;grid-template-columns:repeat(3,minmax(120px,1fr));gap:8px;
    }
    @media (max-width:900px){ .prio-grid{grid-template-columns:1fr;} }
    .prio{
      border:1px solid var(--line);border-radius:5px;padding:10px;background:var(--surface);
    }
    .prio .t{font-size:12px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .prio ul{margin:8px 0 0 16px;padding:0;font-size:11px;line-height:1.25}
    .prio li{margin:4px 0}
    .prio .prio-extra.hidden{display:none}
    .tagA{color:var(--danger)}
    .tagM{color:var(--warn)}
    .tagB{color:var(--ok)}

    /* Main View */
    .main{
      margin:0 14px 14px;
      border:1px solid var(--line);
      border-radius:0;
      background:var(--surface);
      overflow:auto;
      min-height:390px;
    }

    /* Day grid */
    .day-grid{
      display:grid;
      grid-template-columns:60px repeat(var(--team-count), minmax(220px,1fr));
      min-width:980px;
    }
    .grid-head{
      position:sticky; top:0; z-index:15;
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      background:var(--surface-2);
      padding:10px;
      text-align:center;
      font-size:12px;
      font-weight:800;
    }
    .owner-head .sub{
      margin-top:4px;font-size:10px;color:var(--muted);font-weight:700;
    }
    .time-col,.day-col{position:relative;border-right:1px solid var(--line)}
    .time-cell{
      height:var(--hour-h);
      border-bottom:1px solid color-mix(in srgb, var(--line) 72%, transparent);
      font-size:11px;color:var(--muted);
      text-align:center;padding:4px 4px;
    }
    .day-col{
      background-image:linear-gradient(to bottom, transparent calc(var(--hour-h) - 1px), color-mix(in srgb, var(--line) 65%, transparent) 1px);
      background-size:100% var(--hour-h);
    }

    .task{
      position:absolute;
      border-radius:9px;
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      border-left-width:4px;
      background:var(--surface);
      box-shadow:0 2px 8px rgba(2,8,23,.10);
      cursor:pointer;
      overflow:hidden;
      z-index:5;
    }
    .task:hover{transform:translateY(-1px);box-shadow:0 12px 20px rgba(2,8,23,.18);z-index:20}
    .task .h{
      padding:3px 7px;
      font-size:9px;font-weight:800;
      background:var(--surface-2);
      border-bottom:1px solid var(--line);
      text-transform:uppercase;letter-spacing:.25px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .task .b{padding:6px 7px}
    .task .n{font-size:11px;font-weight:800;line-height:1.2;margin-bottom:4px}
    .task .m{font-size:10px;color:var(--muted);display:flex;justify-content:space-between;gap:6px}
    .priority-Alta{border-left-color:var(--danger)}
    .priority-Media{border-left-color:var(--warn)}
    .priority-Baja{border-left-color:var(--ok)}

    /* Week */
    .week-shell{padding:10px}
    .week{
      display:grid;
      grid-template-columns:repeat(5,minmax(250px,1fr));
      gap:10px;
      min-width:1260px;
      align-items:start;
    }
    .day-card{
      border:1px solid var(--line);
      border-radius:5px;
      padding:10px;
      background:var(--surface);
      display:grid;
      gap:8px;
      min-height:230px;
    }
    .day-card.offday{
      background:color-mix(in srgb,var(--surface-2) 86%, var(--surface));
      border-style:dashed;
    }
    .day-card-head{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .day-card h4{margin:0;font-size:13px;font-weight:800;line-height:1.2}
    .day-head-sub{font-size:11px;color:var(--muted);font-weight:600;margin-top:2px}
    .util-pill{
      font-size:11px;
      font-weight:800;
      padding:4px 8px;
      border-radius:5px;
      border:1px solid var(--line);
      background:var(--surface-2);
      white-space:nowrap;
    }
    .util-pill.ok{color:var(--ok);border-color:color-mix(in srgb,var(--ok) 40%, var(--line));background:color-mix(in srgb,var(--ok) 12%, transparent)}
    .util-pill.warn{color:var(--warn);border-color:color-mix(in srgb,var(--warn) 40%, var(--line));background:color-mix(in srgb,var(--warn) 12%, transparent)}
    .util-pill.danger{color:var(--danger);border-color:color-mix(in srgb,var(--danger) 40%, var(--line));background:color-mix(in srgb,var(--danger) 12%, transparent)}
    .day-kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px}
    .day-kpi{border:1px solid var(--line);border-radius:5px;padding:6px 7px;background:var(--surface-2);min-width:0}
    .day-kpi .k{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.22px}
    .day-kpi .v{margin-top:3px;font-size:12px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .day-off{
      border:1px dashed color-mix(in srgb,var(--warn) 42%, var(--line));
      border-radius:5px;
      background:color-mix(in srgb,var(--warn) 8%, transparent);
      color:var(--warn);
      font-size:11px;
      font-weight:700;
      padding:6px 8px;
    }
    .day-owners{display:grid;gap:8px}
    .mini{
      border:1px solid var(--line);
      border-radius:5px;
      padding:8px;
      background:var(--surface-2);
      display:grid;
      gap:6px;
      margin-top:0;
    }
    .mini-head{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .mini-person{display:flex;align-items:center;gap:7px;min-width:0}
    .mini-avatar{
      width:24px;
      height:24px;
      border-radius:5px;
      display:grid;
      place-items:center;
      flex:0 0 24px;
      background:#222B35;
      color:#fff;
      font-size:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .mini .a{font-size:12px;font-weight:700;line-height:1.15;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini .owner-meta{font-size:10px;color:var(--muted);font-weight:700;margin-top:2px}
    .mini-util{font-size:11px;color:var(--muted);font-weight:700;white-space:nowrap}
    .mini-meter{height:6px;border:1px solid color-mix(in srgb,var(--line) 72%, transparent);border-radius:5px;background:var(--surface);overflow:hidden}
    .mini-meter > span{display:block;height:100%;width:0;border-radius:5px;background:linear-gradient(90deg,var(--primary),var(--primary-2))}
    .mini-tasks{display:grid;gap:6px}
    .wk-more{
      font-size:10px;
      color:var(--muted);
      font-weight:700;
      padding:0 1px;
      cursor:pointer;
      user-select:none;
      border:none;
      background:transparent;
      text-align:left;
      width:max-content;
    }
    .wk-more:hover{color:var(--text)}
    .wk-task .a{
      font-size:11px;
      font-weight:600;
      line-height:1.25;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .wk-task .b{
      font-size:10px;
      color:var(--muted);
      margin-top:4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      min-width:0;
    }
    .wk-task .b > span:first-child{
      min-width:0;
      flex:1 1 auto;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .wk-hidden{display:none}
    .wk-hidden.show{display:grid;gap:6px}
    .wk-task .status-badge{flex:0 0 auto}

    .day-empty{
      border:1px dashed color-mix(in srgb,var(--line) 82%, transparent);
      border-radius:5px;
      background:color-mix(in srgb,var(--surface-2) 68%, transparent);
      padding:8px;
      font-size:11px;
      color:var(--muted);
      text-align:center;
      font-weight:700;
    }

    /* Roadmap */
    .roadmap{padding:10px}
    .road-head{
      display:grid;grid-template-columns:290px repeat(var(--road-cols,12),minmax(38px,1fr));
      border:1px solid var(--line);border-bottom:none;border-radius:10px 10px 0 0;overflow:hidden;background:var(--surface-2);
    }
    .road-head div{
      border-right:1px solid var(--line);
      padding:8px;text-align:center;font-size:11px;font-weight:800;color:var(--muted);
    }
    .road-head div:first-child{text-align:left;padding-left:10px}
    .road-body{border:1px solid var(--line);border-top:none;border-radius:0 0 10px 10px;overflow:hidden}
    .road-row{display:grid;grid-template-columns:290px 1fr;min-height:46px;border-bottom:1px solid color-mix(in srgb, var(--line) 65%, transparent)}
    .road-row:last-child{border-bottom:none}
    .road-name{padding:10px;font-size:12px;font-weight:700;line-height:1.35}
    .road-track{position:relative;min-height:44px}
    .road-track .v{position:absolute;top:0;bottom:0;border-left:1px solid color-mix(in srgb, var(--line) 65%, transparent)}
    .bar{
      position:absolute;height:22px;border-radius:999px;
      font-size:11px;color:white;display:flex;align-items:center;padding:0 10px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;
      box-shadow:0 3px 10px rgba(2,8,23,.2);
    }

    .roadmap-tools{gap:8px;margin-left:4px}
    .roadmap-tools .seg{display:flex;gap:4px}
    .roadmap-tools .btn.tab{padding:6px 10px}

    /* Modals */
    .overlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(2,8,23,.46);backdrop-filter:blur(3px);z-index:80;
    }
    .overlay.open{display:flex}
    #projectOverlay{z-index:90}
    #teamOverlay{z-index:100}
    #detailOverlay{z-index:120}
    #infoOverlay{z-index:130}
    .modal{
      width:min(1080px,96vw);max-height:92vh;overflow:hidden;
      background:var(--surface);border:1px solid var(--line);border-radius:16px;
      box-shadow:0 22px 58px rgba(2,8,23,.35);
      display:flex;flex-direction:column;
    }
    .m-head,.m-foot{
      padding:11px 14px;background:var(--surface-2);border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;
    }
    .m-foot{border-top:1px solid var(--line);border-bottom:none}
    .m-body{padding:14px;overflow:auto}
    .tabs{display:flex;gap:6px;margin-bottom:10px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .grid4{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr;gap:8px}
    .form-grid4{grid-template-columns:repeat(4,minmax(160px,1fr))}
    .label{display:block;font-size:11px;color:var(--muted);font-weight:800;text-transform:uppercase;margin:0 0 5px}
    .project-form{display:grid;gap:12px}
    .form-section{border:1px solid color-mix(in srgb,var(--line) 85%, transparent);border-radius:0;padding:12px;background:var(--surface)}
    .form-section h4{margin:0 0 10px;font-size:13px;letter-spacing:.1px}
    .section-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .form-textarea{height:92px;padding:8px 10px;resize:vertical}
    .form-notes{height:80px;padding:8px 10px;resize:vertical;width:100%}
    .table-wrap{border:1px solid var(--line);border-radius:10px;overflow:auto;background:var(--surface)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:9px 8px;border-bottom:1px solid color-mix(in srgb, var(--line) 65%, transparent);text-align:left;font-size:12px}
    th{font-size:11px;background:var(--surface-2);font-weight:800;color:var(--muted)}
    tr:last-child td{border-bottom:none}
    .hidden{display:none !important}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    div.small.muted{display:none !important}
    .right{display:flex;gap:8px;justify-content:flex-end}

    .toast{
      position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
      padding:10px 14px;border-radius:999px;background:var(--text);color:var(--surface);
      font-size:13px;font-weight:700;opacity:0;pointer-events:none;transition:.2s;z-index:200;
    }
    .toast.show{opacity:1;transform:translate(-50%,-5px)}

    /* Detail modal + availability */
    #detailOverlay .modal{width:min(980px,96vw)}
    #infoOverlay .modal{width:min(760px,94vw)}
    .info-modal .m-head{
      background:linear-gradient(180deg, color-mix(in srgb,var(--primary) 12%, var(--surface-2)), var(--surface-2));
    }
    .info-modal .m-head b{display:inline-flex;align-items:center;gap:8px;font-size:15px}
    .info-modal .m-head b i{font-size:14px;color:var(--primary)}
    .info-modal .m-body{padding:14px}
    .info-body{display:grid;gap:12px}
    .info-line{font-size:13px;line-height:1.45}
    .info-meta{border:1px solid var(--line);border-radius:12px;background:var(--surface-2);padding:10px;display:grid;gap:8px}
    .info-meta div{font-size:12px;color:var(--muted)}
    .info-meta b{color:var(--text)}


    #btnInfo{position:relative;overflow:visible;isolation:isolate}
    #btnInfo i{font-size: 13px;line-height:1;transition:transform .18s ease, color .18s ease}
    #btnInfo.has-alert{
      border-color:var(--notif-alert-border);
      background:var(--notif-alert-bg);
      box-shadow:
        inset 0 0 0 1px color-mix(in srgb,var(--notif-alert-border) 30%, transparent),
        0 3px 10px color-mix(in srgb,var(--notif-alert-border) 18%, transparent);
    }
    #btnInfo.has-alert i{
      color:var(--notif-alert-icon);
      transform-origin:50% 8%;
      animation:notifBellWiggle 1.45s cubic-bezier(.2,.7,.2,1) infinite;
    }
    #btnInfo.has-alert::after{
      content:'';
      position:absolute;
      top:4px;
      right:4px;
      width:7px;
      height:7px;
      border-radius:999px;
      background:var(--notif-alert-dot);
      border:1.5px solid var(--surface);
      pointer-events:none;
      will-change:transform,opacity;
      animation:notifDotBlink .72s steps(2,end) infinite, notifDotPulse 1.2s ease-out infinite;
    }
    @keyframes notifDotBlink{
      0%,100%{opacity:1}
      50%{opacity:.48}
    }
    @keyframes notifDotPulse{
      0%{transform:scale(1); box-shadow:0 0 0 0 var(--notif-alert-ring)}
      70%{transform:scale(1.06); box-shadow:0 0 0 5px color-mix(in srgb,var(--notif-alert-ring) 0%, transparent)}
      100%{transform:scale(1); box-shadow:0 0 0 0 color-mix(in srgb,var(--notif-alert-ring) 0%, transparent)}
    }
    @keyframes notifBellWiggle{
      0%,65%,100%{transform:rotate(0)}
      8%{transform:rotate(13deg)}
      16%{transform:rotate(-9deg)}
      24%{transform:rotate(7deg)}
      32%{transform:rotate(-5deg)}
      40%{transform:rotate(2deg)}
    }
    @media (prefers-reduced-motion: reduce){
      #btnInfo.has-alert i,
      #btnInfo.has-alert::after{
        animation:none !important;
      }
    }

    .notif-top{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      border:1px solid var(--line);
      border-radius:12px;
      background:linear-gradient(180deg, color-mix(in srgb,var(--surface-2) 92%, transparent), var(--surface));
      padding:12px;
    }
    .notif-toolbar-title{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
      font-weight:800;
      letter-spacing:.1px;
    }
    .notif-toolbar-title i{color:var(--primary);font-size:13px}
    .notif-toolbar-sub{margin-top:4px;font-size:12px;color:var(--muted);line-height:1.4}
    .notif-stats{display:flex;gap:8px;flex-wrap:wrap}
    .notif-stat{
      min-width:94px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:10px;
      background:var(--surface);
      text-align:center;
    }
    .notif-stat b{display:block;font-size:15px;line-height:1.1}
    .notif-stat span{font-size:11px;color:var(--muted)}

    .notif-controls-wrap{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:var(--surface);
      padding:10px;
      display:grid;
      gap:10px;
    }
    .notif-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .notif-controls .ctrl{min-width:180px}

    .notif-form{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:linear-gradient(180deg, color-mix(in srgb,var(--surface-2) 94%, transparent), var(--surface));
      padding:12px;
      display:grid;
      grid-template-columns:1.1fr 1fr .85fr .8fr auto;
      gap:8px;
      align-items:end;
    }
    .notif-list{display:grid;gap:10px;margin-top:10px}
    .notif-card{
      border:1px solid var(--line);
      border-radius:5px !important;
      background:var(--surface);
      padding:11px;
      display:grid;
      gap:8px;
      box-shadow:0 8px 20px rgba(2,8,23,.06);
    }
    .notif-card.done{opacity:.82}
    .notif-card.status-overdue{border-color:color-mix(in srgb,var(--danger) 45%, var(--line))}
    .notif-card.status-today{border-color:color-mix(in srgb,var(--warn) 45%, var(--line))}
    .notif-card.status-scheduled{border-color:color-mix(in srgb,var(--primary) 35%, var(--line))}
    .notif-card.status-done{border-color:color-mix(in srgb,var(--ok) 35%, var(--line))}

    .notif-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .notif-title{font-size:13px;font-weight:700;line-height:1.35;text-transform:uppercase;letter-spacing:.2px}
    .notif-target{font-size:11px;color:var(--muted);margin-top:4px;display:flex;align-items:center;gap:6px}
    .notif-target i{font-size:10px;opacity:.9}
    .notif-msg{font-size:12px;line-height:1.45;white-space:pre-wrap}
    .notif-meta-row{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .notif-meta{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:6px}
    .notif-actions{display:flex;gap:6px;justify-content:flex-end;flex-wrap:wrap}

    .notif-pill{
      display:inline-flex;
      align-items:center;
      padding:3px 8px;
      border-radius:5px !important;
      border:1px solid var(--line);
      font-size:10px;
      font-weight:700;
      letter-spacing:.2px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .notif-pill.overdue{
      color:var(--danger);
      border-color:color-mix(in srgb,var(--danger) 55%, var(--line));
      background:color-mix(in srgb,var(--danger) 10%, transparent);
    }
    .notif-pill.today{
      color:var(--warn);
      border-color:color-mix(in srgb,var(--warn) 55%, var(--line));
      background:color-mix(in srgb,var(--warn) 12%, transparent);
    }
    .notif-pill.scheduled{
      color:var(--primary);
      border-color:color-mix(in srgb,var(--primary) 50%, var(--line));
      background:color-mix(in srgb,var(--primary) 12%, transparent);
    }
    .notif-pill.done{
      color:var(--ok);
      border-color:color-mix(in srgb,var(--ok) 50%, var(--line));
      background:color-mix(in srgb,var(--ok) 12%, transparent);
    }
    .notif-pill.none{
      color:var(--muted);
      border-color:var(--line);
      background:transparent;
    }
    .notif-empty{
      border:1px dashed var(--line);
      border-radius:12px;
      padding:16px;
      text-align:center;
      color:var(--muted);
      background:color-mix(in srgb,var(--surface-2) 70%, transparent);
      font-size:12px;
    }
    /* Notificaciones: radio uniforme (todo el contenido visual del modal) */
    #tab_notifications :is(
      .notif-top,.notif-toolbar-title,.notif-toolbar-sub,.notif-stats,.notif-stat,
      .notif-controls-wrap,.notif-controls,.notif-form,.notif-list,.notif-card,
      .notif-pill,.notif-empty,.notif-head,.notif-meta-row,.notif-meta,.notif-actions,
      .ctrl,.btn,label,input,select,textarea,button,.row
    ),
    #infoNotifBody :is(
      .notif-top,.notif-toolbar-title,.notif-toolbar-sub,.notif-stats,.notif-stat,
      .notif-controls-wrap,.notif-controls,.notif-form,.notif-list,.notif-card,
      .notif-pill,.notif-empty,.notif-head,.notif-meta-row,.notif-meta,.notif-actions,
      .ctrl,.btn,label,input,select,textarea,button,.row
    ){
      border-radius:5px !important;
    }

    /* Compatibilidad: variantes "notify-*" */
    .notify-card{border-radius:5px !important;}
    .notify-pill{border-radius:5px !important;}
    #tab_notifications .notif-action-btn,
    #infoNotifBody .notif-action-btn{
      font-weight:600;
    }

    /* Reportes a demanda (botón Resumen) */
#summaryOverlay{z-index:98}
#summaryOverlay .summary-modal{
  width:min(1180px,97vw);
  max-height:min(94dvh,980px);
  border-radius:5px;
  overflow:hidden;
  box-shadow:0 20px 56px rgba(0,0,0,.30);
}
#summaryOverlay .m-head{
  padding:9px 12px;
  border-bottom:1px solid var(--line);
  background:var(--surface);
}
#summaryOverlay .m-head b{
  display:flex;align-items:center;gap:8px;
  font-size:18px;letter-spacing:.15px;
}
#summaryOverlay .m-body{padding:9px 10px;background:var(--surface)}
#summaryOverlay .m-foot{
  padding:9px 10px;
  border-top:1px solid var(--line);
  background:color-mix(in srgb,var(--surface-2) 72%, var(--surface));
}

.summary-workspace{display:grid;gap:10px}
.summary-command{
  border:1px solid var(--line);
  border-radius:5px;
  background:var(--surface);
  padding:10px;
  display:grid;
  gap:9px;
}
.summary-command-actions{
  display:flex;gap:7px;flex-wrap:wrap;justify-content:flex-end;
}
.summary-command-actions .btn{
  height:32px;
  border-radius:5px;
  font-size:12px;
  font-weight:700;
  padding:0 12px;
}

.summary-preset-strip{
  display:flex;
  gap:7px;
  flex-wrap:nowrap;
  align-items:center;
  overflow:auto hidden;
  padding-bottom:2px;
  scrollbar-width:thin;
}
.summary-preset-strip::-webkit-scrollbar{height:4px}
.summary-reset-inline{
  margin-left:auto;
  height:29px;
  border-radius:5px;
  padding:0 11px;
  font-size:10.8px;
  font-weight:800;
  white-space:nowrap;
}
.summary-preset{
  border:1px solid var(--line);
  background:var(--surface);
  color:var(--muted);
  border-radius:5px;
  height:29px;
  padding:0 11px;
  font-size:10.5px;
  font-weight:700;
  letter-spacing:.2px;
  text-transform:uppercase;
  cursor:pointer;
  transition:border-color .12s ease, background .12s ease, color .12s ease;
}
.summary-preset:hover{
  transform:translateY(-1px);
  border-color:color-mix(in srgb,var(--primary) 40%, var(--line));
}
.summary-preset:active{transform:translateY(0)}
.summary-preset.active{
  color:var(--primary);
  border-color:color-mix(in srgb,var(--primary) 50%, var(--line));
  background:color-mix(in srgb,var(--primary) 12%, transparent);
}

.summary-layout{
  display:grid;
  grid-template-columns:minmax(300px,360px) minmax(0,1fr);
  gap:10px;
  min-height:0;
}
.summary-panel{
  border:1px solid var(--line);
  border-radius:5px;
  background:var(--surface);
  overflow:hidden;
  min-height:0;
  box-shadow:0 8px 20px rgba(2,8,23,.06);
}
.summary-panel details{
  display:grid;
}
.summary-panel summary{
  list-style:none;
  cursor:pointer;
  user-select:none;
  padding:10px 11px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  font-size:12px;
  font-weight:850;
  background:color-mix(in srgb,var(--surface-2) 72%, var(--surface));
  border-bottom:1px solid var(--line);
}
.summary-panel summary::-webkit-details-marker{display:none}
.summary-panel summary::after{
  content:'▾';
  color:var(--muted);
  font-size:12px;
  transition:transform .15s ease;
}
.summary-panel details[open] summary::after{transform:rotate(180deg)}
.summary-panel-hint{
  font-size:10.5px;
  color:var(--muted);
  font-weight:700;
}

.summary-panel-body{
  padding:9px;
  display:grid;
  gap:9px;
}
.summary-filter-grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:8px;
}
.sum-field{
  display:grid;
  gap:4px;
  align-content:start;
}
.sum-field span{
  font-size:10.2px;
  font-weight:900;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.2px;
}
.sum-field.wide{grid-column:span 2}
#summaryOverlay .ctrl{
  height:33px;
  border-radius:5px;
  font-size:12px;
  padding:6px 9px;
}
#summaryOverlay select.ctrl{padding-right:30px}

.summary-checkgroups{
  display:grid;
  gap:8px;
}
.summary-checkgroup{
  border:1px solid var(--line);
  border-radius:5px;
  padding:7px;
  background:var(--surface);
}
.summary-checkgroup .title{
  margin-bottom:6px;
  font-size:10.3px;
  font-weight:900;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.18px;
}
.summary-checkline{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.summary-checkline label{
  display:inline-flex;
  align-items:center;
  gap:6px;
  border:1px solid var(--line);
  border-radius:5px;
  background:var(--surface);
  font-size:11px;
  padding:4px 8px;
}
.summary-checkline input[type="checkbox"]{accent-color:var(--primary)}

.summary-main{
  display:grid;
  gap:9px;
  min-width:0;
  min-height:0;
}
.summary-kpis{
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:7px;
}
.summary-kpi{
  border:1px solid var(--line);
  border-radius:5px;
  background:var(--surface);
  padding:8px;
  box-shadow:0 6px 16px rgba(2,8,23,.04);
}
.summary-kpi .k{
  font-size:10px;
  font-weight:900;
  text-transform:uppercase;
  letter-spacing:.2px;
  color:var(--muted);
}
.summary-kpi .v{
  font-size:22px;
  font-weight:900;
  letter-spacing:-.25px;
  line-height:1;
  margin-top:2px;
}
.summary-kpi .s{
  font-size:10.8px;
  color:var(--muted);
  margin-top:3px;
  line-height:1.2;
}

.summary-readable{
  border:1px solid var(--line);
  border-radius:5px;
  background:var(--surface);
  padding:8px;
  display:grid;
  gap:8px;
  box-shadow:0 8px 20px rgba(2,8,23,.06);
}
.brief-hero{
  border:1px solid var(--line);
  border-radius:5px;
  background:var(--surface);
  padding:9px;
  display:grid;
  grid-template-columns:1fr auto;
  gap:8px;
  align-items:center;
}
.brief-hero h4{
  margin:0;
  font-size:14px;
  line-height:1.2;
}
.brief-meta{
  margin-top:2px;
  font-size:10.8px;
  color:var(--muted);
  line-height:1.25;
}
.brief-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.brief-tag{
  border:1px solid var(--line);
  border-radius:999px;
  padding:2px 8px;
  font-size:10px;
  font-weight:800;
  color:var(--muted);
  background:var(--surface);
}
.brief-score{
  border:1px solid var(--line);
  border-radius:5px;
  background:var(--surface);
  padding:7px 9px;
  text-align:center;
  min-width:110px;
}
.brief-score .n{
  font-size:26px;
  font-weight:950;
  line-height:1;
  letter-spacing:-.3px;
}
.brief-score .l{
  margin-top:3px;
  font-size:10.2px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.2px;
}

.brief-grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:7px;
}
.brief-card{
  border:1px solid var(--line);
  border-radius:5px;
  background:var(--surface);
  padding:8px;
  min-height:130px;
  box-shadow:0 8px 20px rgba(2,8,23,.05);
}
.brief-card h5{
  margin:0 0 7px;
  display:flex;
  align-items:center;
  gap:6px;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.2px;
}
.brief-list{
  margin:0;
  padding:0;
  list-style:none;
  display:grid;
  gap:6px;
}
.brief-scroll{
  position:relative;
  max-height:248px;
  overflow-y:auto;
  overflow-x:hidden;
  padding:12px 2px 12px 0;
  scrollbar-gutter:stable;
  --brief-fade-size:12px;
  -webkit-mask-image:linear-gradient(to bottom,
    transparent 0,
    #000 var(--brief-fade-size),
    #000 calc(100% - var(--brief-fade-size)),
    transparent 100%
  );
  mask-image:linear-gradient(to bottom,
    transparent 0,
    #000 var(--brief-fade-size),
    #000 calc(100% - var(--brief-fade-size)),
    transparent 100%
  );
}
.brief-scroll::before,
.brief-scroll::after{
  content:none;
}
.brief-scroll-activities .brief-list,
.brief-scroll-reminders .brief-list{
  padding-top:2px;
  padding-bottom:2px;
}
.brief-item{
  border:1px solid color-mix(in srgb,var(--line) 75%, transparent);
  border-radius:5px;
  background:color-mix(in srgb,var(--surface-2) 72%, var(--surface));
  padding:6px;
}
.brief-item .t{
  font-size:11.5px;
  font-weight:850;
  line-height:1.2;
}
.brief-item .m{
  margin-top:2px;
  font-size:10.4px;
  color:var(--muted);
  line-height:1.25;
}
.brief-item.urgent{border-color:color-mix(in srgb,var(--danger) 50%, var(--line))}
.brief-item.warn{border-color:color-mix(in srgb,var(--warn) 52%, var(--line))}
.brief-item.ok{border-color:color-mix(in srgb,var(--ok) 55%, var(--line))}
.brief-empty{
  border:1px dashed color-mix(in srgb,var(--line) 70%, transparent);
  border-radius:5px;
  padding:8px;
  color:var(--muted);
  font-size:10.8px;
}

.brief-bars{display:grid;gap:6px}
.brief-bar{
  display:grid;
  gap:3px;
}
.brief-bar-head{
  display:flex;justify-content:space-between;gap:8px;
  font-size:10.7px;
}
.brief-bar-track{
  height:7px;
  border:1px solid var(--line);
  border-radius:999px;
  overflow:hidden;
  background:color-mix(in srgb,var(--line) 28%, transparent);
}
.brief-bar-track span{
  display:block;height:100%;
  background:linear-gradient(90deg,color-mix(in srgb,var(--primary) 62%, transparent),color-mix(in srgb,var(--primary) 88%, transparent));
}
.brief-next{
  border:1px solid var(--line);
  border-radius:5px;
  background:color-mix(in srgb,var(--surface-2) 72%, var(--surface));
  padding:8px;
}
.brief-next .t{
  font-size:11.6px;
  font-weight:850;
  line-height:1.2;
}
.brief-next .m{
  font-size:10.5px;
  color:var(--muted);
  margin-top:3px;
  line-height:1.25;
}

.summary-plain-wrap{
  border:1px solid var(--line);
  border-radius:5px;
  background:var(--surface);
  overflow:hidden;
}
.summary-plain-wrap > summary{
  list-style:none;
  cursor:pointer;
  user-select:none;
  padding:8px 10px;
  font-size:11.5px;
  font-weight:850;
  background:color-mix(in srgb,var(--surface-2) 72%, var(--surface));
  border-bottom:1px solid var(--line);
}
.summary-plain-wrap > summary::-webkit-details-marker{display:none}
.summary-output{
  width:100%;
  min-height:150px;
  max-height:28dvh;
  resize:vertical;
  border:none;
  background:var(--surface);
  color:var(--text);
  padding:8px;
  font:500 11.4px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  white-space:pre;
  overflow:auto;
}

@media (max-width:1100px){
  .summary-layout{grid-template-columns:320px 1fr}
  .summary-kpis{grid-template-columns:repeat(2,minmax(0,1fr))}
}
@media (max-width:900px){
  #summaryOverlay .summary-modal{
    width:100vw;max-height:100dvh;border-radius:0;
  }
  #summaryOverlay .m-head,#summaryOverlay .m-foot{padding:8px 9px}
  #summaryOverlay .m-body{padding:8px 9px}
  .summary-command-actions{justify-content:stretch}
  .summary-command-actions .btn{flex:1}
  .summary-preset-strip{
    flex-wrap:nowrap;
    overflow:auto hidden;
    padding-bottom:2px;
    scrollbar-width:thin;
  }
  .summary-preset-strip::-webkit-scrollbar{height:4px}
  .summary-preset{flex:0 0 auto}
  .summary-reset-inline{flex:0 0 auto;margin-left:auto}
  .summary-checkline{
    flex-wrap:nowrap;
    overflow:auto hidden;
    padding-bottom:2px;
    scrollbar-width:thin;
    -webkit-overflow-scrolling:touch;
  }
  .summary-checkline::-webkit-scrollbar{height:4px}
  .summary-checkline label{flex:0 0 auto;white-space:nowrap}
  #summaryOverlay #summaryQuery.ctrl{font-size:16px !important}
  .summary-layout{grid-template-columns:1fr}
  .summary-panel{
    order:1;
  }
  .summary-main{
    order:2;
  }
  .brief-hero{
    grid-template-columns:1fr;
  }
  .brief-grid{grid-template-columns:1fr}
  .summary-output{max-height:23dvh}
}
@media (max-width:430px){
  #summaryOverlay .m-head b{font-size:16px}
  .summary-command{padding:8px}
  .summary-command-actions .btn{height:31px;font-size:11.5px}
  .summary-filter-grid{gap:7px}
  #summaryOverlay .ctrl{height:32px;font-size:11.8px}
  .summary-kpi{padding:7px}
  .summary-kpi .v{font-size:20px}
  .brief-score .n{font-size:24px}
}
@media (prefers-reduced-motion:reduce){
  .summary-preset{transition:none}
}
.detail-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    .detail-card{border:1px solid var(--line);border-radius:0;background:var(--surface);padding:10px}
    .detail-card h4{margin:0 0 8px;font-size:13px}
    .detail-list{display:grid;gap:8px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;padding:6px 0;border-bottom:1px dashed color-mix(in srgb,var(--line) 65%, transparent)}
    .kv:last-child{border-bottom:none}
    .kv b{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.2px}
    .kv span{font-size:13px}
    .act-list{display:grid;gap:8px}
    .act-item{border:1px solid var(--line);border-radius:10px;padding:9px;background:var(--surface-2)}
    .act-item .t{display:flex;justify-content:space-between;gap:8px;align-items:center;font-size:12px;font-weight:800}
    .act-item .m{font-size:11px;color:var(--muted);margin-top:4px;line-height:1.35}
    .act-item .d{font-size:12px;margin-top:5px;line-height:1.35}

    .wk-task{
      padding:8px;
      border-radius:5px;
      border:1px solid var(--line);
      background:var(--surface);
      cursor:pointer;
      font-size:11px;
      line-height:1.25;
      margin-top:0;
      transition:transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .wk-task:hover{background:var(--surface);border-color:color-mix(in srgb,var(--primary) 35%, var(--line));transform:translateY(-1px)}
    .availability{padding:10px;min-width:980px}
    .avail-legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:11px;color:var(--muted);margin-bottom:10px}
    .dot{width:12px;height:12px;border-radius:3px;border:1px solid var(--line);display:inline-block}
    .dot.av{background:color-mix(in srgb,var(--ok) 24%, transparent);border-color:color-mix(in srgb,var(--ok) 55%, var(--line))}
    .dot.busy{background:color-mix(in srgb, #cbd5e1 72%, var(--surface));border-color:color-mix(in srgb, #64748b 52%, var(--line))}
    .avail-table{border:1px solid var(--line);border-radius:10px;overflow:auto;background:var(--surface)}
    .avail-head,.avail-row{display:grid;grid-template-columns:190px repeat(5,minmax(150px,1fr));}
    .avail-head{background:var(--surface-2);border-bottom:1px solid var(--line);font-size:11px;font-weight:800;color:var(--muted)}
    .avail-head > div,.avail-row > div{padding:8px;border-right:1px solid color-mix(in srgb,var(--line) 65%, transparent)}
    .avail-head > div:last-child,.avail-row > div:last-child{border-right:none}
    .avail-row{border-bottom:1px solid color-mix(in srgb,var(--line) 55%, transparent)}
    .avail-row:last-child{border-bottom:none}
    .avail-user{font-size:12px;font-weight:800}
    .avail-meta{font-size:10px;color:var(--muted);margin-top:3px}
    .slots{display:grid;grid-template-columns:repeat(var(--slot-count),minmax(6px,1fr));gap:2px;min-height:16px;align-items:center}
    .slot{height:12px;border-radius:3px;border:1px solid color-mix(in srgb,var(--line) 60%, transparent);background:transparent}
    .slot.av{background:color-mix(in srgb,var(--ok) 24%, transparent);border-color:color-mix(in srgb,var(--ok) 55%, var(--line))}
    .slot.busy{background:repeating-linear-gradient(135deg,color-mix(in srgb, #94a3b8 18%, transparent),color-mix(in srgb, #94a3b8 18%, transparent) 8px,transparent 8px,transparent 16px);border-color:color-mix(in srgb, #64748b 52%, var(--line))}
    .slot.off{background:transparent;opacity:.35}
    .day-free{font-size:10px;color:var(--muted);margin-top:4px;text-align:right}
        /* ===== Access/Login vNext (adaptado desde login.html, scopeado al overlay) ===== */
    #accessOverlay{
      z-index:170;
      background:#05080e;
      backdrop-filter:none;
      align-items:stretch;
      justify-content:stretch;
      padding:0;
    }
    #accessOverlay .modal.login-pro{
      width:100vw;
      height:100vh;
      min-height:100vh;
      max-height:none;
      overflow:hidden;
      border-radius:0;
      border:none;
      box-shadow:none;
      background:transparent;
      padding:0;
      margin:0;
    }

    #accessOverlay .access-scene{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
      isolation:isolate;
      background:
        radial-gradient(1200px 640px at 120% -24%, rgba(79,140,255,.16), transparent 68%),
        radial-gradient(980px 560px at -20% -30%, rgba(20,184,166,.12), transparent 64%),
        radial-gradient(1200px 700px at 50% 125%, rgba(0,0,0,.60), transparent 54%),
        #05080e;
      color:#e5edf8;
    }
    #accessOverlay .access-scene::before{
      content:"";
      position:absolute; inset:0;
      z-index:0; pointer-events:none;
      opacity:.14;
      background-image:
        radial-gradient(circle at 1px 1px, rgba(191,219,254,.40) 1px, transparent 1.22px),
        radial-gradient(circle at 1px 1px, rgba(56,189,248,.24) 1px, transparent 1.2px),
        radial-gradient(circle at 1px 1px, rgba(255,255,255,.12) 1px, transparent 1.15px);
      background-size:22px 22px, 44px 44px, 66px 66px;
      background-position:0 0, 11px 11px, 7px 7px;
      mask-image:radial-gradient(130% 100% at 50% 38%, #000 58%, rgba(0,0,0,.78) 84%, transparent 100%);
      -webkit-mask-image:radial-gradient(130% 100% at 50% 38%, #000 58%, rgba(0,0,0,.78) 84%, transparent 100%);
    }
    #accessOverlay .scene-vignette{
      position:absolute; inset:0;
      z-index:15; pointer-events:none;
      background:
        linear-gradient(to bottom, rgba(5,8,14,.72), rgba(5,8,14,0) 18%),
        linear-gradient(to top, rgba(5,8,14,.84), rgba(5,8,14,0) 22%),
        linear-gradient(to right, rgba(5,8,14,.82), rgba(5,8,14,0) 18%),
        linear-gradient(to left, rgba(5,8,14,.82), rgba(5,8,14,0) 18%);
    }

    #accessOverlay .top-ambient{
      position:absolute; left:0; right:0; top:0;
      height:49%; min-height:270px;
      z-index:3; pointer-events:none; overflow:hidden;
      background:
        radial-gradient(68% 54% at 50% 8%, rgba(79,140,255,.19), transparent 72%),
        radial-gradient(58% 40% at 50% 26%, rgba(20,184,166,.12), transparent 76%);
      mask-image:linear-gradient(to bottom, #000 63%, rgba(0,0,0,.72) 82%, transparent 100%);
      -webkit-mask-image:linear-gradient(to bottom, #000 63%, rgba(0,0,0,.72) 82%, transparent 100%);
    }
    #accessOverlay #accessAmbientCanvas{
      position:absolute; inset:0;
      width:100%; height:100%; display:block;
    }
    #accessOverlay .ambient-glass{
      position:absolute; inset:0; pointer-events:none;
      background:
        linear-gradient(105deg, transparent 12%, rgba(130,170,230,.06) 26%, transparent 42%),
        linear-gradient(80deg, transparent 40%, rgba(48,180,170,.06) 56%, transparent 72%);
      mix-blend-mode:screen;
    }
    #accessOverlay .ambient-line{
      position:absolute; left:8%; right:8%; height:1px;
      background:linear-gradient(90deg, transparent, rgba(170,190,210,.30), transparent);
      opacity:.75; filter:blur(.1px);
    }
    #accessOverlay .ambient-line.l1{ top:16%; }
    #accessOverlay .ambient-line.l2{ top:28%; opacity:.48; }
    #accessOverlay .ambient-line.l3{ top:40%; opacity:.34; }

    #accessOverlay .fade-ambient-login{
      position:absolute; left:0; right:0;
      top:30%; height:28%;
      z-index:4; pointer-events:none;
      background:linear-gradient(to bottom, rgba(6,8,13,0) 0%, rgba(6,8,13,.46) 54%, rgba(6,8,13,.76) 100%);
      filter:blur(1px);
    }

    #accessOverlay .login-layer{
      position:absolute; inset:0;
      z-index:8;
      display:grid;
      place-items:center;
      pointer-events:none;
      padding:18px;
    }
    #accessOverlay .login-shell{
      width:min(92%, 500px);
      pointer-events:auto;
      transform:translateY(-.5vh);
    }

    #accessOverlay .login-card{
      overflow:hidden;
      border-radius:5px;
      width:100%;
      border:1px solid color-mix(in srgb,var(--primary) 28%, #22314f);
      box-shadow:
        0 28px 70px rgba(2,8,23,.44),
        0 0 0 1px rgba(255,255,255,.03);
      background:
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)),
        #111a2e;
      backdrop-filter:blur(4px);
    }

    #accessOverlay .login-head{
      background:
        radial-gradient(500px 180px at 110% -25%, color-mix(in srgb,var(--primary) 34%, transparent), transparent 70%),
        linear-gradient(135deg, color-mix(in srgb,var(--primary) 18%, #16233d), #111a2e);
      padding:14px 16px 12px;
      border-bottom:1px solid #22314f;
      display:flex;align-items:center;gap:10px;
    }

    #accessOverlay .login-logo{
      width:38px;height:38px;border-radius:10px;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
      color:#fff;font-weight:900;font-size:12px;letter-spacing:.3px;
      box-shadow:0 8px 18px rgba(79,140,255,.24);flex:0 0 auto;
    }

    #accessOverlay .login-title{color:#e5edf8;font-size:15px;font-weight:780;margin:0;line-height:1.05;}
    #accessOverlay .login-sub{color:#9fb0c9;font-size:12px;margin:4px 0 0;line-height:1.2;}

    #accessOverlay .login-form{
      padding:14px 16px 16px;
      gap:10px;
      display:grid;
      background:#111a2e;
    }
    #accessOverlay .input-access-row{
      display:flex;align-items:center;gap:8px;width:100%;min-width:0;
    }
    #accessOverlay .input-access-row .access-code{
      flex:1 1 auto;min-width:0;width:100%;
      height:42px;border:1px solid #22314f;border-radius:8px;
      background:#16233d;color:#e5edf8;font-size:18px;
      letter-spacing:6px;text-align:center;font-weight:700;padding:0 12px;
      outline:none;
    }
    #accessOverlay .input-access-row .access-code::placeholder{
      color:#8fa3bf;letter-spacing:4px;font-weight:600;
    }
    #accessOverlay .input-access-row .access-code:focus{
      border-color:color-mix(in srgb,var(--primary) 60%, #22314f);
      box-shadow:0 0 0 3px rgba(79,140,255,.22);
    }

    #accessOverlay .input-access-row .login-btn{
      flex:0 0 92px;
      width:92px;min-width:92px;max-width:92px;
      white-space:nowrap;height:42px;
      padding:0 10px;border-radius:8px;
      font-size:12px;font-weight:800;
      overflow:hidden;text-overflow:ellipsis;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(135deg,var(--primary),#376fff);
      color:#fff;
      box-shadow:0 10px 20px rgba(79,140,255,.20);
      cursor:pointer;
      transition:filter .2s ease, transform .12s ease;
    }
    #accessOverlay .input-access-row .login-btn:hover{filter:brightness(1.05);}
    #accessOverlay .input-access-row .login-btn:active{transform:translateY(1px);}
    #accessOverlay .input-access-row .login-btn:disabled{
      opacity:.65;cursor:not-allowed;transform:none;filter:none;
    }

    #accessOverlay .login-hint{
      color:#9fb0c9;
      font-size:11px;
      line-height:1.2;
      text-align:left;
      margin-top:2px;
      user-select:none;
    }
    #accessOverlay .mini-help{font-size:11px;color:#9fb0c9;margin-top:8px;}
    #accessOverlay .dim{opacity:.9;}
    #accessOverlay .lock-msg{
      font-size:12px;
      color:#f87171;
      margin-top:2px;
      display:none;
      line-height:1.3;
    }

    #accessOverlay .fade-login-chart{
      position:absolute; left:0; right:0; top:49%; height:27%;
      z-index:6; pointer-events:none; filter:blur(1px);
      background:linear-gradient(to bottom, rgba(6,8,13,.70) 0%, rgba(6,8,13,.32) 40%, rgba(6,8,13,0) 100%);
    }

    #accessOverlay .chart-wrap{
      position:absolute; left:0; right:0; bottom:0; top:43%;
      z-index:2; overflow:hidden; pointer-events:none;
    }
    #accessOverlay .chart-shell{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:2.6%;
      width:min(1040px,86%);
      height:min(36%,290px);
      min-height:165px;
      background:transparent;
      overflow:hidden;
      border-radius:8px;
    }
    #accessOverlay .chart-shell::before{
      content:"";
      position:absolute; inset:0;
      z-index:20; pointer-events:none;
      background:
        linear-gradient(to bottom, rgba(5,8,14,.74), rgba(5,8,14,0) 20%),
        linear-gradient(to top, rgba(5,8,14,.88), rgba(5,8,14,0) 24%),
        linear-gradient(to right, rgba(5,8,14,.86), rgba(5,8,14,0) 16%),
        linear-gradient(to left, rgba(5,8,14,.86), rgba(5,8,14,0) 16%);
    }

    #accessOverlay .grid{position:absolute; inset:0; z-index:1;}
    #accessOverlay .grid-line{
      position:absolute; top:8%; bottom:11.5%;
      width:1px;
      background:linear-gradient(to bottom, rgba(70,89,103,.90), rgba(70,89,103,.55));
      opacity:.95;
    }
    #accessOverlay .session{
      position:absolute;
      height:12.8%;
      border-radius:2px;
      background:linear-gradient(90deg, rgba(58,74,86,.58), rgba(83,103,117,.74));
      border:1px solid rgba(170,190,206,.06);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.02);
      color:#c8d2db;
      font-weight:600;
      font-size:clamp(12px,1.1vw,16px);
      letter-spacing:.2px;
      display:flex; align-items:center;
      padding-left:1.2%;
      white-space:nowrap;
      overflow:hidden;
      text-shadow:0 1px 0 rgba(0,0,0,.35);
      z-index:4;
    }
    #accessOverlay .s-london{ left:0.5%; top:17%; width:22.6%; }
    #accessOverlay .s-newyork{ left:4.6%; top:35%; width:39.0%; }
    #accessOverlay .s-sydney{ left:43.4%; top:53%; width:37.2%; }
    #accessOverlay .s-tokyo{ left:52.7%; top:71%; width:34.8%; }
    #accessOverlay .s-london-next{ left:84.7%; top:17%; width:15.3%; padding-left:.9%; }

    #accessOverlay .now-line{
      position:absolute; z-index:6;
      top:8%; bottom:11.5%;
      width:2px; left:80.8%;
      background:linear-gradient(to bottom, rgba(217,138,16,.95), rgba(217,138,16,.80));
      box-shadow:0 0 0 1px rgba(217,138,16,.10), 0 0 14px rgba(217,138,16,.18);
    }

    #accessOverlay .x-label{
      position:absolute; bottom:3%;
      transform:translateX(-50%);
      color:#9aa4ae;
      font-size:clamp(11px,.95vw,14px);
      font-weight:500;
      letter-spacing:.1px;
      line-height:1;
      z-index:8;
      text-shadow:0 1px 0 rgba(0,0,0,.3);
      user-select:none;
    }
    #accessOverlay .now-label{
      position:absolute; left:80.8%; bottom:1%;
      transform:translateX(-50%);
      color:#d98a10;
      font-size:clamp(11px,1vw,16px);
      font-weight:700;
      letter-spacing:.1px;
      z-index:9;
      text-shadow:0 1px 0 rgba(0,0,0,.3);
    }

    .acc-ind{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;font-size:11px;border:1px solid var(--line);border-radius:999px;background:var(--surface-2);color:var(--muted)}
    .acc-ind.ok{color:var(--ok);border-color:color-mix(in srgb,var(--ok) 38%, var(--line));background:color-mix(in srgb,var(--ok) 10%, transparent)}
    .acc-ind.warn{color:var(--warn);border-color:color-mix(in srgb,var(--warn) 40%, var(--line));background:color-mix(in srgb,var(--warn) 10%, transparent)}
    .acc-ind.neutral{color:var(--muted)}

    @media (max-width:1100px){
      #accessOverlay .chart-shell{width:min(980px,90%);}
    }
    @media (max-width:900px){
      #accessOverlay .login-layer{padding:14px;}
      #accessOverlay .top-ambient{height:56%;min-height:280px;}
      #accessOverlay .ambient-line.l1{top:32%;}
      #accessOverlay .ambient-line.l2{top:45%;opacity:.50;}
      #accessOverlay .ambient-line.l3{top:58%;opacity:.38;}
      #accessOverlay .fade-ambient-login{top:40%;height:24%;}
      #accessOverlay .chart-wrap{top:39.2%;}
      #accessOverlay .login-shell{width:min(92%,450px);transform:translateY(0);}
      #accessOverlay .fade-login-chart{top:53.2%;height:21%;}
      #accessOverlay .chart-shell{height:min(39%,270px);bottom:6.2%;}
    }
    @media (max-width:640px){
      #accessOverlay .top-ambient{height:54%;min-height:260px;}
      #accessOverlay .ambient-line.l1{top:34%;}
      #accessOverlay .ambient-line.l2{top:47%;}
      #accessOverlay .ambient-line.l3{top:60%;}
      #accessOverlay .fade-ambient-login{top:41%;height:23%;}
      #accessOverlay .chart-wrap{top:38.5%;}
      #accessOverlay .login-shell{width:min(94%,340px);}
      #accessOverlay .input-access-row .access-code{font-size:16px;letter-spacing:5px;}
      #accessOverlay .chart-shell{
        width:min(96vw,560px);
        height:min(37%,235px);
        min-height:158px;
        bottom:7.2%;
      }
      #accessOverlay .fade-login-chart{top:54%;height:19%;}
      #accessOverlay .session{font-size:clamp(10px,2.1vw,12px);}
      #accessOverlay .x-label{font-size:clamp(10px,1.9vw,11px);}
      #accessOverlay .now-label{font-size:clamp(10px,2vw,12px);}
    }
    @media (max-width:1100px){
      .controls{align-items:center}
      .controls > .row{width:auto}
      .controls > .row.filters .ctrl{flex:0 0 auto;min-width:100px}
      .ctrl.search{min-width:130px;width:140px}
      .day-grid{min-width:760px}
      .week{min-width:920px}
      .road-head{grid-template-columns:210px repeat(var(--road-cols,12),minmax(30px,1fr))}
      .road-row{grid-template-columns:210px 1fr}
    }
    @media (max-width:860px){
      .top{padding:12px}
      .actions{
        width:100%;
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        gap:6px;
        align-items:stretch;
      }
      .actions .mode-pill{display:none !important}
      .actions .btn{
        height:34px;
        padding:0 10px;
        font-size:12px;
        min-width:0;
      }

      /* Fila 1: Equipo + Resumen */
      .actions #btnTeam{grid-column:1}
      .actions #btnCopyDaySummary{grid-column:2}

      /* Fila 2: Agenda (50%) + Grupo de íconos (50%) */
      .actions #btnAgenda{grid-column:1}
      .actions .actions-icon-group{
        grid-column:2;
        display:grid;
        grid-template-columns:repeat(4,minmax(0,1fr));
        gap:6px;
        min-width:0;
      }
      .actions .actions-icon-group .btn.icon{
        width:100%;
        height:34px;
        padding:0;
        margin:0;
      }

      /* Si está visible en admin, queda en una tercera fila */
      .actions #btnAdd{grid-column:1 / -1}

      .seg{width:100%;justify-content:space-between}
      .seg .btn{flex:1}
      .controls .seg{width:auto;justify-content:flex-start}
      .controls .seg .btn{flex:0 0 auto}
      .grid2,.grid3,.grid4{grid-template-columns:1fr !important}
      .detail-grid{grid-template-columns:1fr}
      .modal{width:min(1120px,98vw);max-height:94vh}
      .m-body{padding:12px}
      .main{margin:0 10px 12px}
      .availability{min-width:780px}
      .avail-head,.avail-row{grid-template-columns:150px repeat(5,minmax(120px,1fr))}
    }
    @media (max-width:560px){
      .app{padding:0 8px 14px}
      .controls{margin:0 10px 10px}
      .kpi-band,.split{margin:0 10px 10px}
      .title{font-size:18px}
      .subtitle{font-size:11px}
      .availability{min-width:680px}
      .slot{height:10px}
      .panel > .footer-strip{min-height:94px;padding:12px}
      .footer-strip .line1{font-size:13px;line-height:1.25}
      .footer-strip .line2{font-size:11px}
      #accessOverlay .access-code{letter-spacing:6px;font-size:18px}
    }

  

    /* Top header refinado (relleno #222B35 + contraste adaptado) */
    .panel > .top{
      background:#051c2c;
      border-top-left-radius:calc(var(--radius) - 1px);
      border-top-right-radius:calc(var(--radius) - 1px);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .panel > .top .title{color:#f4f7fb;}
    .panel > .top .subtitle{color:#b7c4d7;}
    .panel > .top .logo{
      background:linear-gradient(135deg,#2f72ff,#12a594);
      box-shadow:0 8px 18px rgba(0,0,0,.24);
    }
    .panel > .top .btn{
      background:rgba(255,255,255,.07);
      border-color:rgba(255,255,255,.22);
      color:#eef3fb;
    }
    .panel > .top .btn:hover{
      background:rgba(255,255,255,.12);
    }
    .panel > .top .btn.primary{
      background:linear-gradient(135deg,#3b82f6,#2563eb);
      border-color:rgba(255,255,255,.24);
      color:#fff;
    }
    .panel > .top .btn.primary:hover{filter:brightness(1.05);}
    .panel > .top .btn.tab.active{
      background:#f8fbff;
      color:#1f2937;
      border-color:#f8fbff;
    }


    /* Footer barra institucional */
    .panel > .footer-strip{
      background:#051c2c;
      border-top:1px solid rgba(255,255,255,.10);
      border-bottom-left-radius:calc(var(--radius) - 1px);
      border-bottom-right-radius:calc(var(--radius) - 1px);
      padding:14px;
      min-height:94px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      color:#f4f7fb;
    }
    .footer-strip .line1{font-weight:600;letter-spacing:-.1px}
    .footer-strip .line2{font-size:12px;color:#b7c4d7;margin-top:2px}



    /* Roadmap v91: diseño más limpio + estructura eficiente */
    .roadmap{display:grid;gap:10px;padding:12px}
    .road-summary{
      display:grid;
      grid-template-columns:repeat(5,minmax(120px,1fr));
      gap:8px;
    }
    .road-kpi{
      border:1px solid color-mix(in srgb,var(--line) 80%, transparent);
      background:var(--surface);
      border-radius:5px;
      padding:8px 10px;
      min-width:0;
    }
    .road-kpi .k{font-size:10px;text-transform:uppercase;letter-spacing:.25px;color:var(--muted);font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .road-kpi .v{font-size:14px;font-weight:800;line-height:1.2;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .road-kpi .v.small{font-size:12px;font-weight:700}

    .road-table-wrap{
      border:1px solid color-mix(in srgb,var(--line) 86%, transparent);
      border-radius:5px;
      background:var(--surface);
      overflow:auto;
      max-height:68vh;
      min-height:300px;
    }
    .road-head{
      position:sticky;
      top:0;
      z-index:8;
      display:grid;
      grid-template-columns:320px repeat(var(--road-cols,12),minmax(42px,1fr));
      background:var(--surface-2);
      border:0;
      border-bottom:1px solid color-mix(in srgb,var(--line) 85%, transparent);
      border-radius:0;
      overflow:visible;
    }
    .road-head>div{
      padding:9px 8px;
      font-size:11px;
      font-weight:800;
      text-align:center;
      color:var(--muted);
      border-right:1px solid color-mix(in srgb,var(--line) 60%, transparent);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      background:inherit;
    }
    .road-head>div:last-child{border-right:none}
    .road-head .h-project{
      position:sticky;
      left:0;
      z-index:10;
      text-align:left;
      padding-left:12px;
      color:var(--text);
      background:var(--surface-2);
      box-shadow:1px 0 0 color-mix(in srgb,var(--line) 70%, transparent);
    }

    .road-body{border:0;border-radius:0;overflow:visible}
    .road-row{
      display:grid;
      grid-template-columns:320px minmax(600px,1fr);
      min-height:52px;
      border-bottom:1px solid color-mix(in srgb,var(--line) 58%, transparent);
      background:var(--surface);
    }
    .road-row:last-child{border-bottom:none}

    .road-name{
      position:sticky;
      left:0;
      z-index:6;
      background:var(--surface);
      padding:8px 10px;
      border-right:1px solid color-mix(in srgb,var(--line) 68%, transparent);
      display:grid;
      gap:4px;
      align-content:center;
    }
    .road-name.clickable{cursor:pointer;transition:background-color .14s ease}
    .road-name.clickable:hover{background:color-mix(in srgb,var(--surface-2) 68%, var(--surface))}
    .road-name .title{font-size:12px;font-weight:800;line-height:1.25;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .road-name .meta{display:flex;gap:5px;flex-wrap:wrap;min-width:0}
    .road-name .dates{font-size:10px;color:var(--muted);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2}
    .road-name .mini{font-size:10px;color:var(--muted);line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .road-track{
      position:relative;
      min-height:50px;
      background:
        linear-gradient(to right, color-mix(in srgb,var(--line) 42%, transparent) 1px, transparent 1px);
      background-size:calc(100% / max(1,var(--road-cols,12))) 100%;
      overflow:hidden;
    }
    .road-track .v{position:absolute;top:0;bottom:0;border-left:1px solid color-mix(in srgb,var(--line) 60%, transparent)}
    .road-track .nw{position:absolute;top:0;bottom:0;background:repeating-linear-gradient(135deg,color-mix(in srgb,var(--warn) 10%, transparent),color-mix(in srgb,var(--warn) 10%, transparent) 6px,transparent 6px,transparent 12px);pointer-events:none}

    .bar{
      position:absolute;
      height:20px;
      border-radius:5px;
      font-size:10px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 8px;
      color:#fff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      box-shadow:0 1px 4px rgba(2,8,23,.16);
      cursor:pointer;
      transition:transform .11s ease, filter .11s ease;
    }
    .bar:hover{transform:translateY(-1px);filter:brightness(1.03)}
    .bar .lbl{display:block;width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .bar .lbl.eye-only{display:flex;align-items:center;justify-content:center;overflow:visible}

    .road-empty{
      padding:24px 14px;
      color:var(--muted);
      text-align:center;
      font-weight:700;
      font-size:12px;
    }

    @media (max-width:1280px){
      .road-summary{grid-template-columns:repeat(3,minmax(120px,1fr))}
      .road-head{grid-template-columns:280px repeat(var(--road-cols,12),minmax(36px,1fr))}
      .road-row{grid-template-columns:280px minmax(520px,1fr)}
    }
    @media (max-width:960px){
      .road-summary{grid-template-columns:repeat(2,minmax(120px,1fr))}
      .road-head{grid-template-columns:240px repeat(var(--road-cols,12),minmax(34px,1fr))}
      .road-row{grid-template-columns:240px minmax(460px,1fr)}
    }

      /* === Compactación móvil: Reportes a demanda (Resumen) === */
      @media (max-width: 768px){
        #summaryOverlay .summary-modal{
          width:100% !important;
          max-height:calc(100dvh - 10px) !important;
          border-radius:10px !important;
        }
        #summaryOverlay .m-head{padding:8px 10px !important;}
        #summaryOverlay .m-body{padding:8px !important;}
        #summaryOverlay .m-foot{padding:7px 10px !important;}
        .summary-shell{gap:6px !important;}
        .summary-top{padding:6px !important;gap:6px !important;}
        .summary-title{font-size:12px !important;gap:6px !important;}
        .summary-title i{font-size:11px !important;}
        .summary-sub{font-size:10px !important;line-height:1.2 !important;}
        .summary-top-actions{display:grid !important;grid-template-columns:1fr 1fr !important;gap:6px !important;width:100%;}
        .summary-top-actions .btn{
          width:100% !important;
          min-width:0 !important;
          height:28px !important;
          padding:0 8px !important;
          font-size:11px !important;
        }

        /* Evita "espacios muertos" verticales */
        .summary-grid{
          grid-template-columns:repeat(2,minmax(0,1fr)) !important;
          gap:6px !important;
        }
        .summary-grid > div{
          min-height:auto !important;
          padding:5px !important;
        }
        .summary-grid .label{
          margin-bottom:3px !important;
          font-size:10.5px !important;
          line-height:1.1 !important;
        }
        #summaryOverlay .ctrl{
          height:29px !important;
          font-size:11px !important;
          padding:4px 7px !important;
        }

        .summary-options{padding:6px !important;gap:6px !important;}
        .summary-inline{gap:5px !important;}
        .summary-inline label{
          padding:3px 6px !important;
          font-size:10.5px !important;
          line-height:1.15 !important;
        }

        .summary-kpis{
          grid-template-columns:repeat(2,minmax(0,1fr)) !important;
          gap:6px !important;
        }
        .summary-kpi{padding:6px !important;}
        .summary-kpi .k{font-size:10px !important;}
        .summary-kpi .v{font-size:16px !important;}
        .summary-kpi .s{font-size:10px !important;}

        .summary-output{
          min-height:120px !important;
          max-height:30vh !important;
          padding:7px !important;
          font-size:11px !important;
          line-height:1.3 !important;
        }

        /* Footer más compacto */
        #summaryFooterNote{font-size:10.5px !important;}
        #summaryOverlay .m-foot .right{gap:6px !important;}
        #summaryOverlay .m-foot .right .btn{
          height:29px !important;
          padding:0 9px !important;
          font-size:11px !important;
        }
      }

      @media (max-width: 480px){
        .summary-sub{display:none !important;}
        .summary-grid{grid-template-columns:1fr !important;}
        .summary-kpis{grid-template-columns:1fr 1fr !important;}
        .summary-output{
          min-height:108px !important;
          max-height:27vh !important;
        }
      }

      /* === v13 | Resumen móvil ultra compacto y sin espacios muertos === */
      @media (max-width: 640px){
        #summaryOverlay .summary-modal{
          width:100vw !important;
          max-width:100vw !important;
          max-height:100dvh !important;
          border-radius:0 !important;
        }
        #summaryOverlay .m-head{padding:6px 8px !important;}
        #summaryOverlay .m-body{padding:6px !important;}
        #summaryOverlay .m-foot{padding:6px 8px !important;}
        .summary-shell{gap:6px !important;}
        .summary-top{padding:6px !important;gap:6px !important;border-radius:8px !important;}
        .summary-title{font-size:12px !important;}
        .summary-top-actions{
          display:grid !important;
          grid-template-columns:1fr 1fr !important;
          gap:6px !important;
          width:100% !important;
        }
        .summary-top-actions .btn{
          width:100% !important;
          height:30px !important;
          min-width:0 !important;
          padding:0 8px !important;
          font-size:11px !important;
        }

        .summary-shell > .summary-grid{
          grid-template-columns:repeat(2,minmax(0,1fr)) !important;
          gap:6px !important;
        }
        .summary-shell > .summary-grid > div{
          min-height:auto !important;
          border:none !important;
          background:transparent !important;
          padding:0 !important;
        }
        .summary-shell > .summary-grid .label{
          margin:0 0 2px !important;
          font-size:10px !important;
          line-height:1.1 !important;
          letter-spacing:.25px !important;
        }
        #summaryOverlay .ctrl{
          height:30px !important;
          font-size:11px !important;
          padding:4px 8px !important;
        }

        /* Primer bloque: búsqueda ocupa ancho completo */
        .summary-shell > .summary-grid:nth-child(2) > div:nth-child(6){
          grid-column:1 / -1 !important;
        }
        /* Segundo bloque: salida ocupa ancho completo */
        .summary-shell > .summary-grid:nth-child(3) > div:nth-child(6){
          grid-column:1 / -1 !important;
        }

        .summary-options{
          padding:6px !important;
          gap:5px !important;
          border-radius:8px !important;
        }
        .summary-inline{gap:5px !important;}
        .summary-inline label{
          font-size:10.5px !important;
          padding:3px 6px !important;
        }
        .summary-chip-title{font-size:10px !important;}

        .summary-kpis{
          grid-template-columns:repeat(2,minmax(0,1fr)) !important;
          gap:6px !important;
        }
        .summary-kpi{padding:6px !important;}
        .summary-kpi .k{font-size:9.8px !important;}
        .summary-kpi .v{font-size:15px !important;}
        .summary-kpi .s{font-size:9.8px !important;}

        .summary-output{
          min-height:110px !important;
          max-height:26vh !important;
          padding:7px !important;
          font-size:10.5px !important;
          line-height:1.3 !important;
        }

        #summaryFooterNote{display:none !important;}
        #summaryOverlay .m-foot .right{gap:6px !important;}
        #summaryOverlay .m-foot .right .btn{
          height:30px !important;
          padding:0 9px !important;
          font-size:11px !important;
        }
      }

      @media (max-width: 390px){
        .summary-sub{display:none !important;}
        .summary-title{font-size:11.5px !important;}
      }


      /* === v14 | Resumen móvil ordenado (referencia visual adjunta) === */
      @media (max-width: 640px){
        #summaryOverlay{
          align-items:flex-start !important;
          justify-content:center !important;
          padding:6px 4px !important;
        }
        #summaryOverlay .summary-modal{
          width:calc(100vw - 8px) !important;
          max-width:calc(100vw - 8px) !important;
          max-height:calc(100dvh - 8px) !important;
          border-radius:5px !important;
          overflow:hidden !important;
        }
        #summaryOverlay .m-head{
          padding:8px 10px !important;
          border-bottom:1px solid color-mix(in srgb,var(--line) 85%, transparent) !important;
        }
        #summaryOverlay .m-head b{
          font-size:15px !important;
          font-weight:900 !important;
          letter-spacing:.1px !important;
        }
        #summaryOverlay .m-body{
          padding:6px !important;
          overflow:auto !important;
          -webkit-overflow-scrolling:touch !important;
          overscroll-behavior:contain !important;
        }
        #summaryOverlay .m-foot{
          padding:6px 8px !important;
        }

        .summary-shell{
          gap:6px !important;
        }
        .summary-top{
          grid-template-columns:1fr !important;
          align-items:stretch !important;
          gap:6px !important;
          padding:6px !important;
          border-radius:5px !important;
        }
        .summary-title{
          font-size:11.5px !important;
          gap:6px !important;
          line-height:1.2 !important;
          font-weight:800 !important;
        }
        .summary-title i{font-size:11px !important;}
        .summary-sub{display:none !important;}
        .summary-top-actions{
          display:grid !important;
          grid-template-columns:1fr 1fr !important;
          gap:6px !important;
          width:100% !important;
        }
        .summary-top-actions .btn{
          width:100% !important;
          min-width:0 !important;
          height:34px !important;
          padding:0 8px !important;
          font-size:12px !important;
          font-weight:800 !important;
          border-radius:5px !important;
        }

        .summary-grid{
          grid-template-columns:repeat(2,minmax(0,1fr)) !important;
          gap:6px !important;
        }
        .summary-grid > div{
          border:1px solid color-mix(in srgb,var(--line) 88%, transparent) !important;
          background:var(--surface) !important;
          border-radius:5px !important;
          padding:5px !important;
          min-height:auto !important;
        }
        .summary-grid .label{
          margin:0 0 4px !important;
          font-size:10px !important;
          font-weight:800 !important;
          text-transform:uppercase !important;
          letter-spacing:.35px !important;
          line-height:1 !important;
        }
        #summaryOverlay .ctrl{
          height:34px !important;
          min-height:34px !important;
          padding:6px 8px !important;
          font-size:12px !important;
          border-radius:5px !important;
          width:100% !important;
        }

        /* Distribución exacta en móvil:
           Grid 1 (ámbito..búsqueda) en 2 columnas sin spans forzados */
        .summary-shell > .summary-grid:nth-child(2) > div:nth-child(6){
          grid-column:auto !important;
        }

        /* Grid 2: "Salida" ocupa todo el ancho */
        .summary-shell > .summary-grid:nth-child(3) > div:nth-child(6){
          grid-column:1 / -1 !important;
        }

        /* Bloque SALIDA en 2 columnas */
        .summary-shell > .summary-grid:nth-child(3) > div:nth-child(6) .summary-inline{
          display:grid !important;
          grid-template-columns:1fr 1fr !important;
          gap:6px !important;
          align-items:stretch !important;
        }
        .summary-shell > .summary-grid:nth-child(3) > div:nth-child(6) .summary-inline label{
          width:100% !important;
          min-height:32px !important;
          display:flex !important;
          align-items:center !important;
          justify-content:flex-start !important;
          padding:5px 7px !important;
          border-radius:5px !important;
          font-size:11px !important;
          font-weight:700 !important;
          line-height:1.15 !important;
          margin:0 !important;
        }
        .summary-shell > .summary-grid:nth-child(3) > div:nth-child(6) .summary-inline label:nth-of-type(3){
          grid-column:1 / -1 !important;
        }

        .summary-options{
          border-radius:5px !important;
          padding:6px !important;
          gap:6px !important;
        }
        .summary-options .summary-inline{
          display:grid !important;
          grid-template-columns:1fr 1fr !important;
          gap:6px !important;
          align-items:stretch !important;
        }
        .summary-options .summary-chip-title{
          grid-column:1 / -1 !important;
          margin:0 !important;
          font-size:10px !important;
          font-weight:900 !important;
        }
        .summary-options .summary-inline label{
          width:100% !important;
          min-height:32px !important;
          display:flex !important;
          align-items:center !important;
          justify-content:flex-start !important;
          padding:5px 7px !important;
          border-radius:5px !important;
          font-size:11px !important;
          font-weight:700 !important;
          line-height:1.15 !important;
          margin:0 !important;
        }
        .summary-options .summary-inline label:nth-of-type(3){
          grid-column:1 / -1 !important;
        }

        .summary-kpis{
          grid-template-columns:repeat(2,minmax(0,1fr)) !important;
          gap:6px !important;
        }
        .summary-kpi{
          border-radius:5px !important;
          padding:6px !important;
        }
        .summary-kpi .k{font-size:10px !important;line-height:1.1 !important;}
        .summary-kpi .v{font-size:14px !important;line-height:1 !important;margin-top:2px !important;}
        .summary-kpi .s{font-size:10px !important;line-height:1.1 !important;margin-top:3px !important;}

        .summary-output{
          min-height:108px !important;
          max-height:24vh !important;
          border-radius:5px !important;
          padding:7px !important;
          font-size:10.5px !important;
          line-height:1.3 !important;
        }

        #summaryFooterNote{display:none !important;}
        #summaryOverlay .m-foot .row{
          width:100% !important;
          display:grid !important;
          grid-template-columns:1fr 1fr !important;
          gap:6px !important;
        }
        #summaryOverlay .m-foot .row .btn{
          width:100% !important;
          min-width:0 !important;
          height:32px !important;
          font-size:11.5px !important;
          padding:0 8px !important;
          border-radius:5px !important;
        }
      }

      @media (max-width: 380px){
        #summaryOverlay .summary-modal{
          width:calc(100vw - 6px) !important;
          max-width:calc(100vw - 6px) !important;
          max-height:calc(100dvh - 6px) !important;
        }
        .summary-title{font-size:11px !important;}
      }


/* Ajustes puntuales | Resumen */
#summaryOverlay .m-head{padding:14px 10px !important;}

/* Colores del modal Resumen alineados al modal Notificaciones */
#summaryOverlay .summary-modal{
  border:1px solid var(--line);
  background:var(--surface);
}
#summaryOverlay .m-head{
  background:linear-gradient(180deg, color-mix(in srgb,var(--surface-2) 92%, transparent), var(--surface)) !important;
}
#summaryOverlay .m-body{
  background:var(--surface);
}
#summaryOverlay .m-foot{
  background:linear-gradient(180deg, color-mix(in srgb,var(--surface-2) 92%, transparent), var(--surface));
}

.summary-command{
  background:linear-gradient(180deg, color-mix(in srgb,var(--surface-2) 92%, transparent), var(--surface));
  border-color:var(--line);
}
.summary-panel,
.summary-readable,
.summary-plain-wrap,
.summary-kpi,
.brief-hero,
.brief-score,
.brief-card{
  background:var(--surface);
  border-color:var(--line);
}
.summary-panel summary,
.summary-plain-wrap > summary,
.brief-item,
.brief-next{
  background:linear-gradient(180deg, color-mix(in srgb,var(--surface-2) 92%, transparent), var(--surface));
  border-color:var(--line);
}
.brief-empty{
  background:color-mix(in srgb,var(--surface-2) 70%, transparent);
  border-color:var(--line);
}


.summary-preset-strip{
  position:relative;
  z-index:2;
  overflow-x:auto;
  overflow-y:visible;
  padding-top:1px;
}
.summary-preset,
.summary-reset-inline{
  position:relative;
  z-index:3;
}
.summary-preset:hover,
.summary-preset:active,
.summary-reset-inline:hover,
.summary-reset-inline:active{
  transform:none !important;
}
</style>

  <style id="dark-mode-hardening-v60">
    /* v60 - hardening visual del modo oscuro */
    html[data-theme="dark"] .overlay{
      background: rgba(2,8,23,.62);
    }

    html[data-theme="dark"] .task,
    html[data-theme="dark"] .bar,
    html[data-theme="dark"] .monthcal-shell{
      box-shadow: 0 8px 24px rgba(0,0,0,.26);
    }

    html[data-theme="dark"] .modal{
      box-shadow: 0 20px 52px rgba(0,0,0,.42);
    }

    html[data-theme="dark"] #accessOverlay .modal.login-pro{
      box-shadow:none;
    }

    html[data-theme="dark"] .blocked-slot{
      border-color: color-mix(in srgb, var(--muted) 45%, var(--line));
      border-left-color: color-mix(in srgb, var(--muted) 76%, var(--line));
      background:
        repeating-linear-gradient(
          135deg,
          color-mix(in srgb, var(--muted) 14%, transparent),
          color-mix(in srgb, var(--muted) 14%, transparent) 8px,
          transparent 8px,
          transparent 16px
        );
    }

    html[data-theme="dark"] .blocked-tag{
      color: color-mix(in srgb, var(--text) 72%, var(--muted));
      border-color: color-mix(in srgb, var(--muted) 36%, var(--line));
      background: color-mix(in srgb, var(--surface-2) 85%, var(--surface));
    }

    html[data-theme="dark"] .eq-member-card,
    html[data-theme="dark"] .eq-leader-card,
    html[data-theme="dark"] .eq-group{
      background: color-mix(in srgb, var(--surface) 90%, var(--surface-2));
      border-color: color-mix(in srgb, var(--line) 88%, transparent);
    }

    html[data-theme="dark"] .eq-member-head{
      background: color-mix(in srgb, var(--surface-2) 82%, var(--surface));
      border-bottom-color: color-mix(in srgb, var(--line) 80%, transparent);
    }

    html[data-theme="dark"] .mcal-cell:hover{
      border-color: color-mix(in srgb, var(--primary) 36%, var(--line));
      background: color-mix(in srgb, var(--surface-2) 78%, var(--surface));
    }

    html[data-theme="dark"] .btn.ghost:hover{
      background: color-mix(in srgb, var(--surface-2) 78%, var(--surface));
    }

    html[data-theme="dark"] .kpi{
      background: color-mix(in srgb, var(--surface-2) 72%, var(--surface));
    }
  </style>

  <style id="project-modal-layout-v86">
    /* v86 - Modal Agregar Proyecto más ancho y con mejor encaje visual */
    #projectOverlay .modal{
      width:min(1460px,98.8vw);
      max-height:95vh;
    }

    #projectOverlay .m-head,
    #projectOverlay .m-foot{
      padding:12px 16px;
    }

    #projectOverlay .m-body.project-form{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:12px;
      align-items:start;
      padding:14px 16px 12px;
    }

    #projectOverlay .project-form > .form-section{
      padding:12px;
      background:var(--surface);
    }

    #projectOverlay .project-form > .sec-general{order:1}
    #projectOverlay .project-form > .sec-priority{order:2}
    #projectOverlay .project-form > .sec-dates{order:3}
    #projectOverlay .project-form > .sec-activities{order:4;grid-column:1 / -1}
    #projectOverlay .project-form > .sec-description{order:5;grid-column:1 / -1}

    #projectOverlay .project-form h4{margin:0 0 8px}
    #projectOverlay .project-form .label{margin-bottom:4px}
    #projectOverlay .project-form .ctrl{height:34px}
    #projectOverlay .project-form textarea.ctrl{height:auto;min-height:78px}
    #projectOverlay .project-form .form-textarea{min-height:88px}
    #projectOverlay .project-form .form-notes{min-height:78px}

    #projectOverlay .grid4.form-grid4{
      grid-template-columns:repeat(4,minmax(145px,1fr));
      gap:10px;
    }

    #projectOverlay .project-form .table-wrap{
      max-height:46vh;
      overflow:auto;
    }

    #projectOverlay .project-form table{
      width:100%;
      table-layout:fixed;
    }

    #projectOverlay .project-form th,
    #projectOverlay .project-form td{
      padding:8px 6px;
      font-size:11.5px;
      vertical-align:top;
    }

    #projectOverlay .project-form th{
      font-size:10.5px;
      letter-spacing:.1px;
    }

    #projectOverlay .project-form td .ctrl{
      min-width:0;
      height:32px;
      padding:6px 8px;
      font-size:12px;
    }

    #projectOverlay .project-form td textarea.ctrl{
      min-height:58px;
    }

    #projectOverlay .project-form thead th{position:sticky;top:0;z-index:2}

    #projectOverlay .project-form .section-head{
      margin-bottom:8px;
      padding-bottom:6px;
      border-bottom:1px dashed color-mix(in srgb,var(--line) 75%, transparent);
    }

    @media (max-width:1260px){
      #projectOverlay .modal{width:min(1240px,99vw)}
      #projectOverlay .project-form th,
      #projectOverlay .project-form td{padding:7px 5px}
      #projectOverlay .project-form th{font-size:10px}
      #projectOverlay .project-form td .ctrl{font-size:11.5px}
    }

    @media (max-width:1180px){
      #projectOverlay .m-body.project-form{grid-template-columns:1fr}
      #projectOverlay .project-form > .form-section{grid-column:1 !important}
      #projectOverlay .project-form > .sec-general{order:1}
      #projectOverlay .project-form > .sec-priority{order:2}
      #projectOverlay .project-form > .sec-dates{order:3}
      #projectOverlay .project-form > .sec-activities{order:4}
      #projectOverlay .project-form > .sec-description{order:5}
    }
  </style>


  <style id="mcal-dark-fix-v103">
    /* v103 - Ajustes de contraste para pestaña Mensual en modo oscuro */
    html[data-theme="dark"] .mcal-cell{
      background:color-mix(in srgb,var(--surface) 82%, var(--surface-2));
    }
    html[data-theme="dark"] .mcal-cell-head{
      background:color-mix(in srgb,var(--surface-2) 74%, var(--surface)) !important;
      border:1px solid color-mix(in srgb,var(--line) 86%, transparent);
    }
    html[data-theme="dark"] .mcal-date{
      color:color-mix(in srgb,var(--text) 94%, #fff) !important;
      background:color-mix(in srgb,var(--primary) 24%, var(--surface-2)) !important;
      border-color:color-mix(in srgb,var(--primary) 44%, var(--line)) !important;
    }
    html[data-theme="dark"] .mcal-cell.today .mcal-date{
      color:#fff !important;
      background:color-mix(in srgb,var(--primary) 62%, var(--surface-2)) !important;
      border-color:color-mix(in srgb,var(--primary) 72%, var(--line)) !important;
    }
    html[data-theme="dark"] .mcal-item{
      background:color-mix(in srgb,var(--surface-2) 68%, var(--surface)) !important;
      border-color:color-mix(in srgb,var(--line) 88%, transparent) !important;
    }
    html[data-theme="dark"] .mcal-item:hover{
      background:color-mix(in srgb,var(--surface-2) 86%, var(--surface)) !important;
      border-color:color-mix(in srgb,var(--primary) 38%, var(--line)) !important;
    }
    html[data-theme="dark"] .mcal-empty{
      background:color-mix(in srgb,var(--surface-2) 76%, var(--surface)) !important;
      border-color:color-mix(in srgb,var(--line) 86%, transparent) !important;
      color:color-mix(in srgb,var(--text) 72%, var(--muted)) !important;
    }
    html[data-theme="dark"] .mcal-more{
      background:color-mix(in srgb,var(--primary) 20%, var(--surface-2)) !important;
      border-color:color-mix(in srgb,var(--primary) 44%, var(--line)) !important;
      color:color-mix(in srgb,var(--text) 92%, #fff) !important;
    }
    html[data-theme="dark"] .mcal-off{
      color:color-mix(in srgb,var(--warn) 78%, #fff) !important;
    }
    html[data-theme="dark"] .mcal-dow{
      color:color-mix(in srgb,var(--muted) 72%, var(--text)) !important;
    }

    /* Detalle modal del día mensual */
    html[data-theme="dark"] .month-day-item{
      background:color-mix(in srgb,var(--surface-2) 78%, var(--surface));
      border-color:color-mix(in srgb,var(--line) 90%, transparent);
    }
    html[data-theme="dark"] .month-day-chip,
    html[data-theme="dark"] .month-day-prio-kpi{
      background:color-mix(in srgb,var(--surface-2) 78%, var(--surface));
      border-color:color-mix(in srgb,var(--line) 90%, transparent);
    }
  </style>


  <style id="mcal-dark-fix-v104-titles">
    /* v104 - Corrección de contraste para títulos en Mensual (modo oscuro) */
    .mcal-item,
    .mcal-item .n{
      color:var(--text);
    }
    .month-day-item,
    .month-day-item .title{
      color:var(--text);
    }

    html[data-theme="dark"] .mcal-item,
    html[data-theme="dark"] .mcal-item .n{
      color:color-mix(in srgb,var(--text) 96%, #fff) !important;
    }
    html[data-theme="dark"] .mcal-item .t{
      color:color-mix(in srgb,var(--muted) 68%, var(--text)) !important;
    }
    html[data-theme="dark"] .month-day-item,
    html[data-theme="dark"] .month-day-item .title{
      color:color-mix(in srgb,var(--text) 96%, #fff) !important;
    }
    html[data-theme="dark"] .month-day-item .meta{
      color:color-mix(in srgb,var(--muted) 72%, var(--text)) !important;
    }
  </style>


  <style id="manage-projects-sticky-mobile-v92">
    /* v92 - Proyectos (Configuración) en móvil: primera columna fija */
    @media (max-width:860px){
      #tab_projects .table-wrap{
        overflow:auto;
        -webkit-overflow-scrolling:touch;
      }
      #tab_projects table{
        min-width:900px;
        border-collapse:separate;
        border-spacing:0;
      }
      #tab_projects th:first-child,
      #tab_projects td:first-child{
        position:sticky;
        left:0;
        z-index:3;
        background:var(--surface);
        box-shadow:1px 0 0 color-mix(in srgb, var(--line) 80%, transparent);
        width:140px;
        min-width:140px;
        max-width:140px;
      }
      #tab_projects td:first-child b,
      #tab_projects td:first-child .small{
        display:block;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      #tab_projects thead th:first-child{
        z-index:5;
        background:var(--surface-2);
      }
      #tab_projects #manageProjectSearch{min-width:220px !important; width:min(72vw,280px);}
      #tab_projects #manageProjectSort{min-width:170px !important;}
    }
  </style>


  <style id="access-overlay-hotfix-20260211">
    /* Ajustes puntuales de Acceso */
    #accessOverlay .login-head{
      background:#ffffff;
    }

    #accessOverlay .input-access-row .access-code{
      height:35px;
    }

    @media (max-width:640px){
      #accessOverlay .chart-wrap{
        top:10%;
      }

      #accessOverlay .scene-vignette{
        display:none;
      }
    }
  </style>


<style id="access-overlay-patch-v2">
/* Ajustes solicitados (solo Acceso) */
#accessOverlay .login-title,
#accessOverlay .login.tittle{
  color:#000000;
}

#accessOverlay .login-sub{
  color:#000000;
}

#accessOverlay .input-access-row .login-btn{
  height:35px;
}
</style>

<style id="access-overlay-v3">
/* Ajustes puntuales solicitados (Acceso) */
#accessOverlay .login-logo{
  background: linear-gradient(135deg, #8b0bff, #0d9494);
}

#accessOverlay .access-scene{
  background: none !important;
  background-image: none !important;
}
</style>

</head>
<body>
  <div class="app">
    <div class="panel">
      <div class="top">
        <div class="brand">
          <div class="logo">BIF</div>
          <div>
            <h1 class="title">Proyectos | Capitales &amp; Control de Gestión</h1>
            <div class="subtitle" id="lastUpdate">—</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="btnManage">Administrar</button>
          <button class="btn primary" id="btnAdd">+ Proyecto</button>
          <button class="btn icon" id="btnTheme" title="Tema">☾</button>
          <button class="btn icon" id="btnInfo" title="Notificaciones" aria-label="Notificaciones"><i class="fa-solid fa-bell" aria-hidden="true"></i></button>
          <button class="btn icon" id="btnReload" title="Sincronizar / Recargar" aria-label="Recargar página"><i class="fa-solid fa-rotate-right" aria-hidden="true"></i></button>
        </div>
      </div>

      <div class="controls">
        <div class="row">
          <div class="seg" id="segView">
            <button class="btn tab active" data-view="day">Día</button>
            <button class="btn tab" data-view="week">Semana</button>
            <button class="btn tab" data-view="month">Mensual</button>
            <button class="btn tab" data-view="roadmap">Roadmap</button>
            <button class="btn tab" data-view="availability">Disponibilidad</button>
          </div>
          <button class="btn icon" id="prevBtn">◀</button>
          <input class="ctrl" type="text" id="datePicker" inputmode="numeric" placeholder="dd/mm/aaaa" title="Formato: dd/mm/aaaa" aria-label="Fecha (dd/mm/aaaa)" />
          <button class="btn icon" id="nextBtn">▶</button>
          <button class="btn" id="todayBtn">Hoy</button>
          <div class="row roadmap-tools hidden" id="roadmapZoomWrap">
            <span class="small muted">Zoom</span>
            <div class="seg" id="segRoadmapZoom">
              <button class="btn tab" data-rz="week">Semanal</button>
              <button class="btn tab active" data-rz="month">Mensual</button>
              <button class="btn tab" data-rz="year">Anual</button>
            </div>
          </div>
        </div>
        <div class="row filters">
          <select class="ctrl" id="fOwner"><option value="">Responsable</option></select>
          <select class="ctrl" id="fClient"><option value="">Equipo</option></select>
          <select class="ctrl" id="fStatus"><option value="">Estatus</option></select>
          <select class="ctrl" id="fPriority"><option value="">Prioridad</option></select>
          <input class="ctrl search" id="fSearch" placeholder="Buscar..." />
        </div>
      </div>

      <div class="kpi-band" id="kpiBand"></div>

      <div class="split">
        <div class="box">
          <div class="head">
            <span>Equipo hoy</span>
            <span class="small muted" id="teamTodayLabel"></span>
          </div>
          <div class="body">
            <div class="cards" id="todayCards"></div>
          </div>
        </div>
        <div class="box">
          <div class="head">
            <span>Radar de prioridades</span>
            <span class="small muted">Alta · Media · Baja</span>
          </div>
          <div class="body">
            <div class="prio-grid" id="priorityRadar"></div>
          </div>
        </div>
      </div>

      <div class="main" id="mainView"></div>

      <div class="footer-strip">
        <div>
          <div class="line1">Mercado de Capitales &amp; Control de Gestión de Tesorería</div>
          <div class="line2">mercadodecapitales@banbif.com.pe</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Editor -->
  <div class="overlay" id="projectOverlay">
    <div class="modal">
      <div class="m-head">
        <b id="projectTitle">Proyecto</b>
        <button class="btn" data-close="projectOverlay">✕</button>
      </div>
      <div class="m-body project-form">
        <section class="form-section sec-general">
          <h4>Información general</h4>
          <div class="grid2">
            <div>
              <label class="label">Nombre del proyecto</label>
              <input class="ctrl" id="p_name" placeholder="Ej: Preparación de resultados" />
            </div>
            <div>
              <label class="label">Equipo / Solicitante</label>
              <input class="ctrl" id="p_client" placeholder="Ej: Equipo Riesgos" />
            </div>
          </div>
        </section>

        <section class="form-section sec-dates">
          <h4>Fechas y recurrencia</h4>
          <div class="grid4 form-grid4">
            <div>
              <label class="label">Fecha de solicitud</label>
              <input class="ctrl" type="date" id="p_req" />
            </div>
            <div>
              <label class="label">Inicio base</label>
              <input class="ctrl" type="date" id="p_start" />
            </div>
            <div>
              <label class="label">Fin base</label>
              <input class="ctrl" type="date" id="p_end" />
            </div>
            <div>
              <label class="label">Recurrencia</label>
              <select class="ctrl" id="p_recurrence"></select>
            </div>
          </div>
          <div class="small muted">Se guarda un único proyecto base. Las apariciones se calculan de forma virtual según las fechas.</div>
        </section>

        <section class="form-section sec-priority">
          <h4>Prioridad y responsable</h4>
          <div class="grid4 form-grid4">
            <div>
              <label class="label">Estatus (automático)</label>
              <select class="ctrl" id="p_status"></select>
            </div>
            <div>
              <label class="label">Prioridad</label>
              <select class="ctrl" id="p_priority"></select>
            </div>
            <div>
              <label class="label">Líder / Responsable</label>
              <select class="ctrl" id="p_leader"></select>
            </div>
            <div>
              <label class="label">Importancia (1-5)</label>
              <input class="ctrl" id="p_importance" type="number" min="1" max="5" step="1" />
            </div>
          </div>
        </section>

        <section class="form-section sec-description">
          <h4>Descripción</h4>
          <div class="grid2">
            <div>
              <label class="label">Objetivo estratégico</label>
              <textarea class="ctrl form-textarea" id="p_objective"></textarea>
            </div>
            <div>
              <label class="label">Alcance / Entregable</label>
              <textarea class="ctrl form-textarea" id="p_deliverable"></textarea>
            </div>
          </div>
          <div style="margin-top:10px">
            <label class="label">Dependencias, riesgos y notas</label>
            <textarea class="ctrl form-notes" id="p_notes"></textarea>
          </div>
        </section>

        <section class="form-section sec-activities">
          <div class="section-head">
            <h4>Actividades</h4>
            <button class="btn" id="btnAddAct">+ Agregar actividad</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:18%">Actividad</th>
                  <th style="width:20%">Detalle</th>
                  <th style="width:10%">Inicio</th>
                  <th style="width:10%">Fin</th>
                  <th style="width:10%">Hora inicio</th>
                  <th style="width:10%">Hora fin</th>
                  <th style="width:12%">Responsable</th>
                  <th style="width:6%">Finalizado</th>
                  <th style="width:6%">Foco principal</th>
                  <th style="width:10%">Estatus</th>
                  <th style="width:4%"></th>
                </tr>
              </thead>
              <tbody id="activityBody"></tbody>
            </table>
          </div>
        </section>
      </div>
      <div class="m-foot">
        <button class="btn danger" id="btnDeleteProject">Eliminar</button>
        <div class="right">
          <button class="btn" data-close="projectOverlay">Cancelar</button>
          <button class="btn primary" id="btnSaveProject">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Modal -->
  <div class="overlay" id="manageOverlay">
    <div class="modal">
      <div class="m-head">
        <b>Administrar</b>
        <button class="btn" data-close="manageOverlay">✕</button>
      </div>
      <div class="m-body">
        <div class="tabs manage-tabs" id="manageTabs">
          <button class="btn tab active" data-tab="projects">Proyectos</button>
          <button class="btn tab" data-tab="team">Equipo y Bloqueos</button>
          <button class="btn tab" data-tab="holidays">Feriados</button>
          <button class="btn tab" data-tab="notifications">Notificaciones</button>
          <button class="btn tab" data-tab="data">Datos</button>
        </div>

        <div id="tab_projects"></div>
        <div id="tab_team" class="hidden"></div>
        <div id="tab_holidays" class="hidden"></div>
        <div id="tab_notifications" class="hidden"></div>
        <div id="tab_data" class="hidden"></div>
      </div>
      <div class="m-foot">
        <span class="small muted">Guardado automático</span>
        <button class="btn" data-close="manageOverlay">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Detail Modal (read mode) -->
  <div class="overlay" id="detailOverlay">
    <div class="modal">
      <div class="m-head">
        <b>Detalle del proyecto</b>
        <button class="btn" data-close="detailOverlay">✕</button>
      </div>
      <div class="m-body" id="detailBody"></div>
      <div class="m-foot">
        <span class="small muted">Vista de solo lectura</span>
        <button class="btn" data-close="detailOverlay">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Team Modal -->
  <div class="overlay" id="teamOverlay">
    <div class="modal eq-modal">
      <div class="m-head">
        <b>Equipo</b>
        <button class="btn" data-close="teamOverlay">✕</button>
      </div>
      <div class="m-body">
        <div id="teamMatrix"></div>
      </div>
      <div class="m-foot">
        <span class="small muted">Vista organizacional manual</span>
        <button class="btn" data-close="teamOverlay">Cerrar</button>
      </div>
    </div>
  </div>


  <!-- Info Modal -->
  <div class="overlay" id="infoOverlay">
    <div class="modal info-modal">
      <div class="m-head">
        <b><i class="fa-solid fa-bell" aria-hidden="true"></i> Notificaciones</b>
        <button class="btn" data-close="infoOverlay">✕</button>
      </div>
      <div class="m-body info-body" id="infoBody"></div>
      <div class="m-foot">
        <span class="small muted" id="infoFooterNote">Centro de recordatorios</span>
        <button class="btn" data-close="infoOverlay">Cerrar</button>
      </div>
    </div>
  </div>



  <!-- Resumen / Reportes a demanda -->
  <div class="overlay" id="summaryOverlay">
    <div class="modal summary-modal">
      <div class="m-head">
        <b><i class="fa-solid fa-chart-line" aria-hidden="true"></i> Reportes a demanda</b>
      </div>
      <div class="m-body" id="summaryBody"></div>
      <div class="m-foot">
        <div class="small muted" id="summaryFooterNote">Configura filtros y el reporte se actualiza automáticamente.</div>
        <div class="row" style="gap:8px">
          <button class="btn primary" id="btnSummaryCopy"><i class="fa-regular fa-copy" aria-hidden="true"></i> Copiar reporte</button>
          <button class="btn" data-close="summaryOverlay">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Impact Modal (auto-replan confirmation) -->
  <div class="overlay" id="impactOverlay">
    <div class="modal">
      <div class="m-head">
        <b>Impacto de reprogramación automática</b>
        <button class="btn" id="impactCloseBtn">✕</button>
      </div>
      <div class="m-body">
        <div id="impactSummary" class="impact-summary"></div>
        <div id="impactWarnings" class="impact-warnings"></div>
        <div class="table-wrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="width:26%">Actividad impactada</th>
                <th style="width:14%">Responsable</th>
                <th style="width:18%">Antes</th>
                <th style="width:18%">Después</th>
                <th style="width:14%">Cambio</th>
                <th style="width:10%">Motivo</th>
              </tr>
            </thead>
            <tbody id="impactTableBody"></tbody>
          </table>
        </div>
      </div>
      <div class="m-foot">
        <span class="small muted">Revisa el impacto antes de aplicar.</span>
        <div class="right">
          <button class="btn" id="impactCancelBtn">Cancelar</button>
          <button class="btn primary" id="impactAcceptBtn">Aceptar y recalcular</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
(() => {
  'use strict';

  const STORAGE_KEY = 'BANBIF_WORKLOAD_V9_UX_SECURE';
  const LEGACY_KEYS = [
    'BANBIF_WORKLOAD_V8_UX',
    'BANBIF_WORKLOAD_V7_CLEAN',
    'banbif_workload_v5',
    'banbif_workload_v1'
  ];
  const THEME_KEY = 'BANBIF_WORKLOAD_THEME_V8';
  const HOLIDAYS_KEY = 'BANBIF_WORKLOAD_HOLIDAYS_V1';
  const IMPORT_ROLLBACK_KEY = 'BANBIF_WORKLOAD_IMPORT_ROLLBACK_V1';
  const HOLIDAYS_SCHEMA_VERSION = 1;
  const APP_LOCALE = 'es-PE';
  const REMOTE_JSON_URL = './data/banbif_workload.latest.json';
  const REMOTE_SYNC_META_KEY = 'BANBIF_WORKLOAD_REMOTE_SYNC_META_V1';

  const AUTO_STATUSES = ['Programado','En curso','Demorado','Finalizado'];
  const PRIORITIES = ['Alta','Media','Baja'];
  const RECURRENCE_FREQUENCIES = ['Ninguna','Diaria','Mensual','Trimestral','Anual'];
  const BLOCK_TYPES = ['Almuerzo','Vacaciones','Permiso','Capacitación','Trayecto','Otro'];
  const NOTIF_ALL_USERS = '__all__';

  const DEFAULT_STATE = {
    settings: {
      defaultStartHour: 8,
      defaultEndHour: 19,
      defaultCapacityHoursPerDay: 8,
      workdays: [1,2,3,4,5]
    },
    team: [
      { id:'u1', name:'Tú', startHour:8, endHour:19, capacityHoursPerDay:8, blocks:[
        { id:'b_u1_lunch', type:'Almuerzo', startDate:'2026-01-01', endDate:'2027-12-31', allDay:false, startHour:'13:00', endHour:'14:00' }
      ] },
      { id:'u2', name:'Compañero 1', startHour:8, endHour:19, capacityHoursPerDay:8, blocks:[
        { id:'b_u2_lunch', type:'Almuerzo', startDate:'2026-01-01', endDate:'2027-12-31', allDay:false, startHour:'13:00', endHour:'14:00' }
      ] },
      { id:'u3', name:'Compañero 2', startHour:8, endHour:19, capacityHoursPerDay:8, blocks:[
        { id:'b_u3_lunch', type:'Almuerzo', startDate:'2026-01-01', endDate:'2027-12-31', allDay:false, startHour:'13:00', endHour:'14:00' }
      ] }
    ],
    teamBoard: {
      leader: { name:'Líder del equipo', role:'Líder de operaciones' },
      members: [
        { id:'tm1', name:'Analista 1', role:'Analista Sr', area:'Middle Office', responsibilities:['Seguimiento operativo','Control de líneas'] },
        { id:'tm2', name:'Analista 2', role:'Especialista', area:'Back Office', responsibilities:['Conciliaciones','Reportes regulatorios'] }
      ]
    },
    projects: [
      {
        id:'p_demo_1',
        name:'Covenants Trimestrales',
        client:'Riesgos',
        reqDate:'2026-02-01',
        startDate:'2026-02-02',
        endDate:'2026-02-06',
        priority:'Alta',
        leaderId:'u1',
        importance:5,
        recurrenceFrequency:'Trimestral',
        activities:[
          { id:'a1', name:'Consolidar fuentes', startDate:'2026-02-02', endDate:'2026-02-03', startHour:'15:00', endHour:'18:00', ownerId:'u2', done:false },
          { id:'a2', name:'Cruce de covenants', startDate:'2026-02-04', endDate:'2026-02-05', startHour:'15:00', endHour:'18:00', ownerId:'u1', done:false },
          { id:'a3', name:'Validación y envío', startDate:'2026-02-06', endDate:'2026-02-06', startHour:'16:00', endHour:'18:00', ownerId:'u3', done:false }
        ]
      },
      {
        id:'p_demo_2',
        name:'Preparación de Resultados',
        client:'Tesorería',
        reqDate:'2026-02-05',
        startDate:'2026-02-10',
        endDate:'2026-02-18',
        priority:'Alta',
        leaderId:'u1',
        importance:5,
        recurrenceFrequency:'Mensual',
        activities:[
          { id:'a4', name:'Extraer data y cuadre', startDate:'2026-02-10', endDate:'2026-02-12', startHour:'11:00', endHour:'14:00', ownerId:'u1', done:false },
          { id:'a5', name:'Comentarios de gestión', startDate:'2026-02-13', endDate:'2026-02-16', startHour:'11:00', endHour:'14:00', ownerId:'u2', done:false },
          { id:'a6', name:'Deck final', startDate:'2026-02-17', endDate:'2026-02-18', startHour:'11:00', endHour:'14:00', ownerId:'u3', done:false }
        ]
      },
      {
        id:'p_demo_3',
        name:'Proyectos Internos / Demanda',
        client:'Interno',
        reqDate:'2026-02-01',
        startDate:'2026-02-01',
        endDate:'2026-12-31',
        priority:'Media',
        leaderId:'u2',
        importance:3,
        recurrenceFrequency:'Ninguna',
        activities:[
          { id:'a7', name:'Automatización diaria', startDate:'2026-02-01', endDate:'2026-12-31', startHour:'16:00', endHour:'18:00', ownerId:'u1', done:false },
          { id:'a8', name:'Mejoras dashboard', startDate:'2026-02-01', endDate:'2026-12-31', startHour:'16:00', endHour:'18:00', ownerId:'u2', done:false }
        ]
      }
    ],
    notifications: []
  };

  const DEFAULT_HOLIDAYS_STATE = {
    version: HOLIDAYS_SCHEMA_VERSION,
    items: []
  };

  const ui = {
    role: null, // 'read' | 'admin'
    view: 'day',
    date: toISO(new Date()),
    editingProjectId: null,
    manageTab: 'projects',
    manageProjectSort: 'priority_desc',
    manageProjectSearch: '',
    manageNotifUser: '',
    manageNotifQ: '',
    manageNotifShowDone: true,
    infoNotifUser: '',
    infoNotifQ: '',
    infoNotifShowDone: false,
    summaryScope: 'team',
    summaryUser: '',
    summaryRange: 'week',
    summaryFrom: toISO(new Date()),
    summaryTo: toISO(new Date()),
    summaryGroupBy: 'owner',
    summarySortBy: 'date',
    summaryClient: '',
    summaryPriority: '',
    summaryStatus: '',
    summaryQuery: '',
    summaryIncludeActivities: true,
    summaryIncludeProjects: true,
    summaryIncludeNotifications: true,
    summaryIncludeDoneActivities: false,
    summaryIncludeDoneNotifications: false,
    summaryOnlyDueNotifications: false,
    summaryFiltersOpen: false,
    roadmapZoom: 'month',
    filters: { owner:'', client:'', status:'', priority:'', q:'' },
    lastAdjustedBusinessDates: 0,
    teamWeekOffset: 0,
    editorPrimaryFocus: false
  };

  const $ = (id) => document.getElementById(id);
  const esc = (s) => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const rid = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;

  const _loadedState = loadState();
  let holidaysState = sanitizeHolidayStore(loadHolidays(_loadedState));
  let state = sanitizeState(_loadedState);
  let impactDecisionResolver = null;

  function init(){
    injectRuntimeStyles();
    let themePref = 'light';
    try{ themePref = localStorage.getItem(THEME_KEY) || 'light'; }catch(_e){}
    applyTheme(themePref);
    bindEvents();
    openAccessGate();
  }

  function injectRuntimeStyles(){
    const style = document.createElement('style');
    style.textContent = `
      .mode-pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:800;border-radius:999px;padding:7px 10px;border:1px solid var(--line);background:var(--chip)}
      .mode-pill.read{background:#374353;color:#eaf0f8;border-color:#374353;font-weight:500;}
      .mode-pill.admin{color:var(--ok);border-color:color-mix(in srgb, var(--ok) 35%, var(--line));font-weight:500;}
      #btnCopyDaySummary{white-space:nowrap}
      .blocked-slot{position:absolute;left:0;right:0;border:1px dashed color-mix(in srgb, #64748b 52%, var(--line));background:repeating-linear-gradient(135deg,color-mix(in srgb, #94a3b8 18%, transparent),color-mix(in srgb, #94a3b8 18%, transparent) 8px,transparent 8px,transparent 16px);border-left:4px solid #64748b;border-radius:5px;z-index:2;pointer-events:none;display:flex;align-items:flex-start;overflow:hidden}
      .blocked-name{display:inline-flex;align-items:center;margin:6px 0 0 6px;padding:2px 6px;border-radius:999px;font-size:10px;font-weight:700;color:#334155;background:color-mix(in srgb, #e2e8f0 78%, var(--surface));border:1px solid color-mix(in srgb, #64748b 35%, var(--line));line-height:1.1}
      html[data-theme="dark"] .blocked-name{color:#dbe7f7;background:rgba(55,67,83,.45);border-color:rgba(148,163,184,.45)}
      .blocked-name.is-unavailable{border-radius:5px}
      html[data-theme="dark"] .blocked-name.is-unavailable{border-radius:5px}
      .blocked-tag{font-size:10px;font-weight:700;color:#475569;padding:2px 5px;border-radius:999px;border:1px solid color-mix(in srgb, #64748b 35%, var(--line));background:color-mix(in srgb, #e2e8f0 70%, var(--surface))}
      .status-badge{font-size:10px;font-weight:800;padding:2px 6px;border-radius:999px;border:1px solid var(--line);display:inline-flex;align-items:center;gap:4px}
      .status-Programado{color:var(--muted)}
      .status-En_curso{color:var(--primary)}
      .status-Demorado{color:var(--danger);border-color:color-mix(in srgb, var(--danger) 40%, var(--line));}
      .status-Finalizado{color:var(--ok);border-color:color-mix(in srgb, var(--ok) 40%, var(--line));}
      .status-Ajustar_fecha{color:var(--warn);border-color:color-mix(in srgb, var(--warn) 40%, var(--line));}
      .access-wrap{width:min(420px,94vw)}
      .access-row{display:flex;gap:8px;align-items:center}
      .access-code{letter-spacing:4px;text-align:center;font-weight:700}
      .readonly-lock{opacity:.62;pointer-events:none;filter:grayscale(.12)}
      .mini-help{font-size:11px;color:var(--muted);margin-top:8px}
      .dim{opacity:.75}
      #impactOverlay{z-index:96}
      #impactOverlay .modal{width:min(1120px,96vw)}
      .impact-summary{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:8px}
      .impact-kpi{border:1px solid var(--line);border-radius:10px;background:var(--surface-2);padding:8px 9px}
      .impact-kpi .k{font-size:11px;color:var(--muted);font-weight:800;text-transform:uppercase}
      .impact-kpi .v{font-size:20px;font-weight:900;letter-spacing:-.2px;margin-top:3px}
      .impact-kpi .s{font-size:11px;color:var(--muted);margin-top:2px}
      .impact-warnings{display:grid;gap:6px;margin-top:10px}
      .impact-warn{font-size:12px;border:1px solid color-mix(in srgb,var(--warn) 38%, var(--line));background:color-mix(in srgb,var(--warn) 10%, transparent);padding:8px 10px;border-radius:10px}
      .delta-chip{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:800;padding:3px 8px;border-radius:999px;border:1px solid var(--line)}
      .delta-chip.pos{color:var(--danger);border-color:color-mix(in srgb,var(--danger) 42%, var(--line))}
      .delta-chip.zero{color:var(--ok);border-color:color-mix(in srgb,var(--ok) 42%, var(--line))}

      /* Día: tarjetas robustas y legibles */
      .day-grid{grid-template-columns:60px repeat(var(--team-count), minmax(240px,1fr));}
      .grid-head{padding:12px 10px}
      .owner-head .sub{font-size:11px}
      .day-col{background-image:linear-gradient(to bottom, color-mix(in srgb,var(--line) 58%, transparent) 1px, transparent 1px);background-size:100% var(--hour-h)}
      .task{
        --task-bg: var(--surface);
        --task-head-bg: color-mix(in srgb, var(--surface-2) 90%, transparent);
        --task-border: var(--line);
        border-radius:0;
        border:1px solid color-mix(in srgb, var(--task-border) 52%, var(--line));
        border-left-width:5px;
        background:var(--task-bg);
        box-shadow:0 4px 16px rgba(2,8,23,.10);
        overflow:hidden;
      }
      .task .h{
        padding:6px 9px;
        font-size:10px;
        letter-spacing:.15px;
        background:var(--task-head-bg);
        line-height:1.25;
        white-space:normal;
        overflow:visible;
        text-overflow:clip;
      }
      .task .b{padding:7px 9px 8px;display:flex;flex-direction:column;gap:5px}
      .task .n{font-size:12px;font-weight:600;line-height:1.3;margin:0;white-space:normal;word-break:break-word}
      .task .top-tags{display:flex;flex-wrap:wrap;gap:5px;align-items:center;justify-content:flex-start}
      .task .tag{
        display:inline-flex;align-items:center;gap:4px;
        padding:2px 7px;border-radius:999px;font-size:10px;font-weight:700;
        border:1px solid var(--line);background:var(--surface-2);color:var(--muted);
      }
      .task .meta-grid{
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        gap:7px 10px;
        align-items:start;
      }
      .task .fact{
        min-width:0;
        display:flex;
        flex-direction:column;
        gap:2px;
        padding:4px 6px;
        border-radius:8px;
        background:color-mix(in srgb, var(--surface-2) 74%, transparent);
        border:1px solid color-mix(in srgb, var(--line) 68%, transparent);
      }
      .task .fact .k,.task .detail .k{
        font-size:9px;
        font-weight:800;
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:.2px;
        line-height:1.2;
      }
      .task .fact .v,.task .detail .v{
        font-size:11px;
        font-weight:700;
        line-height:1.25;
        color:var(--text);
        white-space:normal;
        word-break:break-word;
      }
      .task .detail{
        margin-top:1px;
        display:flex;
        flex-direction:column;
        gap:2px;
        padding:4px 6px;
        border-radius:8px;
        background:color-mix(in srgb, var(--surface-2) 72%, transparent);
        border:1px solid color-mix(in srgb, var(--line) 68%, transparent);
      }
      .task .meta-inline{
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        gap:7px 8px;
        align-items:start;
      }
      .task .meta-chip{
        min-width:0;
        display:flex;
        flex-direction:column;
        gap:2px;
        padding:4px 6px;
        border-radius:8px;
        background:color-mix(in srgb, var(--surface-2) 70%, transparent);
        border:1px solid color-mix(in srgb, var(--line) 65%, transparent);
      }
      .task .detail.compact{margin-top:0}

      .task.priority-Alta .tag.prio{color:var(--danger);border-color:color-mix(in srgb,var(--danger) 38%, var(--line))}
      .task.priority-Media .tag.prio{color:var(--warn);border-color:color-mix(in srgb,var(--warn) 40%, var(--line))}
      .task.tone-0{--task-bg:color-mix(in srgb,#2563eb 12%, var(--surface));--task-head-bg:color-mix(in srgb,#2563eb 20%, var(--surface-2));--task-border:#2563eb}
      .task.tone-1{--task-bg:color-mix(in srgb,#7c3aed 12%, var(--surface));--task-head-bg:color-mix(in srgb,#7c3aed 20%, var(--surface-2));--task-border:#7c3aed}
      .task.tone-2{--task-bg:color-mix(in srgb,#0891b2 12%, var(--surface));--task-head-bg:color-mix(in srgb,#0891b2 20%, var(--surface-2));--task-border:#0891b2}
      .task.tone-3{--task-bg:color-mix(in srgb,#0f766e 12%, var(--surface));--task-head-bg:color-mix(in srgb,#0f766e 20%, var(--surface-2));--task-border:#0f766e}
      .task.tone-4{--task-bg:color-mix(in srgb,#4f46e5 12%, var(--surface));--task-head-bg:color-mix(in srgb,#4f46e5 20%, var(--surface-2));--task-border:#4f46e5}
      .task.tone-5{--task-bg:color-mix(in srgb,#c2410c 12%, var(--surface));--task-head-bg:color-mix(in srgb,#c2410c 20%, var(--surface-2));--task-border:#c2410c}
      .task.tone-6{--task-bg:color-mix(in srgb,#b91c1c 12%, var(--surface));--task-head-bg:color-mix(in srgb,#b91c1c 20%, var(--surface-2));--task-border:#b91c1c}
      .task.tone-7{--task-bg:color-mix(in srgb,#9333ea 12%, var(--surface));--task-head-bg:color-mix(in srgb,#9333ea 20%, var(--surface-2));--task-border:#9333ea}

      /* Ajuste visual final: mejor encaje y prioridad más distinguible */
      .task{border-left-color:var(--task-border);background:linear-gradient(180deg,var(--task-bg),color-mix(in srgb,var(--task-bg) 90%, var(--surface)))}
      .task.priority-Alta{--task-bg:color-mix(in srgb,#dc2626 15%, var(--surface));--task-head-bg:color-mix(in srgb,#dc2626 26%, var(--surface-2));--task-border:#dc2626}
      .task.priority-Media{--task-bg:color-mix(in srgb,#d97706 15%, var(--surface));--task-head-bg:color-mix(in srgb,#d97706 26%, var(--surface-2));--task-border:#d97706}
      .task.priority-Baja{--task-bg:color-mix(in srgb,#16a34a 14%, var(--surface));--task-head-bg:color-mix(in srgb,#16a34a 24%, var(--surface-2));--task-border:#16a34a}
      .task.priority-Alta .h{color:color-mix(in srgb,#7f1d1d 86%, var(--text))}
      .task.priority-Media .h{color:color-mix(in srgb,#7c2d12 86%, var(--text))}
      .task.priority-Baja .h{color:color-mix(in srgb,#14532d 86%, var(--text))}

      .day-col .blocked-slot{opacity:.9}

      .day-col .task{left:calc(0%) !important;width:calc(100%) !important;border-radius:5px !important;}
      .day-col .task .n{font-weight:600 !important;}
      .day-col .blocked-slot{border-radius:5px !important;}

      /* Roadmap v95: tabla de proyectos + bloque sólido + líneas de actividades */
      #segRoadmapZoom{border-radius:5px !important;padding:3px}
      #segRoadmapZoom .btn{border-radius:5px !important;padding:6px 10px}

      .roadmap{padding:10px;display:grid;gap:8px}
      .road-summary{grid-template-columns:repeat(5,minmax(112px,1fr));gap:6px}
      .road-kpi{padding:6px 8px}
      .road-kpi .k{font-size:9px}
      .road-kpi .v{font-size:13px}
      .road-kpi .v.small{font-size:11px}

      .road-legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:11px;color:var(--muted)}
      .road-legend span{display:inline-flex;align-items:center;gap:6px}
      .road-legend .dot{width:10px;height:10px;border-radius:3px;border:1px solid var(--line);display:inline-block}
      .road-legend .dot.alta{background:color-mix(in srgb,var(--danger) 30%, transparent);border-color:color-mix(in srgb,var(--danger) 54%, var(--line))}
      .road-legend .dot.media{background:color-mix(in srgb,var(--warn) 34%, transparent);border-color:color-mix(in srgb,var(--warn) 56%, var(--line))}
      .road-legend .dot.baja{background:color-mix(in srgb,var(--ok) 30%, transparent);border-color:color-mix(in srgb,var(--ok) 54%, var(--line))}
      .road-legend .dot.act{background:color-mix(in srgb,var(--primary) 24%, transparent);border-color:color-mix(in srgb,var(--primary) 44%, var(--line))}

      .road-table-wrap{
        border:1px solid color-mix(in srgb,var(--line) 86%, transparent);
        border-radius:5px;
        background:var(--surface);
        overflow:auto;
        max-height:70vh;
        min-height:240px;
        contain:content;
      }

      .road-head{
        position:sticky;
        top:0;
        z-index:8;
        display:grid;
        grid-template-columns:300px repeat(var(--road-cols,12),minmax(64px,1fr));
        width:max-content;
        min-width:100%;
        border-radius:0;
        background:var(--surface-2);
        border-bottom:1px solid color-mix(in srgb,var(--line) 72%, transparent);
      }
      .road-head>div{
        padding:7px 6px;
        font-size:10px;
        font-weight:800;
        border-right:1px solid color-mix(in srgb,var(--line) 58%, transparent);
        text-align:center;
        color:var(--muted);
        min-width:0;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .road-head>div:last-child{border-right:none}
      .road-head>div:first-child{text-align:left;padding-left:11px;color:var(--text)}
      .road-head .h-project{position:sticky;left:0;z-index:10;background:var(--surface-2)}
      .road-head .h-tick{text-transform:uppercase;letter-spacing:.2px}

      .road-body{content-visibility:auto;contain-intrinsic-size:700px 420px}

      .road-row{
        display:grid;
        grid-template-columns:300px minmax(760px,1fr);
        width:max-content;
        min-width:100%;
        border-bottom:1px solid color-mix(in srgb,var(--line) 56%, transparent);
      }
      .road-row:last-child{border-bottom:none}

      .road-name{
        padding:8px 10px;
        border-right:1px solid color-mix(in srgb,var(--line) 65%, transparent);
        display:grid;
        gap:5px;
        align-content:start;
        position:sticky;
        left:0;
        z-index:6;
        background:var(--surface);
      }
      .road-name.clickable{cursor:pointer;transition:background-color .14s ease}
      .road-name.clickable:hover{background:color-mix(in srgb,var(--surface-2) 66%, transparent)}

      .road-proj-title{font-size:11px;font-weight:800;line-height:1.22;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .road-proj-meta{display:flex;gap:4px;flex-wrap:wrap;align-items:center}
      .road-proj-meta .tag,.road-proj-meta .status-badge{font-size:10px;line-height:1.1}

      .road-act-labels{display:grid;gap:4px;margin-top:1px}
      .road-act-label{
        height:12px;
        line-height:12px;
        font-size:10px;
        color:var(--muted);
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }

      .road-track-solid{
        position:relative;
        padding:8px 10px;
        display:grid;
        gap:4px;
        align-content:start;
        background:
          linear-gradient(to right, color-mix(in srgb,var(--line) 42%, transparent) 1px, transparent 1px);
        background-size:calc(100% / max(1,var(--road-cols,12))) 100%;
      }
      .road-lane{position:relative;height:12px}
      .road-lane.project{height:18px;margin-bottom:2px}

      .road-solid,
      .road-act-seg{
        position:absolute;
        left:0;
        width:0;
        max-width:100%;
      }

      .road-solid{
        top:2px;
        height:14px;
        border-radius:5px;
        border:1px solid transparent;
        box-shadow:0 1px 4px rgba(2,8,23,.14);
      }
      .road-solid.pri-alta{
        background:linear-gradient(180deg,color-mix(in srgb,var(--danger) 36%, var(--surface)),color-mix(in srgb,var(--danger) 26%, var(--surface)));
        border-color:color-mix(in srgb,var(--danger) 60%, var(--line));
      }
      .road-solid.pri-media{
        background:linear-gradient(180deg,color-mix(in srgb,var(--warn) 38%, var(--surface)),color-mix(in srgb,var(--warn) 28%, var(--surface)));
        border-color:color-mix(in srgb,var(--warn) 60%, var(--line));
      }
      .road-solid.pri-baja{
        background:linear-gradient(180deg,color-mix(in srgb,var(--ok) 35%, var(--surface)),color-mix(in srgb,var(--ok) 24%, var(--surface)));
        border-color:color-mix(in srgb,var(--ok) 58%, var(--line));
      }

      .road-act-seg{
        top:5px;
        height:2px;
        border-radius:999px;
        background:color-mix(in srgb,var(--primary) 65%, var(--text));
      }

      .road-empty{padding:22px 12px;color:var(--muted);text-align:center;font-size:12px;font-weight:700}


      .road-row.out-window .road-name{opacity:.78}
      .road-row.out-window .road-track-solid{opacity:.55}
      
.road-load-wrap{
        display:grid;
        grid-template-columns:300px repeat(var(--road-cols,12),minmax(64px,1fr));
        width:max-content;
        min-width:100%;
        border-bottom:1px solid color-mix(in srgb,var(--line) 72%, transparent);
        background:var(--surface-2);
      }
      .road-load-title{
        padding:7px 11px;
        font-size:10px;
        font-weight:800;
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:.2px;
        border-right:1px solid color-mix(in srgb,var(--line) 58%, transparent);
        position:sticky;
        left:0;
        z-index:9;
        background:var(--surface-2);
        white-space:nowrap;
      }
      .road-load-grid{
        display:contents;
      }
      .road-heat-cell{
        position:relative;
        min-height:31px;
        border-right:1px solid color-mix(in srgb,var(--line) 58%, transparent);
        overflow:hidden;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .road-heat-cell:last-child{
        border-right:none;
      }
      .road-heat-cell>span{
        position:absolute;
        inset:0;
        background:color-mix(in srgb,var(--primary) 68%, var(--surface));
        opacity:.18;
      }
      .road-heat-cell>b{
        position:relative;
        z-index:1;
        font-size:10px;
        color:var(--text);
      }


      @media (max-width:1280px){
        .road-summary{grid-template-columns:repeat(3,minmax(100px,1fr))}
        .road-head{grid-template-columns:260px repeat(var(--road-cols,12),minmax(58px,1fr))}
        .road-row{grid-template-columns:260px minmax(640px,1fr)}
      }
      @media (max-width:960px){
        .road-summary{grid-template-columns:repeat(2,minmax(100px,1fr))}
        .road-head{grid-template-columns:220px repeat(var(--road-cols,12),minmax(54px,1fr))}
        .road-row{grid-template-columns:220px minmax(560px,1fr)}
        .road-proj-meta{display:none}
      }
      /* Administrar > Feriados */
      .holiday-form{display:grid;grid-template-columns:180px 1fr 160px auto auto;gap:8px;align-items:end}
      .holiday-row-actions{display:flex;gap:6px;justify-content:flex-end}
      .holiday-name{font-weight:700}
      .holiday-pill{display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;font-size:11px;font-weight:700;border:1px solid var(--line)}
      .holiday-pill.on{color:var(--ok);border-color:color-mix(in srgb,var(--ok) 45%, var(--line))}
      .holiday-pill.off{color:var(--muted)}
      .manage-tabs .tab{white-space:nowrap}

      @media (max-width:1200px){
        .holiday-form{grid-template-columns:1fr 1fr;align-items:stretch}
        .holiday-form .col-span-2{grid-column:span 2}
      }
      @media (max-width:1100px){
        .notif-form{grid-template-columns:1fr 1fr}
        .notif-form button{grid-column:span 2}
      }
      @media (max-width:760px){
        .notif-top{padding:10px}
        .notif-stats{width:100%}
        .notif-stat{flex:1 1 30%}
        .notif-controls{width:100%}
        .notif-controls .ctrl{min-width:100%}
        .notif-form{grid-template-columns:1fr}
        .notif-form button{grid-column:auto}
      }
      /* v22: Tarjetas más compactas y funcionales (día) */
      .day-grid{grid-template-columns:60px repeat(var(--team-count), minmax(210px,1fr));}
      .task{border-radius:5px;box-shadow:0 2px 7px rgba(2,8,23,.10)}
      .task .h{
        padding:4px 7px;
        font-size:10px;
        line-height:1.2;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:6px;
      }
      .task .project-title{
        min-width:0;
        font-weight:800;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .task .header-tags{
        display:flex;
        align-items:center;
        justify-content:flex-end;
        gap:4px;
        flex-wrap:nowrap;
        min-width:0;
      }
      .task .b{padding:5px 7px 6px;display:flex;flex-direction:column;gap:4px}
      .task .n{margin:0;font-size:11px;font-weight:600;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .task .tag{
        font-size:10px;
        padding:1px 7px;
        border-radius:999px;
        border:1px solid color-mix(in srgb, var(--line) 72%, transparent);
        background:color-mix(in srgb, var(--surface-2) 76%, transparent);
        line-height:1.2;
        max-width:130px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .task .tag.time{font-weight:800}
      .task .status-badge{
        font-size:10px;
        padding:2px 7px;
        line-height:1.1;
        background:color-mix(in srgb,var(--surface-2) 68%, transparent);
        white-space:nowrap;
      }
      .task .meta-inline{display:flex;flex-wrap:wrap;gap:4px;align-items:center}
      .task .meta-chip{
        min-width:0;display:inline-flex;align-items:center;gap:4px;
        padding:1px 7px;border-radius:999px;
        border:1px solid color-mix(in srgb, var(--line) 72%, transparent);
        background:color-mix(in srgb, var(--surface-2) 74%, transparent);
      }
      .task .meta-chip .v{font-size:10px;font-weight:700;line-height:1.15;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .task.card-compact .header-tags .tag.client{display:none}
      .task.card-ultra .header-tags .tag.client{display:none}
      .task.card-ultra .n{display:none}
      .task.card-ultra .header-tags{gap:3px}
      .task.card-ultra .status-badge{padding:1px 6px}
      .task.card-ultra .tag{padding:1px 6px;font-size:9px;max-width:92px}
      /* Día: evitar tarjetas "mochadas" según duración */
      .task.mode-half .b{display:none !important}
      .task.mode-half .h{
        height:100%;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:4px;
        padding:2px 6px;
      }
      .task.mode-half .project-title{font-size:10px;font-weight:800}
      .task.mode-half .header-tags{display:flex;gap:3px}
      .task.mode-half .tag{font-size:9px;padding:1px 5px;max-width:78px}
      .task.mode-half .status-badge{font-size:9px;padding:1px 5px}
      .task.mode-hour .h{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:4px;
        padding:2px 6px;
      }
      .task.mode-hour .project-title{font-size:10px;font-weight:800}
      .task.mode-hour .header-tags{display:flex;gap:3px}
      .task.mode-hour .tag{font-size:9px;padding:1px 5px;max-width:78px}
      .task.mode-hour .status-badge{font-size:9px;padding:1px 5px}
      .task.mode-hour .b{display:flex;align-items:center;justify-content:flex-start;padding:2px 6px 3px}
      .task.mode-hour .n{margin:0;width:100%;font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .task.mode-hour .meta-inline{display:none !important}
      @media (max-width:900px){
        .impact-summary{grid-template-columns:repeat(2,minmax(120px,1fr));}
        .task .header-tags{display:none !important;}
        .task .h{justify-content:flex-start;}
      }
      @media (max-width:560px){.impact-summary{grid-template-columns:1fr;}}

      
      /* Vista mensual tipo calendario */
      .monthcal-wrap{padding:10px 10px 14px;min-width:980px}
      .monthcal-shell{
        border:1px solid color-mix(in srgb,var(--line) 88%, transparent);
        border-radius:12px;
        background:var(--surface);
        box-shadow:0 8px 24px rgba(15,23,42,.06);
        padding:12px;
      }
      .monthcal-top{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:10px;
        flex-wrap:wrap;
        margin-bottom:10px
      }
      .monthcal-title{font-size:20px;font-weight:900;letter-spacing:-.35px;line-height:1.1;margin:0}
      .monthcal-subtitle{margin-top:3px;font-size:12px;color:var(--muted);font-weight:600}

      .monthcal-kpis{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:8px;margin:0 0 10px}
      .month-kpi{
        border:1px solid color-mix(in srgb,var(--line) 88%, transparent);
        border-radius:5px;
        background:linear-gradient(180deg,color-mix(in srgb,var(--surface-2) 66%, transparent), var(--surface));
        padding:8px 10px;
        min-height:62px;
        min-width:0;
      }
      .month-kpi .k{
        font-size:10px;color:var(--muted);font-weight:800;
        text-transform:uppercase;letter-spacing:.26px;
        white-space:nowrap;overflow:hidden;text-overflow:ellipsis
      }
      .month-kpi .v{margin-top:2px;font-size:20px;font-weight:900;letter-spacing:-.25px;line-height:1.05}
      .month-kpi .s{
        margin-top:2px;font-size:11px;color:var(--muted);font-weight:700;
        white-space:nowrap;overflow:hidden;text-overflow:ellipsis
      }

      .monthcal-weekdays{
        --mcols:7;
        display:grid;
        grid-template-columns:repeat(var(--mcols),minmax(118px,1fr));
        gap:8px;
        margin:0 0 8px;
      }
      .monthcal-weekday{
        border:1px solid color-mix(in srgb,var(--line) 86%, transparent);
        border-radius:5px;
        background:color-mix(in srgb,var(--surface-2) 72%, transparent);
        padding:6px 8px;
        text-align:center;
        font-size:10px;
        font-weight:900;
        color:var(--muted);
        letter-spacing:.38px;
        text-transform:uppercase;
        white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      }

      .monthcal-grid{
        --mcols:7;
        display:grid;
        grid-template-columns:repeat(var(--mcols),minmax(118px,1fr));
        gap:8px;
      }

      .mcal-cell{
        position:relative;
        overflow:hidden;
        border:1px solid color-mix(in srgb,var(--line) 88%, transparent);
        border-radius:5px;
        background:var(--surface);
        min-height:142px;
        padding:8px 8px 7px;
        display:flex;
        flex-direction:column;
        gap:6px;
        transition:border-color .10s ease, box-shadow .10s ease;
        min-width:0;
      }
      .mcal-cell::before{
        content:"";
        position:absolute;
        inset:0;
        border-radius:inherit;
        background:var(--heat-bg, transparent);
        opacity:0;
        pointer-events:none;
      }
      .mcal-cell.heat::before{opacity:1}
      .mcal-cell > *{position:relative;z-index:1;min-width:0}
      .mcal-cell:hover{
        border-color:color-mix(in srgb,var(--primary) 24%, var(--line));
        box-shadow:0 0 0 1px color-mix(in srgb,var(--primary) 16%, transparent) inset;
      }

      /* Mapa de calor sutil: prioridad dominante + nivel de flujo (1 a 3) */
      .mcal-cell.heat-alta.heat-l1{--heat-bg:color-mix(in srgb,var(--danger) 4%, transparent)}
      .mcal-cell.heat-alta.heat-l2{--heat-bg:color-mix(in srgb,var(--danger) 7%, transparent)}
      .mcal-cell.heat-alta.heat-l3{--heat-bg:color-mix(in srgb,var(--danger) 11%, transparent)}
      .mcal-cell.heat-media.heat-l1{--heat-bg:color-mix(in srgb,var(--warn) 4%, transparent)}
      .mcal-cell.heat-media.heat-l2{--heat-bg:color-mix(in srgb,var(--warn) 7%, transparent)}
      .mcal-cell.heat-media.heat-l3{--heat-bg:color-mix(in srgb,var(--warn) 11%, transparent)}
      .mcal-cell.heat-baja.heat-l1{--heat-bg:color-mix(in srgb,var(--ok) 4%, transparent)}
      .mcal-cell.heat-baja.heat-l2{--heat-bg:color-mix(in srgb,var(--ok) 7%, transparent)}
      .mcal-cell.heat-baja.heat-l3{--heat-bg:color-mix(in srgb,var(--ok) 11%, transparent)}

      .mcal-cell.out{opacity:.66;background:color-mix(in srgb,var(--surface-2) 84%, var(--surface))}
      .mcal-cell.weekend.in-month{
        background:linear-gradient(180deg,color-mix(in srgb,var(--primary) 4%, var(--surface)), color-mix(in srgb,var(--surface-2) 78%, var(--surface)))
      }
      .mcal-cell.today{
        border-color:color-mix(in srgb,var(--primary) 40%, var(--line));
        box-shadow:0 0 0 1px color-mix(in srgb,var(--primary) 28%, transparent);
      }
      .mcal-cell.offday{
        background:linear-gradient(180deg,color-mix(in srgb,var(--warn) 8%, var(--surface)), color-mix(in srgb,var(--surface-2) 84%, var(--surface)))
      }

      .mcal-cell-head{display:flex;align-items:flex-start;justify-content:space-between;gap:6px;background:#e9e9e9;border-radius:5px;padding:4px 6px}
      .mcal-date-wrap{display:flex;align-items:center;gap:6px;min-width:0}
      .mcal-date{
        min-width:24px;height:24px;border-radius:5px;
        display:grid;place-items:center;
        font-size:12px;font-weight:500;
        color:#fff;
        background:color-mix(in srgb, #334155 80%, transparent);
        border:1px solid color-mix(in srgb,#334155 88%, transparent);
      }
      .mcal-cell.today .mcal-date{
        color:#fff;
        background:color-mix(in srgb, #334155 80%, transparent);
        border-color:color-mix(in srgb,#334155 88%, transparent);
      }
      .mcal-dow{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.44px;white-space:nowrap}
      .mcal-util.pill{
        font-size:10px;
        font-weight:900;
        border-radius:999px;
        padding:2px 7px;
      }

      .mcal-off{
        font-size:10px;
        color:var(--warn);
        font-weight:800;
        padding:1px 2px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .mcal-list{display:flex;flex-direction:column;gap:5px;min-height:0;min-width:0}
      .mcal-item{
        width:100%;
        display:flex;
        align-items:center;
        gap:6px;
        border-radius:5px;
        border:1px solid color-mix(in srgb,var(--line) 88%, transparent);
        background:color-mix(in srgb,var(--surface-2) 62%, transparent);
        padding:4px 6px;
        cursor:pointer;
        text-align:left;
        transition:border-color .10s ease, background-color .10s ease;
        min-width:0;
      }
      .mcal-item .t{
        font-size:10px;
        font-weight:600;
        color:var(--muted);
        flex:0 0 auto;
        min-width:36px;
      }
      .mcal-item .n{
        font-size:11px;
        font-weight:600;
        line-height:1.2;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        min-width:0;
      }
      .mcal-item.pri-alta{border-left:3px solid color-mix(in srgb,var(--danger) 82%, #0000)}
      .mcal-item.pri-media{border-left:3px solid color-mix(in srgb,var(--warn) 82%, #0000)}
      .mcal-item.pri-baja{border-left:3px solid color-mix(in srgb,var(--ok) 82%, #0000)}
      .mcal-item:hover{border-color:color-mix(in srgb,var(--primary) 24%, var(--line));background:color-mix(in srgb,var(--surface-2) 76%, transparent)}

      .mcal-empty{
        font-size:10px;
        color:var(--muted);
        padding:5px 4px;
        border:1px dashed color-mix(in srgb,var(--line) 80%, transparent);
        border-radius:5px;
        text-align:center;
        background:color-mix(in srgb,var(--surface) 65%, var(--surface-2));
      }
      .mcal-more{
        font-size:10px;
        font-weight:900;
        color:var(--primary);
        padding:2px 6px;
        border:1px solid color-mix(in srgb,var(--primary) 32%, var(--line));
        background:color-mix(in srgb,var(--primary) 8%, transparent);
        cursor:pointer;
        text-align:center;
        border-radius:5px;
        align-self:flex-start;
      }
      .mcal-more:hover{background:color-mix(in srgb,var(--primary) 13%, transparent)}

            .month-day-modal{display:grid;gap:12px}
      .month-day-top{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
      .month-day-chip{
        display:inline-flex;align-items:center;gap:6px;
        padding:4px 8px;border-radius:999px;border:1px solid var(--line);
        background:var(--surface-2);font-size:11px;font-weight:700;
      }
      .month-day-prio-kpis{
        display:grid;grid-template-columns:repeat(3,minmax(120px,1fr));gap:8px;
      }
      .month-day-prio-kpi{
        border:1px solid var(--line);border-radius:5px;padding:7px 9px;
        background:color-mix(in srgb,var(--surface-2) 84%, transparent);
        display:grid;gap:2px;
      }
      .month-day-prio-kpi .k{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.2px}
      .month-day-prio-kpi .v{font-size:16px;font-weight:900;line-height:1}
      .month-day-prio-kpi.alta .v{color:var(--danger)}
      .month-day-prio-kpi.media .v{color:var(--warn)}
      .month-day-prio-kpi.baja .v{color:var(--ok)}

      .month-day-sections{display:grid;gap:10px}
      .month-day-section{border:1px solid var(--line);border-radius:5px;background:var(--surface)}
      .month-day-section-head{
        display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;
        padding:8px 10px;border-bottom:1px solid color-mix(in srgb,var(--line) 70%, transparent);
        background:color-mix(in srgb,var(--surface-2) 78%, transparent)
      }
      .month-day-section-head .lhs{display:flex;align-items:center;gap:7px}
      .month-day-section-head b{font-size:12px}
      .month-day-section-head span{font-size:11px;color:var(--muted);font-weight:700}

      .month-day-list{display:grid;gap:8px;padding:9px}
      .month-day-item{
        width:100%;display:grid;gap:5px;text-align:left;cursor:pointer;
        border:1px solid var(--line);border-left:4px solid color-mix(in srgb,var(--primary) 55%, var(--line));
        border-radius:5px;background:var(--surface-2);padding:7px 8px;
      }
      .month-day-item.pri-alta{border-left-color:color-mix(in srgb,var(--danger) 60%, var(--line))}
      .month-day-item.pri-media{border-left-color:color-mix(in srgb,var(--warn) 60%, var(--line))}
      .month-day-item.pri-baja{border-left-color:color-mix(in srgb,var(--ok) 60%, var(--line))}
      .month-day-item:hover{border-color:color-mix(in srgb,var(--primary) 24%, var(--line))}
      .month-day-item .top{display:flex;justify-content:space-between;gap:8px;align-items:center}
      .month-day-item .top .time{font-size:11px;font-weight:800;color:var(--muted)}
      .month-day-item .top .tags{display:flex;align-items:center;gap:5px;flex-wrap:wrap}
      .month-day-item .title{
        font-size:12px;font-weight:700;line-height:1.25;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap
      }
      .month-day-item .meta{
        font-size:11px;color:var(--muted);line-height:1.25;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap
      }
      .month-priority{font-size:10px;font-weight:800;padding:1px 6px;border-radius:999px;border:1px solid var(--line)}
      .month-priority.alta{color:var(--danger);border-color:color-mix(in srgb,var(--danger) 40%, var(--line))}
      .month-priority.media{color:var(--warn);border-color:color-mix(in srgb,var(--warn) 42%, var(--line))}
      .month-priority.baja{color:var(--ok);border-color:color-mix(in srgb,var(--ok) 42%, var(--line))}
      .month-day-empty{
        border:1px dashed var(--line);border-radius:5px;padding:16px 12px;
        text-align:center;color:var(--muted);font-size:12px
      }
      @media (max-width:760px){
        .month-day-prio-kpis{grid-template-columns:1fr}
      }
      @media (max-width:1100px){
        .monthcal-wrap{min-width:830px}
        .monthcal-grid,
        .monthcal-weekdays{grid-template-columns:repeat(var(--mcols),minmax(102px,1fr))}
        .mcal-cell{min-height:124px}
        .monthcal-kpis{grid-template-columns:repeat(2,minmax(140px,1fr))}
      }
      @media (max-width:700px){
        .monthcal-kpis{grid-template-columns:1fr}
      }
      /* Modal Equipo */
      #teamOverlay .modal{
        width:min(1220px,96vw);
        border-radius:20px;
        border-color:color-mix(in srgb,var(--primary) 18%, var(--line));
      }
      #teamOverlay .m-head{
        background:
          radial-gradient(520px 160px at 100% -30%, color-mix(in srgb,var(--primary) 16%, transparent), transparent 72%),
          linear-gradient(180deg, color-mix(in srgb,var(--surface-2) 88%, transparent), var(--surface));
      }
      #teamOverlay .m-foot{
        background:var(--surface);
      }
      #teamMatrix{display:grid;gap:14px}
            .eq-shell{display:grid;gap:14px}
      .eq-week-nav{
        display:grid;
        grid-template-columns:auto 1fr auto;
        align-items:center;
        gap:10px;
        border:1px solid color-mix(in srgb,var(--line) 88%, transparent);
        background:color-mix(in srgb,var(--surface-2) 70%, transparent);
        border-radius:14px;
        padding:10px 12px;
      }
      .eq-week-center{display:grid;gap:2px;justify-items:center;text-align:center}
      .eq-week-kicker{font-size:10px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.24px}
      .eq-week-range{font-size:13px;font-weight:900;letter-spacing:-.12px}
      .eq-week-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
      .eq-week-nav .btn{white-space:nowrap}
      .eq-week-label-short{display:none}

      .eq-hero-grid{
        display:grid;
        grid-template-columns:1fr;
        gap:12px;
        align-items:stretch;
      }
      .eq-leader-card{
        position:relative;
        overflow:hidden;
        display:grid;
        grid-template-columns:minmax(320px,1.2fr) minmax(250px,.8fr);
        gap:12px;
        align-items:stretch;
        border:1px solid color-mix(in srgb,var(--line) 86%, transparent);
        background:linear-gradient(180deg, color-mix(in srgb,var(--surface-2) 70%, transparent), var(--surface));
        border-radius:12px;
        padding:12px;
      }
      .eq-leader-main{
        display:flex;
        align-items:center;
        gap:12px;
        min-width:0;
        border:1px solid color-mix(in srgb,var(--line) 80%, transparent);
        background:color-mix(in srgb,var(--surface-2) 68%, transparent);
        border-radius:10px;
        padding:10px;
      }
      .eq-leader-main .eq-avatar{
        width:52px;height:52px;font-size:14px;border-width:1px;
      }
      .eq-leader-meta{display:grid;gap:2px;min-width:0}
      .eq-leader-name{
        font-size:20px;
        font-weight:900;
        line-height:1.08;
        letter-spacing:-.2px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .eq-leader-sub{font-size:11px;color:var(--muted);font-weight:800;letter-spacing:.14px;text-transform:uppercase}
      .eq-leader-stats{
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        gap:8px;
      }
      .eq-leader-stat{
        border:1px solid color-mix(in srgb,var(--line) 80%, transparent);
        background:var(--surface);
        border-radius:10px;
        padding:8px 10px;
        display:grid;
        gap:2px;
        align-content:center;
        min-height:58px;
      }
      .eq-leader-stat .k{
        font-size:10px;
        font-weight:800;
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:.2px;
      }
      .eq-leader-stat .v{
        font-size:13px;
        font-weight:800;
        color:var(--text);
        line-height:1.2;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }

      .eq-wow-card{
        border:1px solid color-mix(in srgb,var(--line) 88%, transparent);
        border-radius:16px;
        background:var(--surface);
        padding:12px;
        display:grid;
        gap:10px;
      }
      .eq-wow-title{font-size:12px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.26px}
      .eq-kpi-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
      .eq-kpi{
        border:1px solid color-mix(in srgb,var(--line) 86%, transparent);
        border-radius:11px;
        background:color-mix(in srgb,var(--surface-2) 74%, transparent);
        padding:8px 9px;
      }
      .eq-kpi .k{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.24px}
      .eq-kpi .v{font-size:20px;font-weight:900;line-height:1.05;margin-top:3px;letter-spacing:-.2px}
      .eq-kpi .s{font-size:10px;color:var(--muted);margin-top:3px}

      .eq-group{
        border:1px solid var(--line);
        border-radius:14px;
        background:var(--surface);
        padding:12px;
      }
      .eq-group-head{display:flex;justify-content:space-between;gap:8px;align-items:flex-end;margin-bottom:10px;flex-wrap:wrap}
      .eq-block-title{
        font-size:12px;
        font-weight:900;
        letter-spacing:.25px;
        color:var(--muted);
        text-transform:uppercase;
      }
      .eq-block-sub{font-size:12px;color:var(--muted);font-weight:700}
      .eq-badge{
        display:inline-flex;
        align-items:center;
        gap:6px;
        border:1px solid color-mix(in srgb,var(--primary) 30%, var(--line));
        background:color-mix(in srgb,var(--primary) 10%, transparent);
        padding:4px 10px;
        border-radius:999px;
        font-size:11px;
        font-weight:800;
      }

      .eq-avatar{
        width:60px;height:60px;border-radius:999px;display:grid;place-items:center;
        font-size:15px;font-weight:900;color:#fff;
        border:2px solid color-mix(in srgb,var(--surface) 88%, transparent);
        background:linear-gradient(135deg,var(--primary),var(--primary-2));
        flex:0 0 auto;
      }
      .eq-avatar.sm{width:42px;height:42px;font-size:12px;border-width:1px;box-shadow:none}
      .eq-tone-0{background:linear-gradient(135deg,#2563eb,#0ea5e9)}
      .eq-tone-1{background:linear-gradient(135deg,#7c3aed,#06b6d4)}
      .eq-tone-2{background:linear-gradient(135deg,#ea580c,#f59e0b)}
      .eq-tone-3{background:linear-gradient(135deg,#0f766e,#22c55e)}
      .eq-tone-4{background:linear-gradient(135deg,#1d4ed8,#6366f1)}

      .eq-manual-grid{
        display:grid;
        grid-template-columns:repeat(3,minmax(0,1fr));
        gap:12px;
        align-items:stretch;
      }
      .eq-member-card{
        --eq-accent: color-mix(in srgb,var(--primary) 55%, var(--line));
        border:1px solid var(--line);
        border-top:3px solid var(--eq-accent);
        border-radius:0;
        background:var(--surface);
        min-height:246px;
        display:grid;
        grid-template-rows:auto auto 1fr;
        overflow:hidden;
        transition:transform .16s ease, box-shadow .16s ease;
      }
      .eq-member-card:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(2,8,23,.12)}
      .eq-member-tone-0{--eq-accent:#222B35}
      .eq-member-tone-1{--eq-accent:#222B35}
      .eq-member-tone-2{--eq-accent:#222B35}
      .eq-member-tone-3{--eq-accent:#222B35}
      .eq-member-tone-4{--eq-accent:#222B35}
      .eq-member-tone{--eq-accent:#222B35}

      .eq-member-head{
        display:flex;
        align-items:center;
        gap:9px;
        padding:11px 12px;
        border-bottom:1px solid color-mix(in srgb,var(--line) 70%, transparent);
        background:color-mix(in srgb,var(--surface-2) 72%, var(--surface));
      }
      .eq-member-name{font-size:14px;font-weight:900;line-height:1.15;letter-spacing:-.1px}
      .eq-member-role{font-size:11px;color:var(--muted);font-weight:700;margin-top:2px}

      .eq-member-metrics{
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        gap:6px;
        padding:9px 10px 0;
      }
      .eq-metric{
        border:1px solid color-mix(in srgb,var(--line) 78%, transparent);
        border-radius:9px;
        padding:6px 7px;
        background:color-mix(in srgb,var(--surface-2) 72%, transparent);
      }
      .eq-metric .k{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.2px}
      .eq-metric .v{font-size:12px;font-weight:800;margin-top:2px;line-height:1.2}

      .eq-resp-box{
        margin:10px;
        border:1px solid color-mix(in srgb,var(--line) 82%, transparent);
        border-radius:10px;
        background:var(--surface);
        padding:9px 10px;
      }
      .eq-resp-title{
        font-size:10px;
        font-weight:800;
        margin-bottom:6px;
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:.2px;
      }
      .eq-resp-box ul{
        margin:0;
        padding:0;
        list-style:none;
        display:grid;
        gap:7px;
      }
      .eq-resp-box li{
        font-size:12px;
        line-height:1.3;
        position:relative;
        padding-left:15px;
      }
      .eq-resp-box li::before{
        content:'✓';
        position:absolute;
        left:0;
        top:0;
        color:color-mix(in srgb,var(--primary) 68%, var(--muted));
        font-weight:900;
        font-size:11px;
      }
      .eq-focus-main{
        margin:10px 10px 0;
        padding:8px 10px;
        border:1px solid color-mix(in srgb,var(--line) 82%, transparent);
        border-radius:6px;
        background:color-mix(in srgb,var(--surface-2) 84%, #e5e7eb);
      }
      .eq-focus-main .k{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.2px}
      .eq-focus-main .v{font-size:12px;font-weight:600;line-height:1.25;margin-top:3px}
      .eq-focus-main.is-clickable{cursor:pointer;transition:border-color .15s ease, background .15s ease, box-shadow .15s ease}
      .eq-focus-main.is-clickable:hover{border-color:color-mix(in srgb,var(--primary) 34%, var(--line));background:color-mix(in srgb,var(--surface-2) 72%, #d1d5db)}
      .eq-focus-main.is-clickable:focus-visible{outline:2px solid color-mix(in srgb,var(--primary) 42%, transparent);outline-offset:1px}
      .eq-next-task{margin-top:8px;padding-top:8px;border-top:1px dashed color-mix(in srgb,var(--line) 70%, transparent)}
      .eq-next-task .k{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.2px}
      .eq-next-task .v{font-size:12px;font-weight:700;line-height:1.25;margin-top:3px}

      .eq-leader-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:5px}
      .eq-chip{
        display:inline-flex;
        align-items:center;
        gap:6px;
        border-radius:999px;
        border:1px solid var(--line);
        padding:2px 8px;
        font-size:10px;
        font-weight:800;
        letter-spacing:.2px;
      }
      .eq-chip.soft{
        background:color-mix(in srgb,var(--surface-2) 84%, transparent);
        border-color:color-mix(in srgb,var(--line) 78%, transparent);
        color:var(--muted);
      }
      .eq-member-card{position:relative}
      .eq-rank{
        position:absolute;
        top:8px;
        right:10px;
        font-size:10px;
        font-weight:900;
        color:var(--muted);
        border:1px solid color-mix(in srgb,var(--line) 76%, transparent);
        background:color-mix(in srgb,var(--surface-2) 76%, transparent);
        border-radius:999px;
        padding:2px 8px;
      }
      .eq-chip.load.green{color:#166534;border-color:color-mix(in srgb,#16a34a 40%, var(--line));background:color-mix(in srgb,#16a34a 12%, transparent)}
      .eq-chip.load.amber{color:#92400e;border-color:color-mix(in srgb,#f59e0b 44%, var(--line));background:color-mix(in srgb,#f59e0b 14%, transparent)}
      .eq-chip.load.red{color:#991b1b;border-color:color-mix(in srgb,#ef4444 44%, var(--line));background:color-mix(in srgb,#ef4444 14%, transparent)}

      .eq-member-metrics.eq-member-metrics-3{
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
      .eq-load-wrap{
        margin:8px 10px 0;
        border:1px solid color-mix(in srgb,var(--line) 80%, transparent);
        border-radius:10px;
        padding:7px 8px;
        background:color-mix(in srgb,var(--surface-2) 66%, transparent);
      }
      .eq-load-label{display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.2px}
      .eq-load-label b{font-size:11px;color:var(--text)}
      .eq-load-bar{margin-top:6px;height:6px;border-radius:999px;background:color-mix(in srgb,var(--line) 65%, transparent);overflow:hidden}
      .eq-load-bar > span{display:block;height:100%;width:0;border-radius:999px;background:var(--load-color, #2563eb);transition:width .25s ease}
      .eq-load-sub{margin-top:6px;font-size:11px;color:var(--muted)}
      .eq-load-wrap.green{--load-color:#16a34a}
      .eq-load-wrap.amber{--load-color:#d97706}
      .eq-load-wrap.red{--load-color:#dc2626}

      .eq-wow-divider{height:1px;background:color-mix(in srgb,var(--line) 75%, transparent);margin:1px 0 0}
      .eq-spotlight{display:grid;gap:8px}
      .eq-spotlight-title{font-size:11px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.24px}
      .eq-spotlight-main{display:flex;align-items:center;gap:8px}
      .eq-spotlight-name{font-size:13px;font-weight:900;line-height:1.2}
      .eq-spotlight-sub{font-size:11px;color:var(--muted);font-weight:700;line-height:1.25}
      .eq-spotlight-empty{font-size:12px;color:var(--muted)}
      .eq-load-legend{display:flex;flex-wrap:wrap;gap:6px}
      .eq-load-legend .lg{
        display:inline-flex;align-items:center;gap:6px;
        font-size:10px;font-weight:800;padding:3px 8px;border-radius:999px;
        border:1px solid color-mix(in srgb,var(--line) 82%, transparent);
        background:color-mix(in srgb,var(--surface-2) 72%, transparent);
      }
      .eq-load-legend .lg i{width:7px;height:7px;border-radius:999px;display:inline-block;background:var(--dot)}
      .eq-load-legend .lg.green{--dot:#16a34a}
      .eq-load-legend .lg.amber{--dot:#d97706}
      .eq-load-legend .lg.red{--dot:#dc2626}
      .eq-resp-empty{font-size:11px;color:var(--muted)}
      .eq-empty{
        border:1px dashed var(--line);
        border-radius:0;
        background:color-mix(in srgb,var(--surface-2) 65%, transparent);
        padding:18px 14px;
        font-size:12px;
        color:var(--muted);
        text-align:center;
      }
      .org-note{margin-top:6px}
      #tab_team textarea[data-org-resp]{min-height:88px;resize:vertical}


      /* Ajuste global solicitado: botones y etiquetas con radio 5px */
      .btn,
      .ctrl,
      button,
      input.ctrl,
      select.ctrl,
      textarea.ctrl,
      .mode-pill,
      .status-badge,
      .blocked-tag,
      .task .tag,
      .task .meta-chip,
      .pill,
      .eq-chip,
      .eq-badge,
      .eq-rank,
      .delta-chip,
      .month-day-chip,
      .mcal-tag,
      .wk-task,
      .holiday-pill,
      .role-chip,
      .chip,
      .tag{
        border-radius:5px !important;
      }

      #segView{border-radius:5px !important;}

      /* Semana: evitar desbordes en tarjetas por contenido largo */
      .week, .day-card, .day-card *{min-width:0;}
      .day-card{overflow:hidden;}
      .day-owners,.mini,.mini-head,.mini-person,.mini-tasks,.wk-task,.wk-task .b{min-width:0;max-width:100%;}
      .mini-util,.owner-meta{max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
      .wk-task .a,
      .wk-task .b > span:first-child{max-width:100%;}
      .wk-task .status-badge{
        max-width:48%;
        overflow:hidden;
        text-overflow:ellipsis;
        white-space:nowrap;
      }

      @media (max-width:1080px){
        .eq-week-nav{grid-template-columns:1fr;justify-items:stretch}
        .eq-week-center{justify-items:flex-start;text-align:left}
        .eq-week-actions{justify-content:flex-start}
        .eq-hero-grid{grid-template-columns:1fr}
        .eq-leader-card{grid-template-columns:1fr}
        .eq-manual-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
      }
      @media (max-width:680px){
        .eq-week-nav{
          grid-template-columns:repeat(3,minmax(0,1fr));
          gap:8px;
          padding:10px;
          align-items:stretch;
        }
        .eq-week-center{
          grid-column:1 / -1;
          order:1;
          justify-items:center;
          text-align:center;
        }
        .eq-week-nav > #eqWeekPrev{
          order:2;
          width:100%;
          min-width:0;
        }
        .eq-week-actions{
          order:3;
          grid-column:2 / 4;
          display:grid;
          grid-template-columns:1fr 1fr;
          gap:8px;
          width:100%;
          justify-content:stretch;
          min-width:0;
        }
        .eq-week-actions .btn,
        .eq-week-nav > #eqWeekPrev{
          width:100%;
          min-width:0;
          white-space:nowrap;
        }
        .eq-week-label-long{display:none;}
        .eq-week-label-short{display:inline;}
        .eq-manual-grid{grid-template-columns:1fr;}
        .eq-leader-name{font-size:17px}
        .eq-leader-card{padding:10px}
        .eq-leader-main{padding:9px}
        .eq-leader-stats{grid-template-columns:1fr}
        .eq-kpi-grid{grid-template-columns:1fr}
      }

      /* Móvil: modales navegables y con scroll interno */
      @media (max-width:768px){
        .overlay{
          align-items:flex-start;
          justify-content:center;
          padding:8px 6px;
          overflow-y:auto;
          overflow-x:hidden;
        }
        .overlay .modal{
          width:100% !important;
          max-height:calc(100dvh - 16px);
          border-radius:12px;
        }
        .overlay .m-head,
        .overlay .m-foot{
          padding:10px 11px;
        }
        .overlay .m-body{
          padding:10px;
          overflow:auto;
          -webkit-overflow-scrolling:touch;
          overscroll-behavior:contain;
        }
        #teamOverlay .modal,
        #manageOverlay .modal,
        #projectOverlay .modal,
        #detailOverlay .modal,
        #infoOverlay .modal{
          width:100% !important;
          max-height:calc(100dvh - 16px);
        }
      }
      @media (max-width:520px){
        #teamOverlay .eq-week-actions{width:100%}
        #teamOverlay .eq-week-actions .btn{flex:1 1 calc(50% - 4px)}
        #teamOverlay .m-head b,
        #manageOverlay .m-head b,
        #projectOverlay .m-head b{font-size:14px}
      }

      /* Móvil: columna Hora fija en vista Día */
      @media (max-width:768px){
        #mainView .day-grid{position:relative}
        #mainView .day-grid > .grid-head:first-child{
          position:sticky;
          left:0;
          z-index:24;
          background:var(--surface-2);
          box-shadow:1px 0 0 color-mix(in srgb,var(--line) 78%, transparent);
        }
        #mainView .day-grid > .time-col{
          position:sticky;
          left:0;
          z-index:22;
          background:var(--surface);
          box-shadow:1px 0 0 color-mix(in srgb,var(--line) 78%, transparent);
        }
        #mainView .day-grid > .time-col .time-cell{background:var(--surface)}
      }


    `;
    document.head.appendChild(style);
  }

  function bindEvents(){
    $('btnAdd').addEventListener('click',()=>{
      if(!isAdmin()) return toast('Modo lectura: acceso restringido');
      openProjectEditor();
    });

    $('btnManage').addEventListener('click', openManage);
    $('btnTheme').addEventListener('click', toggleTheme);
    $('btnInfo')?.addEventListener('click', ()=>{ renderInfoNotifications(); openOverlay('infoOverlay'); });
    $('btnReload')?.addEventListener('click', ()=>{ window.location.reload(); });

    $('datePicker').addEventListener('change',e=>{ const v = normalizeISO(e.target.value); if(!v){ e.target.value = fmtDate(ui.date); toast('Fecha inválida. Usa dd/mm/aaaa'); return; } ui.date = v; render(); });
    $('prevBtn').addEventListener('click',()=>shiftDate(-1));
    $('nextBtn').addEventListener('click',()=>shiftDate(1));
    $('todayBtn').addEventListener('click',()=>{ ui.date = toISO(new Date()); render(); });

    $('fOwner').addEventListener('change',e=>{ ui.filters.owner = e.target.value; render(); });
    $('fClient').addEventListener('change',e=>{ ui.filters.client = e.target.value; render(); });
    $('fStatus').addEventListener('change',e=>{ ui.filters.status = e.target.value; render(); });
    $('fPriority').addEventListener('change',e=>{ ui.filters.priority = e.target.value; render(); });
    $('fSearch').addEventListener('input',e=>{ ui.filters.q = e.target.value.trim().toLowerCase(); render(); });

    $('segView').addEventListener('click',e=>{
      const b = e.target.closest('button[data-view]');
      if(!b) return;
      ui.view = b.dataset.view;
      render();
    });

    $('segRoadmapZoom')?.addEventListener('click',e=>{
      const b = e.target.closest('button[data-rz]');
      if(!b) return;
      ui.roadmapZoom = b.dataset.rz;
      render();
    });

    $('btnAddAct').addEventListener('click',()=>{
      if(!isAdmin()) return toast('Modo lectura');
      addActivityRow();
    });

    $('btnSaveProject').addEventListener('click',()=>{
      if(!isAdmin()) return toast('Modo lectura');
      saveProject();
    });

    $('btnDeleteProject').addEventListener('click',()=>{
      if(!isAdmin()) return toast('Modo lectura');
      deleteProject();
    });

    document.querySelectorAll('[data-close]').forEach(btn => {
      btn.addEventListener('click', ()=> closeOverlay(btn.dataset.close));
    });

    $('manageTabs').addEventListener('click',e=>{
      const b=e.target.closest('button[data-tab]');
      if(!b) return;
      ui.manageTab = b.dataset.tab;
      renderManage();
    });

    document.addEventListener('keydown',e=>{
      if(e.key === 'Escape'){
        if($('impactOverlay')?.classList.contains('open')){
          resolveImpactDecision(false);
          return;
        }
        closeOverlay('projectOverlay');
        closeOverlay('manageOverlay');
        closeOverlay('teamOverlay');
        closeOverlay('infoOverlay');
        closeOverlay('summaryOverlay');
      }
    });
  }

  

function openAccessGate(){
    const prev = $('accessOverlay');
    if(prev){
      try{ prev.__cleanup && prev.__cleanup(); }catch(_e){}
      prev.remove();
    }

    const gate = document.createElement('div');
    gate.id = 'accessOverlay';
    gate.className = 'overlay open';
    
    gate.innerHTML = `
      <div class="modal login-pro">
        <main class="access-scene">
          <section class="top-ambient" aria-hidden="true">
            <canvas id="accessAmbientCanvas"></canvas>
            <div class="ambient-glass"></div>
            <div class="ambient-line l1"></div>
            <div class="ambient-line l2"></div>
            <div class="ambient-line l3"></div>
          </section>

          <div class="fade-ambient-login"></div>

          <section class="login-layer">
            <div class="login-shell">
              <div class="login-card">
                <div class="login-head">
                  <div class="login-logo">BIF</div>
                  <div>
                    <p class="login-title">PROYECTOS</p>
                    <p class="login-sub">Mercado de Capitales &amp; Control de Gestión</p>
                  </div>
                </div>
                <form class="login-form" onsubmit="event.preventDefault()">
                  <div class="input-access-row">
                    <input id="accessCode" class="access-code" type="text" inputmode="numeric" maxlength="4" placeholder="****" autocomplete="off" aria-label="Código de acceso" />
                    <button id="accessBtn" class="login-btn" type="submit">Acceder</button>
                  </div>
                  <div class="login-hint">Ingrese el código de acceso</div>
                  <div id="accessErr" class="lock-msg">Código inválido</div>
                  <div id="accessLockMsg" class="mini-help dim" style="display:none;color:#fbbf24"></div>
                </form>
              </div>
            </div>
          </section>

          <div class="fade-login-chart"></div>

          <section class="chart-wrap" aria-hidden="true">
            <div class="chart-shell">
              <div class="grid">
                <div class="grid-line" style="left:4.6%"></div>
                <div class="grid-line" style="left:22.6%"></div>
                <div class="grid-line" style="left:43.4%"></div>
                <div class="grid-line" style="left:52.7%"></div>
                <div class="grid-line" style="left:80.8%"></div>
                <div class="grid-line" style="left:84.7%"></div>
                <div class="grid-line" style="left:88.9%"></div>
              </div>

              <div class="session s-london">Amigables</div>
              <div class="session s-newyork">Creadores</div>
              <div class="session s-sydney">Puentes</div>
              <div class="session s-tokyo">Tesorería</div>
              <div class="session s-london-next"></div>

              <div class="now-line"></div>

              <div class="x-label" style="left:4.6%">8:00</div>
              <div class="x-label" style="left:22.6%">12:00</div>
              <div class="x-label" style="left:43.4%">17:00</div>
              <div class="x-label" style="left:52.7%">19:00</div>
              <div class="x-label" style="left:80.8%">2:00</div>
              <div class="x-label" style="left:84.7%">3:00</div>
              <div class="x-label" style="left:88.9%">4:00</div>

              <div class="now-label">0:21</div>
            </div>
          </section>

          <div class="scene-vignette"></div>
        </main>
      </div>
    `;

    document.body.appendChild(gate);
    document.body.style.overflow = 'hidden';

    const input = $('accessCode');
    const btn = $('accessBtn');
    const lockMsg = $('accessLockMsg');
    const errMsg = $('accessErr');

    const LOGIN_SUCCESS_DELAY_MS = 1500;
    let isAuthorizing = false;
    let successDelayTimer = null;
    const defaultBtnHtml = '<span class="btn-inner"><span class="btn-label">Acceder</span></span>';
    if(btn) btn.innerHTML = defaultBtnHtml;

    const setBtnLoading = (loading=false) => {
      if(!btn) return;
      if(loading){
        btn.classList.add('is-loading');
        btn.innerHTML = '<span class="btn-inner"><i class="fa-solid fa-circle-notch fa-spin btn-spin" aria-hidden="true"></i></span>';
      }else{
        btn.classList.remove('is-loading');
        btn.innerHTML = defaultBtnHtml;
      }
    };

    const startAccessAmbient = (canvas) => {
      const ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
      if(!ctx) return ()=>{};

      let W = 0, H = 0, DPR = 1;
      let raf = 0;
      const t0 = performance.now();

      const ribbons = [
        { amp: 28, freq: 0.012, speed: 0.00028, y: 0.24, width: 1.6, c1:[79,140,255,0.45], c2:[79,140,255,0.04] },
        { amp: 20, freq: 0.016, speed: 0.00042, y: 0.38, width: 1.3, c1:[20,184,166,0.36], c2:[20,184,166,0.03] },
        { amp: 16, freq: 0.011, speed: -0.00023, y: 0.52, width: 1.1, c1:[140,175,230,0.28], c2:[140,175,230,0.02] }
      ];

      const movers = Array.from({length: 22}).map((_,i)=>({
        lane: i % ribbons.length,
        x: Math.random(),
        v: 0.00006 + Math.random()*0.00022,
        r: 1.6 + Math.random()*1.9
      }));

      const resize = () => {
        const rect = canvas.getBoundingClientRect();
        DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        W = Math.max(320, Math.round(rect.width));
        H = Math.max(160, Math.round(rect.height));
        canvas.width = Math.round(W * DPR);
        canvas.height = Math.round(H * DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);
      };

      const pathY = (x, r, time) => {
        const phase = time * r.speed * 1200;
        const yBase = H * r.y;
        return yBase + Math.sin(x*r.freq + phase)*r.amp + Math.sin(x*(r.freq*0.42) - phase*0.75)*(r.amp*0.34);
      };

      const drawRibbon = (r, time) => {
        ctx.beginPath();
        const step = 8;
        for(let x=0; x<=W+step; x+=step){
          const y = pathY(x, r, time);
          if(x===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        }

        const g = ctx.createLinearGradient(0,0,W,0);
        g.addColorStop(0, `rgba(${r.c2[0]},${r.c2[1]},${r.c2[2]},${r.c2[3]})`);
        g.addColorStop(0.2, `rgba(${r.c1[0]},${r.c1[1]},${r.c1[2]},${r.c1[3]})`);
        g.addColorStop(0.8, `rgba(${r.c1[0]},${r.c1[1]},${r.c1[2]},${r.c1[3]})`);
        g.addColorStop(1, `rgba(${r.c2[0]},${r.c2[1]},${r.c2[2]},${r.c2[3]})`);
        ctx.strokeStyle = g;
        ctx.lineWidth = r.width;
        ctx.shadowColor = `rgba(${r.c1[0]},${r.c1[1]},${r.c1[2]},0.35)`;
        ctx.shadowBlur = 7;
        ctx.stroke();
        ctx.shadowBlur = 0;
      };

      const drawMovers = (time) => {
        for(const m of movers){
          m.x += m.v;
          if(m.x > 1.02) m.x = -0.03;
          const r = ribbons[m.lane];
          const x = m.x * W;
          const y = pathY(x, r, time);

          ctx.beginPath();
          ctx.arc(x, y, m.r + 2.2, 0, Math.PI*2);
          ctx.fillStyle = `rgba(${r.c1[0]},${r.c1[1]},${r.c1[2]},0.16)`;
          ctx.fill();

          ctx.beginPath();
          ctx.arc(x, y, m.r, 0, Math.PI*2);
          ctx.fillStyle = `rgba(220,235,255,0.9)`;
          ctx.fill();
        }
      };

      const drawBeams = (time) => {
        const count = 6;
        for(let i=0;i<count;i++){
          const p = (i+1)/(count+1);
          const wob = Math.sin(time*1.3 + i*1.7) * 0.012;
          const x = (p + wob) * W;
          const w = 1 + (i%2)*0.5;

          const g = ctx.createLinearGradient(0, H*0.06, 0, H*0.86);
          g.addColorStop(0, "rgba(130,160,210,0.00)");
          g.addColorStop(0.35, "rgba(130,160,210,0.09)");
          g.addColorStop(0.75, "rgba(130,160,210,0.03)");
          g.addColorStop(1, "rgba(130,160,210,0.00)");

          ctx.fillStyle = g;
          ctx.fillRect(x, H*0.06, w, H*0.80);
        }
      };

      const frame = (ts) => {
        const time = (ts - t0) * 0.001;

        ctx.clearRect(0,0,W,H);

        const halo = ctx.createRadialGradient(W*0.5, H*0.08, 8, W*0.5, H*0.08, W*0.46);
        halo.addColorStop(0, "rgba(110,170,255,0.18)");
        halo.addColorStop(0.42, "rgba(40,110,210,0.08)");
        halo.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = halo;
        ctx.fillRect(0,0,W,H);

        drawBeams(time);
        for(const r of ribbons) drawRibbon(r, time);
        drawMovers(time);

        const fog = ctx.createLinearGradient(0, H*0.60, 0, H);
        fog.addColorStop(0, "rgba(5,8,14,0)");
        fog.addColorStop(1, "rgba(5,8,14,0.42)");
        ctx.fillStyle = fog;
        ctx.fillRect(0, H*0.60, W, H*0.40);

        raf = requestAnimationFrame(frame);
      };

      resize();
      window.addEventListener('resize', resize, { passive:true });
      raf = requestAnimationFrame(frame);

      return () => {
        try{ cancelAnimationFrame(raf); }catch(_){/* noop */}
        window.removeEventListener('resize', resize);
      };
    };

    const stopAmbient = startAccessAmbient(gate.querySelector('#accessAmbientCanvas'));

    const attemptKey = 'BANBIF_ACCESS_ATTEMPTS_V12';
    const lockKey = 'BANBIF_ACCESS_LOCK_UNTIL_V12';
    const lockLevelKey = 'BANBIF_ACCESS_LOCK_LEVEL_V12';

    const lockDurationsSec = [120, 300, 900, 1800, 3600]; // 2m, 5m, 15m, 30m, 60m

    const ACCESS_ROLE_HASH = Object.freeze({
      read: 1537282,   // 2026
      admin: 1513191   // 1602
    });

    const getLockLevel = () => Math.max(0, Number(sessionStorage.getItem(lockLevelKey) || 0));
    const setLockLevel = (v) => sessionStorage.setItem(lockLevelKey, String(Math.max(0, Number(v) || 0)));
    const nextLockSeconds = (level) => lockDurationsSec[Math.min(Math.max(level - 1, 0), lockDurationsSec.length - 1)];

    const fmtLockDuration = (seconds) => {
      const sec = Math.max(1, Number(seconds) || 0);
      const minutes = Math.round(sec / 60);
      if(minutes < 60) return `${minutes} min`;
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return m ? `${h} h ${m} min` : `${h} h`;
    };

    const updateLockState = () => {
      const lockUntil = Number(sessionStorage.getItem(lockKey) || 0);
      const now = Date.now();

      if(lockUntil > now){
        const sec = Math.max(1, Math.ceil((lockUntil - now) / 1000));
        const mm = String(Math.floor(sec / 60)).padStart(2,'0');
        const ss = String(sec % 60).padStart(2,'0');
        const level = Math.max(1, getLockLevel());
        lockMsg.style.display = 'block';
        lockMsg.textContent = `Demasiados intentos. Reintenta en ${mm}:${ss} · nivel ${level}`;
        input.disabled = true;
        btn.disabled = true;
        return true;
      }

      input.disabled = false;
      btn.disabled = false;
      return false;
    };

    const showAttemptHint = () => {
      const attempts = Math.max(0, Number(sessionStorage.getItem(attemptKey) || 0));
      if(attempts <= 0) return;
      const nextLevel = getLockLevel() + 1;
      const nextDur = fmtLockDuration(nextLockSeconds(nextLevel));
      lockMsg.style.display = 'block';
      lockMsg.textContent = `Intento ${attempts}/5. Si llegas a 5, el bloqueo será de ${nextDur}.`;
    };

    let lockTimer = null;
    const startLockTimer = () => {
      clearInterval(lockTimer);
      lockTimer = setInterval(()=>{
        if(!updateLockState()){
          clearInterval(lockTimer);
          showAttemptHint();
          input.focus();
        }
      }, 500);
    };

    const resolveRole = (rawCode) => {
      const code = String(rawCode || '').replace(/\D+/g,'').slice(0,4);
      if(code.length !== 4) return '';
      const codeHash = hashString(code);
      if(codeHash === ACCESS_ROLE_HASH.read) return 'read';
      if(codeHash === ACCESS_ROLE_HASH.admin) return 'admin';
      return '';
    };

    // Password visual: muestra brevemente el último dígito y luego lo oculta
    const MASK_CHAR = '•';
    let realCode = '';
    let revealTimer = null;

    const placeCaretAtEnd = () => {
      try{ input.setSelectionRange(input.value.length, input.value.length); }catch(_){/* noop */}
    };

    const clearRevealTimer = () => {
      if(revealTimer){
        clearTimeout(revealTimer);
        revealTimer = null;
      }
    };

    const renderMaskedCode = (showLastDigit=false) => {
      const len = realCode.length;
      let out = '';
      for(let i=0;i<len;i++){
        const isLast = i === len - 1;
        out += (showLastDigit && isLast) ? realCode[i] : MASK_CHAR;
      }
      input.value = out;
      requestAnimationFrame(placeCaretAtEnd);
    };

    const revealLastDigit = () => {
      clearRevealTimer();
      renderMaskedCode(true);
      revealTimer = setTimeout(()=>{
        renderMaskedCode(false);
      }, 420);
    };

    const addDigits = (raw='') => {
      const digits = String(raw).replace(/\D+/g,'');
      if(!digits) return;
      if(realCode.length >= 4) return;
      realCode = (realCode + digits).slice(0,4);
      if(errMsg) errMsg.style.display = 'none';
      revealLastDigit();
    };

    const removeLastDigit = () => {
      if(!realCode.length) return;
      clearRevealTimer();
      realCode = realCode.slice(0,-1);
      renderMaskedCode(false);
      if(errMsg) errMsg.style.display = 'none';
    };

    const clearCode = () => {
      clearRevealTimer();
      realCode = '';
      renderMaskedCode(false);
    };

    const submit = () => {
      if(isAuthorizing) return;
      if(updateLockState()) return;

      const role = resolveRole(realCode);

      if(role){
        sessionStorage.removeItem(attemptKey);
        sessionStorage.removeItem(lockKey);
        sessionStorage.removeItem(lockLevelKey);

        ui.role = role;
        isAuthorizing = true;
        clearInterval(lockTimer);
        clearRevealTimer();
        input.disabled = true;
        btn.disabled = true;
        lockMsg.style.display = 'none';
        if(errMsg) errMsg.style.display = 'none';
        setBtnLoading(true);

        successDelayTimer = setTimeout(()=>{
          const appRoot = document.querySelector('.app');
          if(appRoot){
            appRoot.classList.add('auth-reveal');
            appRoot.classList.remove('is-visible');
            void appRoot.offsetWidth;
          }

          gate.remove();
          document.body.style.overflow = '';
          try{ stopAmbient && stopAmbient(); }catch(_e){}
          updateRoleUI();
          render();

          if(appRoot){
            requestAnimationFrame(()=>{
              appRoot.classList.add('is-visible');
            });
            setTimeout(()=>{
              appRoot.classList.remove('auth-reveal');
              appRoot.classList.remove('is-visible');
            }, 420);
          }

          toast(ui.role === 'admin' ? 'Modo administrador activado' : 'Modo lectura activado');

          syncFromRemoteJson({
            source: 'auto_login',
            silentErrorToast: true,
            silentImportToast: true
          }).catch((err)=>{
            console.warn('No se pudo sincronizar automáticamente desde JSON remoto', err);
          });
        }, LOGIN_SUCCESS_DELAY_MS);

        return;
      }

      errMsg.style.display = 'block';
      const attempts = Math.max(0, Number(sessionStorage.getItem(attemptKey) || 0)) + 1;
      sessionStorage.setItem(attemptKey, String(attempts));

      if(attempts >= 5){
        const newLevel = getLockLevel() + 1;
        setLockLevel(newLevel);

        const lockSeconds = nextLockSeconds(newLevel);
        const lockUntil = Date.now() + lockSeconds * 1000;

        sessionStorage.setItem(lockKey, String(lockUntil));
        sessionStorage.setItem(attemptKey, '0');

        updateLockState();
        startLockTimer();
      }else{
        showAttemptHint();
      }

      clearCode();
      input.focus();
    };

    btn.addEventListener('click', submit);

    input.addEventListener('keydown',(e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        submit();
        return;
      }

      if(e.key === 'Backspace'){
        e.preventDefault();
        removeLastDigit();
        return;
      }

      if(e.key === 'Delete'){
        e.preventDefault();
        clearCode();
        return;
      }

      if(/^\d$/.test(e.key)){
        e.preventDefault();
        addDigits(e.key);
        return;
      }

      if(['Tab','ArrowLeft','ArrowRight','Home','End'].includes(e.key)) return;
      if(e.ctrlKey || e.metaKey || e.altKey) return;

      // Bloquear cualquier entrada que no sea dígito
      if(e.key.length === 1) e.preventDefault();
    });

    input.addEventListener('beforeinput',(e)=>{
      if(updateLockState()) return;

      if(e.inputType === 'insertText'){
        e.preventDefault();
        addDigits(e.data || '');
        return;
      }
      if(e.inputType === 'deleteContentBackward'){
        e.preventDefault();
        removeLastDigit();
        return;
      }
      if(e.inputType === 'deleteContentForward'){
        e.preventDefault();
        clearCode();
      }
    });

    input.addEventListener('paste',(e)=>{
      e.preventDefault();
      const clip = (e.clipboardData || window.clipboardData);
      const text = clip ? (clip.getData('text') || '') : '';
      addDigits(text);
    });

    input.addEventListener('input',()=>{
      // Fallback para navegadores/teclados que no respeten beforeinput
      const raw = String(input.value || '').replace(/\D+/g,'').slice(0,4);
      if(raw && raw !== realCode){
        realCode = raw;
        revealLastDigit();
      }else{
        renderMaskedCode(false);
      }
      if(errMsg) errMsg.style.display = 'none';
    });

    updateLockState();
    if(lockMsg.style.display !== 'block') showAttemptHint();
    startLockTimer();
    renderMaskedCode(false);
    setTimeout(()=>{
      input.focus();
      placeCaretAtEnd();
    }, 40);

    gate.__cleanup = () => {
      try{ clearInterval(lockTimer); }catch(_e){}
      try{ clearRevealTimer(); }catch(_e){}
      try{ if(successDelayTimer){ clearTimeout(successDelayTimer); successDelayTimer = null; } }catch(_e){}
      try{ setBtnLoading(false); }catch(_e){}
      try{ isAuthorizing = false; }catch(_e){}
      try{ stopAmbient && stopAmbient(); }catch(_e){}
    };
  }



  async function copySelectedDaySummary(){
    openSummaryModal();
  }

  function ensureSummaryState(){
    if(typeof ui.summaryScope !== 'string') ui.summaryScope = 'team';
    if(typeof ui.summaryUser !== 'string') ui.summaryUser = '';
    if(typeof ui.summaryRange !== 'string') ui.summaryRange = 'week';
    if(typeof ui.summaryFrom !== 'string' || !normalizeISO(ui.summaryFrom)) ui.summaryFrom = normalizeISO(ui.date) || todayISO();
    if(typeof ui.summaryTo !== 'string' || !normalizeISO(ui.summaryTo)) ui.summaryTo = normalizeISO(ui.date) || todayISO();
    if(typeof ui.summaryGroupBy !== 'string') ui.summaryGroupBy = 'owner';
    if(typeof ui.summarySortBy !== 'string') ui.summarySortBy = 'date';
    if(typeof ui.summaryClient !== 'string') ui.summaryClient = '';
    if(typeof ui.summaryPriority !== 'string') ui.summaryPriority = '';
    if(typeof ui.summaryStatus !== 'string') ui.summaryStatus = '';
    if(typeof ui.summaryQuery !== 'string') ui.summaryQuery = '';
    if(typeof ui.summaryIncludeActivities !== 'boolean') ui.summaryIncludeActivities = true;
    if(typeof ui.summaryIncludeProjects !== 'boolean') ui.summaryIncludeProjects = true;
    if(typeof ui.summaryIncludeNotifications !== 'boolean') ui.summaryIncludeNotifications = true;
    if(typeof ui.summaryIncludeDoneActivities !== 'boolean') ui.summaryIncludeDoneActivities = false;
    if(typeof ui.summaryIncludeDoneNotifications !== 'boolean') ui.summaryIncludeDoneNotifications = false;
    if(typeof ui.summaryOnlyDueNotifications !== 'boolean') ui.summaryOnlyDueNotifications = false;
    if(typeof ui.summaryFiltersOpen !== 'boolean') ui.summaryFiltersOpen = false;
    if(ui.summaryScope === 'individual' && !ui.summaryUser){
      ui.summaryUser = state.team?.[0]?.id || '';
    }
  }

  function openSummaryModal(){
    ensureSummaryState();
    try{
      renderSummaryModal();
      openOverlay('summaryOverlay');
    }catch(err){
      console.error('Error opening summary modal', err);
      toast('No se pudo abrir el generador de reportes. Revisa consola.');
    }
  }

  function resolveSummaryDateRange(mode = ui.summaryRange){
    const today = todayISO();
    const selectedDate = normalizeISO(ui.date);
    const baseDate = (selectedDate && selectedDate > today) ? selectedDate : today;
    if(mode === 'week'){
      const s = startOfWeekISO(baseDate);
      return { startDate:s, endDate:addDaysISO(s,4) };
    }
    if(mode === 'month'){
      const s = startOfMonthISO(baseDate);
      return { startDate:s, endDate:addDaysISO(addMonthsISO(s,1),-1) };
    }
    if(mode === 'custom'){
      let s = normalizeISO(ui.summaryFrom) || baseDate;
      let e = normalizeISO(ui.summaryTo) || s;
      if(s > e){ const t = s; s = e; e = t; }
      return { startDate:s, endDate:e };
    }
    return { startDate:baseDate, endDate:baseDate };
  }

  function summaryRangeLabel(startDate, endDate){
    return startDate === endDate ? fmtDate(startDate) : `${fmtDate(startDate)} → ${fmtDate(endDate)}`;
  }

  function summarySortRows(rows, sortBy = 'date'){
    const list = Array.isArray(rows) ? rows.slice() : [];
    list.sort((a,b)=>{
      if(sortBy === 'priority'){
        return (
          priorityRank(a.priority) - priorityRank(b.priority) ||
          String(a.startDate || '').localeCompare(String(b.startDate || '')) ||
          String(a.projectName || '').localeCompare(String(b.projectName || ''), APP_LOCALE, { sensitivity:'base' })
        );
      }
      if(sortBy === 'owner'){
        return (
          String(a.ownerName || a.leaderName || '').localeCompare(String(b.ownerName || b.leaderName || ''), APP_LOCALE, { sensitivity:'base' }) ||
          String(a.startDate || '').localeCompare(String(b.startDate || ''))
        );
      }
      return (
        String(a.startDate || '').localeCompare(String(b.startDate || '')) ||
        String(a.startHour || '').localeCompare(String(b.startHour || '')) ||
        priorityRank(a.priority) - priorityRank(b.priority)
      );
    });
    return list;
  }

  function collectSummaryRows(startDate, endDate){
    const today = todayISO();
    const observedDate = normalizeISO(endDate) || today;
    const statusByObserved = (startISO, endISO, isDone=false)=>{
      const s = normalizeISO(startISO);
      const e = normalizeISO(endISO) || s;
      if(!s || !e) return 'Programado';
      if(isDone) return 'Finalizado';
      if(observedDate < s) return 'Programado';
      if(observedDate > e) return 'Demorado';
      return 'En curso';
    };
    const activityRows = [];
    const projectRows = [];

    state.projects.forEach(project=>{
      const occurrences = enumerateProjectOccurrences(project, startDate, endDate);
      if(!occurrences.length) return;

      const activities = Array.isArray(project.activities) ? project.activities : [];

      occurrences.forEach(occ=>{
        const activitySnapshots = activities.map(activity=>{
          const mapped = mapRecurringDateRange(activity.startDate, activity.endDate, occ);
          if(!mapped) return null;

          const occStart = normalizeISO(mapped.startDate);
          const occEnd = normalizeISO(mapped.endDate);
          if(!occStart || !occEnd) return null;

          const done = Boolean(activity.done);
          const status = statusByObserved(occStart, occEnd, done);
          return { done, status };
        }).filter(Boolean);

        const allDone = activitySnapshots.length > 0 && activitySnapshots.every(x=>x.done);
        const hasDelayedOpen = activitySnapshots.some(x=>!x.done && x.status === 'Demorado');

        let status = statusByObserved(occ.startDate, occ.endDate, false);
        if(allDone) status = 'Finalizado';
        else if(hasDelayedOpen) status = 'Demorado';

        const ownerIds = Array.from(new Set(activities.map(a=>String(a.ownerId || '')).filter(Boolean)));
        const ownerNames = ownerIds.map(id=>findTeam(id)?.name).filter(Boolean);

        projectRows.push({
          id: `${project.id}::${occ.index}`,
          projectId: project.id,
          projectName: String(project.name || 'Proyecto sin nombre'),
          client: String(project.client || 'Interno').trim() || 'Interno',
          priority: PRIORITIES.includes(project.priority) ? project.priority : 'Media',
          status,
          pending: !allDone && (status === 'En curso' || status === 'Demorado'),
          overdue: status === 'Demorado',
          startDate: occ.startDate,
          endDate: occ.endDate,
          reqDate: occ.reqDate || normalizeISO(project.reqDate) || occ.startDate,
          recurrence: normalizeRecurrenceFrequency(project.recurrenceFrequency),
          leaderId: String(project.leaderId || ''),
          leaderName: findTeam(project.leaderId)?.name || 'Sin líder',
          owners: ownerIds,
          ownersLabel: ownerNames.join(', '),
          activitiesCount: activities.length,
          searchBlob: normalizeSearchText([
            project.name,
            project.client,
            project.priority,
            status,
            ownerNames.join(' '),
            findTeam(project.leaderId)?.name || '',
            occ.startDate,
            occ.endDate
          ].join(' '))
        });
      });

      activities.forEach(activity=>{
        occurrences.forEach(occ=>{
          const mapped = mapRecurringDateRange(activity.startDate, activity.endDate, occ);
          if(!mapped) return;

          const occStart = normalizeISO(mapped.startDate);
          const occEnd = normalizeISO(mapped.endDate);
          if(!occStart || !occEnd) return;
          if(occEnd < startDate || occStart > endDate) return;

          const enriched = { ...activity, startDate:occStart, endDate:occEnd, done:Boolean(activity.done) };
          const done = Boolean(enriched.done);
          const status = statusByObserved(occStart, occEnd, done);

          activityRows.push({
            id: `${project.id}::${activity.id}::${occ.index}`,
            projectId: project.id,
            projectName: String(project.name || 'Proyecto sin nombre'),
            taskId: activity.id,
            taskName: String(activity.name || 'Actividad'),
            taskDetail: String(activity.detail || ''),
            client: String(project.client || 'Interno').trim() || 'Interno',
            priority: PRIORITIES.includes(project.priority) ? project.priority : 'Media',
            status,
            done,
            pending: !done && (status === 'En curso' || status === 'Demorado'),
            overdue: status === 'Demorado',
            startDate: occStart,
            endDate: occEnd,
            startHour: normalizeOptionalHHMM(activity.startHour) || '',
            endHour: normalizeOptionalHHMM(activity.endHour) || '',
            recurrence: normalizeRecurrenceFrequency(project.recurrenceFrequency),
            ownerId: String(activity.ownerId || ''),
            ownerName: findTeam(activity.ownerId)?.name || 'Sin responsable',
            leaderId: String(project.leaderId || ''),
            searchBlob: normalizeSearchText([
              project.name,
              activity.name,
              activity.detail,
              project.client,
              project.priority,
              status,
              findTeam(activity.ownerId)?.name || '',
              occStart,
              occEnd,
              activity.startHour || '',
              activity.endHour || ''
            ].join(' '))
          });
        });
      });
    });

    const notifications = sanitizeNotifications(state.notifications || [], state.team).map(n=>{
      const st = notificationStatus(n);
      return {
        ...n,
        targetName: notificationTargetName(n.userId),
        statusLabel: st.label,
        statusClass: st.cls,
        pending: !n.done,
        due: isNotificationDue(n),
        inRange: Boolean(n.remindDate) ? (n.remindDate >= startDate && n.remindDate <= endDate) : false,
        searchBlob: normalizeSearchText([
          n.title,
          n.message,
          notificationTargetName(n.userId),
          n.remindDate || '',
          n.remindTime || '',
          st.label,
          n.done ? 'atendida' : 'pendiente'
        ].join(' '))
      };
    }).sort(compareNotifications);

    return { activityRows, projectRows, notifications };
  }

  function applySummaryFilters(dataset, filters){
    const q = normalizeSearchText(filters.query || '');

    const matchesShared = (row)=>{
      if(filters.client && String(row.client || '') !== filters.client) return false;
      if(filters.priority && String(row.priority || '') !== filters.priority) return false;
      if(filters.status && String(row.status || '') !== filters.status) return false;
      if(q){
        const blob = normalizeSearchText(row.searchBlob || '');
        if(!blob.includes(q)) return false;
      }
      return true;
    };

    const userMatchForActivity = (row)=>{
      if(!filters.userId) return true;
      return row.ownerId === filters.userId;
    };

    const userMatchForProject = (row)=>{
      if(!filters.userId) return true;
      return row.leaderId === filters.userId || (Array.isArray(row.owners) && row.owners.includes(filters.userId));
    };

    const userMatchForNotification = (row)=>{
      if(!filters.userId) return true;
      return row.userId === filters.userId || row.userId === NOTIF_ALL_USERS;
    };

    const activities = summarySortRows(
      (dataset.activityRows || []).filter(row=>{
        if(!matchesShared(row)) return false;
        if(filters.scope === 'individual' && !userMatchForActivity(row)) return false;
        if(!filters.includeDoneActivities && row.done) return false;
        return true;
      }),
      filters.sortBy
    );

    const projects = summarySortRows(
      (dataset.projectRows || []).filter(row=>{
        if(!matchesShared(row)) return false;
        if(filters.scope === 'individual' && !userMatchForProject(row)) return false;
        if(!filters.includeDoneActivities && row.status === 'Finalizado') return false;
        return true;
      }),
      filters.sortBy
    );

    const notifications = (dataset.notifications || []).filter(row=>{
      if(filters.scope === 'individual' && !userMatchForNotification(row)) return false;
      if(!filters.includeDoneNotifications && row.done) return false;
      if(filters.onlyDueNotifications && !row.due) return false;
      if(filters.notificationRangeOnly && !row.inRange) return false;
      if(q && !String(row.searchBlob || '').includes(q)) return false;
      return true;
    });

    return { activities, projects, notifications };
  }

  function summarizeByGroup(rows, groupBy, type = 'activity'){
    const safe = Array.isArray(rows) ? rows : [];
    const groups = new Map();

    const keyFn = (row)=>{
      if(groupBy === 'project') return String(row.projectName || 'Sin proyecto');
      if(groupBy === 'priority') return String(row.priority || 'Sin prioridad');
      if(groupBy === 'status') return String(row.status || 'Sin estado');
      if(type === 'project') return String(row.leaderName || 'Sin líder');
      return String(row.ownerName || 'Sin responsable');
    };

    safe.forEach(row=>{
      const key = keyFn(row);
      if(!groups.has(key)) groups.set(key, []);
      groups.get(key).push(row);
    });

    return Array.from(groups.entries())
      .sort((a,b)=>{
        if(b[1].length !== a[1].length) return b[1].length - a[1].length;
        return a[0].localeCompare(b[0], APP_LOCALE, { sensitivity:'base' });
      });
  }

  function buildAdvancedSummaryReport(filters){
    const { startDate, endDate } = resolveSummaryDateRange(filters.rangeMode);
    const dataset = collectSummaryRows(startDate, endDate);
    const scoped = applySummaryFilters(dataset, {
      scope: filters.scope,
      userId: filters.userId,
      client: filters.client,
      priority: filters.priority,
      status: filters.status,
      query: filters.query,
      includeDoneActivities: filters.includeDoneActivities,
      includeDoneNotifications: filters.includeDoneNotifications,
      onlyDueNotifications: filters.onlyDueNotifications,
      notificationRangeOnly: filters.notificationRangeOnly,
      sortBy: filters.sortBy
    });

    const allActivities = scoped.activities;
    const allProjects = scoped.projects;
    const allNotifications = scoped.notifications;

    const visibleActivities = filters.includeActivities ? allActivities : [];
    const visibleProjects = filters.includeProjects ? allProjects : [];
    const visibleNotifications = filters.includeNotifications ? allNotifications : [];

    const pendingActivities = visibleActivities.filter(r=>r.pending).length;
    const overdueActivities = visibleActivities.filter(r=>r.overdue).length;
    const pendingProjects = visibleProjects.filter(r=>{
      const related = visibleActivities.filter(a=>{
        const occ = String(a.id || '').split('::').pop();
        return `${a.projectId || ''}::${occ || ''}` === String(r.id || '');
      });
      if(related.length) return related.some(a=>a.pending);
      return Boolean(r.pending);
    }).length;
    const overdueProjects = visibleProjects.filter(r=>{
      const related = visibleActivities.filter(a=>{
        const occ = String(a.id || '').split('::').pop();
        return `${a.projectId || ''}::${occ || ''}` === String(r.id || '');
      });
      if(related.length) return related.some(a=>a.overdue);
      return Boolean(r.overdue);
    }).length;
    const pendingNotifications = visibleNotifications.filter(r=>!r.done).length;
    const dueNotifications = visibleNotifications.filter(r=>r.due).length;

    const scopeLabel = filters.scope === 'individual'
      ? `Individual (${findTeam(filters.userId)?.name || 'Sin usuario'})`
      : 'Equipo';

    const filterParts = [];
    if(filters.client) filterParts.push(`Equipo/Cliente: ${filters.client}`);
    if(filters.priority) filterParts.push(`Prioridad: ${filters.priority}`);
    if(filters.status) filterParts.push(`Estado: ${filters.status}`);
    if(filters.query) filterParts.push(`Búsqueda: "${filters.query}"`);
    if(filters.scope === 'team' && filters.userId) filterParts.push(`Usuario foco: ${findTeam(filters.userId)?.name || 'N/A'}`);

    const modeLabel = filters.rangeMode === 'custom'
      ? 'Personalizado'
      : filters.rangeMode === 'week'
        ? 'Semana'
        : filters.rangeMode === 'month'
          ? 'Mes'
          : 'Día';

    const selectedOutputLabels = [];
    if(filters.includeActivities) selectedOutputLabels.push('Actividades');
    if(filters.includeProjects) selectedOutputLabels.push('Proyectos');
    if(filters.includeNotifications) selectedOutputLabels.push('Notificaciones');

    const rhythmSourceActivities = allActivities.slice();
    const rhythmTeam = (filters.scope === 'individual' && filters.userId)
      ? (state.team || []).filter(t=>String(t.id || '') === String(filters.userId || ''))
      : (state.team || []).slice();

    const plannedMinutesInRange = rhythmSourceActivities.reduce((acc, row)=>{
      const rawStart = normalizeISO(row.startDate);
      const rawEnd = normalizeISO(row.endDate) || rawStart;
      if(!rawStart || !rawEnd) return acc;

      const clampedStart = maxISO(rawStart, startDate);
      const clampedEnd = minISO(rawEnd, endDate);
      if(clampedEnd < clampedStart) return acc;

      const perDay = Math.max(0, durationMinutes(row.startHour || '', row.endHour || ''));
      if(perDay <= 0) return acc;

      const businessDays = eachBusinessDateBetween(clampedStart, clampedEnd).length;
      if(businessDays <= 0) return acc;

      return acc + (perDay * businessDays);
    }, 0);

    let availableCapacityMinutes = 0;
    if(rhythmTeam.length){
      let d = startDate;
      let guard = 0;
      while(d <= endDate && guard < 5000){
        if(!isNonWorkingDayISO(d)){
          availableCapacityMinutes += rhythmTeam.reduce((sum, person)=>sum + getDailyCapacityMin(person, d), 0);
        }
        d = addDaysISO(d, 1);
        guard += 1;
      }
    }

    const rhythmPct = availableCapacityMinutes
      ? Math.round((plannedMinutesInRange / availableCapacityMinutes) * 100)
      : (plannedMinutesInRange > 0 ? 100 : 0);

    const rhythmSeverity = severity(rhythmPct);
    const rhythmFreeMinutes = Math.max(0, availableCapacityMinutes - plannedMinutesInRange);

    const nowText = `${fmtDate(todayISO())} ${new Date().toLocaleTimeString(APP_LOCALE, {hour:'2-digit', minute:'2-digit'})}`;

    const lines = [];
    const sep = '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━';
    const addSection = (title)=>{
      lines.push('');
      lines.push(title.toUpperCase());
      lines.push(sep);
    };

    lines.push('📌 REPORTE OPERATIVO | A DEMANDA');
    lines.push(sep);
    lines.push(`Generado: ${nowText}`);
    lines.push(`Periodo: ${summaryRangeLabel(startDate, endDate)} (${modeLabel})`);
    lines.push(`Ámbito: ${scopeLabel}`);
    lines.push(`Vista: ${filters.groupBy === 'project' ? 'Proyecto' : filters.groupBy === 'priority' ? 'Prioridad' : filters.groupBy === 'status' ? 'Estado' : 'Responsable'} | Orden: ${filters.sortBy === 'priority' ? 'Prioridad' : filters.sortBy === 'owner' ? 'Responsable' : 'Fecha'}`);
    lines.push(`Salida: ${selectedOutputLabels.length ? selectedOutputLabels.join(' | ') : 'Sin bloques seleccionados'}`);
    if(filterParts.length) lines.push(`Filtros: ${filterParts.join(' | ')}`);

    addSection('Resumen ejecutivo');
    if(filters.includeActivities){
      lines.push(`• Actividades: ${visibleActivities.length} | Pendientes: ${pendingActivities} | Demoradas: ${overdueActivities} | Finalizadas: ${Math.max(0, visibleActivities.length - pendingActivities)}`);
    }else{
      lines.push('• Actividades: no incluidas en SALIDA.');
    }

    if(filters.includeProjects){
      lines.push(`• Proyectos: ${visibleProjects.length} | Pendientes: ${pendingProjects} | Demorados: ${overdueProjects} | Finalizados: ${Math.max(0, visibleProjects.length - pendingProjects)}`);
    }else{
      lines.push('• Proyectos: no incluidos en SALIDA.');
    }

    if(filters.includeNotifications){
      lines.push(`• Notificaciones: ${visibleNotifications.length} | Pendientes: ${pendingNotifications} | Por fecha: ${dueNotifications} | Atendidas: ${Math.max(0, visibleNotifications.length - pendingNotifications)}`);
    }else{
      lines.push('• Notificaciones: no incluidas en SALIDA.');
    }

    const pendingHighlights = [];
    const criticalActivities = visibleActivities
      .filter(a=>a.overdue || a.pending)
      .sort((a,b)=>{
        if(a.overdue !== b.overdue) return a.overdue ? -1 : 1;
        return String(a.endDate || '').localeCompare(String(b.endDate || ''));
      })
      .slice(0, 10);

    criticalActivities.forEach(a=>{
      const schedule = a.startDate === a.endDate
        ? fmtDate(a.startDate)
        : `${fmtDate(a.startDate)}→${fmtDate(a.endDate)}`;
      const hour = a.startHour && a.endHour ? ` ${a.startHour}-${a.endHour}` : '';
      pendingHighlights.push(`[${a.overdue ? 'Demorada' : 'Pendiente'}] ${schedule}${hour} | ${a.ownerName} | ${a.projectName} › ${a.taskName}`);
    });

    const criticalNotifs = visibleNotifications
      .filter(n=>n.due || (!n.done && !n.remindDate))
      .slice(0, 6);

    criticalNotifs.forEach(n=>{
      const when = n.remindDate ? formatNotificationReminder(n) : 'Sin fecha';
      pendingHighlights.push(`[Notif ${n.due ? 'por fecha' : 'pendiente'}] ${when} | ${n.targetName} | ${n.title}`);
    });

    addSection('Alertas prioritarias');
    if(!selectedOutputLabels.length){
      lines.push('• Activa al menos un bloque en SALIDA para generar alertas.');
    }else if(!pendingHighlights.length){
      lines.push('• Sin alertas críticas para este criterio.');
    }else{
      pendingHighlights.forEach((item, idx)=>lines.push(`${idx + 1}. ${item}`));
    }

    if(filters.includeActivities){
      addSection(`Actividades (${visibleActivities.length})`);
      if(!visibleActivities.length){
        lines.push('• Sin actividades para este criterio.');
      }else{
        const grouped = summarizeByGroup(visibleActivities, filters.groupBy, 'activity');
        let printed = 0;
        const maxItems = 70;
        grouped.forEach(([groupName, rows])=>{
          if(printed >= maxItems) return;
          lines.push(`• ${String(groupName || 'Sin grupo').toUpperCase()} (${rows.length})`);
          rows.forEach(row=>{
            if(printed >= maxItems) return;
            const day = row.startDate === row.endDate ? fmtDate(row.startDate) : `${fmtDate(row.startDate)}→${fmtDate(row.endDate)}`;
            const hour = row.startHour && row.endHour ? ` ${row.startHour}-${row.endHour}` : '';
            lines.push(`  · ${day}${hour} | ${row.projectName} | ${row.taskName} | ${row.priority} | ${row.status}`);
            printed += 1;
          });
        });
        if(visibleActivities.length > maxItems){
          lines.push(`• ... ${visibleActivities.length - maxItems} actividad(es) adicional(es).`);
        }
      }
    }

    if(filters.includeProjects){
      addSection(`Proyectos (${visibleProjects.length})`);
      if(!visibleProjects.length){
        lines.push('• Sin proyectos para este criterio.');
      }else{
        const grouped = summarizeByGroup(visibleProjects, filters.groupBy, 'project');
        let printed = 0;
        const maxItems = 55;
        grouped.forEach(([groupName, rows])=>{
          if(printed >= maxItems) return;
          lines.push(`• ${String(groupName || 'Sin grupo').toUpperCase()} (${rows.length})`);
          rows.forEach(row=>{
            if(printed >= maxItems) return;
            const day = row.startDate === row.endDate ? fmtDate(row.startDate) : `${fmtDate(row.startDate)}→${fmtDate(row.endDate)}`;
            const owners = row.ownersLabel ? ` | Resp: ${row.ownersLabel}` : '';
            lines.push(`  · ${day} | ${row.projectName} | ${row.priority} | ${row.status}${owners}`);
            printed += 1;
          });
        });
        if(visibleProjects.length > maxItems){
          lines.push(`• ... ${visibleProjects.length - maxItems} proyecto(s) adicional(es).`);
        }
      }
    }

    if(filters.includeNotifications){
      addSection(`Notificaciones (${visibleNotifications.length})`);
      if(!visibleNotifications.length){
        lines.push('• Sin notificaciones para este criterio.');
      }else{
        visibleNotifications.slice(0,55).forEach(n=>{
          const when = n.remindDate ? formatNotificationReminder(n) : 'Sin fecha';
          const stateLabel = n.done ? 'Atendida' : (n.due ? 'Por fecha' : 'Pendiente');
          lines.push(`  · [${stateLabel}] ${when} | ${n.targetName} | ${n.title}${n.message ? ` — ${n.message}` : ''}`);
        });
        if(visibleNotifications.length > 55){
          lines.push(`• ... ${visibleNotifications.length - 55} notificación(es) adicional(es).`);
        }
      }
    }

    addSection('Siguiente acción sugerida');
    if(!selectedOutputLabels.length){
      lines.push('• Define al menos un bloque en SALIDA para construir un plan de acción.');
    }else if(pendingHighlights.length){
      lines.push('• Prioriza "Demoradas" y "Notif por fecha", reasigna responsables y confirma nuevo compromiso en la reunión de seguimiento.');
    }else{
      lines.push('• Mantener monitoreo semanal y registrar notificaciones preventivas por responsable.');
    }

    let breakdownRows = [];
    let breakdownType = 'activity';
    if(filters.includeActivities){
      breakdownRows = visibleActivities;
      breakdownType = 'activity';
    }else if(filters.includeProjects){
      breakdownRows = visibleProjects;
      breakdownType = 'project';
    }

    return {
      text: lines.join('\\n'),
      stats: {
        activities: visibleActivities.length,
        pendingActivities,
        projects: visibleProjects.length,
        pendingProjects,
        notifications: visibleNotifications.length,
        pendingNotifications,
        dueNotifications,
        range: summaryRangeLabel(startDate, endDate),
        rhythmPct,
        rhythmPlannedMin: plannedMinutesInRange,
        rhythmCapacityMin: availableCapacityMinutes,
        rhythmFreeMin: rhythmFreeMinutes
      },
      details: {
        scopeLabel,
        modeLabel,
        generatedAt: nowText,
        filtersApplied: filterParts.slice(),
        startDate,
        endDate,
        outputFlags: {
          activities: Boolean(filters.includeActivities),
          projects: Boolean(filters.includeProjects),
          notifications: Boolean(filters.includeNotifications)
        },
        selectedOutputLabels: selectedOutputLabels.slice(),
        loadRhythm: {
          pct: rhythmPct,
          plannedMin: plannedMinutesInRange,
          capacityMin: availableCapacityMinutes,
          freeMin: rhythmFreeMinutes,
          tone: rhythmSeverity.className,
          label: rhythmSeverity.label
        },
        visibleActivities: visibleActivities.slice(),
        topActivities: criticalActivities.slice(0, 8),
        topProjects: visibleProjects
          .filter(p=>p.overdue || p.pending)
          .sort((a,b)=>String(a.endDate || '').localeCompare(String(b.endDate || '')))
          .slice(0, 8),
        topNotifications: visibleNotifications.slice(),
        pendingHighlights: pendingHighlights.slice(0, 10),
        groupBreakdown: summarizeByGroup(breakdownRows, filters.groupBy, breakdownType)
          .slice(0, 6)
          .map(([name, rows])=>{
            const total = rows.length;
            const pending = rows.filter(r=>r.pending).length;
            const overdue = rows.filter(r=>r.overdue).length;
            const flowPct = total ? Math.round((pending / total) * 100) : 0;
            return { name, total, pending, overdue, flowPct };
          })
      }
    };
  }

  function renderSummaryKpis(stats){
    const root = $('summaryKpis');
    if(!root || !stats) return;

    root.innerHTML = `
      <div class="summary-kpi">
        <div class="k">Actividades</div>
        <div class="v">${Number(stats.activities || 0)}</div>
        <div class="s">Pendientes: ${Number(stats.pendingActivities || 0)}</div>
      </div>
      <div class="summary-kpi">
        <div class="k">Proyectos</div>
        <div class="v">${Number(stats.projects || 0)}</div>
        <div class="s">Pend. por actividad: ${Number(stats.pendingProjects || 0)}</div>
      </div>
      <div class="summary-kpi">
        <div class="k">Notificaciones</div>
        <div class="v">${Number(stats.notifications || 0)}</div>
        <div class="s">Pendientes: ${Number(stats.pendingNotifications || 0)}</div>
      </div>
      <div class="summary-kpi">
        <div class="k">Alertas por fecha</div>
        <div class="v">${Number(stats.dueNotifications || 0)}</div>
        <div class="s">Rango: ${esc(stats.range || '-')}</div>
      </div>
    `;
  }



function renderSummaryReadable(result, filters){
  const root = $('summaryReadable');
  if(!root) return;

  const stats = result?.stats || {};
  const details = result?.details || {};
  const outputFlags = details.outputFlags || { activities:true, projects:true, notifications:true };
  const selectedOutputs = Array.isArray(details.selectedOutputLabels)
    ? details.selectedOutputLabels.filter(Boolean)
    : [];

  const includeActivities = Boolean(filters?.includeActivities);
  const includeProjects = Boolean(filters?.includeProjects);
  const includeNotifications = Boolean(filters?.includeNotifications);

  const pendingWork = includeActivities
    ? Number(stats.pendingActivities || 0)
    : (includeProjects ? Number(stats.pendingProjects || 0) : 0);

  const pendingAlerts = includeNotifications ? Number(stats.pendingNotifications || 0) : 0;
  const totalPending = pendingWork + pendingAlerts;

  const scopeLabel = filters?.scope === 'individual'
    ? (findTeam(filters.userId)?.name || 'Individual')
    : 'Equipo completo';

  const periodText = (details.startDate && details.endDate)
    ? summaryRangeLabel(details.startDate, details.endDate)
    : (stats.range || '-');

  const filterText = (details.filtersApplied || []).length
    ? details.filtersApplied.join(' · ')
    : 'Sin filtros adicionales';

  const outputText = selectedOutputs.length ? selectedOutputs.join(', ') : 'Ninguna';

  const allFilteredActivities = Array.isArray(details.visibleActivities) ? details.visibleActivities : [];
  const topNotifs = Array.isArray(details.topNotifications) ? details.topNotifications : [];
  const groups = Array.isArray(details.groupBreakdown) ? details.groupBreakdown.slice(0, 6) : [];

  const rhythm = details.loadRhythm || {
    pct: Number(stats.rhythmPct || 0),
    plannedMin: Number(stats.rhythmPlannedMin || 0),
    capacityMin: Number(stats.rhythmCapacityMin || 0),
    freeMin: Number(stats.rhythmFreeMin || 0),
    tone: 'ok',
    label: 'Normal'
  };

  const urgentHtml = outputFlags.activities
    ? (allFilteredActivities.length
      ? allFilteredActivities.map(a=>{
          const range = a.startDate === a.endDate ? fmtDate(a.startDate) : `${fmtDate(a.startDate)} → ${fmtDate(a.endDate)}`;
          const hour = a.startHour && a.endHour ? ` · ${a.startHour}-${a.endHour}` : '';
          const cls = a.overdue ? 'urgent' : (a.pending ? 'warn' : 'ok');
          const statusLabel = a.done ? 'Finalizado' : (a.status || (a.pending ? 'Pendiente' : 'Programado'));
          return `<li class="brief-item ${cls}">
            <div class="t">${esc(a.taskName || 'Actividad')}</div>
            <div class="m">${esc(a.ownerName || 'Sin responsable')} · ${esc(a.projectName || 'Sin proyecto')}</div>
            <div class="m">${esc(range + hour)} · ${esc(statusLabel)}</div>
          </li>`;
        }).join('')
      : `<li class="brief-empty">No hay actividades para este criterio.</li>`)
    : `<li class="brief-empty">Bloque Actividades no incluido en SALIDA.</li>`;

  const notifHtml = !outputFlags.notifications
    ? `<li class="brief-empty">Bloque Notificaciones no incluido en SALIDA.</li>`
    : (topNotifs.length
      ? topNotifs.map(n=>{
          const when = n.remindDate ? formatNotificationReminder(n) : 'Sin fecha';
          const cls = n.due ? 'urgent' : 'warn';
          const st = n.done ? 'Atendida' : (n.due ? 'Por fecha' : 'Pendiente');
          return `<li class="brief-item ${cls}">
            <div class="t">${esc(n.title || 'Notificación')}</div>
            <div class="m">${esc(n.targetName || 'Equipo')} · ${esc(st)}</div>
            <div class="m">${esc(when)}</div>
          </li>`;
        }).join('')
      : `<li class="brief-empty">No hay recordatorios para este rango.</li>`);

  const rhythmPct = Math.max(0, Number(rhythm.pct || 0));
  const rhythmBarPct = Math.min(100, rhythmPct);
  const rhythmTitle = filters?.scope === 'individual' ? 'Ritmo de trabajo individual' : 'Ritmo de trabajo del equipo';

  const barsHtml = `
    <div class="brief-bars">
      <div class="brief-bar">
        <div class="brief-bar-head">
          <span>${esc(rhythmTitle)}</span>
          <span>${Math.round(rhythmPct)}%</span>
        </div>
        <div class="brief-bar-track"><span style="width:${rhythmBarPct}%"></span></div>
      </div>
    </div>
    <div class="brief-next">
      <div class="t">${esc(fmtH(Number(rhythm.plannedMin || 0)))} de ${esc(fmtH(Number(rhythm.capacityMin || 0)))} planificado</div>
      <div class="m">Capacidad libre: ${esc(fmtH(Number(rhythm.freeMin || 0)))} · ${esc(rhythm.label || 'Normal')}</div>
    </div>`;

  const nextStep = !selectedOutputs.length
    ? 'Activa al menos un bloque en SALIDA para definir prioridades.'
    : totalPending > 0
      ? ((outputFlags.notifications && Number(stats.dueNotifications || 0) > 0)
          ? 'Primero atiende recordatorios por fecha. Luego libera actividades demoradas.'
          : 'Prioriza pendientes del flujo principal y confirma bloque de trabajo hoy.')
      : 'Sin pendientes críticos. Mantén revisión breve diaria y control semanal.';

  root.innerHTML = `
    <section class="brief-hero">
      <div>
        <h4>Briefing operativo</h4>
        <div class="brief-meta">${esc(scopeLabel)} · ${esc(periodText)} · Generado ${esc(details.generatedAt || '')}</div>
        <div class="brief-tags">
          <span class="brief-tag">${esc(details.modeLabel || 'Resumen')}</span>
          <span class="brief-tag">${esc(filterText)}</span>
          <span class="brief-tag">Salida: ${esc(outputText)}</span>
        </div>
      </div>
      <div class="brief-score">
        <div class="n">${Number(totalPending || 0)}</div>
        <div class="l">pendientes en foco</div>
      </div>
    </section>

    <section class="brief-grid">
      <article class="brief-card">
        <h5><i class="fa-solid fa-bolt" aria-hidden="true"></i> Atención inmediata</h5>
        <div class="brief-scroll brief-scroll-activities"><ul class="brief-list">${urgentHtml}</ul></div>
      </article>

      <article class="brief-card">
        <h5><i class="fa-regular fa-bell" aria-hidden="true"></i> Recordatorios</h5>
        <div class="brief-scroll brief-scroll-reminders"><ul class="brief-list">${notifHtml}</ul></div>
      </article>

      <article class="brief-card">
        <h5><i class="fa-solid fa-chart-simple" aria-hidden="true"></i> Ritmo de trabajo</h5>
        ${barsHtml}
      </article>

      <article class="brief-card">
        <h5><i class="fa-solid fa-compass" aria-hidden="true"></i> Siguiente paso</h5>
        <div class="brief-next">
          <div class="t">${esc(nextStep)}</div>
          <div class="m">Tip: usa “Pendientes semana” para lectura rápida en el trayecto.</div>
        </div>
      </article>
    </section>
  `;
}

function getSummaryFiltersFromControls(){
    const scope = String($('summaryScope')?.value || ui.summaryScope || 'team');
    let userId = String($('summaryUser')?.value || ui.summaryUser || '');
    const rangeMode = String($('summaryRange')?.value || ui.summaryRange || 'day');

    ui.summaryScope = scope;
    ui.summaryRange = rangeMode;
    ui.summaryGroupBy = String($('summaryGroupBy')?.value || ui.summaryGroupBy || 'owner');
    ui.summarySortBy = String($('summarySortBy')?.value || ui.summarySortBy || 'date');
    ui.summaryClient = String($('summaryClient')?.value || ui.summaryClient || '');
    ui.summaryPriority = String($('summaryPriority')?.value || ui.summaryPriority || '');
    ui.summaryStatus = String($('summaryStatus')?.value || ui.summaryStatus || '');
    ui.summaryQuery = String($('summaryQuery')?.value || ui.summaryQuery || '').trim();
    ui.summaryIncludeActivities = Boolean($('summaryIncludeActivities')?.checked);
    ui.summaryIncludeProjects = Boolean($('summaryIncludeProjects')?.checked);
    ui.summaryIncludeNotifications = Boolean($('summaryIncludeNotifications')?.checked);
    ui.summaryIncludeDoneActivities = Boolean($('summaryIncludeDoneActivities')?.checked);
    ui.summaryIncludeDoneNotifications = Boolean($('summaryIncludeDoneNotifications')?.checked);
    ui.summaryOnlyDueNotifications = Boolean($('summaryOnlyDueNotifications')?.checked);
    ui.summaryFrom = normalizeISO($('summaryFrom')?.value || ui.summaryFrom || '') || (normalizeISO(ui.date) || todayISO());
    ui.summaryTo = normalizeISO($('summaryTo')?.value || ui.summaryTo || '') || ui.summaryFrom;

    if(scope === 'individual' && !userId){
      userId = state.team?.[0]?.id || '';
      ui.summaryUser = userId;
    }else{
      ui.summaryUser = userId;
    }

    return {
      scope,
      userId,
      rangeMode,
      groupBy: ui.summaryGroupBy,
      sortBy: ui.summarySortBy,
      client: ui.summaryClient,
      priority: ui.summaryPriority,
      status: ui.summaryStatus,
      query: ui.summaryQuery,
      includeActivities: ui.summaryIncludeActivities,
      includeProjects: ui.summaryIncludeProjects,
      includeNotifications: ui.summaryIncludeNotifications,
      includeDoneActivities: ui.summaryIncludeDoneActivities,
      includeDoneNotifications: ui.summaryIncludeDoneNotifications,
      onlyDueNotifications: ui.summaryOnlyDueNotifications,
      notificationRangeOnly: true
    };
  }

  function syncSummaryOptionAvailability(){
    const includeActivities = Boolean($('summaryIncludeActivities')?.checked);
    const includeProjects = Boolean($('summaryIncludeProjects')?.checked);
    const includeNotifications = Boolean($('summaryIncludeNotifications')?.checked);

    const doneActivities = $('summaryIncludeDoneActivities');
    if(doneActivities){
      doneActivities.disabled = !(includeActivities || includeProjects);
    }

    const doneNotifications = $('summaryIncludeDoneNotifications');
    const onlyDueNotifications = $('summaryOnlyDueNotifications');
    [doneNotifications, onlyDueNotifications].forEach(ctrl=>{
      if(ctrl) ctrl.disabled = !includeNotifications;
    });
  }


  function updateSummaryPreview(){
    const filters = getSummaryFiltersFromControls();
    const result = buildAdvancedSummaryReport(filters);

    const out = $('summaryOutput');
    if(out) out.value = result.text;

    renderSummaryKpis(result.stats);
    renderSummaryReadable(result, filters);

    const footer = $('summaryFooterNote');
    if(footer){
      const scopeLabel = filters.scope === 'individual'
        ? `Individual: ${findTeam(filters.userId)?.name || 'N/A'}`
        : 'Equipo completo';

      footer.textContent = `${scopeLabel} · ${result.stats.range} · Actividades ${result.stats.activities} · Proyectos ${result.stats.projects} · Notificaciones ${result.stats.notifications}`;
    }
  }

  function renderSummaryModal(){
    ensureSummaryState();

    const body = $('summaryBody');
    if(!body) return;

    const users = state.team.slice();
    const clients = Array.from(new Set(
      state.projects.map(p=>String(p?.client || 'Interno').trim() || 'Interno')
    )).sort((a,b)=>a.localeCompare(b, APP_LOCALE, { sensitivity:'base' }));

    const { startDate, endDate } = resolveSummaryDateRange(ui.summaryRange);
    if(ui.summaryRange !== 'custom'){
      ui.summaryFrom = startDate;
      ui.summaryTo = endDate;
    }

    const userOpts = [
      `<option value="">Todos</option>`,
      ...users.map(u=>`<option value="${esc(u.id)}" ${ui.summaryUser===u.id?'selected':''}>${esc(u.name)}</option>`)
    ].join('');

    const isHighPreset = (
      ui.summaryScope === 'team' &&
      !ui.summaryUser &&
      ui.summaryRange === 'day' &&
      ui.summaryPriority === 'Alta' &&
      !ui.summaryClient &&
      !ui.summaryStatus &&
      !ui.summaryQuery &&
      ui.summaryIncludeActivities &&
      !ui.summaryIncludeProjects &&
      !ui.summaryIncludeNotifications
    );
    const activePreset = isHighPreset ? 'high' : (ui.summaryRange === 'day' ? 'today' : (ui.summaryRange === 'week' ? 'week' : ''));

    body.innerHTML = `
  <div class="summary-workspace">
    <section class="summary-command">
      <div class="summary-preset-strip">
        <button class="summary-preset ${activePreset==='week'?'active':''}" data-summary-preset="week">Semana</button>
        <button class="summary-preset ${activePreset==='today'?'active':''}" data-summary-preset="today">Hoy</button>
        <button class="summary-preset ${activePreset==='high'?'active':''}" data-summary-preset="high">ALTA</button>
        <button class="btn summary-reset-inline" id="btnSummaryResetFilters">Limpiar filtros</button>
      </div>
    </section>

    <div class="summary-layout">
      <aside class="summary-panel">
        <details id="summaryFiltersDetails" ${ui.summaryFiltersOpen ? 'open' : ''}>
          <summary>
            <span>Filtros y parámetros</span>
            <span class="summary-panel-hint">Despliega para ajustar</span>
          </summary>
          <div class="summary-panel-body">
            <div class="summary-filter-grid">
              <label class="sum-field">
                <span>Ámbito</span>
                <select class="ctrl" id="summaryScope">
                  <option value="team" ${ui.summaryScope==='team'?'selected':''}>Equipo</option>
                  <option value="individual" ${ui.summaryScope==='individual'?'selected':''}>Individual</option>
                </select>
              </label>

              <label class="sum-field">
                <span>Usuario</span>
                <select class="ctrl" id="summaryUser">${userOpts}</select>
              </label>

              <label class="sum-field">
                <span>Periodo</span>
                <select class="ctrl" id="summaryRange">
                  <option value="day" ${ui.summaryRange==='day'?'selected':''}>Día</option>
                  <option value="week" ${ui.summaryRange==='week'?'selected':''}>Semana</option>
                  <option value="month" ${ui.summaryRange==='month'?'selected':''}>Mes</option>
                  <option value="custom" ${ui.summaryRange==='custom'?'selected':''}>Personalizado</option>
                </select>
              </label>

              <label class="sum-field">
                <span>Equipo</span>
                <select class="ctrl" id="summaryClient">
                  <option value="">Todos</option>
                  ${clients.map(c=>`<option value="${esc(c)}" ${ui.summaryClient===c?'selected':''}>${esc(c)}</option>`).join('')}
                </select>
              </label>

              <label class="sum-field">
                <span>Desde</span>
                <input class="ctrl" id="summaryFrom" type="date" value="${esc(ui.summaryFrom || startDate)}" ${ui.summaryRange==='custom' ? '' : 'disabled'} />
              </label>

              <label class="sum-field">
                <span>Hasta</span>
                <input class="ctrl" id="summaryTo" type="date" value="${esc(ui.summaryTo || endDate)}" ${ui.summaryRange==='custom' ? '' : 'disabled'} />
              </label>

              <label class="sum-field">
                <span>Prioridad</span>
                <select class="ctrl" id="summaryPriority">
                  <option value="">Todas</option>
                  ${PRIORITIES.map(p=>`<option value="${esc(p)}" ${ui.summaryPriority===p?'selected':''}>${esc(p)}</option>`).join('')}
                </select>
              </label>

              <label class="sum-field">
                <span>Estado</span>
                <select class="ctrl" id="summaryStatus">
                  <option value="">Todos</option>
                  ${((typeof STATUSES!=='undefined' && Array.isArray(STATUSES)) ? STATUSES : AUTO_STATUSES).map(s=>`<option value="${esc(s)}" ${ui.summaryStatus===s?'selected':''}>${esc(s.replaceAll('_',' '))}</option>`).join('')}
                </select>
              </label>

              <label class="sum-field">
                <span>Agrupar</span>
                <select class="ctrl" id="summaryGroupBy">
                  <option value="owner" ${ui.summaryGroupBy==='owner'?'selected':''}>Responsable</option>
                  <option value="project" ${ui.summaryGroupBy==='project'?'selected':''}>Proyecto</option>
                  <option value="priority" ${ui.summaryGroupBy==='priority'?'selected':''}>Prioridad</option>
                  <option value="status" ${ui.summaryGroupBy==='status'?'selected':''}>Estado</option>
                </select>
              </label>

              <label class="sum-field">
                <span>Orden</span>
                <select class="ctrl" id="summarySortBy">
                  <option value="date" ${ui.summarySortBy==='date'?'selected':''}>Fecha</option>
                  <option value="priority" ${ui.summarySortBy==='priority'?'selected':''}>Prioridad</option>
                  <option value="owner" ${ui.summarySortBy==='owner'?'selected':''}>Responsable</option>
                </select>
              </label>

              <label class="sum-field wide">
                <span>Búsqueda</span>
                <input class="ctrl" id="summaryQuery" type="search" placeholder="Proyecto, tarea, detalle..." value="${esc(ui.summaryQuery || '')}" />
              </label>
            </div>

            <div class="summary-checkgroups">
              <div class="summary-checkgroup">
                <div class="title">Salida</div>
                <div class="summary-checkline">
                  <label><input id="summaryIncludeActivities" type="checkbox" ${ui.summaryIncludeActivities?'checked':''} /> Actividades</label>
                  <label><input id="summaryIncludeProjects" type="checkbox" ${ui.summaryIncludeProjects?'checked':''} /> Proyectos</label>
                  <label><input id="summaryIncludeNotifications" type="checkbox" ${ui.summaryIncludeNotifications?'checked':''} /> Notificaciones</label>
                </div>
              </div>

              <div class="summary-checkgroup">
                <div class="title">Opciones</div>
                <div class="summary-checkline">
                  <label><input id="summaryIncludeDoneActivities" type="checkbox" ${ui.summaryIncludeDoneActivities?'checked':''} /> Finalizadas</label>
                  <label><input id="summaryIncludeDoneNotifications" type="checkbox" ${ui.summaryIncludeDoneNotifications?'checked':''} /> Atendidas</label>
                  <label><input id="summaryOnlyDueNotifications" type="checkbox" ${ui.summaryOnlyDueNotifications?'checked':''} /> Solo por fecha</label>
                </div>
              </div>
            </div>
          </div>
        </details>
      </aside>

      <main class="summary-main">
        <section id="summaryKpis" class="summary-kpis"></section>
        <section id="summaryReadable" class="summary-readable"></section>
        <details class="summary-plain-wrap">
          <summary>Texto plano para copiar / compartir</summary>
          <textarea id="summaryOutput" class="summary-output" spellcheck="false" aria-label="Salida del reporte"></textarea>
        </details>
      </main>
    </div>
  </div>
`;

    const controls = [
      'summaryScope','summaryUser','summaryRange','summaryFrom','summaryTo','summaryGroupBy','summarySortBy',
      'summaryClient','summaryPriority','summaryStatus','summaryQuery',
      'summaryIncludeActivities','summaryIncludeProjects','summaryIncludeNotifications',
      'summaryIncludeDoneActivities','summaryIncludeDoneNotifications','summaryOnlyDueNotifications'
    ].map(id=>$(id)).filter(Boolean);

    const detailsCtrl = $('summaryFiltersDetails');
    if(detailsCtrl){
      detailsCtrl.addEventListener('toggle', ()=>{
        ui.summaryFiltersOpen = detailsCtrl.open;
      });
    }

    let summaryDebounceTimer = null;
    const debounced = ()=>{
      if(summaryDebounceTimer) clearTimeout(summaryDebounceTimer);
      summaryDebounceTimer = setTimeout(()=>{
        syncSummaryOptionAvailability();
        updateSummaryPreview();
      }, 90);
    };

    controls.forEach(ctrl=>{
      const evt = (ctrl.type === 'search' || ctrl.tagName === 'INPUT') ? 'input' : 'change';
      ctrl.addEventListener(evt, ()=>{
        if(ctrl.id === 'summaryRange'){
          const isCustom = ctrl.value === 'custom';
          if($('summaryFrom')) $('summaryFrom').disabled = !isCustom;
          if($('summaryTo')) $('summaryTo').disabled = !isCustom;

          if(!isCustom){
            const r = resolveSummaryDateRange(ctrl.value);
            if($('summaryFrom')) $('summaryFrom').value = r.startDate;
            if($('summaryTo')) $('summaryTo').value = r.endDate;
            ui.summaryFrom = r.startDate;
            ui.summaryTo = r.endDate;
          }
        }
        debounced();
      });

      if(ctrl.id === 'summaryQuery'){
        ctrl.addEventListener('change', debounced);
        ctrl.addEventListener('search', debounced);
        ctrl.addEventListener('keyup', debounced);
      }
    });

    document.querySelectorAll('[data-summary-preset]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const preset = String(btn.getAttribute('data-summary-preset') || '');
        if(!preset) return;

        if(preset === 'today'){
          ui.summaryScope = 'team';
          ui.summaryUser = '';
          ui.summaryRange = 'day';
          ui.summaryGroupBy = 'owner';
          ui.summarySortBy = 'date';
          ui.summaryClient = '';
          ui.summaryPriority = '';
          ui.summaryStatus = '';
          ui.summaryQuery = '';
          ui.summaryIncludeActivities = true;
          ui.summaryIncludeProjects = true;
          ui.summaryIncludeNotifications = true;
          ui.summaryOnlyDueNotifications = false;
          ui.summaryIncludeDoneActivities = false;
          ui.summaryIncludeDoneNotifications = false;
        }else if(preset === 'week'){
          ui.summaryScope = 'team';
          ui.summaryUser = '';
          ui.summaryRange = 'week';
          ui.summaryGroupBy = 'owner';
          ui.summarySortBy = 'date';
          ui.summaryClient = '';
          ui.summaryPriority = '';
          ui.summaryStatus = '';
          ui.summaryQuery = '';
          ui.summaryIncludeActivities = true;
          ui.summaryIncludeProjects = true;
          ui.summaryIncludeNotifications = true;
          ui.summaryOnlyDueNotifications = false;
          ui.summaryIncludeDoneActivities = false;
          ui.summaryIncludeDoneNotifications = false;
        }else if(preset === 'high'){
          ui.summaryScope = 'team';
          ui.summaryUser = '';
          ui.summaryRange = 'day';
          ui.summaryGroupBy = 'owner';
          ui.summarySortBy = 'date';
          ui.summaryClient = '';
          ui.summaryPriority = 'Alta';
          ui.summaryStatus = '';
          ui.summaryQuery = '';
          ui.summaryIncludeActivities = true;
          ui.summaryIncludeProjects = false;
          ui.summaryIncludeNotifications = false;
          ui.summaryIncludeDoneActivities = true;
          ui.summaryIncludeDoneNotifications = false;
          ui.summaryOnlyDueNotifications = false;
        }

        renderSummaryModal();
      });
    });

    $('btnSummaryResetFilters')?.addEventListener('click', ()=>{
      ui.summaryScope = 'team';
      ui.summaryUser = '';
      ui.summaryRange = 'week';
      ui.summaryFrom = normalizeISO(ui.date) || todayISO();
      ui.summaryTo = ui.summaryFrom;
      ui.summaryGroupBy = 'owner';
      ui.summarySortBy = 'date';
      ui.summaryClient = '';
      ui.summaryPriority = '';
      ui.summaryStatus = '';
      ui.summaryQuery = '';
      ui.summaryIncludeActivities = true;
      ui.summaryIncludeProjects = true;
      ui.summaryIncludeNotifications = true;
      ui.summaryIncludeDoneActivities = false;
      ui.summaryIncludeDoneNotifications = false;
      ui.summaryOnlyDueNotifications = false;
      ui.summaryFiltersOpen = false;
      renderSummaryModal();
    });

    const copyBtn = $('btnSummaryCopy');
    if(copyBtn){
      copyBtn.onclick = async ()=>{
        const txt = String($('summaryOutput')?.value || '').trim();
        if(!txt){
          toast('No hay contenido para copiar.');
          return;
        }
        try{
          await navigator.clipboard.writeText(txt);
          toast('Reporte copiado al portapapeles.');
        }catch(_){
          const area = $('summaryOutput');
          if(area){
            area.focus();
            area.select();
            document.execCommand('copy');
            toast('Reporte copiado.');
          }else{
            toast('No se pudo copiar automáticamente.');
          }
        }
      };
    }

    syncSummaryOptionAvailability();
    updateSummaryPreview();
  }

function buildDaySummaryText(dayISO=ui.date){
    const selectedDate = normalizeISO(dayISO) || todayISO();
    const d = parseISO(selectedDate);
    const dateObj = Number.isNaN(d.getTime()) ? new Date() : d;

    const dd = String(dateObj.getDate()).padStart(2,'0');
    const mm = String(dateObj.getMonth()+1).padStart(2,'0');
    const yyyy = dateObj.getFullYear();
    const weekday = dateObj.toLocaleDateString(APP_LOCALE, { weekday:'long' })
      .replace(/^./, c=>c.toUpperCase());

    const teamList = Array.isArray(state?.team) ? state.team.slice() : [];
    const teamById = new Map(teamList.map(p=>[String(p.id), p]));
    const ownerOrder = new Map(teamList.map((p,i)=>[String(p.id), i]));

    const normalizeKey = (v='') => String(v || '')
      .normalize('NFD')
      .replace(/[̀-ͯ]/g, '')
      .trim()
      .toLowerCase();

    const ownerNameById = new Map(teamList.map(t => [String(t.id), String(t.name || '').trim()]));
    const ownerNameFor = (ownerId) => ownerNameById.get(String(ownerId || '').trim()) || '';

    const weekScope = teamModalWeekBounds(selectedDate, Number(ui.teamWeekOffset || 0));

    const focusCandidateRows = [];
    (state.projects || []).forEach((p)=>{
      const acts = Array.isArray(p?.activities) ? p.activities : [];
      const hasExplicitFocus = acts.some(a=>Boolean(a?.primaryFocus));

      acts.forEach((a)=>{
        if(!a?.primaryFocus) return;
        const ownerId = String(a?.ownerId || '').trim();
        if(!ownerId) return;

        const s = normalizeISO(a.startDate) || normalizeISO(p?.startDate) || weekScope.start;
        const e = normalizeISO(a.endDate) || normalizeISO(p?.endDate) || s;
        focusCandidateRows.push({
          ownerId,
          projectId: String(p?.id || ''),
          projectName: String(p?.name || ''),
          inWeek: (e >= weekScope.start && s <= weekScope.end) ? 1 : 0,
          priority: priorityRank(p?.priority || 'Media'),
          startDate: s
        });
      });

      // Compatibilidad retroactiva: foco legado a nivel proyecto.
      if(!hasExplicitFocus && Boolean(p?.isPrimaryFocus)){
        const fallbackOwner = String(p?.leaderId || acts?.[0]?.ownerId || '').trim();
        if(fallbackOwner){
          const s = normalizeISO(p?.startDate) || weekScope.start;
          const e = normalizeISO(p?.endDate) || s;
          focusCandidateRows.push({
            ownerId: fallbackOwner,
            projectId: String(p?.id || ''),
            projectName: String(p?.name || ''),
            inWeek: (e >= weekScope.start && s <= weekScope.end) ? 1 : 0,
            priority: priorityRank(p?.priority || 'Media'),
            startDate: s
          });
        }
      }
    });

    focusCandidateRows.sort((a,b)=>
      (b.inWeek - a.inWeek) ||
      (a.priority - b.priority) ||
      String(a.startDate).localeCompare(String(b.startDate))
    );

    const focusProjectByOwner = new Map();
    focusCandidateRows.forEach(row=>{
      if(!row.ownerId || !row.projectName) return;
      if(!focusProjectByOwner.has(row.ownerId)){
        focusProjectByOwner.set(row.ownerId, {
          projectId: String(row.projectId || ''),
          projectName: String(row.projectName || '')
        });
      }
    });

    const resolveFocusLabel = (ownerId, ownerName='') => {
      const oid = String(ownerId || '').trim();
      const byId = focusProjectByOwner.get(oid);
      if(byId?.projectName) return byId.projectName;

      const memberNameKey = normalizeKey(ownerName || ownerNameFor(oid));
      if(memberNameKey){
        for(const [id, focusData] of focusProjectByOwner.entries()){
          const ownerNameKey = normalizeKey(ownerNameFor(id));
          if(ownerNameKey && (ownerNameKey === memberNameKey || ownerNameKey.includes(memberNameKey) || memberNameKey.includes(ownerNameKey))){
            return focusData?.projectName || 'Sin foco principal definido';
          }
        }
      }
      return 'Sin foco principal definido';
    };

    const activities = getVisibleActivityInstances(selectedDate)
      .slice()
      .sort((a,b)=>{
        const idxA = ownerOrder.has(String(a.ownerId || '')) ? ownerOrder.get(String(a.ownerId || '')) : Number.MAX_SAFE_INTEGER;
        const idxB = ownerOrder.has(String(b.ownerId || '')) ? ownerOrder.get(String(b.ownerId || '')) : Number.MAX_SAFE_INTEGER;
        return (
          idxA - idxB ||
          String(a.startHour || '').localeCompare(String(b.startHour || '')) ||
          String(a.endHour || '').localeCompare(String(b.endHour || '')) ||
          String(a.projectName || '').localeCompare(String(b.projectName || ''), APP_LOCALE) ||
          String(a.taskName || '').localeCompare(String(b.taskName || ''), APP_LOCALE)
        );
      });

    const statusCount = { Programado:0, 'En curso':0, Demorado:0, Finalizado:0 };
    const prioCount = { Alta:0, Media:0, Baja:0 };

    activities.forEach(a=>{
      if(Object.prototype.hasOwnProperty.call(statusCount,a.status)) statusCount[a.status]++;
      const p = PRIORITIES.includes(a.priority) ? a.priority : 'Media';
      prioCount[p]++;
    });

    const byOwnerActs = new Map();
    teamList.forEach(person=>byOwnerActs.set(String(person.id), []));

    activities.forEach(a=>{
      const oid = String(a.ownerId || '').trim();
      const key = oid || `__name__:${normalizeKey(a.ownerName || 'Sin responsable')}`;
      if(!byOwnerActs.has(key)) byOwnerActs.set(key, []);
      byOwnerActs.get(key).push(a);
    });

    for(const arr of byOwnerActs.values()){
      arr.sort((x,y)=>
        String(x.startHour || '').localeCompare(String(y.startHour || '')) ||
        String(x.endHour || '').localeCompare(String(y.endHour || '')) ||
        String(x.projectName || '').localeCompare(String(y.projectName || ''), APP_LOCALE) ||
        String(x.taskName || '').localeCompare(String(y.taskName || ''), APP_LOCALE)
      );
    }

    const ownerEntries = Array.from(byOwnerActs.entries())
      .map(([ownerKey, acts])=>{
        const ownerId = String(ownerKey).startsWith('__name__:') ? '' : String(ownerKey);
        const fallbackName = acts[0]?.ownerName || 'Sin responsable';
        const ownerName = teamById.get(ownerId)?.name || fallbackName;
        const ord = ownerOrder.has(ownerId) ? ownerOrder.get(ownerId) : Number.MAX_SAFE_INTEGER;
        return { ownerId, acts, ownerName, ord };
      })
      .sort((a,b)=> a.ord - b.ord || String(a.ownerName || '').localeCompare(String(b.ownerName || ''), APP_LOCALE));

    const SEP = '────────────────────────';
    const lines = [];

    lines.push('*ACTIVIDADES | RESUMEN DIARIO*');
    lines.push(`Fecha: ${dd}/${mm}/${yyyy}${weekday ? ` (${weekday})` : ''}`);
    lines.push(SEP);
    lines.push('*PANORAMA*');
    lines.push(`• Actividades programadas: ${activities.length}`);
    lines.push(`• Prioridad: Alta ${prioCount.Alta} | Media ${prioCount.Media} | Baja ${prioCount.Baja}`);
    lines.push(`• Estatus: Programado ${statusCount['Programado']} | En curso ${statusCount['En curso']} | Demorado ${statusCount['Demorado']} | Finalizado ${statusCount['Finalizado']}`);
    lines.push(SEP);
    lines.push('*DETALLE POR RESPONSABLE*');

    if(!ownerEntries.length){
      lines.push('• SIN RESPONSABLES — Foco: Sin foco principal definido');
      lines.push('- Sin actividades asignadas');
      return lines.join('\n').replace(/[ \t]+\n/g, '\n').replace(/\n{3,}/g, '\n\n').trim();
    }

    ownerEntries.forEach(({acts, ownerName, ownerId}, idx)=>{
      const owner = String(ownerName || 'Sin responsable').toUpperCase();
      const focusLabel = resolveFocusLabel(ownerId, ownerName);
      lines.push(`• ${owner} — Foco: ${focusLabel}`);

      if(!acts.length){
        lines.push('- Sin actividades asignadas');
      }else{
        acts.forEach(a=>{
          const pri = PRIORITIES.includes(a.priority) ? a.priority : 'Media';
          const proj = String(a.projectName || 'Proyecto sin nombre').replace(/\s*\|\s*/g, ' / ');
          const task = String(a.taskName || 'Actividad').replace(/\s*\|\s*/g, ' / ');
          lines.push(`- ${a.startHour}-${a.endHour} | ${proj} | ${task} | Prioridad: ${pri}`);
        });
      }

      if(idx < ownerEntries.length - 1) lines.push('');
    });

    return lines.join('\n').replace(/[ \t]+\n/g, '\n').replace(/\n{3,}/g, '\n\n').trim();
  }



  function updateRoleUI(){

    const actions = document.querySelector('.actions');
    if(!actions) return;

    // Se elimina visualmente el badge de modo (lectura/admin) en actions.
    const badge = $('modeBadge');
    if(badge?.parentNode) badge.parentNode.removeChild(badge);

    let teamBtn = $('btnTeam');
    if(!teamBtn){
      teamBtn = document.createElement('button');
      teamBtn.id = 'btnTeam';
      teamBtn.className = 'btn';
      teamBtn.type = 'button';
      teamBtn.textContent = 'Equipo';
      teamBtn.title = 'Ver estructura y actividades del equipo';
      teamBtn.setAttribute('aria-label', 'Equipo');
      teamBtn.addEventListener('click', openTeamModal);
    }
    teamBtn.onclick = openTeamModal;

    let copyBtn = $('btnCopyDaySummary');
    if(!copyBtn){
      copyBtn = document.createElement('button');
      copyBtn.id = 'btnCopyDaySummary';
      copyBtn.className = 'btn';
      copyBtn.type = 'button';
      copyBtn.textContent = 'Resumen';
      copyBtn.title = 'Abrir generador de reportes';
      copyBtn.addEventListener('click', copySelectedDaySummary);
    }
    copyBtn.onclick = copySelectedDaySummary;

    let agendaBtn = $('btnAgenda');
    if(!agendaBtn){
      agendaBtn = document.createElement('button');
      agendaBtn.id = 'btnAgenda';
      agendaBtn.className = 'btn';
      agendaBtn.type = 'button';
      agendaBtn.textContent = 'Agenda';
      agendaBtn.title = 'Abrir agenda del día seleccionado';
      agendaBtn.addEventListener('click', ()=> openMonthDayModal(normalizeISO(ui.date) || todayISO()));
    }

    const manageBtn = $('btnManage');
    const addBtn = $('btnAdd');
    const themeBtn = $('btnTheme');
    const infoBtn = $('btnInfo');
    const reloadBtn = $('btnReload');

    if(manageBtn){
      manageBtn.classList.add('icon');
      manageBtn.innerHTML = '<i class="fa-solid fa-gear" aria-hidden="true"></i>';
      const cfgLabel = isAdmin() ? 'Administrar' : 'Ver configuración';
      manageBtn.title = cfgLabel;
      manageBtn.setAttribute('aria-label', cfgLabel);
    }

    if(addBtn){
      addBtn.style.display = isAdmin() ? '' : 'none';
    }

    // Orden estable de actions:
    // - Fila 1 (móvil): Equipo + Resumen
    // - Fila 2 (móvil): Agenda + grupo de íconos (50/50)
    let iconGroup = actions.querySelector('.actions-icon-group');
    if(!iconGroup){
      iconGroup = document.createElement('div');
      iconGroup.className = 'actions-icon-group';
    }
    [manageBtn, themeBtn, infoBtn, reloadBtn].forEach((el)=>{
      if(el) iconGroup.appendChild(el);
    });

    [teamBtn, copyBtn, agendaBtn, iconGroup, addBtn].forEach((el)=>{
      if(el) actions.appendChild(el);
    });
  }

  function isAdmin(){ return ui.role === 'admin'; }

  function openTeamModal(){
    ui.teamWeekOffset = 0;
    renderTeamModal();
    openOverlay('teamOverlay');
  }

  function teamInitials(name){
    const parts = String(name || '').trim().split(/\s+/).filter(Boolean);
    if(!parts.length) return '??';
    if(parts.length === 1) return parts[0].slice(0,2).toUpperCase();
    return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
  }

  function teamModalWeekBounds(anchorISO, weekOffset = 0){
    const base = normalizeISO(anchorISO) || todayISO();
    const offset = Number(weekOffset || 0) * 7;
    const shifted = addDaysISO(base, offset);
    const start = startOfWeekISO(shifted);
    const end = addDaysISO(start, 6);
    return { start, end, offsetWeeks: Number(weekOffset || 0) };
  }

  function renderTeamModal(){
    const mount = $('teamMatrix');
    if(!mount) return;

    const board = sanitizeTeamBoard(state.teamBoard, state.team);
    state.teamBoard = board;

    const leader = board.leader;
    const members = board.members || [];

    const allActs = (state.projects || []).flatMap(p =>
      (p.activities || []).map(a => ({
        ...a,
        projectId: p.id || '',
        projectName: p.name || '',
        projectPriority: p.priority || '',
        projectClient: p.client || ''
      }))
    );

    const normalize = (v) => String(v || '').trim().toLowerCase();
    const normalizeKey = (v) => String(v || '')
      .normalize('NFD')
      .replace(/[̀-ͯ]/g, '')
      .trim()
      .toLowerCase();

    const ownerNameById = new Map((state.team || []).map(t => [String(t.id), String(t.name || '').trim()]));
    const ownerNameFor = (ownerId) => ownerNameById.get(String(ownerId)) || '';

    const nowIso = normalizeISO(ui.date) || toISO(new Date());
    const weekOffset = Number(ui.teamWeekOffset || 0);
    const weekScope = teamModalWeekBounds(nowIso, weekOffset);
    const horizonStartIso = weekScope.start;
    const horizonEndIso = weekScope.end;
    const horizonBusinessDays = Math.max(1, countBusinessDays(horizonStartIso, horizonEndIso));
    const weekLabel = `${fmtDate(horizonStartIso)} → ${fmtDate(horizonEndIso)}`;

    const asMoment = (a) => `${a.startDate || ''}T${a.startHour || '00:00'}`;

    const focusCandidateRows = [];
    (state.projects || []).forEach((p)=>{
      const acts = Array.isArray(p?.activities) ? p.activities : [];
      const hasExplicitFocus = acts.some(a=>Boolean(a?.primaryFocus));
      acts.forEach((a)=>{
        if(!a?.primaryFocus) return;
        focusCandidateRows.push({
          ownerId: String(a.ownerId || ''),
          projectId: String(p?.id || ''),
          projectName: String(p?.name || ''),
          inWeek: intersectsHorizon(a) ? 1 : 0,
          priority: priorityRank(p?.priority || 'Media'),
          startDate: normalizeISO(a.startDate) || normalizeISO(p?.startDate) || horizonStartIso
        });
      });

      // Compatibilidad retroactiva: proyectos antiguos con foco a nivel proyecto.
      if(!hasExplicitFocus && Boolean(p?.isPrimaryFocus)){
        const fallbackOwner = String(p?.leaderId || acts?.[0]?.ownerId || '');
        if(fallbackOwner){
          focusCandidateRows.push({
            ownerId: fallbackOwner,
            projectId: String(p?.id || ''),
            projectName: String(p?.name || ''),
            inWeek: dateRangesOverlap(
              normalizeISO(p?.startDate) || horizonStartIso,
              normalizeISO(p?.endDate) || normalizeISO(p?.startDate) || horizonStartIso,
              horizonStartIso,
              horizonEndIso
            ) ? 1 : 0,
            priority: priorityRank(p?.priority || 'Media'),
            startDate: normalizeISO(p?.startDate) || horizonStartIso
          });
        }
      }
    });

    focusCandidateRows.sort((a,b)=>
      (b.inWeek - a.inWeek) ||
      (a.priority - b.priority) ||
      String(a.startDate).localeCompare(String(b.startDate))
    );

    const focusProjectByOwner = new Map();
    focusCandidateRows.forEach(row=>{
      if(!row.ownerId || !row.projectName) return;
      if(!focusProjectByOwner.has(row.ownerId)){
        focusProjectByOwner.set(row.ownerId, {
          projectId: String(row.projectId || ''),
          projectName: row.projectName
        });
      }
    });

    function intersectsHorizon(a){
      const s = normalizeISO(a.startDate) || horizonStartIso;
      const e = normalizeISO(a.endDate) || s;
      return e >= horizonStartIso && s <= horizonEndIso;
    }

    const calcActMinutesInHorizon = (a)=>{
      const sh = normalizeHHMM(a.startHour, '09:00');
      const eh = normalizeHHMM(a.endHour, '10:00');
      const perDay = Math.max(30, durationMinutes(sh, eh));

      const rawS = normalizeISO(a.startDate) || horizonStartIso;
      const rawE = normalizeISO(a.endDate) || rawS;
      const s = maxISO(rawS, horizonStartIso);
      const e = minISO(rawE, horizonEndIso);
      if(e < s) return 0;

      const spanBusiness = Math.max(0, countBusinessDays(s, e));
      return perDay * spanBusiness;
    };

    const classifyLoad = (pct)=>{
      if(pct >= 95) return { label:'Alto flujo', tone:'red' };
      if(pct >= 70) return { label:'Flujo medio', tone:'amber' };
      return { label:'Flujo bajo', tone:'green' };
    };

    const teamProfiles = (state.team || []).map((t, i)=>({
      ...t,
      _idx:i,
      _nameKey: normalizeKey(t.name)
    }));

    const findTeamProfile = (member, idx)=>{
      const memberId = String(member?.id || '').trim();
      const mk = normalizeKey(member?.name);

      let found = memberId ? teamProfiles.find(t => String(t.id) === memberId) : null;
      if(found) return found;

      found = teamProfiles.find(t => t._nameKey === mk);
      if(found) return found;

      found = teamProfiles.find(t => t._nameKey && mk && (t._nameKey.includes(mk) || mk.includes(t._nameKey)));
      if(found) return found;

      return teamProfiles[idx] || null;
    };

    const insights = members.map((member, idx)=>{
      const profile = findTeamProfile(member, idx);
      const memberName = normalize(member.name);

      const ownActsAll = allActs
        .filter(a => {
          if(profile && profile.id) return String(a.ownerId || '') === String(profile.id);
          return normalize(ownerNameFor(a.ownerId)) === memberName;
        })
        .sort((a,b)=> asMoment(a).localeCompare(asMoment(b)));

      const ownActs = ownActsAll.filter(intersectsHorizon);

      const ownTotal = ownActs.length;
      const ownDone = ownActs.filter(a => !!a.done).length;
      const ownOpen = Math.max(0, ownTotal - ownDone);
      const ownCompletionPct = ownTotal ? Math.round((ownDone / ownTotal) * 100) : 0;

      const pendingActs = ownActs.filter(a => !a.done);
      const pendingMin = pendingActs.reduce((acc, a)=> acc + calcActMinutesInHorizon(a), 0);

      const fallbackCapPerDay = Number(state.settings.defaultCapacityHoursPerDay || 8);
      let horizonCapacityMin = 0;
      let blockedMin = 0;
      let dCap = horizonStartIso;
      while(dCap <= horizonEndIso){
        if(!isNonWorkingDayISO(dCap)){
          const capPerDay = Number(profile?.capacityHoursPerDay || fallbackCapPerDay || 8);
          const nominal = Math.max(0, capPerDay * 60);
          const blockedToday = profile ? Math.min(nominal, sumBlockedMinutes(profile, dCap)) : 0;
          blockedMin += blockedToday;
          horizonCapacityMin += Math.max(0, nominal - blockedToday);
        }
        dCap = addDaysISO(dCap, 1);
      }

      let loadPct = 0;
      let availabilityPct = 0;
      let load = { label:'Sin capacidad', tone:'red' };

      if(horizonCapacityMin > 0){
        loadPct = Math.max(0, Math.round((pendingMin / horizonCapacityMin) * 100));
        availabilityPct = clamp(100 - loadPct, 0, 100);
        load = classifyLoad(loadPct);
      }else{
        loadPct = pendingMin > 0 ? 200 : 100;
        availabilityPct = 0;
      }

      const ownInProgress = ownActs.filter(a => activityStatus(a) === 'En curso').length;
      const ownProgrammed = ownActs.filter(a => activityStatus(a) === 'Programado').length;

      const score = Math.round((ownCompletionPct * 0.65) + (Math.max(0, 100 - Math.min(loadPct, 130)) * 0.35));

      return {
        idx,
        member,
        profile,
        ownActs,
        ownTotal,
        ownDone,
        ownOpen,
        ownCompletionPct,
        pendingMin,
        blockedMin,
        horizonCapacityMin,
        loadPct,
        availabilityPct,
        loadLabel: load.label,
        loadTone: load.tone,
        ownInProgress,
        ownProgrammed,
        focusInfo: (() => {
          const ownerCandidates = [
            String(profile?.id || '').trim(),
            String(member?.id || '').trim()
          ].filter(Boolean);

          for(const oid of ownerCandidates){
            const v = focusProjectByOwner.get(oid);
            if(v?.projectName){
              return { label: v.projectName, projectId: String(v.projectId || '') };
            }
          }

          const memberNameKey = normalizeKey(member?.name || '');
          if(memberNameKey){
            for(const [oid, focusData] of focusProjectByOwner.entries()){
              const ownerNameKey = normalizeKey(ownerNameFor(oid));
              if(ownerNameKey && (ownerNameKey === memberNameKey || ownerNameKey.includes(memberNameKey) || memberNameKey.includes(ownerNameKey))){
                return { label: focusData?.projectName || 'Sin foco principal definido', projectId: String(focusData?.projectId || '') };
              }
            }
          }

          return { label:'Sin foco principal definido', projectId:'' };
        })(),
        score
      };
    });

    const scopedActs = insights.flatMap(x => x.ownActs);
    const totalActs = scopedActs.length;
    const doneActs = scopedActs.filter(a => !!a.done).length;
    const inProgressActs = scopedActs.filter(a => {
      if(a.done) return false;
      const st = normalize(a.status);
      if(st === 'en curso') return true;
      const s = normalizeISO(a.startDate) || horizonStartIso;
      const e = normalizeISO(a.endDate) || s;
      return s <= horizonEndIso && e >= horizonStartIso;
    }).length;
    const pendingActsTotal = scopedActs.filter(a => !a.done).length;
    const completionPct = totalActs ? Math.round((doneActs / totalActs) * 100) : 0;

    const scopedProjectIds = new Set(scopedActs.map(a => String(a.projectId || '').trim()).filter(Boolean));
    const scopedProjectNames = new Set(scopedActs.map(a => normalizeKey(a.projectName)).filter(Boolean));
    const scopedProjects = (state.projects || []).filter(p => {
      const pid = String(p.id || '').trim();
      const pname = normalizeKey(p.name);
      return (pid && scopedProjectIds.has(pid)) || (pname && scopedProjectNames.has(pname));
    });

    const highPriorityProjects = scopedProjects.filter(p => p.priority === 'Alta').length;
    const activeProjectsCount = scopedProjects.length;
    const clientCount = new Set(scopedProjects.map(p => String(p.client || '').trim()).filter(Boolean)).size;

    const ranking = insights.slice().sort((a,b)=> b.score - a.score || b.ownCompletionPct - a.ownCompletionPct || a.ownOpen - b.ownOpen);
    const rankMap = new Map(ranking.map((x, i)=>[x.member.id || `${x.idx}-${normalizeKey(x.member.name)}`, i + 1]));

    const topMember = ranking[0] || null;
    const overloadedCount = insights.filter(x => x.loadTone === 'red').length;
    const balancedCount = insights.filter(x => x.loadTone === 'amber').length;
    const availableCount = insights.filter(x => x.loadTone === 'green').length;
    const avgAvailability = insights.length
      ? Math.round(insights.reduce((acc,x)=>acc + x.availabilityPct, 0) / insights.length)
      : 0;

    const memberCards = insights.length
      ? insights.map((item)=>{
          const member = item.member;
          const responsibilities = (member.responsibilities || []).map(r=>`<li>${esc(r)}</li>`).join('');
          const respHtml = responsibilities
            ? `<ul>${responsibilities}</ul>`
            : `<div class="eq-resp-empty">Sin responsabilidades registradas.</div>`;

          const key = member.id || `${item.idx}-${normalizeKey(member.name)}`;
          const rank = rankMap.get(key) || 0;
          const loadWidth = clamp(item.loadPct, 0, 100);

          return `
            <article class="eq-member-card eq-member-tone eq-member-tone-${item.idx % 5}">
              <span class="eq-rank">#${rank}</span>
              <div class="eq-member-head">
                <div class="eq-avatar sm eq-tone-${item.idx % 5}">${esc(teamInitials(member.name))}</div>
                <div>
                  <div class="eq-member-name">${esc(member.name)}</div>
                  <div class="eq-member-role">${esc(member.role || 'Miembro')}</div>
                </div>
              </div>

              <div class="eq-member-metrics eq-member-metrics-3">
                <div class="eq-metric">
                  <div class="k">Actividades</div>
                  <div class="v">${item.ownTotal}</div>
                </div>
                <div class="eq-metric">
                  <div class="k">En curso</div>
                  <div class="v">${item.ownInProgress}</div>
                </div>
                <div class="eq-metric">
                  <div class="k">Programadas</div>
                  <div class="v">${item.ownProgrammed}</div>
                </div>
              </div>

              <div class="eq-load-wrap ${item.loadTone}">
                <div class="eq-load-label">
                  <span>Flujo semanal</span>
                  <b>${item.loadPct}%</b>
                </div>
                <div class="eq-load-bar"><span style="width:${loadWidth}%"></span></div>
                <div class="eq-load-sub">Disponibilidad estimada ${item.availabilityPct}% · ${esc(fmtH(item.pendingMin))} tareas · ${esc(fmtH(item.blockedMin || 0))} bloqueos</div>
              </div>

              <div class="eq-focus-main ${item.focusInfo?.projectId ? 'is-clickable' : ''}" ${item.focusInfo?.projectId ? `role="button" tabindex="0" data-focus-project-id="${esc(item.focusInfo.projectId)}" title="Ver detalle del proyecto"` : ''}>
                <div class="k">Foco principal</div>
                <div class="v">${esc(item.focusInfo?.label || 'Sin foco principal definido')}</div>
              </div>

              <div class="eq-resp-box">
                <div class="eq-resp-title">Responsabilidades</div>
                ${respHtml}
              </div>
            </article>
          `;
        }).join('')
      : `<div class="eq-empty">No hay miembros registrados. Configúralos en <b>Administrar → Equipo y Bloqueos</b> (solo modo administrador).</div>`;

    mount.innerHTML = `
      <section class="eq-shell">
        <section class="eq-week-nav">
          <button class="btn" id="eqWeekPrev" type="button"><span class="eq-week-label-long">← Semana anterior</span><span class="eq-week-label-short">← Anterior</span></button>
          <div class="eq-week-center">
            <div class="eq-week-kicker">Semana visible</div>
            <div class="eq-week-range">${weekLabel}</div>
          </div>
          <div class="eq-week-actions">
            <button class="btn" id="eqWeekToday" type="button"><span class="eq-week-label-long">Semana actual</span><span class="eq-week-label-short">Hoy</span></button>
            <button class="btn" id="eqWeekNext" type="button"><span class="eq-week-label-long">Semana siguiente →</span><span class="eq-week-label-short">Siguiente →</span></button>
          </div>
        </section>

        <section class="eq-hero-grid">
          <article class="eq-leader-card">
            <div class="eq-leader-main">
              <div class="eq-avatar eq-tone-0">${esc(teamInitials(leader.name))}</div>
              <div class="eq-leader-meta">
                <div class="eq-leader-name">${esc(leader.name)}</div>
                <div class="eq-leader-sub">${esc(leader.role || 'Líder')}</div>
              </div>
            </div>
            <div class="eq-leader-stats">
              <div class="eq-leader-stat">
                <div class="k">Frentes activos</div>
                <div class="v">${activeProjectsCount}</div>
              </div>
              <div class="eq-leader-stat">
                <div class="k">Semana visible</div>
                <div class="v">${weekLabel}</div>
              </div>
            </div>
          </article>

        </section>

        <section class="eq-group">
          <div class="eq-group-head">
            <div>
              <div class="eq-block-title">Miembros y responsabilidades</div>
              <div class="eq-block-sub">Vista semanal: navega semana a semana para comparar flujo y avance.</div>
            </div>
            <span class="eq-badge">${members.length} integrantes</span>
          </div>
          <div class="eq-manual-grid">${memberCards}</div>
        </section>
      </section>
    `;

    const prevWeekBtn = $('eqWeekPrev');
    const nextWeekBtn = $('eqWeekNext');
    const currentWeekBtn = $('eqWeekToday');

    if(prevWeekBtn){
      prevWeekBtn.addEventListener('click', ()=>{
        ui.teamWeekOffset = Number(ui.teamWeekOffset || 0) - 1;
        renderTeamModal();
      });
    }
    if(nextWeekBtn){
      nextWeekBtn.addEventListener('click', ()=>{
        ui.teamWeekOffset = Number(ui.teamWeekOffset || 0) + 1;
        renderTeamModal();
      });
    }
    if(currentWeekBtn){
      currentWeekBtn.addEventListener('click', ()=>{
        ui.teamWeekOffset = 0;
        renderTeamModal();
      });
    }

    mount.querySelectorAll('.eq-focus-main[data-focus-project-id]').forEach(box=>{
      const openFocusDetail = ()=>{
        const pid = String(box.dataset.focusProjectId || '').trim();
        if(!pid) return;
        openProjectDetail(pid);
      };
      box.addEventListener('click', openFocusDetail);
      box.addEventListener('keydown', (ev)=>{
        if(ev.key === 'Enter' || ev.key === ' '){
          ev.preventDefault();
          openFocusDetail();
        }
      });
    });
  }

  function safeParse(raw, fallback = null){
    try{
      if(raw === null || raw === undefined || raw === '') return fallback;
      return JSON.parse(raw);
    }catch(_e){
      return fallback;
    }
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) return JSON.parse(raw);

      for(const k of LEGACY_KEYS){
        const legacyRaw = localStorage.getItem(k);
        if(!legacyRaw) continue;
        try{
          const legacy = JSON.parse(legacyRaw);
          const migrated = migrateLegacyState(legacy);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
          return migrated;
        }catch(_err){}
      }

      return structuredClone(DEFAULT_STATE);
    }catch(_e){
      return structuredClone(DEFAULT_STATE);
    }
  }

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(_e){}
  }

  function loadHolidays(stateCandidate = null){
    try{
      const raw = safeParse(localStorage.getItem(HOLIDAYS_KEY));
      if(raw) return raw;
    }catch(_e){}

    if(Array.isArray(stateCandidate?.holidays)){
      return { version: HOLIDAYS_SCHEMA_VERSION, items: stateCandidate.holidays };
    }
    return structuredClone(DEFAULT_HOLIDAYS_STATE);
  }

  function saveHolidays(){
    try{ localStorage.setItem(HOLIDAYS_KEY, JSON.stringify(holidaysState)); }catch(_e){}
  }

  function sanitizeHolidayStore(raw){
    const base = (raw && typeof raw === 'object') ? raw : {};
    const arr = Array.isArray(base.items) ? base.items : (Array.isArray(raw) ? raw : []);
    const cleaned = [];
    const seen = new Set();

    arr.forEach((h, idx)=>{
      if(!h || typeof h !== 'object') return;
      const date = normalizeISO(h.date || h.day || h.fecha);
      if(!date) return;
      const id = String(h.id || `h_${date}_${idx+1}`);
      if(seen.has(id)) return;
      seen.add(id);
      const name = String(h.name || h.description || h.descripcion || h.title || 'Feriado').trim().slice(0,140) || 'Feriado';
      const active = h.active !== false && h.enabled !== false && h.estado !== 'inactivo';
      cleaned.push({ id, date, name, active });
    });

    cleaned.sort((a,b)=>a.date.localeCompare(b.date) || a.name.localeCompare(b.name));
    return { version: HOLIDAYS_SCHEMA_VERSION, items: cleaned };
  }

  function getHolidayByDate(dayISO){
    if(!dayISO) return null;
    return (holidaysState.items || []).find(h=>h.active && h.date===dayISO) || null;
  }

  function isWeekendISO(dayISO){
    const wd = isoWeekday(dayISO);
    return wd === 6 || wd === 7;
  }

  function isNonWorkingDayISO(dayISO){
    if(!dayISO) return false;
    if(isWeekendISO(dayISO)) return true;
    return Boolean(getHolidayByDate(dayISO));
  }

  function nonWorkingReason(dayISO){
    const holiday = getHolidayByDate(dayISO);
    if(holiday) return `Feriado: ${holiday.name}`;
    if(isWeekendISO(dayISO)) return 'Fin de semana';
    return '';
  }

  function enforceBusinessDateInput(input, label='Fecha'){
    if(!input) return '';
    const raw = normalizeISO(input.value);
    if(!raw) return '';
    if(!isNonWorkingDayISO(raw)) return raw;

    const adjusted = nextBusinessDayISO(raw);
    input.value = adjusted;
    const reason = nonWorkingReason(raw) || 'día no laborable';
    toast(`${label} no puede caer en ${reason.toLowerCase()}. Se movió a ${fmtDate(adjusted)}.`);
    return adjusted;
  }

  function coerceBusinessDateISO(dayISO){
    const d = normalizeISO(dayISO);
    if(!d) return '';
    return isNonWorkingDayISO(d) ? nextBusinessDayISO(d) : d;
  }

  function nextBusinessDayISO(dayISO){
    let d = normalizeISO(dayISO) || todayISO();
    let guard = 0;
    while(isNonWorkingDayISO(d) && guard < 730){
      d = addDaysISO(d,1);
      guard++;
    }
    return d;
  }

  function countBusinessDays(startISO, endISO){
    if(!startISO || !endISO) return 1;
    const s = minISO(startISO, endISO);
    const e = maxISO(startISO, endISO);
    let days = 0;
    let d = s;
    let guard = 0;
    while(d <= e && guard < 5000){
      if(!isNonWorkingDayISO(d)) days++;
      d = addDaysISO(d,1);
      guard++;
    }
    return Math.max(1, days);
  }

  function addBusinessDaysISO(startISO, amount){
    const total = Math.max(1, Number(amount || 1));
    let d = nextBusinessDayISO(startISO);
    let count = 1;
    let guard = 0;
    while(count < total && guard < 5000){
      d = addDaysISO(d,1);
      if(!isNonWorkingDayISO(d)) count++;
      guard++;
    }
    return d;
  }

  function eachBusinessDateBetween(startISO, endISO){
    const out = [];
    if(!startISO || !endISO) return out;
    let d = minISO(startISO, endISO);
    const e = maxISO(startISO, endISO);
    let guard = 0;
    while(d <= e && guard < 5000){
      if(!isNonWorkingDayISO(d)) out.push(d);
      d = addDaysISO(d,1);
      guard++;
    }
    return out;
  }

  function addBusinessOffsetISO(dayISO, offset = 0){
    let d = nextBusinessDayISO(dayISO);
    let left = Math.max(0, Number(offset || 0));
    let guard = 0;
    while(left > 0 && guard < 20000){
      d = addDaysISO(d,1);
      if(!isNonWorkingDayISO(d)) left--;
      guard++;
    }
    return d;
  }

  function mapRecurringDateRange(baseStart, baseEnd, offsets = { months:0, days:0, businessDays:0, useBusinessCalendar:true }){
    const start = normalizeISO(baseStart);
    const end = normalizeISO(baseEnd) || start;
    if(!start) return null;

    const cfg = (typeof offsets === 'number')
      ? { months:Number(offsets || 0), days:0, businessDays:0, useBusinessCalendar:true }
      : {
          months:Number(offsets?.months || offsets?.offsetMonths || 0),
          days:Number(offsets?.days || offsets?.offsetDays || 0),
          businessDays:Number(offsets?.businessDays || offsets?.offsetBusinessDays || 0),
          useBusinessCalendar: offsets?.useBusinessCalendar !== false
        };

    let shiftedStart = addMonthsISO(start, cfg.months);
    shiftedStart = addDaysISO(shiftedStart, cfg.days);

    if(cfg.useBusinessCalendar){
      shiftedStart = cfg.businessDays > 0
        ? addBusinessOffsetISO(shiftedStart, cfg.businessDays)
        : nextBusinessDayISO(shiftedStart);
    }else{
      shiftedStart = normalizeISO(shiftedStart);
    }

    const mappedStart = shiftedStart;

    if(cfg.useBusinessCalendar){
      const spanBusinessDays = countBusinessDays(start, end);
      const mappedEnd = addBusinessDaysISO(mappedStart, spanBusinessDays);
      return {
        startDate: mappedStart,
        endDate: mappedEnd,
        spanBusinessDays,
        spanCalendarDays: Math.max(1, daysDiff(start, end) + 1),
        useBusinessCalendar: true
      };
    }

    const spanCalendarDays = Math.max(1, daysDiff(start, end) + 1);
    const mappedEnd = addDaysISO(mappedStart, spanCalendarDays - 1);
    return {
      startDate: mappedStart,
      endDate: mappedEnd,
      spanBusinessDays: countBusinessDays(start, end),
      spanCalendarDays,
      useBusinessCalendar: false
    };
  }


  function migrateLegacyState(legacy){
    if(!legacy || typeof legacy !== 'object') return structuredClone(DEFAULT_STATE);

    const base = structuredClone(DEFAULT_STATE);

    if(Array.isArray(legacy.team) && legacy.team.length){
      base.team = legacy.team.map((t,i)=>(
        {
          id: String(t?.id || `u${i+1}`),
          name: String(t?.name || `Persona ${i+1}`),
          startHour: clampInt(t?.startHour ?? legacy?.settings?.startHour ?? legacy?.settings?.defaultStartHour ?? 8, 0, 23, 8),
          endHour: clampInt(t?.endHour ?? legacy?.settings?.endHour ?? legacy?.settings?.defaultEndHour ?? 19, 1, 24, 19),
          capacityHoursPerDay: clampInt(t?.capacityHoursPerDay ?? legacy?.settings?.capacityHoursPerDay ?? legacy?.settings?.defaultCapacityHoursPerDay ?? 8, 1, 24, 8),
          blocks: Array.isArray(t?.blocks) ? t.blocks : []
        }
      ));
    }

    const teamIds = new Set(base.team.map(t=>t.id));

    if(Array.isArray(legacy.projects)){
      base.projects = legacy.projects.map((p,idx)=>{
        const s = normalizeISO(p?.startDate) || toISO(new Date());
        const e = normalizeISO(p?.endDate) || s;

        const activities = Array.isArray(p?.activities) ? p.activities : [];
        const acts = activities.map((a,j)=>({
          id: String(a?.id || rid('a')),
          name: String(a?.name || `Actividad ${j+1}`),
          startDate: minISO(normalizeISO(a?.startDate) || s, normalizeISO(a?.endDate) || e),
          endDate: maxISO(normalizeISO(a?.startDate) || s, normalizeISO(a?.endDate) || e),
          startHour: normalizeHHMM(a?.startHour, '09:00'),
          endHour: normalizeHHMM(a?.endHour, '10:00'),
          ownerId: teamIds.has(a?.ownerId) ? a.ownerId : (teamIds.has(p?.leaderId) ? p.leaderId : base.team[0].id),
          detail: String(a?.detail || a?.description || '').slice(0,220),
          done: Boolean(a?.done || a?.status === 'Terminado' || a?.status === 'Finalizado'),
          primaryFocus: Boolean(a?.primaryFocus || a?.isPrimaryFocus)
        }));

        const legacyProjectFocus = Boolean(p?.isPrimaryFocus || p?.primaryFocus || p?.focusPrincipal);
        if(legacyProjectFocus && acts.length && !acts.some(a=>a.primaryFocus)){
          const preferredOwner = teamIds.has(p?.leaderId) ? p.leaderId : acts[0].ownerId;
          const target = acts.find(a=>a.ownerId===preferredOwner) || acts[0];
          if(target) target.primaryFocus = true;
        }

        return {
          id: String(p?.id || rid('p')),
          name: String(p?.name || `Proyecto ${idx+1}`),
          client: String(p?.client || p?.requester || ''),
          reqDate: normalizeISO(p?.reqDate) || s,
          startDate: minISO(s,e),
          endDate: maxISO(s,e),
          priority: PRIORITIES.includes(p?.priority) ? p.priority : 'Media',
          recurrenceFrequency: normalizeRecurrenceFrequency(p?.recurrenceFrequency || p?.frequency || p?.recurrence?.frequency),
          leaderId: teamIds.has(p?.leaderId) ? p.leaderId : base.team[0].id,
          importance: clampInt(p?.importance,1,5,3),
          objective: String(p?.objective || '').slice(0,500),
          deliverable: String(p?.deliverable || '').slice(0,500),
          notes: String(p?.notes || '').slice(0,800),
          isPrimaryFocus: acts.some(a=>a.primaryFocus) || Boolean(p?.isPrimaryFocus || p?.primaryFocus || p?.focusPrincipal),
          activities: acts
        };
      });
    } else if(Array.isArray(legacy.tasks)) {
      base.projects = legacy.tasks.map((t,idx)=>{
        const s = normalizeISO(t?.start) || toISO(new Date());
        const e = normalizeISO(t?.due) || s;
        const ownerId = teamIds.has(t?.ownerId) ? t.ownerId : base.team[0].id;
        const blocks = Array.isArray(t?.blocks) && t.blocks.length ? t.blocks : [{start:'09:00',end:'10:00'}];

        return {
          id: String(t?.id || rid('p')),
          name: String(t?.name || `Proyecto ${idx+1}`),
          client: String(t?.requester || ''),
          reqDate: normalizeISO(t?.requestedAt) || s,
          startDate: minISO(s,e),
          endDate: maxISO(s,e),
          priority: t?.priority === 'P1' ? 'Alta' : t?.priority === 'P3' ? 'Baja' : 'Media',
          recurrenceFrequency: normalizeRecurrenceFrequency(t?.frequency),
          leaderId: ownerId,
          importance: clampInt(t?.importance,1,5,3),
          objective: '',
          deliverable: '',
          notes: '',
          activities: blocks.map((b,j)=>({
            id: rid('a'),
            name: blocks.length>1 ? `${String(t?.name||'Actividad')} (bloque ${j+1})` : String(t?.name||'Actividad'),
            startDate: minISO(s,e),
            endDate: maxISO(s,e),
            startHour: normalizeHHMM(b?.start, '09:00'),
            endHour: normalizeHHMM(b?.end, '10:00'),
            ownerId,
            detail: '',
            done: Boolean(t?.status === 'Terminado' || t?.status === 'Finalizado'),
            primaryFocus: false
          }))
        };
      });
    }

    return base;
  }

  function buildDefaultTeamBoardFromTeam(_team){
    const base = DEFAULT_STATE?.teamBoard && typeof DEFAULT_STATE.teamBoard === 'object'
      ? structuredClone(DEFAULT_STATE.teamBoard)
      : {
          leader:{ name:'Líder del equipo', role:'Líder de operaciones' },
          members:[]
        };

    const leaderName = String(base?.leader?.name || 'Líder del equipo').slice(0,80).trim() || 'Líder del equipo';
    const leaderRole = String(base?.leader?.role || 'Líder de operaciones').slice(0,80).trim() || 'Líder de operaciones';
    const members = Array.isArray(base?.members) ? base.members : [];

    return {
      leader: { name: leaderName, role: leaderRole },
      members: members.map((m,idx)=>({
        id: String(m?.id || `tm${idx+1}`),
        name: String(m?.name || `Miembro ${idx+1}`).slice(0,80).trim() || `Miembro ${idx+1}`,
        role: String(m?.role || 'Analista').slice(0,80).trim() || 'Analista',
        area: String(m?.area || 'General').slice(0,80).trim() || 'General',
        responsibilities: parseResponsibilities(m?.responsibilities)
      }))
    };
  }

  function parseResponsibilities(raw){
    if(Array.isArray(raw)){
      return raw
        .map(x=>String(x || '').replace(/\\n/g,'\n').trim())
        .filter(Boolean)
        .slice(0,24);
    }

    const text = String(raw || '').replace(/\\n/g,'\n');
    if(!text.trim()) return [];
    return text
      .split(/\r?\n|;/g)
      .map(x=>x.trim())
      .filter(Boolean)
      .slice(0,24);
  }

  function sanitizeTeamBoard(raw, fallbackTeam = []){
    const fallback = buildDefaultTeamBoardFromTeam(fallbackTeam);
    const board = raw && typeof raw === 'object' ? raw : {};

    const leaderRaw = board.leader && typeof board.leader === 'object'
      ? board.leader
      : { name: board.leaderName, role: board.leaderRole };

    const leader = {
      name: String(leaderRaw?.name || fallback.leader.name).slice(0,80).trim() || fallback.leader.name,
      role: String(leaderRaw?.role || fallback.leader.role).slice(0,80).trim() || fallback.leader.role
    };

    const hasExplicitMembers = Object.prototype.hasOwnProperty.call(board, 'members');
    const rawMembers = hasExplicitMembers ? board.members : fallback.members;

    const members = Array.isArray(rawMembers)
      ? rawMembers.map((m,idx)=>{
          const name = String(m?.name || `Miembro ${idx+1}`).slice(0,80).trim();
          const role = String(m?.role || 'Analista').slice(0,80).trim();
          const area = String(m?.area || m?.group || 'General').slice(0,80).trim();
          const responsibilities = parseResponsibilities(m?.responsibilities ?? m?.responsibilitiesText);

          if(!name) return null;
          return {
            id: String(m?.id || rid('tm')),
            name,
            role: role || 'Analista',
            area: area || 'General',
            responsibilities
          };
        }).filter(Boolean)
      : [];

    return { leader, members };
  }

  function sanitizeState(raw){
    const s = raw && typeof raw === 'object' ? raw : structuredClone(DEFAULT_STATE);
    const out = structuredClone(DEFAULT_STATE);

    const set = s.settings || {};
    out.settings.defaultStartHour = clampInt(set.defaultStartHour ?? set.startHour, 0, 23, 8);
    out.settings.defaultEndHour = clampInt(set.defaultEndHour ?? set.endHour, out.settings.defaultStartHour+1, 24, 19);
    out.settings.defaultCapacityHoursPerDay = clampInt(set.defaultCapacityHoursPerDay ?? set.capacityHoursPerDay, 1, 24, 8);
    out.settings.workdays = Array.isArray(set.workdays)
      ? [...new Set(set.workdays.map(x=>clampInt(x,1,7,1)).filter(x=>x>=1 && x<=7))]
      : [1,2,3,4,5];
    if(!out.settings.workdays.length) out.settings.workdays = [1,2,3,4,5];

    if(Array.isArray(s.team) && s.team.length){
      out.team = s.team.map((t,i)=>{
        const start = clampInt(t?.startHour ?? out.settings.defaultStartHour, 0, 23, out.settings.defaultStartHour);
        const end = clampInt(t?.endHour ?? out.settings.defaultEndHour, start+1, 24, out.settings.defaultEndHour);
        const cap = clampInt(t?.capacityHoursPerDay ?? out.settings.defaultCapacityHoursPerDay, 1, 24, out.settings.defaultCapacityHoursPerDay);
        const blocks = Array.isArray(t?.blocks) ? t.blocks.map((b,bi)=>sanitizeBlock(b, start, end, bi)) : [];

        return {
          id: String(t?.id || `u${i+1}`),
          name: String(t?.name || `Persona ${i+1}`).slice(0,60),
          startHour: start,
          endHour: end,
          capacityHoursPerDay: cap,
          blocks
        };
      }).filter(t=>t.name.trim());
    }

    if(!out.team.length) out.team = structuredClone(DEFAULT_STATE.team);
    out.teamBoard = sanitizeTeamBoard(s.teamBoard, out.team);
    const teamIds = new Set(out.team.map(t=>t.id));

    if(Array.isArray(s.projects)){
      out.projects = s.projects.map((p,idx)=>{
        const sDate = normalizeISO(p?.startDate) || toISO(new Date());
        const eDate = normalizeISO(p?.endDate) || sDate;
        let startDate = minISO(sDate, eDate);
        let endDate = maxISO(sDate, eDate);

        if(isNonWorkingDayISO(startDate)) startDate = nextBusinessDayISO(startDate);
        if(isNonWorkingDayISO(endDate)) endDate = nextBusinessDayISO(endDate);
        if(startDate > endDate) endDate = startDate;

        const leaderId = teamIds.has(p?.leaderId) ? p.leaderId : out.team[0].id;

        const acts = Array.isArray(p?.activities) ? p.activities : [];
        const activities = acts.map((a,i)=>{
          const as = normalizeISO(a?.startDate) || startDate;
          const ae = normalizeISO(a?.endDate) || as;
          let aStart = minISO(as,ae);
          let aEnd = maxISO(as,ae);

          if(isNonWorkingDayISO(aStart)) aStart = nextBusinessDayISO(aStart);
          if(isNonWorkingDayISO(aEnd)) aEnd = nextBusinessDayISO(aEnd);

          let sh = normalizeHHMM(a?.startHour, '09:00');
          let eh = normalizeHHMM(a?.endHour, '10:00');
          if(timeToMin(eh) <= timeToMin(sh)) eh = minToHHMM(Math.min(timeToMin(sh)+60, 23*60+59));

          return {
            id: String(a?.id || rid('a')),
            name: String(a?.name || `Actividad ${i+1}`).slice(0,120),
            startDate: (()=>{ const s = clampISO(aStart, startDate, endDate); const e = clampISO(aEnd, startDate, endDate); return s > e ? e : s; })(),
            endDate: (()=>{ const s = clampISO(aStart, startDate, endDate); const e = clampISO(aEnd, startDate, endDate); return e < s ? s : e; })(),
            startHour: sh,
            endHour: eh,
            ownerId: teamIds.has(a?.ownerId) ? a.ownerId : leaderId,
            detail: String(a?.detail || a?.description || '').slice(0,220),
            done: Boolean(a?.done || a?.status === 'Terminado' || a?.status === 'Finalizado'),
            primaryFocus: Boolean(a?.primaryFocus || a?.isPrimaryFocus)
          };
        }).filter(a=>a.name.trim());

        const projectLevelFocus = Boolean(p?.isPrimaryFocus || p?.primaryFocus || p?.focusPrincipal);
        if(projectLevelFocus && activities.length && !activities.some(a=>a.primaryFocus)){
          const preferredOwner = teamIds.has(p?.leaderId) ? p.leaderId : activities[0].ownerId;
          const target = activities.find(a=>a.ownerId===preferredOwner) || activities[0];
          if(target) target.primaryFocus = true;
        }

        return {
          id: String(p?.id || rid('p')),
          name: String(p?.name || `Proyecto ${idx+1}`).slice(0,120),
          client: String(p?.client || '').slice(0,80),
          reqDate: normalizeISO(p?.reqDate) || startDate,
          startDate,
          endDate,
          priority: PRIORITIES.includes(p?.priority) ? p.priority : 'Media',
          recurrenceFrequency: normalizeRecurrenceFrequency(p?.recurrenceFrequency || p?.frequency || p?.recurrence?.frequency),
          leaderId,
          importance: clampInt(p?.importance,1,5,3),
          objective: String(p?.objective || '').slice(0,500),
          deliverable: String(p?.deliverable || '').slice(0,500),
          notes: String(p?.notes || '').slice(0,800),
          isPrimaryFocus: activities.some(a=>a.primaryFocus) || Boolean(p?.isPrimaryFocus || p?.primaryFocus || p?.focusPrincipal),
          activities
        };
      }).filter(p=>p.name.trim());

    }

    out.notifications = sanitizeNotifications(s.notifications, out.team);

    return out;
  }

  function sanitizeBlock(raw, personStartHour, personEndHour, idx=0){
    const today = toISO(new Date());
    const s = normalizeISO(raw?.startDate) || today;
    const e = normalizeISO(raw?.endDate) || s;
    let start = minISO(s,e);
    let end = maxISO(s,e);

    const allDay = Boolean(raw?.allDay);
    let startHour = normalizeHHMM(raw?.startHour, '13:00');
    let endHour = normalizeHHMM(raw?.endHour, '14:00');

    if(timeToMin(endHour) <= timeToMin(startHour)){
      endHour = minToHHMM(Math.min(timeToMin(startHour)+60, 23*60+59));
    }

    // clamp to person schedule
    const minM = personStartHour*60;
    const maxM = personEndHour*60;
    const shM = clamp(timeToMin(startHour), minM, Math.max(minM, maxM-1));
    const ehM = clamp(timeToMin(endHour), shM+1, maxM);

    return {
      id: String(raw?.id || rid('b')),
      type: BLOCK_TYPES.includes(raw?.type) ? raw.type : 'Permiso',
      startDate: start,
      endDate: end,
      allDay,
      startHour: allDay ? `${String(personStartHour).padStart(2,'0')}:00` : minToHHMM(shM),
      endHour: allDay ? `${String(personEndHour).padStart(2,'0')}:00` : minToHHMM(ehM),
      note: String(raw?.note || '').slice(0,80)
    };
  }

  function normalizeRecurrenceFrequency(raw){
    const val = String(raw || '').trim().toLowerCase();
    if(['diaria','diario','diario hábil','diaria hábil','daily','day'].includes(val)) return 'Diaria';
    if(['mensual','monthly','month'].includes(val)) return 'Mensual';
    if(['trimestral','quarterly','quarter'].includes(val)) return 'Trimestral';
    if(['anual','yearly','annual','year'].includes(val)) return 'Anual';
    return 'Ninguna';
  }

  function recurrenceMeta(freq){
    const f = normalizeRecurrenceFrequency(freq);
    if(f === 'Diaria') return { unit:'businessDay', step:1, useBusinessCalendar:true };
    if(f === 'Mensual') return { unit:'month', step:1, useBusinessCalendar:true };
    if(f === 'Trimestral') return { unit:'month', step:3, useBusinessCalendar:true };
    if(f === 'Anual') return { unit:'month', step:12, useBusinessCalendar:true };
    return { unit:'none', step:0, useBusinessCalendar:true };
  }

  function recurrenceStepMonths(freq){
    const meta = recurrenceMeta(freq);
    return meta.unit === 'month' ? meta.step : 0;
  }


  function clampOccurrenceToProjectWindow(project, meta, mapped){
    if(!mapped) return null;
    if(meta?.unit !== 'businessDay') return mapped;

    const projectStart = normalizeISO(project?.startDate);
    const projectEnd = normalizeISO(project?.endDate);
    const mappedStart = normalizeISO(mapped?.startDate);
    const mappedEnd = normalizeISO(mapped?.endDate);

    if(!projectStart || !projectEnd || !mappedStart || !mappedEnd) return mapped;

    const startDate = maxISO(mappedStart, projectStart);
    const endDate = minISO(mappedEnd, projectEnd);
    if(!startDate || !endDate || endDate < startDate) return null;

    return { ...mapped, startDate, endDate };
  }

  function businessDayIndexFromBase(baseISO, targetISO){
    const base = normalizeISO(baseISO);
    const target = normalizeISO(targetISO);
    if(!base || !target || target <= base) return 0;

    let d = nextBusinessDayISO(base);
    let idx = 0;
    let guard = 0;
    while(d < target && guard < 20000){
      d = addDaysISO(d, 1);
      if(!isNonWorkingDayISO(d)) idx++;
      guard++;
    }
    return idx;
  }

  function isRecurringProject(project){
    return recurrenceMeta(project?.recurrenceFrequency).step > 0;
  }

  function startOfMonthISO(iso){
    const d = parseISO(iso);
    d.setDate(1);
    return toISO(d);
  }

  function addMonthsISO(iso, months){
    const d = parseISO(iso);
    const baseDay = d.getDate();
    d.setDate(1);
    d.setMonth(d.getMonth() + Number(months || 0));
    const lastDay = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    d.setDate(Math.min(baseDay, lastDay));
    return toISO(d);
  }

  function monthDiffISO(fromISO, toISO_){
    const a = parseISO(fromISO), b = parseISO(toISO_);
    return (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());
  }

  function enumerateProjectOccurrences(project, rangeStartISO, rangeEndISO){
    if(!project || !rangeStartISO || !rangeEndISO || rangeStartISO > rangeEndISO) return [];
    const meta = recurrenceMeta(project.recurrenceFrequency);
    const baseStart = normalizeISO(project.startDate);
    const baseEnd = normalizeISO(project.endDate);
    if(!baseStart || !baseEnd) return [];

    if(meta.step <= 0){
      const startDate = coerceBusinessDateISO(baseStart);
      const endDate = coerceBusinessDateISO(baseEnd);
      if(!startDate || !endDate) return [];
      const safeStart = minISO(startDate, endDate);
      const safeEnd = maxISO(startDate, endDate);

      if(safeEnd < rangeStartISO || safeStart > rangeEndISO) return [];

      return [{
        index: 0,
        offsetMonths: 0,
        offsetDays: 0,
        offsetBusinessDays: 0,
        useBusinessCalendar: true,
        startDate: safeStart,
        endDate: safeEnd,
        reqDate: coerceBusinessDateISO(normalizeISO(project.reqDate) || safeStart) || safeStart
      }];
    }

    const out = [];
    const reqBase = normalizeISO(project.reqDate) || baseStart;

    if(meta.unit === 'day'){
      const spanDays = Math.max(1, daysDiff(baseStart, baseEnd) + 1);
      const paddedStart = addDaysISO(rangeStartISO, -(spanDays + 3));
      const paddedEnd = addDaysISO(rangeEndISO, 3);
      const approxStart = Math.max(0, Math.floor(daysDiff(baseStart, paddedStart) / meta.step));
      const approxEnd = Math.max(approxStart, Math.ceil(daysDiff(baseStart, paddedEnd) / meta.step));

      for(let idx=approxStart; idx<=approxEnd && out.length<1500; idx++){
        const offsetDays = idx * meta.step;
        const mapped = mapRecurringDateRange(baseStart, baseEnd, { days: offsetDays, useBusinessCalendar:false });
        if(!mapped) continue;

        const startDate = mapped.startDate;
        const endDate = mapped.endDate;
        if(startDate > rangeEndISO) break;
        if(endDate < rangeStartISO) continue;

        out.push({
          index: idx,
          offsetMonths: 0,
          offsetDays,
          offsetBusinessDays: 0,
          useBusinessCalendar: false,
          startDate,
          endDate,
          reqDate: addDaysISO(reqBase, offsetDays)
        });
      }

      return out;
    }

    if(meta.unit === 'businessDay'){
      const windowStart = minISO(baseStart, baseEnd);
      const windowEnd = maxISO(baseStart, baseEnd);
      const iterStart = maxISO(windowStart, addDaysISO(rangeStartISO, -3));
      const iterEnd = minISO(windowEnd, addDaysISO(rangeEndISO, 3));
      if(!iterStart || !iterEnd || iterStart > iterEnd) return out;

      let d = nextBusinessDayISO(iterStart);
      let guard = 0;
      while(d <= iterEnd && out.length < 2000 && guard < 6000){
        const offsetBusinessDays = businessDayIndexFromBase(windowStart, d);
        if(offsetBusinessDays % meta.step === 0){
          out.push({
            index: Math.floor(offsetBusinessDays / meta.step),
            offsetMonths: 0,
            offsetDays: 0,
            offsetBusinessDays,
            useBusinessCalendar: true,
            startDate: d,
            endDate: d,
            reqDate: addBusinessOffsetISO(reqBase, offsetBusinessDays)
          });
        }

        d = addDaysISO(d, 1);
        while(d <= iterEnd && isNonWorkingDayISO(d)) d = addDaysISO(d, 1);
        guard++;
      }

      return out;
    }

    const stepMonths = meta.step;
    const approxStart = Math.max(0, Math.floor((monthDiffISO(baseStart, rangeStartISO) - 2) / stepMonths));
    const approxEnd = Math.max(approxStart, Math.ceil((monthDiffISO(baseStart, rangeEndISO) + 2) / stepMonths));

    for(let idx=approxStart; idx<=approxEnd && out.length<1200; idx++){
      const offsetMonths = idx * stepMonths;
      const mapped = mapRecurringDateRange(baseStart, baseEnd, { months: offsetMonths, useBusinessCalendar:true });
      if(!mapped) continue;

      const startDate = mapped.startDate;
      const endDate = mapped.endDate;
      if(endDate < rangeStartISO) continue;
      if(startDate > rangeEndISO && idx > approxEnd) break;

      if(startDate <= rangeEndISO && endDate >= rangeStartISO){
        out.push({
          index: idx,
          offsetMonths,
          offsetDays: 0,
          offsetBusinessDays: 0,
          useBusinessCalendar: true,
          startDate,
          endDate,
          reqDate: nextBusinessDayISO(addMonthsISO(reqBase, offsetMonths))
        });
      }
    }

    return out;
  }

  function onlyNonWorkingGapBetween(prevEndISO, nextStartISO){
    const prevEnd = normalizeISO(prevEndISO);
    const nextStart = normalizeISO(nextStartISO);
    if(!prevEnd || !nextStart) return false;

    if(nextStart <= addDaysISO(prevEnd, 1)) return true;

    let d = addDaysISO(prevEnd, 1);
    const limit = addDaysISO(nextStart, -1);
    let guard = 0;

    while(d <= limit && guard < 120){
      if(!isNonWorkingDayISO(d)) return false;
      d = addDaysISO(d, 1);
      guard++;
    }

    return true;
  }

  function mergeOccurrenceIntervalsForRoadmap(project, occurrences){
    if(!Array.isArray(occurrences) || !occurrences.length) return [];

    const recurrence = normalizeRecurrenceFrequency(project?.recurrenceFrequency);
    const mergeContiguous = recurrence === 'Diaria';
    const maxGapDays = mergeContiguous ? 1 : 0;

    const sorted = occurrences
      .filter(o=>o && normalizeISO(o.startDate) && normalizeISO(o.endDate))
      .slice()
      .sort((a,b)=>{
        if(a.startDate !== b.startDate) return a.startDate.localeCompare(b.startDate);
        if(a.endDate !== b.endDate) return a.endDate.localeCompare(b.endDate);
        return Number(a.index||0) - Number(b.index||0);
      });

    const merged = [];
    sorted.forEach((occ, idx)=>{
      const current = {
        index: Number.isFinite(Number(occ.index)) ? Number(occ.index) : idx,
        startDate: normalizeISO(occ.startDate),
        endDate: normalizeISO(occ.endDate),
        reqDate: normalizeISO(occ.reqDate) || normalizeISO(occ.startDate),
        occurrenceCount: 1
      };

      const last = merged[merged.length-1];
      if(last){
        const canMerge = mergeContiguous
          ? onlyNonWorkingGapBetween(last.endDate, current.startDate)
          : current.startDate <= addDaysISO(last.endDate, maxGapDays);

        if(canMerge){
          if(current.endDate > last.endDate) last.endDate = current.endDate;
          last.occurrenceCount = Number(last.occurrenceCount || 1) + 1;
          return;
        }
      }

      merged.push(current);
    });

    return merged;
  }

  function getRelevantOccurrenceForDate(project, refDate){
    const meta = recurrenceMeta(project?.recurrenceFrequency);
    if(meta.step <= 0){
      return {
        index:0,
        offsetMonths:0,
        offsetDays:0,
        offsetBusinessDays:0,
        useBusinessCalendar:true,
        startDate:project.startDate,
        endDate:project.endDate
      };
    }

    const baseStart = normalizeISO(project.startDate);
    const baseEnd = normalizeISO(project.endDate);
    if(!baseStart || !baseEnd) return null;

    const safeRef = normalizeISO(refDate) || todayISO();

    if(meta.unit === 'businessDay'){
      const windowStart = minISO(baseStart, baseEnd);
      const windowEnd = maxISO(baseStart, baseEnd);
      if(safeRef > windowEnd) return null;

      let candidate = safeRef < windowStart ? windowStart : safeRef;
      candidate = isNonWorkingDayISO(candidate) ? nextBusinessDayISO(candidate) : candidate;
      if(candidate < windowStart) candidate = nextBusinessDayISO(windowStart);
      if(candidate > windowEnd) return null;

      const offsetBusinessDaysRaw = businessDayIndexFromBase(windowStart, candidate);
      const offsetBusinessDays = Math.ceil(offsetBusinessDaysRaw / meta.step) * meta.step;
      const startDate = addBusinessOffsetISO(windowStart, offsetBusinessDays);
      if(!startDate || startDate > windowEnd) return null;

      return {
        index: Math.floor(offsetBusinessDays / meta.step),
        offsetMonths: 0,
        offsetDays: 0,
        offsetBusinessDays,
        useBusinessCalendar: true,
        startDate,
        endDate: startDate
      };
    }

    let guess = 0;
    if(meta.unit === 'day'){
      guess = Math.floor(Math.max(0, daysDiff(baseStart, safeRef)) / meta.step);
    }else{
      guess = Math.floor(Math.max(0, monthDiffISO(baseStart, safeRef)) / meta.step);
    }

    const candidates = [];
    for(let k=Math.max(0, guess-2); k<=guess+2; k++){
      const offsetMonths = meta.unit === 'month' ? (k * meta.step) : 0;
      const offsetDays = meta.unit === 'day' ? (k * meta.step) : 0;
      const offsetBusinessDays = 0;
      const useBusinessCalendar = meta.unit !== 'day';

      const rawMapped = mapRecurringDateRange(baseStart, baseEnd, {
        months: offsetMonths,
        days: offsetDays,
        businessDays: offsetBusinessDays,
        useBusinessCalendar
      });
      if(!rawMapped) continue;

      const mapped = clampOccurrenceToProjectWindow(project, meta, rawMapped);
      if(!mapped) continue;

      candidates.push({
        index:k,
        offsetMonths,
        offsetDays,
        offsetBusinessDays,
        useBusinessCalendar,
        startDate:mapped.startDate,
        endDate:mapped.endDate
      });
    }

    const direct = candidates.find(c=>safeRef >= c.startDate && safeRef <= c.endDate);
    if(direct) return direct;

    const sorted = candidates.slice().sort((a,b)=>a.startDate.localeCompare(b.startDate));
    const next = sorted.find(c=>c.startDate > safeRef);
    if(next) return next;

    const fallbackIndex = Math.max(0, guess+1);
    const fallbackOffsets = meta.unit === 'month'
      ? { months: fallbackIndex * meta.step, businessDays: 0, days: 0, useBusinessCalendar:true }
      : { months: 0, businessDays: 0, days: fallbackIndex * meta.step, useBusinessCalendar:false };

    const rawFallbackMapped = mapRecurringDateRange(baseStart, baseEnd, fallbackOffsets);
    if(!rawFallbackMapped) return null;

    const fallbackMapped = clampOccurrenceToProjectWindow(project, meta, rawFallbackMapped);
    if(!fallbackMapped) return null;

    return {
      index:fallbackIndex,
      offsetMonths:Number(fallbackOffsets.months || 0),
      offsetDays:Number(fallbackOffsets.days || 0),
      offsetBusinessDays:Number(fallbackOffsets.businessDays || 0),
      useBusinessCalendar: fallbackOffsets.useBusinessCalendar !== false,
      startDate:fallbackMapped.startDate,
      endDate:fallbackMapped.endDate
    };
  }

  function getRoadmapWindow(refISO, zoom){
    const safeRef = normalizeISO(refISO) || todayISO();

    if(zoom === 'week'){
      const start = startOfWeekISO(safeRef); // lunes
      const end = addDaysISO(start, 4);      // viernes
      return { start, end };
    }

    if(zoom === 'year'){
      const year = parseISO(safeRef).getFullYear();
      return { start: `${year}-01-01`, end: `${year}-12-31` };
    }

    // Mensual: ventana de 6 meses (rápida de leer y más ligera para renderizar)
    const start = startOfMonthISO(safeRef);
    const end = addDaysISO(addMonthsISO(start, 6), -1);
    return { start, end };
  }

  function buildPristineState(){
    return sanitizeState({
      settings: structuredClone(DEFAULT_STATE.settings),
      team: structuredClone(DEFAULT_STATE.team),
      teamBoard: {
        leader: { name:'Líder del equipo', role:'Líder de operaciones' },
        members: []
      },
      projects: [],
      notifications: []
    });
  }

  function hardResetApplication(){
    const prefixList = ['BANBIF_WORKLOAD','banbif_workload'];
    try{
      sessionStorage.removeItem('bb_access_failures');
      sessionStorage.removeItem('bb_access_lock_until');
      sessionStorage.removeItem('BANBIF_ACCESS_ATTEMPTS_V11');
      sessionStorage.removeItem('BANBIF_ACCESS_LOCK_UNTIL_V11');
      sessionStorage.removeItem('BANBIF_ACCESS_ATTEMPTS_V12');
      sessionStorage.removeItem('BANBIF_ACCESS_LOCK_UNTIL_V12');
      sessionStorage.removeItem('BANBIF_ACCESS_LOCK_LEVEL_V12');

      const keys = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(prefixList.some(p=>k.startsWith(p))) keys.push(k);
      }

      keys.forEach(k=>localStorage.removeItem(k));
      LEGACY_KEYS.forEach(k=>localStorage.removeItem(k));
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(THEME_KEY);
      localStorage.removeItem(HOLIDAYS_KEY);
      localStorage.removeItem(IMPORT_ROLLBACK_KEY);
    }catch(_err){}

    state = buildPristineState();
    holidaysState = sanitizeHolidayStore(structuredClone(DEFAULT_HOLIDAYS_STATE));

    ui.view = 'day';
    ui.date = todayISO();
    ui.editingProjectId = null;
    ui.manageTab = 'projects';
    ui.manageProjectSort = 'priority_desc';
    ui.manageProjectSearch = '';
    ui.manageNotifUser = '';
    ui.manageNotifQ = '';
    ui.manageNotifShowDone = true;
    ui.infoNotifUser = '';
    ui.infoNotifQ = '';
    ui.infoNotifShowDone = false;
    ui.roadmapZoom = 'month';
    ui.lastAdjustedBusinessDates = 0;
    ui.filters = { owner:'', client:'', status:'', priority:'', q:'' };

    closeOverlay('projectOverlay');
    closeOverlay('detailOverlay');
    closeOverlay('teamOverlay');
    closeOverlay('manageOverlay');
    closeOverlay('infoOverlay');
    closeOverlay('impactOverlay');

    applyTheme('light');
    saveState();
    saveHolidays();
    render();
    toast('Reset total aplicado. La herramienta quedó limpia (sin proyectos).');
  }


  function render(){
    if(!ui.role) return;
    state = sanitizeState(state);
    ui.roadmapZoom = (ui.roadmapZoom === 'week' || ui.roadmapZoom === 'year' || ui.roadmapZoom === 'month') ? ui.roadmapZoom : 'month';
    saveState();

    $('datePicker').value = fmtDate(ui.date);
    updateRoleUI();
    updateNotificationIndicator();
    renderHeaderControls();
    renderKPIBand();
    renderTodayCards();
    renderPriorityRadar();
    renderView();
    if($('infoOverlay')?.classList.contains('open')) renderInfoNotifications();
    applyStatTooltips(document);
    $('lastUpdate').textContent = `${formatDateTime(new Date())} · ${labelView(ui.view)} · ${rangeLabel()}`;
  }


  function statTooltipByLabel(labelText=''){
    const label = String(labelText || '').trim();
    const key = label.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

    if(!key) return 'Indicador estadístico del tablero.';
    if(key.includes('utilizacion') || key==='flujo' || key.includes('flujo')) return 'Ritmo de trabajo del equipo en el período visible: porcentaje de capacidad ya planificada respecto a la capacidad disponible.';
    if(key.includes('capacidad libre')) return 'Horas disponibles que aún no tienen asignaciones para el período visible.';
    if(key.includes('capacidad')) return 'Capacidad total disponible según horario y bloqueos del período visible.';
    if(key.includes('alertas')) return 'Cantidad de alertas de ejecución detectadas (demoras, vencimientos próximos o riesgos).';
    if(key.includes('conflictos')) return 'Cantidad de choques de agenda: solapes de actividades y asignaciones en horas bloqueadas.';
    if(key.includes('proyectos')) return 'Número de proyectos considerados en la vista y filtros actuales.';
    if(key.includes('ventana')) return 'Rango de fechas actualmente visible en la vista.';
    if(key.includes('vista')) return 'Tipo de vista activa para calcular estas métricas.';
    if(key.includes('alta') || key.includes('media') || key.includes('baja')) return 'Conteo de actividades por nivel de prioridad en el período visible.';
    if(key.includes('libre')) return 'Tiempo disponible sin asignaciones para la persona o equipo en el período visible.';
    if(key.includes('carga')) return 'Nivel de carga de trabajo respecto a la capacidad disponible.';
    if(key.includes('avance')) return 'Avance del período en función del tiempo transcurrido.';
    return `Indicador: ${label}.`;
  }

  function applyStatTooltips(root = document){
    const scope = root || document;
    const statSelectors = [
      '.kpi',
      '.day-kpi',
      '.month-kpi',
      '.road-kpi',
      '.impact-kpi',
      '.eq-kpi',
      '.eq-leader-stat',
      '.month-day-prio-kpi'
    ];

    scope.querySelectorAll(statSelectors.join(',')).forEach(card=>{
      const labelEl = card.querySelector('.label,.k,.t');
      const valueEl = card.querySelector('.val,.v');
      const label = (labelEl?.textContent || '').replace(/\s+/g,' ').trim();
      const value = (valueEl?.textContent || '').replace(/\s+/g,' ').trim();

      const base = statTooltipByLabel(label);
      const tip = value ? `${base} Valor actual: ${value}.` : base;

      card.setAttribute('title', tip);
      if(labelEl && !labelEl.getAttribute('title')) labelEl.setAttribute('title', base);
      if(valueEl && !valueEl.getAttribute('title')) valueEl.setAttribute('title', value ? `${label || 'Indicador'}: ${value}` : (label || 'Indicador'));
    });

    scope.querySelectorAll('.person').forEach(card=>{
      const personName = (card.querySelector('.n span')?.textContent || '').trim();
      const meta = (card.querySelector('.meta')?.textContent || '').replace(/\s+/g,' ').trim();
      if(personName || meta){
        const tip = `Resumen de carga${personName ? ` de ${personName}` : ''}. ${meta || 'Incluye flujo, capacidad y tiempo libre.'}`;
        card.setAttribute('title', tip);
      }
    });

    scope.querySelectorAll('.kpi .pill,.month-kpi .s,.eq-kpi .s,.impact-kpi .s').forEach(el=>{
      if(!el.getAttribute('title')){
        const txt = (el.textContent || '').replace(/\s+/g,' ').trim();
        if(txt) el.setAttribute('title', txt);
      }
    });
  }

  function renderHeaderControls(){
    document.querySelectorAll('#segView [data-view]').forEach(b => b.classList.toggle('active', b.dataset.view === ui.view));
    document.querySelectorAll('#segRoadmapZoom [data-rz]').forEach(b => b.classList.toggle('active', b.dataset.rz === (ui.roadmapZoom || 'month')));

    const roadmapWrap = $('roadmapZoomWrap');
    if(roadmapWrap) roadmapWrap.classList.toggle('hidden', ui.view !== 'roadmap');

    $('fOwner').innerHTML = ['<option value="">Responsable</option>']
      .concat(state.team.map(t=>`<option value="${esc(t.id)}" ${ui.filters.owner===t.id?'selected':''}>${esc(t.name)}</option>`))
      .join('');

    const clientOpts = [...new Set(state.projects.map(p=>String(p?.client || 'Interno').trim() || 'Interno'))]
      .sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
    $('fClient').innerHTML = ['<option value="">Equipo</option>']
      .concat(clientOpts.map(c=>`<option value="${esc(c)}" ${ui.filters.client===c?'selected':''}>${esc(c)}</option>`))
      .join('');

    $('fStatus').innerHTML = ['<option value="">Estatus</option>']
      .concat(AUTO_STATUSES.map(s=>`<option value="${esc(s)}" ${ui.filters.status===s?'selected':''}>${esc(s)}</option>`))
      .join('');

    $('fPriority').innerHTML = ['<option value="">Prioridad</option>']
      .concat(PRIORITIES.map(p=>`<option value="${esc(p)}" ${ui.filters.priority===p?'selected':''}>${esc(p)}</option>`))
      .join('');

    $('fSearch').value = ui.filters.q || '';
  }

  function renderKPIBand(){
    const day = ui.date;
    const acts = getVisibleActivityInstances(day);
    const team = getFilteredTeam();

    const totalMin = acts.reduce((a,b)=>a+b.minutes,0);
    const capMin = team.reduce((acc,t)=>acc + getDailyCapacityMin(t, day),0);
    const freeMin = Math.max(0, capMin-totalMin);
    const util = capMin ? Math.round((totalMin/capMin)*100) : (totalMin>0?100:0);

    const risksRaw = getRiskMetrics(day) || {};
    const risks = {
      overdue: Number(risksRaw.overdue ?? risksRaw.demorado ?? 0) || 0,
      dueSoon: Number(risksRaw.dueSoon ?? risksRaw.enRiesgo ?? 0) || 0,
      conflicts: Number(risksRaw.conflicts ?? 0) || 0,
      blocked: Number(risksRaw.blocked ?? risksRaw.bloqueado ?? 0) || 0
    };
    const sev = severity(util);
    const alertTotal = risks.overdue + risks.dueSoon + risks.conflicts + risks.blocked;

    $('kpiBand').innerHTML = `
      <div class="kpi">
        <div>
          <div class="label">${esc(flowDayLabel(day))}</div>
          <div class="val">${util}%</div>
          <div class="sub">${fmtH(totalMin)} de ${fmtH(capMin)}</div>
        </div>
        <span class="pill ${sev.className}">${sev.label}</span>
      </div>
      <div class="kpi">
        <div>
          <div class="label">Disponible</div>
          <div class="val">${fmtH(freeMin)}</div>
          <div class="sub">${team.length} Persona(s)</div>
        </div>
        <span class="pill">Nd.: ${fmtH(team.reduce((a,t)=>a+sumBlockedMinutes(t,day),0))}</span>
      </div>
      <div class="kpi">
        <div>
          <div class="label">Alertas ejecución</div>
          <div class="val">${alertTotal}</div>
          <div class="sub">Demoras ${risks.overdue} · Vencen ≤2d ${risks.dueSoon}</div>
        </div>
        <span class="pill ${alertTotal>=6?'danger':alertTotal>=3?'warn':'ok'}">${alertTotal>=6?'Alta':'Normal'}</span>
      </div>
      <div class="kpi">
        <div>
          <div class="label">Conflictos agenda</div>
          <div class="val">${risks.conflicts + risks.blocked}</div>
          <div class="sub">Cruces: ${risks.conflicts} · En restricción: ${risks.blocked}</div>
        </div>
        <span class="pill ${(risks.conflicts+risks.blocked)>0?'warn':'ok'}">${(risks.conflicts+risks.blocked)>0?'Revisar':'OK'}</span>
      </div>
    `;
  }

  function renderTodayCards(){
    const day = ui.date;
    const acts = getVisibleActivityInstances(day);
    const team = getFilteredTeam();
    const teamTodayLabelEl = $('teamTodayLabel');
    if(teamTodayLabelEl) teamTodayLabelEl.textContent = dayLabel(day);

    const cards = team.map(t=>{
      const mine = acts.filter(a=>a.ownerId===t.id).sort((a,b)=>a.startHour.localeCompare(b.startHour));
      const min = mine.reduce((a,b)=>a+b.minutes,0);
      const cap = getDailyCapacityMin(t, day);
      const util = cap ? Math.round((min/cap)*100) : (min>0?100:0);
      const free = Math.max(0, cap-min);
      const sev = severity(util);

      const blockTags = getBlocksForDay(t, day).slice(0,2)
        .map(b=>`<span class="blocked-tag">${esc(b.type)}</span>`).join(' ');

      const agendaItems = mine.map(a=>`${a.startHour}-${a.endHour} ${a.taskName}`);
      const fullAgenda = agendaItems.join(' · ');
      const maxVisibleItems = 3;
      const hasMoreByItems = agendaItems.length > maxVisibleItems;
      let previewAgenda = agendaItems.slice(0, maxVisibleItems).join(' · ');
      const hasMoreByLength = !hasMoreByItems && previewAgenda.length > 110;
      if(hasMoreByLength) previewAgenda = `${previewAgenda.slice(0, 107).trimEnd()}…`;
      const canExpand = hasMoreByItems || hasMoreByLength;
      const hiddenAgendaCount = hasMoreByItems ? (agendaItems.length - maxVisibleItems) : (hasMoreByLength ? 1 : 0);

      const agendaHtml = !fullAgenda
        ? `<div class="agenda">Sin actividades asignadas</div>`
        : canExpand
          ? `<div class="agenda agenda-collapsed" data-agenda-expandable="1" data-expanded="false"><span class="agenda-preview">${esc(previewAgenda)}</span><span class="agenda-full hidden">${esc(fullAgenda)}</span><button class="more-inline-btn agenda-toggle" type="button" data-more-count="${hiddenAgendaCount}" aria-expanded="false">ver más (${hiddenAgendaCount})</button></div>`
          : `<div class="agenda">${esc(fullAgenda)}</div>`;

      return `
        <div class="person">
          <div class="n">
            <span>${esc(t.name)}</span>
            <span class="pill ${sev.className}">${util}%</span>
          </div>
          <div class="meter"><span style="width:${Math.min(100,util)}%"></span></div>
          <div class="meta">Flujo ${fmtH(min)} · Capacidad ${fmtH(cap)} · Libre ${fmtH(free)}</div>
          ${agendaHtml}
          <div style="margin-top:6px">${blockTags || '<span class="small muted">Sin bloqueos</span>'}</div>
        </div>
      `;
    }).join('');

    const cardsEl = $('todayCards');
    if(!cardsEl) return;
    cardsEl.innerHTML = cards || `<div class="muted small">Sin responsables para mostrar.</div>`;

    cardsEl.querySelectorAll('.agenda-toggle').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const agenda = btn.closest('[data-agenda-expandable]');
        if(!agenda) return;

        const expanded = agenda.getAttribute('data-expanded') === 'true';
        const next = !expanded;

        agenda.setAttribute('data-expanded', next ? 'true' : 'false');
        agenda.classList.toggle('agenda-collapsed', !next);

        const preview = agenda.querySelector('.agenda-preview');
        const full = agenda.querySelector('.agenda-full');

        if(preview) preview.classList.toggle('hidden', next);
        if(full) full.classList.toggle('hidden', !next);

        const moreCount = Number(btn.getAttribute('data-more-count') || '0');
        btn.textContent = next ? 'ver menos' : `ver más (${moreCount})`;
        btn.setAttribute('aria-expanded', next ? 'true' : 'false');
      });
    });
  }

  function renderPriorityRadar(){
    const day = ui.date;
    const acts = getVisibleActivityInstances(day);

    const groups = {
      'Alta': acts.filter(a=>a.priority==='Alta').sort((a,b)=>priorityRank(a.priority)-priorityRank(b.priority) || a.startHour.localeCompare(b.startHour)),
      'Media': acts.filter(a=>a.priority==='Media').sort((a,b)=>a.startHour.localeCompare(b.startHour)),
      'Baja': acts.filter(a=>a.priority==='Baja').sort((a,b)=>a.startHour.localeCompare(b.startHour))
    };

    const buildItemLabel = (a)=>`${esc(a.startHour)} ${esc(findTeam(a.ownerId)?.name || '-')} · ${esc(a.taskName)}`;

    const build = (key, cls) => {
      const arr = groups[key];
      const visible = arr.slice(0,4);
      const hidden = arr.slice(4);
      const dayKey = String(day || '').replace(/[^\w-]/g,'_');
      const groupId = `prio_more_${dayKey}_${key.toLowerCase()}`;

      const visibleItems = visible.map((a, idx)=>{
        const isLastVisible = idx === visible.length - 1;
        const inlineToggle = (hidden.length && isLastVisible)
          ? ` <button class="more-inline-btn prio-toggle" type="button" data-prio-group="${esc(groupId)}" data-more-count="${hidden.length}" data-expanded="false" aria-expanded="false">ver más (${hidden.length})</button>`
          : '';
        return `<li>${buildItemLabel(a)}${inlineToggle}</li>`;
      }).join('');

      const hiddenItems = hidden
        .map(a=>`<li class="prio-extra hidden" data-prio-group="${esc(groupId)}">${buildItemLabel(a)}</li>`)
        .join('');

      return `
        <div class="prio">
          <div class="t"><span class="${cls}">${key}</span><span class="pill">${arr.length}</span></div>
          <ul>${visibleItems || '<li class="muted">Sin flujo</li>'}${hiddenItems}</ul>
        </div>
      `;
    };

    const radarEl = $('priorityRadar');
    if(!radarEl) return;
    radarEl.innerHTML = [
      build('Alta','tagA'),
      build('Media','tagM'),
      build('Baja','tagB')
    ].join('');

    radarEl.querySelectorAll('.prio-toggle').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const group = btn.getAttribute('data-prio-group');
        if(!group) return;

        const expanded = btn.getAttribute('data-expanded') === 'true';
        const next = !expanded;

        const safeGroup = (window.CSS && typeof CSS.escape === 'function')
          ? CSS.escape(group)
          : String(group).replace(/["\\]/g,'\\$&');
        radarEl.querySelectorAll(`.prio-extra[data-prio-group="${safeGroup}"]`).forEach(li=>{
          li.classList.toggle('hidden', !next);
        });

        btn.setAttribute('data-expanded', next ? 'true' : 'false');
        btn.setAttribute('aria-expanded', next ? 'true' : 'false');
        const moreCount = Number(btn.getAttribute('data-more-count') || '0');
        btn.textContent = next ? 'ver menos' : `ver más (${moreCount})`;
      });
    });
  }

  function renderView(){
    if(ui.view !== 'day'){
      document.documentElement.style.setProperty('--hour-h','56px');
    }
    if(ui.view === 'day') return renderDayView();
    if(ui.view === 'week') return renderWeekView();
    if(ui.view === 'month') return renderMonthCalendarView();
    if(ui.view === 'roadmap'){
      try{ return renderRoadmapView(); }
      catch(err){
        console.error('[roadmap-render-fallback]', err);
        const c = $('mainView');
        if(c){
          c.innerHTML = `<div class="roadmap"><div class="road-empty">No se pudo renderizar el Roadmap con esta configuración. Intenta cambiar el zoom o revisar datos de fechas.</div></div>`;
        }
        return;
      }
    }
    return renderAvailabilityView();
  }

  function renderDayView(fitPass = 0, windowOverride = null){
    const container = $('mainView');
    const date = ui.date;
    const acts = getVisibleActivityInstances(date);
    const nonWorking = isNonWorkingDayISO(date);

    // Escala horaria estable para evitar que todo el día se deforme.
    document.documentElement.style.setProperty('--hour-h','56px');
    const pxHour = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--hour-h')) || 56;

    const team = getFilteredTeam();
    container.style.setProperty('--team-count', String(team.length || 1));

    const teamStartHour = Math.min(...team.map(t=>t.startHour), state.settings.defaultStartHour);
    const teamEndHour = Math.max(...team.map(t=>t.endHour), state.settings.defaultEndHour);

    let displayStartHour = teamStartHour;
    let displayEndHour = teamEndHour;

    // Mostrar TODO el rango horario del equipo (no solo horas ocupadas).
    if(windowOverride && Number.isFinite(windowOverride.start) && Number.isFinite(windowOverride.end)){
      displayStartHour = clampInt(windowOverride.start, 0, 23, teamStartHour);
      displayEndHour = clampInt(windowOverride.end, displayStartHour + 1, 24, teamEndHour);
    }else{
      displayStartHour = clampInt(teamStartHour, 0, 23, state.settings.defaultStartHour);
      displayEndHour = clampInt(teamEndHour, displayStartHour + 1, 24, state.settings.defaultEndHour);
    }

    let html = `<div class="day-grid">`;
    html += `<div class="grid-head">Hora</div>`;

    team.forEach(t => {
      const mine = acts.filter(a=>a.ownerId===t.id);
      const min = mine.reduce((x,y)=>x+y.minutes,0);
      const cap = getDailyCapacityMin(t, date);
      const util = cap ? Math.round(min/cap*100) : 0;
      html += `<div class="grid-head owner-head"><div>${esc(t.name)}</div><div class="sub">${fmtH(min)} · cap ${fmtH(cap)} · ${util}% ${nonWorking?` · ${esc(nonWorkingReason(date))}`:''}</div></div>`;
    });

    html += `<div class="time-col">`;
    for(let h=displayStartHour; h<displayEndHour; h++){
      html += `<div class="time-cell">${h}:00</div>`;
    }
    html += `</div>`;

    for(const person of team){
      const mine = acts.filter(a => a.ownerId === person.id);
      const lanes = calcLanes(mine, displayStartHour, displayEndHour);
      const blocks = blockIntervalsForDay(person, date, displayStartHour, displayEndHour);

      html += `<div class="day-col">`;

      blocks.forEach(bl=>{
        const top = minutesToPx(bl.startMin, displayStartHour);
        const h = minutesToPx(bl.endMin, displayStartHour) - top;
        const blockLabel = /fin\s+de\s+semana/i.test(String(bl.type||'')) ? 'Fin de semana' : 'No disponible';
        html += `<div class="blocked-slot" style="top:${top}px;height:${Math.max(22,h)}px" title="${esc(bl.type)} ${bl.startHour}-${bl.endHour}"><span class="blocked-name ${/no\s+disponible/i.test(String(blockLabel||''))?'is-unavailable':''}">${esc(blockLabel)}</span></div>`;
      });

      for(const ev of lanes){
        const laneWidth = 100 / ev.totalLanes;
        const left = ev.lane * laneWidth;
        const laneGapPx = 10;
        const cardTop = Math.max(0, ev.top + 1);
        const cardHeight = Math.max(22, ev.height - 2);
        const cardLeft = 'calc(0%)';
        const cardWidth = 'calc(100%)';
        const dayProgress = multiDayProgress(ev.startDate, ev.endDate, date);
        const tone = projectToneIndex(ev.projectId);
        const shownStatus = ev.displayStatus || ev.status || 'Programado';
        const durationMin = Number(ev.minutes) || durationMinutes(ev.startHour, ev.endHour);
        const visualMode = durationMin <= 30 ? 'half' : (durationMin <= 60 ? 'hour' : 'full');
        const sizeClass = visualMode === 'full'
          ? (cardHeight < 44 ? 'card-ultra' : (cardHeight < 68 ? 'card-compact' : ''))
          : '';
        const modeClass = visualMode === 'half' ? 'mode-half' : (visualMode === 'hour' ? 'mode-hour' : 'mode-full');

        let cardBody = '';
        if(visualMode === 'half'){
          cardBody = `
            <div class="h">
              <span class="project-title">${esc(ev.projectName)}</span>
              <span class="header-tags">
                <span class="tag time" title="Hora">${esc(ev.startHour)}-${esc(ev.endHour)}</span>
                <span class="tag client" title="Equipo">${esc(ev.client || 'Interno')}</span>
                <span class="status-badge ${statusClassName(shownStatus)}" title="Estatus">${esc(shownStatus)}</span>
              </span>
            </div>
          `;
        }else if(visualMode === 'hour'){
          cardBody = `
            <div class="h">
              <span class="project-title">${esc(ev.projectName)}</span>
              <span class="header-tags">
                <span class="tag time" title="Hora">${esc(ev.startHour)}-${esc(ev.endHour)}</span>
                <span class="tag client" title="Equipo">${esc(ev.client || 'Interno')}</span>
                <span class="status-badge ${statusClassName(shownStatus)}" title="Estatus">${esc(shownStatus)}</span>
              </span>
            </div>
            <div class="b">
              <div class="n">${esc(ev.taskName)}</div>
            </div>
          `;
        }else{
          cardBody = `
            <div class="h">
              <span class="project-title">${esc(ev.projectName)}</span>
              <span class="header-tags">
                <span class="tag time" title="Hora">${esc(ev.startHour)}-${esc(ev.endHour)}</span>
                <span class="tag client" title="Equipo">${esc(ev.client || 'Interno')}</span>
                <span class="status-badge ${statusClassName(shownStatus)}" title="Estatus">${esc(shownStatus)}</span>
              </span>
            </div>
            <div class="b">
              <div class="n">${esc(ev.taskName)}</div>
              ${dayProgress ? `<div class="meta-inline"><span class="meta-chip"><span class="v">${esc(dayProgress)}</span></span></div>` : ''}
            </div>
          `;
        }

        const titleText = visualMode === 'half' ? ev.projectName : `${ev.projectName} · ${ev.taskName}`;

        html += `
          <div class="task ${modeClass} ${sizeClass} tone-${tone} priority-${esc(ev.priority)}" style="top:${cardTop}px;height:${cardHeight}px;left:${cardLeft};width:${cardWidth}" data-project-id="${esc(ev.projectId)}" data-task-id="${esc(ev.taskId)}" data-start-hour="${esc(ev.startHour)}" data-end-hour="${esc(ev.endHour)}" title="${esc(titleText)}">
            ${cardBody}
          </div>
        `;
      }

      if(!lanes.length && nonWorking){
        html += `<div class="small muted" style="position:absolute;left:8px;right:8px;top:10px;font-weight:700">${esc(nonWorkingReason(date))}</div>`;
      }

      html += `</div>`;
    }

    html += `</div>`;
    container.innerHTML = html;

    // Mantener coherencia temporal: la tarjeta respeta su rango horario (sin estirar horas adicionales).

    container.querySelectorAll('.task').forEach(elm => {
      elm.addEventListener('click',()=>{
        if(isAdmin()) return openProjectEditor(elm.dataset.projectId);
        openProjectDetail(elm.dataset.projectId, elm.dataset.taskId);
      });
    });
  }

  function renderWeekView(){
    const c = $('mainView');
    const monday = startOfWeekISO(ui.date);
    const days = [0,1,2,3,4].map(i => addDaysISO(monday,i));

    const wkKey = (v)=> String(v ?? '')
      .normalize('NFD')
      .replace(/[̀-ͯ]/g,'')
      .trim()
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,'_')
      .replace(/^_+|_+$/g,'');

    const initials = (name)=>{
      const parts = String(name || '').trim().split(/\s+/).filter(Boolean);
      if(!parts.length) return '—';
      if(parts.length === 1) return parts[0].slice(0,2).toUpperCase();
      return `${parts[0][0] || ''}${parts[parts.length-1][0] || ''}`.toUpperCase();
    };

    const utilTone = (pct)=>{
      if(pct >= 90) return 'danger';
      if(pct >= 70) return 'warn';
      return 'ok';
    };

    const cols = days.map(day => {
      const nonWorking = isNonWorkingDayISO(day);
      const acts = getVisibleActivityInstances(day);
      const total = acts.reduce((a,b)=>a+b.minutes,0);
      const cap = getFilteredTeam().reduce((acc,t)=>acc + getDailyCapacityMin(t,day),0);
      const util = cap ? Math.round(total/cap*100) : (total ? 100 : 0);
      const ownerMap = new Map();

      acts.forEach(a => {
        if(!ownerMap.has(a.ownerId)) ownerMap.set(a.ownerId, []);
        ownerMap.get(a.ownerId).push(a);
      });

      const ownerCards = [...ownerMap.entries()]
        .map(([ownerId,list]) => {
          const personObj = findTeam(ownerId);
          const person = personObj?.name || 'Sin dueño';
          const min = list.reduce((x,y)=>x+y.minutes,0);
          const capP = personObj ? getDailyCapacityMin(personObj, day) : 0;
          const utilP = capP ? Math.round(min/capP*100) : (min ? 100 : 0);
          const sorted = list
            .slice()
            .sort((a,b)=>priorityRank(a.priority)-priorityRank(b.priority) || a.startHour.localeCompare(b.startHour));

          const top = sorted.slice(0,3);
          const rest = sorted.slice(3);
          const hiddenCount = rest.length;
          const moreId = `wkMore_${wkKey(day)}_${wkKey(ownerId || person)}`;
          const taskTiles = top.map(x=>`
            <div class="wk-task" data-project-id="${esc(x.projectId)}" data-task-id="${esc(x.taskId)}">
              <div class="a">${esc(x.startHour)} - ${esc(x.endHour)} · ${esc(x.taskName)}</div>
              <div class="b"><span>${esc(x.projectName)}</span><span class="status-badge ${statusClassName(x.displayStatus || x.status)}">${esc(x.displayStatus || x.status)}</span></div>
            </div>
          `).join('');
          const hiddenTaskTiles = rest.map(x=>`
            <div class="wk-task" data-project-id="${esc(x.projectId)}" data-task-id="${esc(x.taskId)}">
              <div class="a">${esc(x.startHour)} - ${esc(x.endHour)} · ${esc(x.taskName)}</div>
              <div class="b"><span>${esc(x.projectName)}</span><span class="status-badge ${statusClassName(x.displayStatus || x.status)}">${esc(x.displayStatus || x.status)}</span></div>
            </div>
          `).join('');

          return {
            person,
            min,
            card:`<article class="mini">
              <div class="mini-head">
                <div class="mini-person">
                  <span class="mini-avatar">${esc(initials(person))}</span>
                  <div>
                    <div class="a">${esc(person)}</div>
                    <div class="owner-meta">${fmtH(min)} de ${fmtH(capP)} · ${capP ? `${utilP}%` : 'Sin capacidad'}</div>
                  </div>
                </div>
                <span class="mini-util">${capP ? `${utilP}%` : '—'}</span>
              </div>
              <div class="mini-meter"><span style="width:${Math.max(0,Math.min(100,utilP))}%"></span></div>
              <div class="mini-tasks">
                ${taskTiles || `<div class="day-empty">Sin actividades asignadas</div>`}
                ${hiddenCount ? `<button class="wk-more" type="button" data-more-target="${esc(moreId)}" data-more-count="${hiddenCount}" aria-expanded="false">+${hiddenCount} más</button>` : ''}
                ${hiddenCount ? `<div class="wk-hidden" id="${esc(moreId)}">${hiddenTaskTiles}</div>` : ''}
              </div>
            </article>`
          };
        })
        .sort((a,b)=>(b.min - a.min) || a.person.localeCompare(b.person,'es'))
        .map(o=>o.card)
        .join('');

      return `
        <section class="day-card ${nonWorking ? 'offday' : ''}">
          <header class="day-card-head">
            <div>
              <h4>${esc(dayLabel(day))}</h4>
              <div class="day-head-sub">${nonWorking ? esc(nonWorkingReason(day)) : 'Día laborable'}</div>
            </div>
            <span class="util-pill ${utilTone(util)}">${util}%</span>
          </header>

          <div class="day-kpis">
            <div class="day-kpi"><div class="k">Flujo</div><div class="v">${fmtH(total)}</div></div>
            <div class="day-kpi"><div class="k">Capacidad</div><div class="v">${fmtH(cap)}</div></div>
          </div>

          ${nonWorking ? `<div class="day-off">${esc(nonWorkingReason(day))}</div>` : ''}

          <div class="day-owners">
            ${ownerCards || `<div class="day-empty">${nonWorking ? 'No laborable' : 'Sin actividades programadas'}</div>`}
          </div>
        </section>
      `;
    }).join('');

    c.innerHTML = `<div class="week-shell"><div class="week">${cols}</div></div>`;

    c.querySelectorAll('.wk-task').forEach(el=>{
      el.addEventListener('click',()=>{
        if(isAdmin()) return openProjectEditor(el.dataset.projectId);
        openProjectDetail(el.dataset.projectId, el.dataset.taskId);
      });
    });

    c.querySelectorAll('.wk-more').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const targetId = btn.getAttribute('data-more-target');
        const hidden = targetId ? document.getElementById(targetId) : null;
        if(!hidden) return;
        const expanded = hidden.classList.toggle('show');
        btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        const count = Number(btn.getAttribute('data-more-count') || 0);
        btn.textContent = expanded ? 'Mostrar menos' : `+${count} más`;
      });
    });
  }


  function getBusyIntervalsForPersonDay(person, dayISO){
    const acts = getVisibleActivityInstances(dayISO).filter(a=>a.ownerId===person.id);
    const taskIntervals = acts.map(a=>[timeToMin(a.startHour), timeToMin(a.endHour)]);
    const blockIntervals = blockIntervalsForDay(person, dayISO).map(b=>[b.startMin, b.endMin]);
    const all = taskIntervals.concat(blockIntervals).map(([s,e])=>[
      clamp(s, person.startHour*60, person.endHour*60),
      clamp(e, person.startHour*60, person.endHour*60)
    ]).filter(([s,e])=>e>s);
    return mergeIntervals(all);
  }

  function subtractIntervals(baseStart, baseEnd, busy){
    if(baseEnd <= baseStart) return [];
    if(!busy.length) return [[baseStart, baseEnd]];
    const out = [];
    let cursor = baseStart;
    for(const [s,e] of busy){
      if(e <= cursor) continue;
      if(s > cursor) out.push([cursor, Math.min(s, baseEnd)]);
      cursor = Math.max(cursor, e);
      if(cursor >= baseEnd) break;
    }
    if(cursor < baseEnd) out.push([cursor, baseEnd]);
    return out.filter(([s,e])=>e>s);
  }

  function minutesFromIntervals(iv){
    return iv.reduce((acc,[s,e])=>acc + (e-s), 0);
  }

  
  function renderMonthCalendarView(){
    const c = $('mainView');
    const monthStart = startOfMonthISO(ui.date);
    const monthEnd = addDaysISO(addMonthsISO(monthStart, 1), -1);

    const dayOffsetStart = (parseISO(monthStart).getDay() + 6) % 7; // Lunes = 0
    const gridStart = addDaysISO(monthStart, -dayOffsetStart);
    const dayOffsetEnd = 6 - ((parseISO(monthEnd).getDay() + 6) % 7);
    const gridEnd = addDaysISO(monthEnd, dayOffsetEnd);

    const filteredTeam = getFilteredTeam();
    const today = todayISO();

    let weekendActivityDays = 0;
    let probe = monthStart;
    while(probe <= monthEnd){
      const wd = parseISO(probe).getDay();
      if(wd === 0 || wd === 6){
        const weekendActs = getVisibleActivityInstances(probe);
        if(weekendActs.length) weekendActivityDays += 1;
      }
      probe = addDaysISO(probe, 1);
    }
    const showWeekends = weekendActivityDays > 0;

    const weekLabels = showWeekends
      ? ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom']
      : ['Lun','Mar','Mié','Jue','Vie'];
    const colCount = weekLabels.length;

    const cells = [];
    let d = gridStart;

    let totalActivitiesMonth = 0;
    const prioCount = { alta:0, media:0, baja:0 };
    const utilSamples = [];
    let overloadedDays = 0;
    let activeDays = 0;
    let consideredDays = 0;

    while(d <= gridEnd){
      const inMonth = d >= monthStart && d <= monthEnd;
      const dayDate = parseISO(d);
      const weekday = dayDate.getDay();
      const weekend = weekday === 0 || weekday === 6;
      const nonWorking = isNonWorkingDayISO(d);

      if(!showWeekends && weekend){
        d = addDaysISO(d, 1);
        continue;
      }

      const acts = getVisibleActivityInstances(d)
        .sort((a,b)=> priorityRank(a.priority)-priorityRank(b.priority) || a.startHour.localeCompare(b.startHour) || a.projectName.localeCompare(b.projectName));

      const totalMin = acts.reduce((acc,a)=>acc + a.minutes, 0);
      const capMin = filteredTeam.reduce((acc,t)=>acc + getDailyCapacityMin(t, d), 0);
      const util = capMin ? Math.round((totalMin/capMin)*100) : 0;
      const utilClass = util>=100 ? 'danger' : util>=85 ? 'warn' : 'ok';

      const dayPrioCount = { alta:0, media:0, baja:0 };
      for(const a of acts){
        const pri = String(a.priority || 'Media').toLowerCase();
        if(pri === 'alta') dayPrioCount.alta += 1;
        else if(pri === 'baja') dayPrioCount.baja += 1;
        else dayPrioCount.media += 1;
      }

      const dominantPriority =
        (dayPrioCount.alta >= dayPrioCount.media && dayPrioCount.alta >= dayPrioCount.baja) ? 'alta' :
        (dayPrioCount.media >= dayPrioCount.alta && dayPrioCount.media >= dayPrioCount.baja) ? 'media' : 'baja';

      let heatLevel = 0;
      if(inMonth && acts.length){
        const loadScore = capMin ? util : Math.min(140, acts.length * 30); // fallback simple
        heatLevel = loadScore >= 100 ? 3 : loadScore >= 70 ? 2 : 1;
      }

      if(inMonth){
        consideredDays += 1;
        totalActivitiesMonth += acts.length;
        utilSamples.push(util);
        if(util >= 100) overloadedDays += 1;
        if(acts.length) activeDays += 1;
        prioCount.alta += dayPrioCount.alta;
        prioCount.media += dayPrioCount.media;
        prioCount.baja += dayPrioCount.baja;
      }

      const pills = acts.slice(0,3).map(a=>{
        const tip = `${a.startHour} · ${a.taskName} · ${a.projectName}`;
        return `<button class="mcal-item pri-${String(a.priority||'Media').toLowerCase()}" data-project-id="${esc(a.projectId)}" data-task-id="${esc(a.taskId)}" title="${esc(tip)}">
          <span class="t">${esc(a.startHour)}</span>
          <span class="n">${esc(a.taskName)}</span>
        </button>`;
      }).join('');

      const more = acts.length > 3 ? `<button class="mcal-more" type="button" data-day-more="${esc(d)}" title="Ver ${acts.length-3} actividades adicionales">+${acts.length-3} más</button>` : '';
      const reason = nonWorking && inMonth ? `<div class="mcal-off">${esc(nonWorkingReason(d))}</div>` : '';
      const dayLabelRaw = dayDate.toLocaleDateString(APP_LOCALE,{weekday:'short'});
      const dayLabel = dayLabelRaw.replace('.','');

      cells.push(`
        <div class="mcal-cell ${inMonth?'in-month':'out'} ${d===today?'today':''} ${nonWorking?'offday':''} ${weekend?'weekend':''} ${acts.length?'has-items':'empty'} ${heatLevel?`heat heat-${dominantPriority} heat-l${heatLevel}`:''}" ${inMonth ? `data-day="${esc(d)}"` : ''}>
          <div class="mcal-cell-head">
            <div class="mcal-date-wrap">
              <span class="mcal-date">${dayDate.getDate()}</span>
              <span class="mcal-dow">${esc(dayLabel)}</span>
            </div>
            ${inMonth ? `<span class="pill ${utilClass} mcal-util">${util}%</span>` : ''}
          </div>
          ${reason}
          <div class="mcal-list">
            ${pills || (inMonth ? '<div class="mcal-empty">Sin tareas</div>' : '')}
            ${more}
          </div>
        </div>
      `);

      d = addDaysISO(d, 1);
    }

    const monthTitle = parseISO(monthStart).toLocaleDateString(APP_LOCALE, { month:'long', year:'numeric' });
    const avgUtil = utilSamples.length ? Math.round(utilSamples.reduce((a,b)=>a+b,0) / utilSamples.length) : 0;

    c.innerHTML = `
      <div class="monthcal-wrap">
        <div class="monthcal-shell">
          <div class="monthcal-top">
            <div>
              <div class="monthcal-title">${esc(monthTitle.charAt(0).toUpperCase() + monthTitle.slice(1))}</div>
              <div class="monthcal-subtitle">Vista mensual de flujo, prioridades y foco operativo · ordenada por día</div>
            </div>
          </div>

          <div class="monthcal-kpis">
            <div class="month-kpi">
              <div class="k">Actividades del mes</div>
              <div class="v">${totalActivitiesMonth}</div>
              <div class="s">${activeDays} de ${consideredDays} días con actividad</div>
            </div>
            <div class="month-kpi">
              <div class="k">Flujo promedio diario</div>
              <div class="v">${avgUtil}%</div>
              <div class="s">Promedio en días visibles</div>
            </div>
            <div class="month-kpi">
              <div class="k">Días de alto flujo</div>
              <div class="v">${overloadedDays}</div>
              <div class="s">Objetivo: reducir colisiones</div>
            </div>
            <div class="month-kpi">
              <div class="k">Mix de prioridad</div>
              <div class="v">${prioCount.alta}/${prioCount.media}/${prioCount.baja}</div>
              <div class="s">Alta / Media / Baja</div>
            </div>
          </div>

          <div class="monthcal-weekdays" style="--mcols:${colCount}">
            ${weekLabels.map(w=>`<div class="monthcal-weekday">${w}</div>`).join('')}
          </div>
          <div class="monthcal-grid" style="--mcols:${colCount}">${cells.join('')}</div>
        </div>
      </div>
    `;

    c.querySelectorAll('.mcal-cell[data-day]').forEach(cell=>{
      cell.addEventListener('click',(ev)=>{
        if(ev.target.closest('button')) return;
        openMonthDayModal(cell.dataset.day);
      });
    });

    c.querySelectorAll('.mcal-item[data-project-id]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        if(isAdmin()) return openProjectEditor(btn.dataset.projectId);
        openProjectDetail(btn.dataset.projectId, btn.dataset.taskId);
      });
    });

    c.querySelectorAll('.mcal-more[data-day-more]').forEach(btn=>{
      btn.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        openMonthDayModal(btn.dataset.dayMore);
      });
    });
  }


  function renderAvailabilityView(){
    const c = $('mainView');
    const monday = startOfWeekISO(ui.date);
    const days = [0,1,2,3,4].map(i => addDaysISO(monday,i));
    const team = getFilteredTeam();

    if(!team.length){
      c.innerHTML = `<div class="availability"><div class="muted small">Sin responsables para mostrar.</div></div>`;
      return;
    }

    const globalStart = Math.min(...team.map(t=>t.startHour))*60;
    const globalEnd = Math.max(...team.map(t=>t.endHour))*60;
    const slotSize = 30;
    const slotCount = Math.max(1, Math.ceil((globalEnd-globalStart)/slotSize));

    const dayHeaders = ['Lunes','Martes','Miércoles','Jueves','Viernes'];

    const rows = team.map(person=>{
      const cells = days.map((d,idx)=>{
        const busy = getBusyIntervalsForPersonDay(person, d);
        const free = subtractIntervals(person.startHour*60, person.endHour*60, busy);
        const freeMin = minutesFromIntervals(free);

        const slots = [];
        for(let t=globalStart; t<globalEnd; t+=slotSize){
          const s=t,e=t+slotSize;
          const inSchedule = s >= person.startHour*60 && e <= person.endHour*60;
          let className = 'off';
          if(inSchedule){
            const isFree = free.some(([fs,fe])=>Math.max(fs,s) < Math.min(fe,e));
            className = isFree ? 'av' : 'busy';
          }
          slots.push(`<span class="slot ${className}" title="${minToHHMM(s)}-${minToHHMM(e)}"></span>`);
        }

        return `
          <div>
            <div class="slots" style="--slot-count:${slotCount}">${slots.join('')}</div>
            <div class="day-free">${fmtH(freeMin)} libres · ${dayHeaders[idx]}</div>
          </div>
        `;
      }).join('');

      return `
        <div class="avail-row">
          <div>
            <div class="avail-user">${esc(person.name)}</div>
            <div class="avail-meta">${String(person.startHour).padStart(2,'0')}:00–${String(person.endHour).padStart(2,'0')}:00 · cap ${person.capacityHoursPerDay}h</div>
          </div>
          ${cells}
        </div>
      `;
    }).join('');

    c.innerHTML = `
      <div class="availability">
        <div class="avail-legend">
          <span><span class="dot av"></span> Disponible</span>
          <span><span class="dot busy"></span> Ocupado / bloqueado</span>
          <span>Semana: ${fmtDate(days[0])} → ${fmtDate(days[4])}</span>
        </div>
        <div class="avail-table">
          <div class="avail-head">
            <div>Responsable</div>
            ${days.map((d,i)=>`<div>${dayHeaders[i]}<br><span class="small muted">${fmtDate(d)}</span></div>`).join('')}
          </div>
          ${rows}
        </div>
      </div>
    `;
  }

  function roadmapStatusOrder(status){
    const s = String(status||'');
    if(s === 'En curso') return 1;
    if(s === 'Programado') return 2;
    if(s === 'Demorado') return 3;
    if(s === 'Finalizado') return 4;
    return 5;
  }


  
  function buildRoadmapTicks(windowStart, windowEnd, zoom){
    const ticks = [];

    if(zoom === 'week'){
      const dayNames = ['LUN','MAR','MIÉ','JUE','VIE'];
      for(let i=0;i<5;i++){
        const dIso = addDaysISO(windowStart, i);
        if(dIso > windowEnd) break;
        const d = parseISO(dIso);
        ticks.push({
          label: `${dayNames[i]} ${String(d.getDate()).padStart(2,'0')}`,
          startDate: dIso,
          endDate: dIso,
          month: d.getMonth()+1,
          year: d.getFullYear()
        });
      }
      if(!ticks.length){
        const d = parseISO(windowStart);
        ticks.push({
          label: d.toLocaleDateString(APP_LOCALE,{weekday:'short',day:'2-digit'}).toUpperCase(),
          startDate: windowStart,
          endDate: windowStart,
          month: d.getMonth()+1,
          year: d.getFullYear()
        });
      }
      return ticks;
    }

    // Encabezados por meses para vistas Mensual y Anual.
    let cursor = startOfMonthISO(windowStart);
    let guard = 0;

    while(cursor <= windowEnd && guard < 24){
      const monthStart = cursor;
      const monthEnd = addDaysISO(addMonthsISO(monthStart, 1), -1);
      const startDate = maxISO(monthStart, windowStart);
      const endDate = minISO(monthEnd, windowEnd);

      if(startDate <= endDate){
        const d = parseISO(monthStart);
        ticks.push({
          label: d.toLocaleDateString(APP_LOCALE, { month:'short' }).toUpperCase(),
          startDate,
          endDate,
          month: d.getMonth()+1,
          year: d.getFullYear()
        });
      }

      cursor = addMonthsISO(cursor, 1);
      guard += 1;
    }

    if(!ticks.length){
      const d = parseISO(windowStart);
      ticks.push({
        label: d.toLocaleDateString(APP_LOCALE, { month:'short' }).toUpperCase(),
        startDate: windowStart,
        endDate: windowEnd,
        month: d.getMonth()+1,
        year: d.getFullYear()
      });
    }

    return ticks;
  }

  function paintRoadmapRowsChunked(container, rowsHtml){
    if(!container) return;
    if(!Array.isArray(rowsHtml) || !rowsHtml.length){
      container.innerHTML = `<div class="road-empty">Sin proyectos para mostrar con los filtros actuales.</div>`;
      return;
    }

    const chunkSize = 60;
    let idx = 0;
    container.innerHTML = '';

    const draw = ()=>{
      const end = Math.min(idx + chunkSize, rowsHtml.length);
      const chunk = rowsHtml.slice(idx, end).join('');
      container.insertAdjacentHTML('beforeend', chunk);
      idx = end;
      if(idx < rowsHtml.length) requestAnimationFrame(draw);
    };

    requestAnimationFrame(draw);
  }

  function clampSpanToWindow(startISO, endISO, windowStart, windowEnd){
    const s0 = normalizeISO(startISO);
    const e0 = normalizeISO(endISO || startISO);
    if(!s0 || !e0) return null;

    const s = maxISO(s0, windowStart);
    const e = minISO(e0, windowEnd);
    if(!s || !e || s > e) return null;
    return { startDate: s, endDate: e };
  }

  function toSpanStyle(startISO, endISO, windowStart, windowEnd){
    const totalDays = Math.max(1, daysDiff(windowStart, windowEnd) + 1);
    const rawStart = daysDiff(windowStart, startISO);
    const rawEnd = daysDiff(windowStart, endISO) + 1;
    const startOffset = Number.isFinite(rawStart) ? clamp(rawStart, 0, totalDays - 1) : 0;
    const endOffset = Number.isFinite(rawEnd) ? clamp(rawEnd, 1, totalDays) : Math.max(1, startOffset + 1);

    const left = (startOffset / totalDays) * 100;
    const width = Math.max(0.8, ((endOffset - startOffset) / totalDays) * 100);
    return `left:${left.toFixed(4)}%;width:${width.toFixed(4)}%;`;
  }

  function mergeIntervals(intervals){
    if(!Array.isArray(intervals) || !intervals.length) return [];
    const sorted = intervals
      .filter(x=>x && x.startDate && x.endDate)
      .slice()
      .sort((a,b)=>a.startDate === b.startDate ? a.endDate.localeCompare(b.endDate) : a.startDate.localeCompare(b.startDate));

    const out = [];
    sorted.forEach(seg=>{
      const last = out[out.length - 1];
      if(last && seg.startDate <= addDaysISO(last.endDate, 1)){
        if(seg.endDate > last.endDate) last.endDate = seg.endDate;
      }else{
        out.push({ startDate: seg.startDate, endDate: seg.endDate });
      }
    });
    return out;
  }

  function buildProjectSolidSpan(mergedOccurrences, windowStart, windowEnd){
    if(!Array.isArray(mergedOccurrences) || !mergedOccurrences.length) return null;
    let minStart = mergedOccurrences[0].startDate;
    let maxEnd = mergedOccurrences[0].endDate;

    for(let i=1; i<mergedOccurrences.length; i++){
      const occ = mergedOccurrences[i];
      if(occ.startDate < minStart) minStart = occ.startDate;
      if(occ.endDate > maxEnd) maxEnd = occ.endDate;
    }

    return clampSpanToWindow(minStart, maxEnd, windowStart, windowEnd);
  }

  function estimateMonthRecurringEnvelope(project, windowStart, windowEnd){
    const meta = recurrenceMeta(project?.recurrenceFrequency);
    if(meta.unit !== 'month' || meta.step <= 0) return null;

    const baseStart = normalizeISO(project?.startDate);
    const baseEnd = normalizeISO(project?.endDate || project?.startDate);
    if(!baseStart || !baseEnd) return null;

    const firstIdx = Math.max(0, Math.floor((monthDiffISO(baseStart, windowStart) - 2) / meta.step));
    const lastIdx = Math.max(firstIdx, Math.ceil((monthDiffISO(baseStart, windowEnd) + 2) / meta.step));

    let minStart = null;
    let maxEnd = null;

    for(let idx = firstIdx; idx <= lastIdx && idx < firstIdx + 36; idx++){
      const mapped = mapRecurringDateRange(baseStart, baseEnd, {
        months: idx * meta.step,
        useBusinessCalendar: true
      });
      if(!mapped) continue;

      const clipped = clampSpanToWindow(mapped.startDate, mapped.endDate, windowStart, windowEnd);
      if(!clipped) continue;

      if(!minStart || clipped.startDate < minStart) minStart = clipped.startDate;
      if(!maxEnd || clipped.endDate > maxEnd) maxEnd = clipped.endDate;
    }

    if(!minStart || !maxEnd) return null;
    return { startDate:minStart, endDate:maxEnd };
  }

  function estimateProjectRoadmapSpan(project, windowStart, windowEnd){
    const pStart = normalizeISO(project?.startDate);
    const pEnd = normalizeISO(project?.endDate || project?.startDate);
    if(!pStart || !pEnd) return null;

    if(!isRecurringProject(project)){
      return clampSpanToWindow(pStart, pEnd, windowStart, windowEnd);
    }

    const rec = normalizeRecurrenceFrequency(project?.recurrenceFrequency);

    // Diaria se trata como franja base (muy liviano y evita miles de ocurrencias).
    if(rec === 'Diaria'){
      return clampSpanToWindow(pStart, pEnd, windowStart, windowEnd);
    }

    // Mensual/Trimestral/Anual: envelope optimizado por ventanas.
    const env = estimateMonthRecurringEnvelope(project, windowStart, windowEnd);
    if(env) return env;

    // Fallback defensivo
    return clampSpanToWindow(pStart, pEnd, windowStart, windowEnd);
  }

  function buildActivityRoadmapSpans(project, projectSpan, windowStart, windowEnd){
    const acts = Array.isArray(project?.activities) ? project.activities : [];
    if(!acts.length) return [];

    const recurring = isRecurringProject(project);
    const maxLines = 6;
    const rows = [];

    const pStart = normalizeISO(project?.startDate) || (projectSpan?.startDate || windowStart);
    const pEnd = normalizeISO(project?.endDate || project?.startDate) || (projectSpan?.endDate || windowEnd);
    const baseDur = Math.max(1, daysDiff(pStart, pEnd) + 1);

    for(let i=0; i<acts.length && rows.length < maxLines; i++){
      const a = acts[i] || {};
      let span = null;

      if(!recurring){
        const aStart = normalizeISO(a.startDate);
        const aEnd = normalizeISO(a.endDate || a.startDate);
        span = clampSpanToWindow(aStart, aEnd, windowStart, windowEnd);
      }else if(projectSpan){
        // Proyección liviana para no iterar cientos de ocurrencias:
        // ubica la actividad según su posición relativa dentro de la franja del proyecto.
        const aStart = normalizeISO(a.startDate) || pStart;
        const aEnd = normalizeISO(a.endDate || a.startDate) || aStart;

        const offsetDays = clamp(daysDiff(pStart, aStart), 0, baseDur - 1);
        const actDurBase = Math.max(1, daysDiff(aStart, aEnd) + 1);

        const envDur = Math.max(1, daysDiff(projectSpan.startDate, projectSpan.endDate) + 1);
        const projectedOffset = Math.round((offsetDays / baseDur) * (envDur - 1));
        const projectedDur = Math.max(1, Math.round((actDurBase / baseDur) * envDur));

        const s = addDaysISO(projectSpan.startDate, projectedOffset);
        const e = addDaysISO(s, Math.max(0, projectedDur - 1));
        span = clampSpanToWindow(s, e, windowStart, windowEnd);
      }

      if(!span) continue;

      rows.push({
        id: String(a.id || `act_${i+1}`),
        name: String(a.name || `Act ${i+1}`),
        ownerName: findTeam(a.ownerId)?.name || 'Sin dueño',
        startDate: span.startDate,
        endDate: span.endDate
      });
    }

    rows.sort((a,b)=>a.startDate === b.startDate ? a.endDate.localeCompare(b.endDate) : a.startDate.localeCompare(b.startDate));
    return rows;
  }

  function roadmapProjectVisible(p){
    if(ui.filters.priority && p.priority !== ui.filters.priority) return false;

    const client = String(p?.client || 'Interno').trim() || 'Interno';
    if(ui.filters.client && client !== ui.filters.client) return false;

    if(ui.filters.owner){
      const hasOwner = (p.activities||[]).some(a => a.ownerId === ui.filters.owner);
      if(!hasOwner) return false;
    }

    // En Roadmap ignoramos filtro de estatus para evitar "desapariciones" inesperadas.
    const q = String(ui.filters.q || '').trim().toLowerCase();
    if(q){
      const blob = `${p.name} ${client} ${normalizeRecurrenceFrequency(p.recurrenceFrequency)} ${(p.activities||[]).map(a=>a.name).join(' ')}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  }

  function renderRoadmapView(){
    const c = $('mainView');
    const ref = ui.date || todayISO();
    const zoom = (ui.roadmapZoom === 'week' || ui.roadmapZoom === 'year') ? ui.roadmapZoom : 'month';
    const range = getRoadmapWindow(ref, zoom);
    const zoomLabel = zoom === 'year' ? 'Anual' : (zoom === 'week' ? 'Semanal' : 'Mensual');

    const ticks = buildRoadmapTicks(range.start, range.end, zoom);
    c.style.setProperty('--road-cols', String(ticks.length || 1));

    const allVisible = state.projects
      .filter(roadmapProjectVisible)
      .map(p=>({ p, status: projectStatus(p, ref) }))
      .sort((a,b)=>{
        const pr = priorityRank(a.p.priority) - priorityRank(b.p.priority);
        if(pr) return pr;
        if(a.p.startDate !== b.p.startDate) return String(a.p.startDate||'').localeCompare(String(b.p.startDate||''));
        return String(a.p.name||'').localeCompare(String(b.p.name||''), APP_LOCALE);
      });

    const rows = [];
    const monthLoad = Array.from({length:ticks.length}, ()=>0);

    for(let pi=0; pi<allVisible.length; pi++){
      const { p, status:pStatus } = allVisible[pi];
      try{
        const recurringLabel = isRecurringProject(p) ? normalizeRecurrenceFrequency(p.recurrenceFrequency) : 'Único';
        const priKey = p.priority === 'Alta' ? 'alta' : (p.priority === 'Baja' ? 'baja' : 'media');
        const weight = p.priority === 'Alta' ? 3 : (p.priority === 'Media' ? 2 : 1);

        const projectSpan = estimateProjectRoadmapSpan(p, range.start, range.end);
        let projectBarHtml = `<div class="road-lane project"></div>`;
        let activityRows = [];
        let outsideWindow = true;

        if(projectSpan){
          outsideWindow = false;
          const projectTitle = `${p.name} · ${fmtDate(projectSpan.startDate)} → ${fmtDate(projectSpan.endDate)}`;
          const projectStyle = toSpanStyle(projectSpan.startDate, projectSpan.endDate, range.start, range.end);
          projectBarHtml = `
            <div class="road-lane project" title="${esc(projectTitle)}">
              <span class="road-solid pri-${priKey}" style="${projectStyle}"></span>
            </div>
          `;

          activityRows = buildActivityRoadmapSpans(p, projectSpan, range.start, range.end);

          for(let ti=0; ti<ticks.length; ti++){
            const t = ticks[ti];
            if(projectSpan.startDate <= t.endDate && projectSpan.endDate >= t.startDate){
              monthLoad[ti] += weight;
            }
          }
        }

        const maxActivityShown = 6;
        const visibleActs = activityRows.slice(0, maxActivityShown);
        const hiddenActs = Math.max(0, activityRows.length - visibleActs.length);

        const actLabelHtml = visibleActs.length
          ? visibleActs.map(a=>`<div class="road-act-label" title="${esc(a.name)} · ${esc(a.ownerName)}">${esc(a.name)}</div>`).join('')
          : `<div class="road-act-label muted">${outsideWindow ? 'Fuera de ventana' : 'Sin actividades'}</div>`;

        const plusActs = hiddenActs > 0 ? `<div class="road-act-label muted">+${hiddenActs} más…</div>` : '';

        const actLaneHtml = visibleActs.length
          ? visibleActs.map(a=>{
              const title = `${a.name} · ${a.ownerName} · ${fmtDate(a.startDate)} → ${fmtDate(a.endDate)}`;
              const style = toSpanStyle(a.startDate, a.endDate, range.start, range.end);
              return `<div class="road-lane act" title="${esc(title)}"><span class="road-act-seg" style="${style}"></span></div>`;
            }).join('')
          : `<div class="road-lane act"></div>`;

        rows.push(`
          <div class="road-row ${outsideWindow ? 'out-window' : ''}" data-project-id="${esc(p.id)}">
            <div class="road-name clickable" title="Ver detalle del proyecto">
              <div class="road-proj-title">${esc(p.name)}</div>
              <div class="road-proj-meta">
                <span class="tag">Prioridad ${esc(p.priority)}</span>
                <span class="tag">${esc(recurringLabel)}</span>
                <span class="status-badge ${statusClassName(pStatus)}">${esc(pStatus)}</span>
              </div>
              <div class="road-act-labels">${actLabelHtml}${plusActs}</div>
            </div>
            <div class="road-track-solid">
              ${projectBarHtml}
              ${actLaneHtml}
            </div>
          </div>
        `);
      }catch(err){
        console.warn('[roadmap-row-skip]', p?.name, err);
      }
    }

    const maxLoad = Math.max(1, ...monthLoad);
    const loadTitle = zoom === 'week' ? 'Presión diaria' : 'Presión mensual';
    const peakTitle = zoom === 'week' ? 'Día pico' : 'Mes pico';
    const heatHtml = ticks.map((t, i)=>{
      const score = monthLoad[i];
      const pct = clamp(Math.round((score / maxLoad) * 100), 0, 100);
      const alpha = (0.15 + (pct / 100) * 0.75).toFixed(3);
      const title = `${t.label} ${t.year} · Presión ${score}`;
      return `<div class="road-heat-cell" title="${esc(title)}"><span style="opacity:${alpha}"></span><b>${score}</b></div>`;
    }).join('');

    const headHtml = `<div class="h-project">Proyecto</div>${ticks.map((t)=>{
      const title = `${fmtDate(t.startDate)}${t.endDate!==t.startDate?` → ${fmtDate(t.endDate)}`:''}`;
      return `<div class="h-tick" title="${esc(title)}">${esc(t.label)}</div>`;
    }).join('')}`;

    c.innerHTML = `
      <div class="roadmap">
        <div class="road-summary">
          <div class="road-kpi"><div class="k">Vista</div><div class="v small">Roadmap ${zoomLabel}</div></div>
          <div class="road-kpi"><div class="k">Ventana</div><div class="v small">${esc(fmtDate(range.start))} → ${esc(fmtDate(range.end))}</div></div>
          <div class="road-kpi"><div class="k">Proyectos</div><div class="v">${rows.length}</div></div>
          <div class="road-kpi"><div class="k">${peakTitle}</div><div class="v small">${ticks[monthLoad.indexOf(maxLoad)] ? `${ticks[monthLoad.indexOf(maxLoad)].label} (${maxLoad})` : '-'}</div></div>
        </div>

        <div class="road-legend">
          <span><span class="dot alta"></span> Bloque proyecto (Alta)</span>
          <span><span class="dot media"></span> Bloque proyecto (Media)</span>
          <span><span class="dot baja"></span> Bloque proyecto (Baja)</span>
          <span><span class="dot act"></span> Línea de actividad</span>
        </div>

        <div class="road-table-wrap">
          <div class="road-load-wrap">
            <div class="road-load-title">${loadTitle}</div>
            <div class="road-load-grid">${heatHtml}</div>
          </div>
          <div class="road-head">${headHtml}</div>
          <div class="road-body"><div class="road-empty">Cargando roadmap…</div></div>
        </div>
      </div>
    `;

    const bodyEl = c.querySelector('.road-body');
    paintRoadmapRowsChunked(bodyEl, rows);

    const roadmapRoot = c.querySelector('.roadmap');
    if(roadmapRoot){
      roadmapRoot.addEventListener('click', (evt)=>{
        const row = evt.target.closest('.road-row[data-project-id]');
        if(!row) return;
        const projectId = row.dataset.projectId;
        if(!projectId) return;
        if(isAdmin()) return openProjectEditor(projectId);
        openProjectDetail(projectId);
      });
    }
  }


  function setDetailOverlayLabels(title = 'Detalle del proyecto', foot = 'Vista de solo lectura'){
    const titleNode = document.querySelector('#detailOverlay .m-head b');
    if(titleNode) titleNode.textContent = title;
    const footNode = document.querySelector('#detailOverlay .m-foot .small.muted');
    if(footNode) footNode.textContent = foot;
  }

  function openMonthDayModal(dayISO){
    const day = normalizeISO(dayISO) || ui.date;
    const acts = getVisibleActivityInstances(day).sort((a,b)=>{
      const pr = priorityRank(a.priority) - priorityRank(b.priority);
      if(pr) return pr;
      if(a.startHour !== b.startHour) return String(a.startHour||'').localeCompare(String(b.startHour||''));
      const ownerCmp = String(a.ownerName||'').localeCompare(String(b.ownerName||''), APP_LOCALE);
      if(ownerCmp) return ownerCmp;
      return String(a.projectName||'').localeCompare(String(b.projectName||''), APP_LOCALE);
    });

    const totalMin = acts.reduce((acc,a)=>acc + durationMinutes(a.startHour, a.endHour), 0);
    const capMin = getFilteredTeam().reduce((acc,t)=>acc + getDailyCapacityMin(t, day), 0);
    const util = capMin ? Math.round((totalMin / capMin) * 100) : 0;
    const nonWorking = isNonWorkingDayISO(day);

    if(!acts.length){
      $('detailBody').innerHTML = `
        <div class="month-day-modal">
          <div class="month-day-top">
            <span class="month-day-chip">Fecha: <b>${esc(fmtDate(day))}</b></span>
            <span class="month-day-chip">Sin actividades</span>
            ${nonWorking ? `<span class="month-day-chip">${esc(nonWorkingReason(day))}</span>` : ''}
          </div>
          <div class="month-day-empty">No hay proyectos/actividades para mostrar en este día.</div>
        </div>
      `;
      setDetailOverlayLabels(`Agenda del día · ${fmtDate(day)}`, 'Vista resumen diaria');
      openOverlay('detailOverlay');
      return;
    }

    const priorityBuckets = { Alta:[], Media:[], Baja:[] };
    acts.forEach(a=>{
      const key = (a.priority === 'Alta' || a.priority === 'Baja') ? a.priority : 'Media';
      priorityBuckets[key].push(a);
    });

    const sectionOrder = ['Alta','Media','Baja'];
    const prioKpiHtml = sectionOrder.map(label=>{
      const key = label.toLowerCase();
      const items = priorityBuckets[label];
      const min = items.reduce((acc,a)=>acc + durationMinutes(a.startHour, a.endHour), 0);
      return `
        <div class="month-day-prio-kpi ${key}">
          <div class="k">Prioridad ${label}</div>
          <div class="v">${items.length}</div>
          <div class="s">${fmtH(min)}</div>
        </div>
      `;
    }).join('');

    const sectionsHtml = sectionOrder
      .filter(label=>priorityBuckets[label].length)
      .map(label=>{
        const key = label.toLowerCase();
        const items = priorityBuckets[label].slice().sort((a,b)=>{
          if(a.startHour !== b.startHour) return String(a.startHour||'').localeCompare(String(b.startHour||''));
          const ownerCmp = String(a.ownerName||'').localeCompare(String(b.ownerName||''), APP_LOCALE);
          if(ownerCmp) return ownerCmp;
          return String(a.projectName||'').localeCompare(String(b.projectName||''), APP_LOCALE);
        });
        const bucketMin = items.reduce((acc,a)=>acc + durationMinutes(a.startHour, a.endHour), 0);

        const rows = items.map(a=>{
          const pri = String(a.priority || 'Media').toLowerCase();
          const priLabel = a.priority || 'Media';
          const status = a.displayStatus || a.status || 'Programado';
          const owner = a.ownerName || 'Sin dueño';
          const metaParts = [owner, a.client || 'Interno'];
          if(a.taskDetail) metaParts.push(a.taskDetail);
          return `
            <button type="button" class="month-day-item pri-${esc(pri)}" data-project-id="${esc(a.projectId)}" data-task-id="${esc(a.taskId)}">
              <div class="top">
                <span class="time">${esc(a.startHour)}-${esc(a.endHour)}</span>
                <span class="tags">
                  <span class="month-priority ${esc(pri)}">${esc(priLabel)}</span>
                  <span class="status-badge ${statusClassName(status)}">${esc(status)}</span>
                </span>
              </div>
              <div class="title">${esc(a.projectName)} · ${esc(a.taskName)}</div>
              <div class="meta">${esc(metaParts.join(' · '))}</div>
            </button>
          `;
        }).join('');

        return `
          <section class="month-day-section prio-${key}">
            <div class="month-day-section-head">
              <div class="lhs">
                <span class="month-priority ${key}">${label}</span>
                <b>Prioridad ${label}</b>
              </div>
              <span>${items.length} actividad(es) · ${fmtH(bucketMin)}</span>
            </div>
            <div class="month-day-list">${rows}</div>
          </section>
        `;
      }).join('');

    $('detailBody').innerHTML = `
      <div class="month-day-modal">
        <div class="month-day-top">
          <span class="month-day-chip">Fecha: <b>${esc(fmtDate(day))}</b></span>
          <span class="month-day-chip">Actividades: <b>${acts.length}</b></span>
          <span class="month-day-chip">Flujo: <b>${fmtH(totalMin)}</b> · ${util}%</span>
          <span class="month-day-chip">Orden: <b>Prioridad (Alta → Media → Baja)</b></span>
          ${nonWorking ? `<span class="month-day-chip">${esc(nonWorkingReason(day))}</span>` : ''}
        </div>
        <div class="month-day-prio-kpis">${prioKpiHtml}</div>
        <div class="month-day-sections">${sectionsHtml}</div>
      </div>
    `;

    setDetailOverlayLabels(`Agenda del día · ${fmtDate(day)}`, 'Vista resumen diaria');
    openOverlay('detailOverlay');

    $('detailBody').querySelectorAll('.month-day-item[data-project-id]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        if(isAdmin()){
          closeOverlay('detailOverlay');
          return openProjectEditor(btn.dataset.projectId);
        }
        openProjectDetail(btn.dataset.projectId, btn.dataset.taskId);
      });
    });
  }

  function openProjectDetail(projectId, taskId = ''){
    const p = state.projects.find(x=>x.id===projectId);
    if(!p){ toast('Proyecto no encontrado'); return; }

    setDetailOverlayLabels('Detalle del proyecto', 'Vista de solo lectura');

    const ref = todayISO();
    const pStatus = projectStatus(p, ref);
    const leader = findTeam(p.leaderId)?.name || '-';

    const activities = (p.activities||[]).slice().sort((a,b)=>{
      if(a.startDate !== b.startDate) return a.startDate.localeCompare(b.startDate);
      return (a.startHour||'').localeCompare(b.startHour||'');
    });

    const activityHtml = activities.map(a=>{
      const st = activityStatus(a, ref, p);
      const owner = findTeam(a.ownerId)?.name || '-';
      const focus = taskId && taskId===a.id ? ' style="outline:2px solid color-mix(in srgb,var(--primary) 42%, transparent)"' : '';
      return `<div class="act-item"${focus}>
        <div class="t">
          <span>${esc(a.name)}</span>
          <span class="status-badge ${statusClassName(st)}">${esc(st)}</span>
        </div>
        <div class="m">${esc(fmtDate(a.startDate))} ${esc(a.startHour)} → ${esc(fmtDate(a.endDate))} ${esc(a.endHour)} · ${esc(owner)}</div>
        ${a.detail ? `<div class="d">${esc(a.detail)}</div>` : ''}
      </div>`;
    }).join('') || `<div class="small muted">Sin actividades registradas.</div>`;

    const recurrence = normalizeRecurrenceFrequency(p.recurrenceFrequency);

    $('detailBody').innerHTML = `
      <div class="detail-grid">
        <div class="detail-card">
          <h4>${esc(p.name)}</h4>
          <div class="detail-list">
            <div class="kv"><b>Equipo</b><span>${esc(p.client || 'Interno')}</span></div>
            <div class="kv"><b>Estatus</b><span><span class="status-badge ${statusClassName(pStatus)}">${esc(pStatus)}</span></span></div>
            <div class="kv"><b>Fechas base</b><span>${esc(fmtDate(p.startDate))} → ${esc(fmtDate(p.endDate))}</span></div>
            <div class="kv"><b>Recurrencia</b><span>${esc(recurrence)}</span></div>
            <div class="kv"><b>Solicitud</b><span>${esc(fmtDate(p.reqDate || p.startDate))}</span></div>
            <div class="kv"><b>Prioridad</b><span>${esc(p.priority)} · Importancia ${Number(p.importance||3)}/5</span></div>
            <div class="kv"><b>Líder</b><span>${esc(leader)}</span></div>
            <div class="kv"><b>Objetivo</b><span>${esc(p.objective || '—')}</span></div>
            <div class="kv"><b>Entregable</b><span>${esc(p.deliverable || '—')}</span></div>
            <div class="kv"><b>Notas</b><span>${esc(p.notes || '—')}</span></div>
          </div>
        </div>
        <div class="detail-card">
          <h4>Actividades (${activities.length})</h4>
          <div class="act-list">${activityHtml}</div>
        </div>
      </div>
    `;
    openOverlay('detailOverlay');
  }

  function openProjectEditor(projectId = null){
    if(!isAdmin()) return toast('Modo lectura: acceso restringido');

    closeOverlay('manageOverlay');
    ui.editingProjectId = projectId;
    const isEdit = !!projectId;
    const p = isEdit ? state.projects.find(x=>x.id===projectId) : null;

    $('projectTitle').textContent = isEdit ? 'Editar proyecto' : 'Nuevo proyecto';
    $('btnDeleteProject').style.display = isEdit ? 'inline-flex' : 'none';

    $('p_status').innerHTML = AUTO_STATUSES.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
    $('p_status').disabled = true;
    $('p_priority').innerHTML = PRIORITIES.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
    $('p_leader').innerHTML = state.team.map(t=>`<option value="${esc(t.id)}">${esc(t.name)}</option>`).join('');
    $('p_recurrence').innerHTML = RECURRENCE_FREQUENCIES.map(f=>`<option value="${esc(f)}">${esc(f)}</option>`).join('');

    const actHead = document.querySelector('#projectOverlay thead tr');
    if(actHead){
      actHead.innerHTML = `
        <th style="width:18%">Actividad</th>
        <th style="width:20%">Detalle</th>
        <th style="width:10%">Inicio</th>
        <th style="width:10%">Fin</th>
        <th style="width:10%">Hora inicio</th>
        <th style="width:10%">Hora fin</th>
        <th style="width:12%">Responsable</th>
        <th style="width:6%">Finalizado</th>
        <th style="width:6%">Foco principal</th>
        <th style="width:10%">Estatus (auto)</th>
        <th style="width:4%"></th>
      `;
    }

    $('activityBody').innerHTML = '';

    if(isEdit && p){
      $('p_name').value = p.name;
      $('p_client').value = p.client || '';
      $('p_req').value = p.reqDate || p.startDate;
      $('p_start').value = coerceBusinessDateISO(p.startDate) || p.startDate;
      $('p_end').value = coerceBusinessDateISO(p.endDate) || p.endDate;
      $('p_recurrence').value = normalizeRecurrenceFrequency(p.recurrenceFrequency);
      $('p_status').value = projectStatus(p, todayISO());
      $('p_priority').value = p.priority;
      $('p_leader').value = p.leaderId;
      $('p_importance').value = p.importance || 3;
      $('p_objective').value = p.objective || '';
      $('p_deliverable').value = p.deliverable || '';
      $('p_notes').value = p.notes || '';
      (p.activities||[]).forEach(a=>addActivityRow(a));
    }else{
      const d = ui.date;
      $('p_name').value = '';
      $('p_client').value = '';
      $('p_req').value = d;
      const dBiz = coerceBusinessDateISO(d) || d;
      $('p_start').value = dBiz;
      $('p_end').value = dBiz;
      $('p_recurrence').value = 'Ninguna';
      $('p_status').value = autoStatusByDates(d, d, false);
      $('p_priority').value = 'Media';
      $('p_leader').value = state.team[0]?.id || '';
      $('p_importance').value = 3;
      $('p_objective').value = '';
      $('p_deliverable').value = '';
      $('p_notes').value = '';
      addActivityRow();
    }

    $('p_start').onchange = ()=>{
      enforceBusinessDateInput($('p_start'),'Inicio del proyecto');
      refreshProjectAutoStatus();
    };
    $('p_end').onchange = ()=>{
      enforceBusinessDateInput($('p_end'),'Fin del proyecto');
      refreshProjectAutoStatus();
    };

    openOverlay('projectOverlay');
  }

  function refreshProjectAutoStatus(){
    const s = normalizeISO($('p_start').value) || todayISO();
    const e = normalizeISO($('p_end').value) || s;
    const allDone = [...$('activityBody').querySelectorAll('tr')].length > 0
      && [...$('activityBody').querySelectorAll('tr')].every(tr=>tr.querySelector('[data-k="done"]')?.checked);
    $('p_status').value = autoStatusByDates(minISO(s,e), maxISO(s,e), allDone);
  }

  function enforceEditorPrimaryFocusByOwner(changedRow = null){
    const rows = [...$('activityBody').querySelectorAll('tr')];

    // Normaliza: solo una actividad marcada por responsable dentro del editor actual.
    const seenByOwner = new Set();
    rows.forEach((tr)=>{
      const chk = tr.querySelector('[data-k="primaryFocus"]');
      const ownerId = String(tr.querySelector('[data-k="ownerId"]')?.value || '').trim();
      if(!chk || !chk.checked || !ownerId) return;

      if(seenByOwner.has(ownerId)){
        chk.checked = false;
        return;
      }
      seenByOwner.add(ownerId);
    });

    if(changedRow){
      const changedChk = changedRow.querySelector('[data-k="primaryFocus"]');
      const changedOwnerId = String(changedRow.querySelector('[data-k="ownerId"]')?.value || '').trim();

      if(changedChk?.checked && changedOwnerId){
        rows.forEach((tr)=>{
          if(tr === changedRow) return;
          const chk = tr.querySelector('[data-k="primaryFocus"]');
          const ownerId = String(tr.querySelector('[data-k="ownerId"]')?.value || '').trim();
          if(chk && chk.checked && ownerId === changedOwnerId){
            chk.checked = false;
          }
        });
      }
    }
  }

  function getPrimaryFocusOwnersFromEditor(){
    const owners = new Set();
    $('activityBody').querySelectorAll('tr').forEach((tr)=>{
      const chk = tr.querySelector('[data-k="primaryFocus"]');
      const ownerId = String(tr.querySelector('[data-k="ownerId"]')?.value || '').trim();
      if(chk?.checked && ownerId) owners.add(ownerId);
    });
    return owners;
  }

  function addActivityRow(data = null){
    const tb = $('activityBody');
    const tr = document.createElement('tr');

    const pStart = $('p_start').value || ui.date;
    const pEnd = $('p_end').value || pStart;

    const d = {
      id: data?.id || rid('a'),
      name: data?.name || '',
      startDate: coerceBusinessDateISO(data?.startDate || pStart) || (data?.startDate || pStart),
      endDate: coerceBusinessDateISO(data?.endDate || pEnd) || (data?.endDate || pEnd),
      startHour: normalizeHHMM(data?.startHour, '09:00'),
      endHour: normalizeHHMM(data?.endHour, '10:00'),
      ownerId: data?.ownerId || $('p_leader').value || state.team[0]?.id || '',
      detail: data?.detail || '',
      done: Boolean(data?.done || data?.status === 'Terminado' || data?.status === 'Finalizado'),
      primaryFocus: Boolean(data?.primaryFocus || data?.isPrimaryFocus)
    };

    tr.dataset.id = d.id;
    tr.innerHTML = `
      <td><input class="ctrl" data-k="name" value="${esc(d.name)}" placeholder="Actividad" /></td>
      <td><input class="ctrl" data-k="detail" value="${esc(d.detail)}" placeholder="Detalle breve para modo lectura" /></td>
      <td><input class="ctrl" type="date" data-k="startDate" value="${esc(d.startDate)}" /></td>
      <td><input class="ctrl" type="date" data-k="endDate" value="${esc(d.endDate)}" /></td>
      <td><input class="ctrl" type="time" data-k="startHour" value="${esc(d.startHour)}" /></td>
      <td><input class="ctrl" type="time" data-k="endHour" value="${esc(d.endHour)}" /></td>
      <td>
        <select class="ctrl" data-k="ownerId">${state.team.map(t=>`<option value="${esc(t.id)}" ${t.id===d.ownerId?'selected':''}>${esc(t.name)}</option>`).join('')}</select>
      </td>
      <td style="text-align:center"><input type="checkbox" data-k="done" ${d.done?'checked':''} /></td>
      <td style="text-align:center"><input type="checkbox" data-k="primaryFocus" ${d.primaryFocus?'checked':''} /></td>
      <td><span class="status-badge" data-k="autoStatus">—</span></td>
      <td><button class="btn" type="button" data-del-row>✕</button></td>
    `;

    const refresh = () => {
      refreshActivityRowStatus(tr);
      refreshProjectAutoStatus();
    };

    const inStartDate = tr.querySelector('[data-k="startDate"]');
    const inEndDate = tr.querySelector('[data-k="endDate"]');

    inStartDate?.addEventListener('change',()=>{
      enforceBusinessDateInput(inStartDate, 'Inicio de tarea');
      refresh();
    });
    inEndDate?.addEventListener('change',()=>{
      enforceBusinessDateInput(inEndDate, 'Fin de tarea');
      refresh();
    });

    tr.querySelectorAll('input,select').forEach(el=>{
      if(el === inStartDate || el === inEndDate) return;
      el.addEventListener('change', refresh);
    });
    const ownerSel = tr.querySelector('[data-k="ownerId"]');
    ownerSel?.addEventListener('change', ()=>{
      enforceEditorPrimaryFocusByOwner(tr);
    });

    const primaryFocusChk = tr.querySelector('[data-k="primaryFocus"]');
    primaryFocusChk?.addEventListener('change', ()=>{
      enforceEditorPrimaryFocusByOwner(tr);
    });

    tr.querySelector('[data-del-row]').addEventListener('click',()=>{
      tr.remove();
      refreshProjectAutoStatus();
    });

    tb.appendChild(tr);
    enforceEditorPrimaryFocusByOwner(tr);
    refresh();
  }

  function refreshActivityRowStatus(tr){
    const startDate = normalizeISO(tr.querySelector('[data-k="startDate"]').value) || todayISO();
    const endDate = normalizeISO(tr.querySelector('[data-k="endDate"]').value) || startDate;
    const done = Boolean(tr.querySelector('[data-k="done"]').checked);
    const rangeStart = minISO(startDate,endDate);
    const rangeEnd = maxISO(startDate,endDate);
    const nonWorking = isNonWorkingDayISO(rangeStart) || isNonWorkingDayISO(rangeEnd);
    const status = nonWorking ? 'Ajustar fecha' : autoStatusByDates(rangeStart, rangeEnd, done);

    const badge = tr.querySelector('[data-k="autoStatus"]');
    badge.textContent = status;
    badge.className = `status-badge ${statusClassName(status)}`;
  }

  function saveProject(){
    return saveProjectAsync();
  }

  async function saveProjectAsync(){
    const name = $('p_name').value.trim();
    if(!name){ toast('El proyecto necesita nombre.'); return; }

    let pStart = normalizeISO($('p_start').value);
    let pEnd = normalizeISO($('p_end').value);
    if(!pStart || !pEnd){ toast('Completa inicio y fin del proyecto.'); return; }
    if(isNonWorkingDayISO(pStart)){
      const adj = nextBusinessDayISO(pStart);
      toast(`Inicio del proyecto ajustado a día hábil: ${fmtDate(adj)}.`);
      pStart = adj;
      $('p_start').value = adj;
    }
    if(isNonWorkingDayISO(pEnd)){
      const adj = nextBusinessDayISO(pEnd);
      toast(`Fin del proyecto ajustado a día hábil: ${fmtDate(adj)}.`);
      pEnd = adj;
      $('p_end').value = adj;
    }
    if(pStart > pEnd) [pStart,pEnd] = [pEnd,pStart];

    const activities = [];
    let adjustedBusinessDates = 0;
    for(const tr of $('activityBody').querySelectorAll('tr')){
      const nameA = tr.querySelector('[data-k="name"]').value.trim();
      if(!nameA) continue;

      let aStart = normalizeISO(tr.querySelector('[data-k="startDate"]').value) || pStart;
      let aEnd = normalizeISO(tr.querySelector('[data-k="endDate"]').value) || aStart;
      if(aStart > aEnd) [aStart,aEnd] = [aEnd,aStart];

      aStart = clampISO(aStart, pStart, pEnd);
      aEnd = clampISO(aEnd, pStart, pEnd);

      if(isNonWorkingDayISO(aStart)){
        adjustedBusinessDates++;
        aStart = clampISO(nextBusinessDayISO(aStart), pStart, pEnd);
      }
      if(isNonWorkingDayISO(aEnd)){
        adjustedBusinessDates++;
        aEnd = clampISO(nextBusinessDayISO(aEnd), pStart, pEnd);
      }

      if(aStart > aEnd) aEnd = aStart;

      let startHour = normalizeHHMM(tr.querySelector('[data-k="startHour"]').value, '09:00');
      let endHour = normalizeHHMM(tr.querySelector('[data-k="endHour"]').value, '10:00');
      if(timeToMin(endHour) <= timeToMin(startHour)){
        endHour = minToHHMM(Math.min(timeToMin(startHour)+60, 23*60+59));
      }

      activities.push({
        id: tr.dataset.id || rid('a'),
        name: nameA,
        detail: String(tr.querySelector('[data-k="detail"]')?.value || '').trim().slice(0,220),
        startDate: aStart,
        endDate: aEnd,
        startHour,
        endHour,
        ownerId: tr.querySelector('[data-k="ownerId"]').value || $('p_leader').value,
        done: Boolean(tr.querySelector('[data-k="done"]').checked),
        primaryFocus: Boolean(tr.querySelector('[data-k="primaryFocus"]')?.checked)
      });
    }

    // Solo un foco principal por responsable dentro del proyecto que se está editando.
    const localPrimaryByOwner = new Set();
    activities.forEach((a)=>{
      const ownerId = String(a.ownerId || '').trim();
      if(!a.primaryFocus || !ownerId) return;
      if(localPrimaryByOwner.has(ownerId)){
        a.primaryFocus = false;
        return;
      }
      localPrimaryByOwner.add(ownerId);
    });

    ui.lastAdjustedBusinessDates = adjustedBusinessDates;
    if(adjustedBusinessDates > 0){
      toast(`Se ajustaron ${adjustedBusinessDates} fecha(s) de tareas al siguiente día hábil.`);
    }

    const focusOwnersInPayload = [...localPrimaryByOwner];

    if(focusOwnersInPayload.length){
      const editingId = ui.editingProjectId || null;
      const existingFocusByOwner = new Map();

      (state.projects || []).forEach((p)=>{
        if(String(p?.id || '') === String(editingId || '')) return;

        const acts = Array.isArray(p?.activities) ? p.activities : [];
        let hasExplicit = false;

        acts.forEach((a)=>{
          if(!a?.primaryFocus) return;
          hasExplicit = true;
          const ownerId = String(a.ownerId || '').trim();
          if(!ownerId || existingFocusByOwner.has(ownerId)) return;
          existingFocusByOwner.set(ownerId, String(p?.name || 'Proyecto'));
        });

        // Compatibilidad: foco legado a nivel proyecto.
        if(!hasExplicit && Boolean(p?.isPrimaryFocus)){
          const fallbackOwner = String(p?.leaderId || acts?.[0]?.ownerId || '').trim();
          if(fallbackOwner && !existingFocusByOwner.has(fallbackOwner)){
            existingFocusByOwner.set(fallbackOwner, String(p?.name || 'Proyecto'));
          }
        }
      });

      const conflictOwnerId = focusOwnersInPayload.find(ownerId => existingFocusByOwner.has(ownerId));
      if(conflictOwnerId){
        const ownerName = findTeam(conflictOwnerId)?.name || 'este miembro';
        const existingProjectName = existingFocusByOwner.get(conflictOwnerId) || 'otro proyecto';
        toast(`Ya existe un foco principal para ${ownerName} en "${existingProjectName}". Desmárcalo primero.`);
        return;
      }
    }

    const payload = {
      id: ui.editingProjectId || rid('p'),
      name,
      client: $('p_client').value.trim(),
      reqDate: normalizeISO($('p_req').value) || pStart,
      startDate: pStart,
      endDate: pEnd,
      priority: PRIORITIES.includes($('p_priority').value) ? $('p_priority').value : 'Media',
      recurrenceFrequency: normalizeRecurrenceFrequency($('p_recurrence').value),
      leaderId: $('p_leader').value || state.team[0]?.id,
      importance: clampInt($('p_importance').value,1,5,3),
      objective: String($('p_objective').value || '').trim().slice(0,500),
      deliverable: String($('p_deliverable').value || '').trim().slice(0,500),
      notes: String($('p_notes').value || '').trim().slice(0,800),
      isPrimaryFocus: activities.some(a=>Boolean(a?.primaryFocus)),
      activities
    };

    const simulation = buildAutoReplanSimulation(payload, ui.editingProjectId);

    let appliedAutoReplan = false;
    if(simulation.hasImpact){
      const accepted = await showImpactConfirmation(simulation);
      if(accepted){
        state = sanitizeState(simulation.proposedState);
        appliedAutoReplan = true;

        closeOverlay('projectOverlay');
        render();

        const moved = simulation.items.filter(x=>x.changed).length;
        const unresolved = simulation.unresolved.length;
        const msg = unresolved
          ? `Replanificación aplicada: ${moved} ajustadas, ${unresolved} con ajuste manual pendiente.`
          : `Replanificación aplicada: ${moved} actividades ajustadas.`;
        toast(msg);
        return;
      }
    }

    if(ui.editingProjectId){
      const idx = state.projects.findIndex(p=>p.id===ui.editingProjectId);
      if(idx>=0) state.projects[idx] = payload;
    }else{
      state.projects.push(payload);
    }

    state = sanitizeState(state);
    closeOverlay('projectOverlay');
    render();

    const hasCapacityWarning = (simulation.anchorWarnings || []).some(w=>String(w).includes('supera su capacidad'));
    const hasBlockWarning = (simulation.anchorWarnings || []).some(w=>String(w).includes('cruza un bloqueo'));

    if(appliedAutoReplan){
      // no-op: covered by early return
    }else if(simulation.hasImpact){
      toast(ui.editingProjectId ? 'Proyecto actualizado sin reprogramar otros proyectos no afectados directamente.' : 'Proyecto creado sin reprogramar otros proyectos no afectados directamente.');
    }else if(hasCapacityWarning){
      toast(ui.editingProjectId ? 'Proyecto actualizado. Nota: el miembro supera su capacidad planificada.' : 'Proyecto creado. Nota: el miembro supera su capacidad planificada.');
    }else if(hasBlockWarning){
      toast(ui.editingProjectId ? 'Proyecto actualizado. Nota: hay cruce con bloqueos.' : 'Proyecto creado. Nota: hay cruce con bloqueos.');
    }else{
      toast(ui.editingProjectId ? 'Proyecto actualizado' : 'Proyecto creado');
    }
  }

  function activityKey(projectId, activityId){
    return `${projectId}::${activityId}`;
  }

  function dateRangesOverlap(aStart,aEnd,bStart,bEnd){
    return !(aEnd < bStart || bEnd < aStart);
  }

  function timeRangesOverlap(startA,endA,startB,endB){
    const aS = timeToMin(startA), aE = timeToMin(endA);
    const bS = timeToMin(startB), bE = timeToMin(endB);
    return Math.max(aS,bS) < Math.min(aE,bE);
  }

  function eachDateBetween(startISO, endISO){
    const out = [];
    let d = startISO;
    while(d <= endISO){
      out.push(d);
      d = addDaysISO(d,1);
    }
    return out;
  }

  function collectActivityRefs(stateObj){
    const refs = [];
    (stateObj.projects || []).forEach(p=>{
      (p.activities || []).forEach(a=>{
        refs.push({ key: activityKey(p.id,a.id), project: p, activity: a });
      });
    });
    return refs;
  }

  function activityActiveOn(activity, dayISO){
    if(isNonWorkingDayISO(dayISO)) return false;
    return activity.startDate <= dayISO && activity.endDate >= dayISO;
  }

  function buildAutoReplanSimulation(payload, editingProjectId = null){
    const candidate = structuredClone(state);

    if(editingProjectId){
      const idx = candidate.projects.findIndex(p=>p.id===editingProjectId);
      if(idx >= 0) candidate.projects[idx] = payload;
      else candidate.projects.push(payload);
    }else{
      candidate.projects.push(payload);
    }

    const normalized = sanitizeState(candidate);
    const refs = collectActivityRefs(normalized);
    const refByKey = new Map(refs.map(r=>[r.key, r]));

    const anchorKeys = new Set((payload.activities || []).map(a=>activityKey(payload.id, a.id)));
    const anchors = refs.filter(r=>anchorKeys.has(r.key) && !r.activity.done);

    const impacted = new Set();
    const reasonMap = new Map();
    const touchedOwnerDays = new Map();
    const anchorWarningsSet = new Set();

    const addReason = (key, reason) => {
      if(!reasonMap.has(key)) reasonMap.set(key, new Set());
      reasonMap.get(key).add(reason);
    };

    for(const anchor of anchors){
      const owner = normalized.team.find(t=>t.id===anchor.activity.ownerId);
      if(!owner) continue;

      const businessDays = eachBusinessDateBetween(anchor.activity.startDate, anchor.activity.endDate);
      for(const day of businessDays){
        if(!touchedOwnerDays.has(owner.id)) touchedOwnerDays.set(owner.id, new Set());
        touchedOwnerDays.get(owner.id).add(day);

        const overlapsBlock = blockIntervalsForDay(owner, day).some(iv=>
          timeRangesOverlap(anchor.activity.startHour, anchor.activity.endHour, iv.startHour, iv.endHour)
        );
        if(overlapsBlock){
          anchorWarningsSet.add(`La actividad nueva <b>${esc(anchor.activity.name)}</b> de <b>${esc(owner.name)}</b> cruza un bloqueo (${esc(fmtDate(day))}).`);
        }
      }

      for(const other of refs){
        if(other.key === anchor.key) continue;
        if(other.activity.done) continue;
        if(other.activity.ownerId !== anchor.activity.ownerId) continue;

        if(!dateRangesOverlap(anchor.activity.startDate, anchor.activity.endDate, other.activity.startDate, other.activity.endDate)) continue;
        if(!timeRangesOverlap(anchor.activity.startHour, anchor.activity.endHour, other.activity.startHour, other.activity.endHour)) continue;

        impacted.add(other.key);
        addReason(other.key, 'Solape horario con nuevo flujo');
      }
    }

    for(const [ownerId, daysSet] of touchedOwnerDays.entries()){
      const owner = normalized.team.find(t=>t.id===ownerId);
      if(!owner) continue;

      for(const day of daysSet){
        const dayRefs = refs.filter(r=>
          !r.activity.done &&
          r.activity.ownerId===ownerId &&
          activityActiveOn(r.activity, day)
        );

        const cap = getDailyCapacityMin(owner, day);
        const total = dayRefs.reduce((acc,r)=>acc + durationMinutes(r.activity.startHour, r.activity.endHour), 0);

        // Regla solicitada:
        // - Permitir guardar aunque se exceda la capacidad.
        // - No reprogramar por capacidad a proyectos no afectados directamente.
        if(total > cap){
          anchorWarningsSet.add(`El día <b>${esc(fmtDate(day))}</b> de <b>${esc(owner.name)}</b> supera su capacidad planificada.`);
        }
      }
    }

    // Solo hay impacto si existe afectación directa (solape horario real).
    if(!impacted.size){
      return {
        hasImpact:false,
        proposedState: normalized,
        items: [],
        unresolved: [],
        anchorWarnings: [...anchorWarningsSet],
        summary:{ direct:0, moved:0, unresolved:0, impacted:0 }
      };
    }

    const proposed = structuredClone(normalized);
    const pRefs = collectActivityRefs(proposed);
    const pRefByKey = new Map(pRefs.map(r=>[r.key,r]));

    const originalPos = new Map();
    [...impacted].forEach(k=>{
      const r = refByKey.get(k);
      if(!r) return;
      originalPos.set(k,{
        ownerId: r.activity.ownerId,
        projectName: r.project.name,
        taskName: r.activity.name,
        startDate: r.activity.startDate,
        endDate: r.activity.endDate,
        startHour: r.activity.startHour,
        endHour: r.activity.endHour
      });
    });

    const unscheduled = new Set([...impacted].filter(k=>pRefByKey.has(k)));

    const canPlace = (ref, candStartISO) => {
      const owner = proposed.team.find(t=>t.id===ref.activity.ownerId);
      if(!owner) return false;

      const sMin = timeToMin(ref.activity.startHour);
      const eMin = timeToMin(ref.activity.endHour);
      if(sMin < owner.startHour*60 || eMin > owner.endHour*60) return false;

      const spanBusiness = countBusinessDays(ref.activity.startDate, ref.activity.endDate);
      const perDayMin = durationMinutes(ref.activity.startHour, ref.activity.endHour);
      const start = nextBusinessDayISO(candStartISO);
      const end = addBusinessDaysISO(start, spanBusiness);
      const targetDays = eachBusinessDateBetween(start, end);
      if(targetDays.length < spanBusiness) return false;

      for(const day of targetDays){
        const blocked = blockIntervalsForDay(owner, day);
        if(blocked.some(iv=>Math.max(iv.startMin,sMin) < Math.min(iv.endMin,eMin))) return false;

        let used = 0;
        for(const other of pRefs){
          if(other.key === ref.key) continue;
          if(unscheduled.has(other.key)) continue;
          if(other.activity.done) continue;
          if(other.activity.ownerId !== owner.id) continue;
          if(!activityActiveOn(other.activity, day)) continue;

          const os = timeToMin(other.activity.startHour);
          const oe = timeToMin(other.activity.endHour);
          if(Math.max(os,sMin) < Math.min(oe,eMin)) return false;

          used += durationMinutes(other.activity.startHour, other.activity.endHour);
        }

        const cap = getDailyCapacityMin(owner, day);
        if(used + perDayMin > cap) return false;
      }

      return true;
    };

    const ordered = [...unscheduled]
      .map(k=>pRefByKey.get(k))
      .filter(Boolean)
      .sort((a,b)=>{
        const pa = priorityRank(a.project.priority);
        const pb = priorityRank(b.project.priority);
        if(pa !== pb) return pa - pb;
        if(a.activity.startDate !== b.activity.startDate) return a.activity.startDate.localeCompare(b.activity.startDate);
        return a.activity.startHour.localeCompare(b.activity.startHour);
      });

    const moved = [];
    const unresolved = [];

    for(const ref of ordered){
      const before = originalPos.get(ref.key);
      if(!before){
        unscheduled.delete(ref.key);
        continue;
      }

      const spanBusiness = countBusinessDays(ref.activity.startDate, ref.activity.endDate);
      let placed = false;
      let chosenStart = nextBusinessDayISO(ref.activity.startDate);
      let cand = nextBusinessDayISO(before.startDate);

      for(let step=0; step<=365; step++){
        if(canPlace(ref, cand)){
          chosenStart = cand;
          placed = true;
          break;
        }
        cand = nextBusinessDayISO(addDaysISO(cand, 1));
      }

      if(placed){
        ref.activity.startDate = chosenStart;
        ref.activity.endDate = addBusinessDaysISO(chosenStart, spanBusiness);
      }

      unscheduled.delete(ref.key);

      const changed = ref.activity.startDate !== before.startDate || ref.activity.endDate !== before.endDate ||
        ref.activity.startHour !== before.startHour || ref.activity.endHour !== before.endHour;

      if(!placed){
        unresolved.push({
          key: ref.key,
          projectName: before.projectName,
          taskName: before.taskName,
          ownerName: findTeam(before.ownerId)?.name || 'Sin dueño',
          reason: 'No se encontró hueco en los próximos 365 días hábiles'
        });
      }

      moved.push({
        key: ref.key,
        changed,
        before,
        after: {
          ownerId: ref.activity.ownerId,
          startDate: ref.activity.startDate,
          endDate: ref.activity.endDate,
          startHour: ref.activity.startHour,
          endHour: ref.activity.endHour
        },
        reasons: [...(reasonMap.get(ref.key) || ['Reprogramación automática'])]
      });
    }

    for(const p of proposed.projects){
      if(!Array.isArray(p.activities) || !p.activities.length) continue;
      let minD = p.activities[0].startDate;
      let maxD = p.activities[0].endDate;
      for(const a of p.activities){
        if(a.startDate < minD) minD = a.startDate;
        if(a.endDate > maxD) maxD = a.endDate;
      }
      p.startDate = minISO(p.startDate, minD);
      p.endDate = maxISO(p.endDate, maxD);
      if(p.reqDate && p.reqDate > p.startDate) p.reqDate = p.startDate;
    }

    const items = moved.map(m=>({
      key: m.key,
      changed: m.changed,
      projectName: m.before.projectName,
      taskName: m.before.taskName,
      ownerName: findTeam(m.before.ownerId)?.name || 'Sin dueño',
      beforeText: `${fmtDate(m.before.startDate)} ${m.before.startHour} → ${fmtDate(m.before.endDate)} ${m.before.endHour}`,
      afterText: `${fmtDate(m.after.startDate)} ${m.after.startHour} → ${fmtDate(m.after.endDate)} ${m.after.endHour}`,
      deltaDays: daysDiff(m.before.startDate, m.after.startDate),
      reasons: m.reasons
    }));

    return {
      hasImpact: true,
      proposedState: proposed,
      items: items.sort((a,b)=>{
        if(a.changed !== b.changed) return a.changed ? -1 : 1;
        return a.projectName.localeCompare(b.projectName) || a.taskName.localeCompare(b.taskName);
      }),
      unresolved,
      anchorWarnings: [...anchorWarningsSet],
      summary:{
        direct: [...reasonMap.values()].filter(set=>[...set].some(x=>x.includes('Solape'))).length,
        impacted: impacted.size,
        moved: items.filter(x=>x.changed).length,
        unresolved: unresolved.length
      }
    };
  }

  function resolveImpactDecision(accepted){
    if(typeof impactDecisionResolver === 'function'){
      const fn = impactDecisionResolver;
      impactDecisionResolver = null;
      closeOverlay('impactOverlay');
      fn(Boolean(accepted));
      return;
    }
    closeOverlay('impactOverlay');
  }

  function showImpactConfirmation(simulation){
    const overlay = $('impactOverlay');
    if(!overlay){
      const fallback = confirm('Se detectó impacto por solapes/capacidad. ¿Deseas aplicar la reprogramación automática?');
      return Promise.resolve(fallback);
    }

    const kpis = [
      {k:'Actividades impactadas',v:simulation.summary.impacted,s:'detectadas'},
      {k:'Reprogramadas',v:simulation.summary.moved,s:'ajuste automático'},
      {k:'Sin hueco automático',v:simulation.summary.unresolved,s:'requiere ajuste manual'},
      {k:'Solapes detectados',v:simulation.summary.direct,s:'al registrar nuevo requerimiento'}
    ].map(x=>`<div class="impact-kpi"><div class="k">${esc(x.k)}</div><div class="v">${esc(x.v)}</div><div class="s">${esc(x.s)}</div></div>`).join('');

    $('impactSummary').innerHTML = kpis;

    const warns = [];
    simulation.anchorWarnings.forEach(w=>warns.push(`<div class="impact-warn">⚠ ${w}</div>`));
    if(simulation.unresolved.length){
      warns.push(`<div class="impact-warn">⚠ ${simulation.unresolved.length} actividad(es) no se pudieron reubicar automáticamente; quedarán marcadas para revisión manual.</div>`);
    }
    $('impactWarnings').innerHTML = warns.join('');

    const rows = simulation.items.map(it=>{
      const cls = it.deltaDays > 0 ? 'pos' : 'zero';
      const deltaText = it.deltaDays > 0 ? `+${it.deltaDays} día(s)` : 'Sin cambio';
      return `
        <tr>
          <td><b>${esc(it.projectName)}</b><div class="small muted">${esc(it.taskName)}</div></td>
          <td>${esc(it.ownerName)}</td>
          <td>${esc(it.beforeText)}</td>
          <td>${esc(it.afterText)}</td>
          <td><span class="delta-chip ${cls}">${esc(deltaText)}</span></td>
          <td>${esc((it.reasons||[]).join(' · '))}</td>
        </tr>
      `;
    }).join('');

    $('impactTableBody').innerHTML = rows || `<tr><td colspan="6" class="muted">No hay cambios de calendario.</td></tr>`;

    openOverlay('impactOverlay');

    return new Promise(resolve=>{
      impactDecisionResolver = resolve;

      const acceptBtn = $('impactAcceptBtn');
      const cancelBtn = $('impactCancelBtn');
      const closeBtn = $('impactCloseBtn');

      const onAccept = () => resolveImpactDecision(true);
      const onCancel = () => resolveImpactDecision(false);
      const onBackdrop = (e) => { if(e.target === overlay) resolveImpactDecision(false); };

      acceptBtn.onclick = onAccept;
      cancelBtn.onclick = onCancel;
      closeBtn.onclick = onCancel;
      overlay.onclick = onBackdrop;
    });
  }



  function deleteProject(){
    if(!ui.editingProjectId) return;
    if(!confirm('¿Eliminar este proyecto?')) return;
    state.projects = state.projects.filter(p=>p.id!==ui.editingProjectId);
    state = sanitizeState(state);
    closeOverlay('projectOverlay');
    toast('Proyecto eliminado');
    render();
  }

  function openManage(){
    renderManage();
    openOverlay('manageOverlay');
  }

  function renderManage(){
    const allTabs = ['projects','team','holidays','notifications','data'];
    const allowedTabs = isAdmin() ? allTabs : ['projects','notifications','data'];
    if(!allowedTabs.includes(ui.manageTab)) ui.manageTab = 'projects';

    const tabsRoot = $('manageTabs');
    if(tabsRoot){
      tabsRoot.querySelectorAll('[data-tab]').forEach(b=>{
        const visible = allowedTabs.includes(b.dataset.tab);
        b.classList.toggle('hidden', !visible);
        b.classList.toggle('active', visible && b.dataset.tab===ui.manageTab);
      });
    }

    allTabs.forEach(tab=>{
      const node = $(`tab_${tab}`);
      if(node){
        const shouldHide = !allowedTabs.includes(tab) || ui.manageTab!==tab;
        node.classList.toggle('hidden', shouldHide);
      }
    });

    if(ui.manageTab==='projects') renderManageProjects();
    if(ui.manageTab==='team') renderManageTeam();
    if(ui.manageTab==='holidays') renderManageHolidays();
    if(ui.manageTab==='notifications') renderManageNotifications();
    if(ui.manageTab==='data') renderManageData();
  }

  function compareManageProject(a,b,sortMode,refDate){
    const safeSort = sortMode || 'priority_desc';
    const ref = refDate || todayISO();

    const byName = ()=>String(a.name||'').localeCompare(String(b.name||''), APP_LOCALE, {sensitivity:'base'});
    const byStartAsc = ()=>String(a.startDate||'').localeCompare(String(b.startDate||''));

    if(safeSort === 'priority_desc'){
      return (
        priorityRank(a.priority) - priorityRank(b.priority) ||
        byStartAsc() ||
        byName()
      );
    }

    if(safeSort === 'priority_asc'){
      return (
        priorityRank(b.priority) - priorityRank(a.priority) ||
        byStartAsc() ||
        byName()
      );
    }

    if(safeSort === 'start_desc'){
      return byStartAsc() * -1 || byName();
    }

    // default: start_asc
    return byStartAsc() || byName();
  }

    function renderManageProjects(options = {}){
    // En móvil, evitar reconstruir todo el panel en cada tecla para no perder foco/teclado.
    const partial = !!options.partial;
    const ref = todayISO();
    const sortMode = ui.manageProjectSort || 'priority_desc';
    const searchQuery = String(ui.manageProjectSearch || '').trim().toLowerCase();

    const matchesSearch = (p)=>{
      if(!searchQuery) return true;
      const leaderName = findTeam(p.leaderId)?.name || '';
      const status = projectStatus(p,ref);
      const freq = normalizeRecurrenceFrequency(p.recurrenceFrequency);
      const haystack = [
        p.name,
        p.client,
        leaderName,
        p.priority,
        status,
        freq,
        p.startDate,
        p.endDate
      ].map(v=>String(v || '').toLowerCase()).join(' | ');
      return haystack.includes(searchQuery);
    };

    const filteredProjects = state.projects
      .slice()
      .filter(matchesSearch)
      .sort((a,b)=>compareManageProject(a,b,sortMode,ref));

    const rows = filteredProjects
      .map(p=>`<tr>
        <td><b>${esc(p.name)}</b><div class="small muted">${esc(p.client||'Interno')}</div></td>
        <td>${esc(fmtDate(p.startDate))} → ${esc(fmtDate(p.endDate))}</td>
        <td>${esc(normalizeRecurrenceFrequency(p.recurrenceFrequency))}</td>
        <td>${esc(p.priority)}</td>
        <td><span class="status-badge ${statusClassName(projectStatus(p,ref))}">${esc(projectStatus(p,ref))}</span></td>
        <td>${esc(findTeam(p.leaderId)?.name || '-')}</td>
        <td>${(p.activities||[]).length}</td>
        <td>
          ${isAdmin() ? `<div class="row">
            <button class="btn" data-edit="${esc(p.id)}">Editar</button>
            <button class="btn danger" data-del="${esc(p.id)}">Eliminar</button>
            <button class="btn" data-view-detail="${esc(p.id)}">Detalle</button>
          </div>` : `<button class="btn" data-view-detail="${esc(p.id)}">Ver detalle</button>`}
        </td>
      </tr>`).join('');

    const total = state.projects.length;
    const shown = filteredProjects.length;
    const emptyMessage = searchQuery
      ? `No se encontraron proyectos para "${esc(ui.manageProjectSearch)}".`
      : 'No hay proyectos.';

    const metaText = `Portafolio actual ${isAdmin()?'':'· modo lectura'} · Mostrando ${shown} de ${total}`;

    const bindManageProjectRowActions = ()=>{
      if(isAdmin()){
        $('manageNewProject')?.addEventListener('click',()=>openProjectEditor());
        $('tab_projects').querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>openProjectEditor(b.dataset.edit)));
        $('tab_projects').querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{
          const id = b.dataset.del;
          if(!confirm('¿Eliminar proyecto?')) return;
          state.projects = state.projects.filter(p=>p.id!==id);
          render();
          renderManageProjects();
          toast('Proyecto eliminado');
        }));
      }
      $('tab_projects').querySelectorAll('[data-view-detail]').forEach(b=>b.addEventListener('click',()=>{
        openProjectDetail(b.dataset.viewDetail);
      }));
    };

    // Render parcial: solo meta + filas (mantiene el input vivo y evita pérdida de foco en móvil).
    if(partial && $('manageProjectsTbody')){
      const metaNode = $('manageProjectsMeta');
      if(metaNode) metaNode.textContent = metaText;
      const tbody = $('manageProjectsTbody');
      if(tbody) tbody.innerHTML = rows || `<tr><td colspan="8" class="muted">${emptyMessage}</td></tr>`;
      bindManageProjectRowActions();
      return;
    }

    // Render completo (primera carga o cuando cambian estructuras de cabecera).
    $('tab_projects').innerHTML = `
      <div class="row" style="justify-content:space-between;margin-bottom:8px;gap:10px;align-items:center;flex-wrap:wrap">
        <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
          <div class="small muted" id="manageProjectsMeta">${metaText}</div>
          <input class="ctrl" id="manageProjectSearch" type="search" placeholder="Buscar: proyecto, equipo, líder, estado..." value="${esc(ui.manageProjectSearch||'')}" style="min-width:290px" />
          <select class="ctrl" id="manageProjectSort" title="Ordenar proyectos" style="min-width:230px">
            <option value="priority_desc" ${sortMode==='priority_desc'?'selected':''}>Prioridad: Alta → Baja</option>
            <option value="priority_asc" ${sortMode==='priority_asc'?'selected':''}>Prioridad: Baja → Alta</option>
            <option value="start_asc" ${sortMode==='start_asc'?'selected':''}>Inicio: más antiguo → más reciente</option>
            <option value="start_desc" ${sortMode==='start_desc'?'selected':''}>Inicio: más reciente → más antiguo</option>
          </select>
        </div>
        ${isAdmin() ? `<button class="btn primary" id="manageNewProject">+ Nuevo</button>` : ''}
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th>Proyecto</th><th>Fechas base</th><th>Recurrencia</th><th>Prioridad</th><th>Estatus</th><th>Líder</th><th>Actividades</th><th>Acciones</th></tr></thead>
        <tbody id="manageProjectsTbody">${rows || `<tr><td colspan="8" class="muted">${emptyMessage}</td></tr>`}</tbody>
      </table></div>
    `;

    $('manageProjectSearch')?.addEventListener('input', e=>{
      ui.manageProjectSearch = e.target.value || '';
      renderManageProjects({ partial:true });
    });

    $('manageProjectSort')?.addEventListener('change', e=>{
      ui.manageProjectSort = e.target.value || 'priority_desc';
      renderManageProjects({ partial:true });
    });

    bindManageProjectRowActions();
  }

  function renderManageTeam(){
    const disabled = !isAdmin();
    state.teamBoard = sanitizeTeamBoard(state.teamBoard, state.team);
    const org = state.teamBoard;

    const teamRows = state.team.map(t=>`
      <tr data-team-row="${esc(t.id)}">
        <td><input class="ctrl" data-team-name="${esc(t.id)}" value="${esc(t.name)}" ${disabled?'disabled':''} /></td>
        <td><input class="ctrl" type="number" min="0" max="23" data-team-start="${esc(t.id)}" value="${t.startHour}" ${disabled?'disabled':''} /></td>
        <td><input class="ctrl" type="number" min="1" max="24" data-team-end="${esc(t.id)}" value="${t.endHour}" ${disabled?'disabled':''} /></td>
        <td><input class="ctrl" type="number" min="1" max="24" data-team-cap="${esc(t.id)}" value="${t.capacityHoursPerDay}" ${disabled?'disabled':''} /></td>
        <td>${(t.blocks||[]).length}</td>
        <td>${isAdmin() ? `<button class="btn danger" data-remove-team="${esc(t.id)}" ${state.team.length<=1?'disabled':''}>Eliminar</button>` : '<span class="small muted">—</span>'}</td>
      </tr>
    `).join('');

    const flatBlocks = [];
    state.team.forEach(t=>(t.blocks||[]).forEach(b=>flatBlocks.push({...b, ownerId:t.id})));

    const blockRows = flatBlocks.map(b=>`
      <tr data-block-id="${esc(b.id)}">
        <td>
          <select class="ctrl" data-block-owner ${disabled?'disabled':''}>
            ${state.team.map(t=>`<option value="${esc(t.id)}" ${t.id===b.ownerId?'selected':''}>${esc(t.name)}</option>`).join('')}
          </select>
        </td>
        <td>
          <select class="ctrl" data-block-type ${disabled?'disabled':''}>
            ${BLOCK_TYPES.map(tp=>`<option value="${esc(tp)}" ${tp===b.type?'selected':''}>${esc(tp)}</option>`).join('')}
          </select>
        </td>
        <td><input class="ctrl" type="date" data-block-start value="${esc(b.startDate)}" ${disabled?'disabled':''} /></td>
        <td><input class="ctrl" type="date" data-block-end value="${esc(b.endDate)}" ${disabled?'disabled':''} /></td>
        <td style="text-align:center"><input type="checkbox" data-block-all ${b.allDay?'checked':''} ${disabled?'disabled':''} /></td>
        <td><input class="ctrl" type="time" data-block-sh value="${esc(b.startHour)}" ${b.allDay?'disabled':''} ${disabled?'disabled':''} /></td>
        <td><input class="ctrl" type="time" data-block-eh value="${esc(b.endHour)}" ${b.allDay?'disabled':''} ${disabled?'disabled':''} /></td>
        <td>${isAdmin() ? `<button class="btn" data-block-del>✕</button>` : '<span class="small muted">—</span>'}</td>
      </tr>
    `).join('');

    const orgRows = (org.members || []).map(m=>`
      <tr data-org-member-id="${esc(m.id)}">
        <td><input class="ctrl" data-org-name value="${esc(m.name)}" ${disabled?'disabled':''} /></td>
        <td><input class="ctrl" data-org-role value="${esc(m.role)}" ${disabled?'disabled':''} /></td>
        <td><input class="ctrl" data-org-area value="${esc(m.area)}" ${disabled?'disabled':''} /></td>
        <td><textarea class="ctrl" data-org-resp rows="4" ${disabled?'disabled':''}>${esc((m.responsibilities||[]).join('\n'))}</textarea></td>
        <td>${isAdmin() ? `<button class="btn danger" data-org-remove>Eliminar</button>` : '<span class="small muted">—</span>'}</td>
      </tr>
    `).join('');

    $('tab_team').innerHTML = `
      <div class="grid3" style="margin-bottom:10px">
        <div>
          <label class="label">Default inicio (nuevos usuarios)</label>
          <input class="ctrl" id="s_defaultStart" type="number" min="0" max="23" value="${state.settings.defaultStartHour}" ${disabled?'disabled':''} />
        </div>
        <div>
          <label class="label">Default fin (nuevos usuarios)</label>
          <input class="ctrl" id="s_defaultEnd" type="number" min="1" max="24" value="${state.settings.defaultEndHour}" ${disabled?'disabled':''} />
        </div>
        <div>
          <label class="label">Default capacidad h/día</label>
          <input class="ctrl" id="s_defaultCap" type="number" min="1" max="24" value="${state.settings.defaultCapacityHoursPerDay}" ${disabled?'disabled':''} />
        </div>
      </div>

      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <b>Configuración individual por usuario</b>
        ${isAdmin() ? `<button class="btn" id="btnAddTeam">+ Responsable</button>` : '<span class="small muted">Modo lectura</span>'}
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th>Nombre</th><th>Inicio</th><th>Fin</th><th>Capacidad h/día</th><th>Bloqueos</th><th>Acción</th></tr></thead>
        <tbody>${teamRows}</tbody>
      </table></div>

      <div class="row" style="justify-content:space-between;margin:12px 0 8px">
        <b>Bloqueos de tiempo por usuario (almuerzo, vacaciones, permisos, capacitación, trayecto)</b>
        ${isAdmin() ? `<button class="btn" id="btnAddBlock">+ Bloqueo</button>` : ''}
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th>Usuario</th><th>Tipo</th><th>Desde</th><th>Hasta</th><th>Todo día</th><th>Hora inicio</th><th>Hora fin</th><th></th></tr></thead>
        <tbody id="blockBody">${blockRows || `<tr><td colspan="8" class="muted">Sin bloqueos</td></tr>`}</tbody>
      </table></div>

      <div class="row" style="justify-content:space-between;margin:14px 0 8px">
        <b>Configuración manual del modal “Equipo”</b>
        ${isAdmin() ? `<button class="btn" id="btnOrgAddMember">+ Miembro</button>` : '<span class="small muted">Solo editable en modo administrador</span>'}
      </div>

      <div class="grid2" style="margin-bottom:8px">
        <div>
          <label class="label">Nombre del líder</label>
          <input class="ctrl" id="orgLeaderName" value="${esc(org.leader?.name || '')}" ${disabled?'disabled':''} />
        </div>
        <div>
          <label class="label">Rol del líder</label>
          <input class="ctrl" id="orgLeaderRole" value="${esc(org.leader?.role || '')}" ${disabled?'disabled':''} />
        </div>
      </div>

      <div class="table-wrap"><table>
        <thead><tr><th>Miembro</th><th>Rol</th><th>Caja / Área</th><th>Responsabilidades (1 por línea)</th><th>Acción</th></tr></thead>
        <tbody id="orgMemberBody">${orgRows || `<tr><td colspan="5" class="muted">Sin miembros. Agrega uno para mostrarlo en el modal Equipo.</td></tr>`}</tbody>
      </table></div>
      <div class="small muted org-note">Esta sección es totalmente manual y no está conectada a proyectos, actividades ni flujo de trabajo.</div>

      <div class="right" style="margin-top:10px">
        ${isAdmin() ? `<button class="btn primary" id="btnSaveTeam">Guardar</button>` : ''}
      </div>
    `;

    // Toggle all-day rows
    $('tab_team').querySelectorAll('[data-block-all]').forEach(chk=>{
      chk.disabled = disabled;
      chk.addEventListener('change', ()=>{
        const tr = chk.closest('tr');
        const sh = tr.querySelector('[data-block-sh]');
        const eh = tr.querySelector('[data-block-eh]');
        sh.disabled = chk.checked;
        eh.disabled = chk.checked;
      });
    });

    // Disable all editable controls in read mode
    if(disabled){
      $('tab_team').querySelectorAll('input,select,textarea,button').forEach(el=>{
        if(el.closest('#manageTabs')) return;
        if(el.id === 'btnTheme') return;
        if(el.hasAttribute('data-close')) return;
        if(el.tagName === 'BUTTON'){
          if(el.textContent?.trim() === 'Cerrar') return;
        }
        if(el.dataset && (el.dataset.close || el.dataset.tab)) return;
        if(el.type !== 'button' && el.type !== 'submit') el.disabled = true;
      });
      return;
    }

    $('btnAddTeam')?.addEventListener('click',()=>{
      const id = rid('u');
      state.team.push({
        id,
        name:'Nuevo responsable',
        startHour: state.settings.defaultStartHour,
        endHour: state.settings.defaultEndHour,
        capacityHoursPerDay: state.settings.defaultCapacityHoursPerDay,
        blocks: []
      });
      renderManageTeam();
    });

    $('tab_team').querySelectorAll('[data-remove-team]').forEach(b=>b.addEventListener('click',()=>{
      const id = b.dataset.removeTeam;
      if(state.team.length<=1){ toast('Debe quedar al menos un responsable.'); return; }
      state.team = state.team.filter(t=>t.id!==id);
      const fallback = state.team[0]?.id || 'u1';
      state.projects.forEach(p=>{
        if(p.leaderId===id) p.leaderId=fallback;
        (p.activities||[]).forEach(a=>{ if(a.ownerId===id) a.ownerId=fallback; });
      });
      renderManageTeam();
      render();
    }));

    $('btnAddBlock')?.addEventListener('click',()=>{
      const body = $('blockBody');
      if(body.querySelector('td[colspan="8"]')) body.innerHTML = '';
      const ownerId = state.team[0]?.id || '';
      const today = ui.date;
      const tr = document.createElement('tr');
      tr.dataset.blockId = rid('b');
      tr.innerHTML = `
        <td>
          <select class="ctrl" data-block-owner>${state.team.map(t=>`<option value="${esc(t.id)}" ${t.id===ownerId?'selected':''}>${esc(t.name)}</option>`).join('')}</select>
        </td>
        <td><select class="ctrl" data-block-type>${BLOCK_TYPES.map(tp=>`<option value="${esc(tp)}">${esc(tp)}</option>`).join('')}</select></td>
        <td><input class="ctrl" type="date" data-block-start value="${today}" /></td>
        <td><input class="ctrl" type="date" data-block-end value="${today}" /></td>
        <td style="text-align:center"><input type="checkbox" data-block-all /></td>
        <td><input class="ctrl" type="time" data-block-sh value="13:00" /></td>
        <td><input class="ctrl" type="time" data-block-eh value="14:00" /></td>
        <td><button class="btn" data-block-del>✕</button></td>
      `;
      body.appendChild(tr);

      tr.querySelector('[data-block-all]').addEventListener('change',e=>{
        tr.querySelector('[data-block-sh]').disabled = e.target.checked;
        tr.querySelector('[data-block-eh]').disabled = e.target.checked;
      });
      tr.querySelector('[data-block-del]').addEventListener('click',()=>tr.remove());
    });

    $('btnOrgAddMember')?.addEventListener('click',()=>{
      state.teamBoard.members.push({
        id: rid('tm'),
        name:'Nuevo miembro',
        role:'Analista',
        area:'General',
        responsibilities:[]
      });
      renderManageTeam();
    });

    $('tab_team').querySelectorAll('[data-org-remove]').forEach(btn=>btn.addEventListener('click',()=>{
      const tr = btn.closest('tr');
      tr?.remove();
      const body = $('orgMemberBody');
      if(body && !body.querySelector('tr[data-org-member-id]')){
        body.innerHTML = `<tr><td colspan="5" class="muted">Sin miembros. Agrega uno para mostrarlo en el modal Equipo.</td></tr>`;
      }
    }));

    $('tab_team').querySelectorAll('[data-block-del]').forEach(btn=>btn.addEventListener('click',()=>{
      btn.closest('tr')?.remove();
      const body = $('blockBody');
      if(body && !body.querySelector('tr[data-block-id]')){
        body.innerHTML = `<tr><td colspan="8" class="muted">Sin bloqueos</td></tr>`;
      }
    }));

    $('btnSaveTeam')?.addEventListener('click',()=>{
      const dStart = clampInt($('s_defaultStart').value,0,23,8);
      const dEnd = clampInt($('s_defaultEnd').value,dStart+1,24,19);
      const dCap = clampInt($('s_defaultCap').value,1,24,8);
      state.settings.defaultStartHour = dStart;
      state.settings.defaultEndHour = dEnd;
      state.settings.defaultCapacityHoursPerDay = dCap;

      // team individual data
      for(const t of state.team){
        const nInp = [...$('tab_team').querySelectorAll('[data-team-name]')].find(el=>el.dataset.teamName===t.id);
        const sInp = [...$('tab_team').querySelectorAll('[data-team-start]')].find(el=>el.dataset.teamStart===t.id);
        const eInp = [...$('tab_team').querySelectorAll('[data-team-end]')].find(el=>el.dataset.teamEnd===t.id);
        const cInp = [...$('tab_team').querySelectorAll('[data-team-cap]')].find(el=>el.dataset.teamCap===t.id);

        t.name = (nInp?.value || t.name).trim() || t.name;
        t.startHour = clampInt(sInp?.value,0,23,t.startHour);
        t.endHour = clampInt(eInp?.value,t.startHour+1,24,t.endHour);
        t.capacityHoursPerDay = clampInt(cInp?.value,1,24,t.capacityHoursPerDay);
      }

      // clear blocks
      state.team.forEach(t=>t.blocks = []);

      const rows = $('tab_team').querySelectorAll('#blockBody tr[data-block-id]');
      rows.forEach(tr=>{
        const ownerId = tr.querySelector('[data-block-owner]')?.value;
        const owner = state.team.find(t=>t.id===ownerId);
        if(!owner) return;

        const allDay = Boolean(tr.querySelector('[data-block-all]')?.checked);
        let startDate = normalizeISO(tr.querySelector('[data-block-start]')?.value) || ui.date;
        let endDate = normalizeISO(tr.querySelector('[data-block-end]')?.value) || startDate;
        if(startDate > endDate) [startDate,endDate] = [endDate,startDate];

        let startHour = normalizeHHMM(tr.querySelector('[data-block-sh]')?.value, `${String(owner.startHour).padStart(2,'0')}:00`);
        let endHour = normalizeHHMM(tr.querySelector('[data-block-eh]')?.value, `${String(Math.min(owner.endHour, owner.startHour+1)).padStart(2,'0')}:00`);
        if(timeToMin(endHour) <= timeToMin(startHour)) endHour = minToHHMM(Math.min(timeToMin(startHour)+60, owner.endHour*60));

        const b = sanitizeBlock({
          id: tr.dataset.blockId || rid('b'),
          type: tr.querySelector('[data-block-type]')?.value || 'Permiso',
          startDate,
          endDate,
          allDay,
          startHour,
          endHour
        }, owner.startHour, owner.endHour);

        owner.blocks.push(b);
      });

      // manual org chart data (independent from planning data)
      const leaderName = String($('orgLeaderName')?.value || '').trim();
      const leaderRole = String($('orgLeaderRole')?.value || '').trim();
      const orgRows = $('tab_team').querySelectorAll('#orgMemberBody tr[data-org-member-id]');
      const members = [...orgRows].map(tr=>{
        const name = String(tr.querySelector('[data-org-name]')?.value || '').trim();
        if(!name) return null;
        const role = String(tr.querySelector('[data-org-role]')?.value || '').trim() || 'Analista';
        const area = String(tr.querySelector('[data-org-area]')?.value || '').trim() || 'General';
        const responsibilities = parseResponsibilities(tr.querySelector('[data-org-resp]')?.value || '');
        return {
          id: tr.dataset.orgMemberId || rid('tm'),
          name,
          role,
          area,
          responsibilities
        };
      }).filter(Boolean);

      state.teamBoard = sanitizeTeamBoard({
        leader: {
          name: leaderName || 'Líder del equipo',
          role: leaderRole || 'Líder de operaciones'
        },
        members
      }, state.team);

      state = sanitizeState(state);
      render();
      renderManageTeam();
      toast('Configuración de equipo guardada');
    });
  }

  function renderManageHolidays(){
    const disabled = !isAdmin();
    const sorted = (holidaysState.items || []).slice().sort((a,b)=>a.date.localeCompare(b.date) || a.name.localeCompare(b.name));

    const rows = sorted.map(h=>`
      <tr data-holiday-id="${esc(h.id)}">
        <td>${esc(fmtDate(h.date))}</td>
        <td><span class="holiday-name">${esc(h.name)}</span></td>
        <td><span class="holiday-pill ${h.active?'on':'off'}">${h.active?'Activo':'Inactivo'}</span></td>
        <td>
          <div class="holiday-row-actions">
            ${isAdmin()?`<button class="btn" data-h-edit="${esc(h.id)}">Editar</button><button class="btn danger" data-h-del="${esc(h.id)}">Eliminar</button>`:'<span class="small muted">Solo lectura</span>'}
          </div>
        </td>
      </tr>
    `).join('');

    $('tab_holidays').innerHTML = `
      <div class="small muted" style="margin-bottom:8px">Gestiona feriados para excluirlos de recurrencias y recálculos.</div>
      <div class="holiday-form" id="holidayForm">
        <div>
          <label class="label">Fecha</label>
          <input class="ctrl" id="h_date" type="date" ${disabled?'disabled':''} />
        </div>
        <div class="col-span-2">
          <label class="label">Nombre / descripción</label>
          <input class="ctrl" id="h_name" placeholder="Ej. Fiestas Patrias" ${disabled?'disabled':''} />
        </div>
        <div>
          <label class="label">Estado</label>
          <select class="ctrl" id="h_active" ${disabled?'disabled':''}>
            <option value="1">Activo</option>
            <option value="0">Inactivo</option>
          </select>
        </div>
        <input type="hidden" id="h_id" />
        <div class="row">
          <button class="btn primary" id="h_save" ${disabled?'disabled':''}>Guardar</button>
          <button class="btn" id="h_clear" ${disabled?'disabled':''}>Limpiar</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:12px"><table>
        <thead><tr><th>Fecha</th><th>Nombre</th><th>Estado</th><th style="width:180px">Acciones</th></tr></thead>
        <tbody>${rows || `<tr><td colspan="4" class="muted">No hay feriados registrados.</td></tr>`}</tbody>
      </table></div>
    `;

    if(disabled) return;

    const clearForm = () => {
      $('h_id').value = '';
      $('h_date').value = '';
      $('h_name').value = '';
      $('h_active').value = '1';
    };

    $('h_clear')?.addEventListener('click', (ev)=>{
      ev.preventDefault();
      clearForm();
    });

    $('h_save')?.addEventListener('click', (ev)=>{
      ev.preventDefault();
      const id = $('h_id').value.trim();
      const date = normalizeISO($('h_date').value);
      const name = String($('h_name').value || '').trim();
      const active = $('h_active').value === '1';

      if(!date){ toast('Fecha inválida.'); return; }
      if(!name){ toast('Ingresa un nombre para el feriado.'); return; }

      const data = { id: id || rid('h'), date, name: name.slice(0,140), active };

      const idx = holidaysState.items.findIndex(x=>x.id===data.id);
      if(idx >= 0){
        holidaysState.items[idx] = data;
        toast('Feriado actualizado');
      }else{
        const dup = holidaysState.items.find(x=>x.date===data.date && x.name.toLowerCase()===data.name.toLowerCase());
        if(dup){
          toast('Ese feriado ya existe.');
          return;
        }
        holidaysState.items.push(data);
        toast('Feriado agregado');
      }

      holidaysState = sanitizeHolidayStore(holidaysState);
      saveHolidays();
      render();
      renderManageHolidays();
      clearForm();
    });

    $('tab_holidays').querySelectorAll('[data-h-edit]').forEach(btn=>btn.addEventListener('click',()=>{
      const h = holidaysState.items.find(x=>x.id===btn.dataset.hEdit);
      if(!h) return;
      $('h_id').value = h.id;
      $('h_date').value = h.date;
      $('h_name').value = h.name;
      $('h_active').value = h.active ? '1' : '0';
    }));

    $('tab_holidays').querySelectorAll('[data-h-del]').forEach(btn=>btn.addEventListener('click',()=>{
      if(!confirm('¿Eliminar feriado?')) return;
      holidaysState.items = holidaysState.items.filter(x=>x.id!==btn.dataset.hDel);
      holidaysState = sanitizeHolidayStore(holidaysState);
      saveHolidays();
      render();
      renderManageHolidays();
      toast('Feriado eliminado');
    }));
  }


  function countActivitiesInState(snapshot){
    return (snapshot?.projects || []).reduce((acc,p)=>acc + ((p?.activities || []).length), 0);
  }

  function summarizeBackupCounts(snapshotState, snapshotHolidays){
    const team = (snapshotState?.team || []).length;
    const projects = (snapshotState?.projects || []).length;
    const activities = countActivitiesInState(snapshotState);
    const holidays = (snapshotHolidays?.items || []).length;
    const notifications = (snapshotState?.notifications || []).length;
    return { team, projects, activities, holidays, notifications };
  }

  function buildBackupPayload(){
    const snapshotState = sanitizeState(structuredClone(state));
    const snapshotHolidays = sanitizeHolidayStore(structuredClone(holidaysState));
    const counts = summarizeBackupCounts(snapshotState, snapshotHolidays);

    let theme = 'light';
    try{
      theme = localStorage.getItem(THEME_KEY) || document.documentElement.getAttribute('data-theme') || 'light';
    }catch(_e){
      theme = document.documentElement.getAttribute('data-theme') || 'light';
    }

    return {
      meta: {
        app: 'banbif_workload',
        exportedAt: new Date().toISOString(),
        version: 2,
        schema: 'full_backup',
        counts
      },
      state: snapshotState,
      holidays: snapshotHolidays,
      theme,
      ui: {
        view: ui.view,
        date: '',
        roadmapZoom: ui.roadmapZoom,
        manageTab: ui.manageTab,
        manageProjectSort: ui.manageProjectSort,
        manageProjectSearch: ui.manageProjectSearch,
        manageNotifUser: ui.manageNotifUser,
        manageNotifQ: ui.manageNotifQ,
        manageNotifShowDone: ui.manageNotifShowDone,
        infoNotifUser: ui.infoNotifUser,
        infoNotifQ: ui.infoNotifQ,
        infoNotifShowDone: ui.infoNotifShowDone,
        filters: { ...ui.filters }
      }
    };
  }

  function validateImportStateCandidate(candidate){
    if(!candidate || typeof candidate !== 'object') return false;
    const markers = ['settings','team','projects','teamBoard'];
    if(!markers.some(k=>Object.prototype.hasOwnProperty.call(candidate, k))) return false;
    if(candidate.team !== undefined && !Array.isArray(candidate.team)) return false;
    if(candidate.projects !== undefined && !Array.isArray(candidate.projects)) return false;
    return true;
  }

  function extractImportBundle(parsed){
    if(!parsed || typeof parsed !== 'object'){
      throw new Error('El archivo no contiene un JSON válido.');
    }

    const envelope = (parsed.data && typeof parsed.data === 'object') ? parsed.data : parsed;

    let importedState = envelope.state ?? parsed.state ?? null;
    if(!importedState && (envelope.settings || envelope.team || envelope.projects || envelope.teamBoard)){
      importedState = envelope;
    }
    if(!importedState && (parsed.settings || parsed.team || parsed.projects || parsed.teamBoard)){
      importedState = parsed;
    }

    if(!validateImportStateCandidate(importedState)){
      throw new Error('El JSON no tiene la estructura de respaldo esperada (state/settings/team/projects).');
    }

    const importedHolidays = envelope.holidays ?? parsed.holidays ?? importedState?.holidays ?? [];
    const importedTheme = envelope.theme ?? parsed.theme ?? null;
    const importedUI = envelope.ui ?? parsed.ui ?? null;

    return {
      state: importedState,
      holidays: importedHolidays,
      theme: importedTheme,
      ui: importedUI
    };
  }

  function applyImportedBundle(bundle, options = {}){
    const nextState = sanitizeState(bundle?.state || {});
    const nextHolidays = sanitizeHolidayStore(bundle?.holidays || []);

    state = nextState;
    holidaysState = nextHolidays;

    if(bundle?.ui && typeof bundle.ui === 'object'){
      if(bundle.ui.view === 'day' || bundle.ui.view === 'week' || bundle.ui.view === 'month' || bundle.ui.view === 'roadmap'){
        ui.view = bundle.ui.view;
      }
      // Mantener siempre la fecha real del día al importar JSON.
      ui.date = todayISO();
      if(bundle.ui.roadmapZoom === 'week' || bundle.ui.roadmapZoom === 'month' || bundle.ui.roadmapZoom === 'year'){
        ui.roadmapZoom = bundle.ui.roadmapZoom;
      }
      if(bundle.ui.manageTab === 'projects' || bundle.ui.manageTab === 'team' || bundle.ui.manageTab === 'holidays' || bundle.ui.manageTab === 'notifications' || bundle.ui.manageTab === 'data'){
        ui.manageTab = bundle.ui.manageTab;
      }
      if(typeof bundle.ui.manageProjectSort === 'string') ui.manageProjectSort = bundle.ui.manageProjectSort;
      if(typeof bundle.ui.manageProjectSearch === 'string') ui.manageProjectSearch = bundle.ui.manageProjectSearch;
      if(typeof bundle.ui.manageNotifUser === 'string') ui.manageNotifUser = bundle.ui.manageNotifUser;
      if(typeof bundle.ui.manageNotifQ === 'string') ui.manageNotifQ = bundle.ui.manageNotifQ;
      if(typeof bundle.ui.manageNotifShowDone === 'boolean') ui.manageNotifShowDone = bundle.ui.manageNotifShowDone;
      if(typeof bundle.ui.infoNotifUser === 'string') ui.infoNotifUser = bundle.ui.infoNotifUser;
      if(typeof bundle.ui.infoNotifQ === 'string') ui.infoNotifQ = bundle.ui.infoNotifQ;
      if(typeof bundle.ui.infoNotifShowDone === 'boolean') ui.infoNotifShowDone = bundle.ui.infoNotifShowDone;
      if(bundle.ui.filters && typeof bundle.ui.filters === 'object'){
        ui.filters = {
          owner: String(bundle.ui.filters.owner || ''),
          client: String(bundle.ui.filters.client || ''),
          status: String(bundle.ui.filters.status || ''),
          priority: String(bundle.ui.filters.priority || ''),
          q: String(bundle.ui.filters.q || '')
        };
      }
    }

    if(bundle?.theme === 'dark' || bundle?.theme === 'light'){
      applyTheme(bundle.theme);
    }

    // Siempre abrir en la fecha real del día después de importar/restaurar.
    ui.date = todayISO();

    saveState();
    saveHolidays();
    render();
    renderManage();

    if(!options.silentToast){
      const c = summarizeBackupCounts(state, holidaysState);
      toast(`${options.restoring ? 'Respaldo restaurado' : 'Importación exitosa'} · ${c.projects} proyecto(s), ${c.activities} actividad(es), ${c.holidays} feriado(s), ${c.notifications} notificación(es).`);
    }
  }

  function getRemoteSyncMeta(){
    const raw = safeParse(localStorage.getItem(REMOTE_SYNC_META_KEY));
    if(!raw || typeof raw !== 'object') return null;
    const lastSuccessAt = typeof raw.lastSuccessAt === 'string' ? raw.lastSuccessAt : '';
    const source = typeof raw.source === 'string' ? raw.source : '';
    const url = typeof raw.url === 'string' ? raw.url : REMOTE_JSON_URL;
    return { lastSuccessAt, source, url };
  }

  function setRemoteSyncMeta(meta){
    try{
      localStorage.setItem(REMOTE_SYNC_META_KEY, JSON.stringify({
        lastSuccessAt: typeof meta?.lastSuccessAt === 'string' ? meta.lastSuccessAt : '',
        source: typeof meta?.source === 'string' ? meta.source : '',
        url: typeof meta?.url === 'string' ? meta.url : REMOTE_JSON_URL
      }));
    }catch(_e){}
  }

  function formatRemoteSyncStamp(iso){
    if(!iso) return 'Sin sincronizaciones remotas todavía.';
    const d = parseISO(iso);
    if(!(d instanceof Date) || Number.isNaN(d.getTime())) return 'Sin sincronizaciones remotas todavía.';
    return `Última sincronización: ${fmtDate(d)} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }

  async function syncFromRemoteJson(options = {}){
    const opts = {
      silentErrorToast: false,
      source: 'manual',
      silentImportToast: false,
      ...options
    };

    const sep = REMOTE_JSON_URL.includes('?') ? '&' : '?';
    const urlWithTs = `${REMOTE_JSON_URL}${sep}ts=${Date.now()}`;

    const res = await fetch(urlWithTs, { cache:'no-store' });
    if(!res.ok){
      const err = new Error(`No se pudo cargar JSON remoto (${res.status}).`);
      if(!opts.silentErrorToast) toast(err.message);
      throw err;
    }

    const parsed = await res.json();
    const bundle = extractImportBundle(parsed);

    try{
      localStorage.setItem(IMPORT_ROLLBACK_KEY, JSON.stringify(buildBackupPayload()));
    }catch(_backupErr){
      console.warn('No se pudo guardar backup automático previo a sincronización remota', _backupErr);
    }

    applyImportedBundle(bundle, { restoring:false, silentToast: Boolean(opts.silentImportToast) });

    const stamp = new Date().toISOString();
    setRemoteSyncMeta({
      lastSuccessAt: stamp,
      source: String(opts.source || 'manual'),
      url: REMOTE_JSON_URL
    });

    return stamp;
  }


  function normalizeSearchText(v=''){
    return String(v || '')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .trim();
  }

  function normalizeOptionalHHMM(raw){
    const txt = String(raw || '').trim();
    if(!txt) return '';
    const m = txt.match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return '';
    const h = Number(m[1]);
    const mm = Number(m[2]);
    if(!Number.isFinite(h) || !Number.isFinite(mm)) return '';
    if(h < 0 || h > 23 || mm < 0 || mm > 59) return '';
    return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
  }

  function sanitizeNotifications(rawList, teamList = []){
    const arr = Array.isArray(rawList) ? rawList : [];
    const teamIds = new Set((teamList || []).map(t=>String(t.id)));
    const seen = new Set();

    const clean = arr.map((n, idx)=>{
      if(!n || typeof n !== 'object') return null;

      const id = String(n.id || rid('n')).trim();
      if(!id || seen.has(id)) return null;
      seen.add(id);

      const title = String(n.title || n.subject || `Recordatorio ${idx+1}`).slice(0,120).trim() || `Recordatorio ${idx+1}`;
      const message = String(n.message || n.detail || n.note || '').slice(0,600).trim();

      let userId = String(n.userId || n.ownerId || NOTIF_ALL_USERS).trim() || NOTIF_ALL_USERS;
      if(userId !== NOTIF_ALL_USERS && !teamIds.has(userId)) userId = NOTIF_ALL_USERS;

      const remindDate = normalizeISO(n.remindDate || n.date || n.reminderDate || '');
      const remindTime = normalizeOptionalHHMM(n.remindTime || n.time || n.reminderTime || '');
      const done = Boolean(n.done || n.completed || n.attended || n.read);

      const createdAt = typeof n.createdAt === 'string' ? n.createdAt : '';
      const updatedAt = typeof n.updatedAt === 'string' ? n.updatedAt : '';

      return {
        id,
        title,
        message,
        userId,
        remindDate,
        remindTime,
        done,
        createdAt,
        updatedAt
      };
    }).filter(Boolean);

    return clean.sort(compareNotifications);
  }

  function compareNotifications(a,b){
    if(Boolean(a.done) !== Boolean(b.done)) return a.done ? 1 : -1;

    const ad = String(a.remindDate || '9999-12-31');
    const bd = String(b.remindDate || '9999-12-31');
    if(ad !== bd) return ad.localeCompare(bd);

    const at = String(a.remindTime || '23:59');
    const bt = String(b.remindTime || '23:59');
    if(at !== bt) return at.localeCompare(bt);

    const au = String(a.updatedAt || a.createdAt || '');
    const bu = String(b.updatedAt || b.createdAt || '');
    if(au !== bu) return bu.localeCompare(au);

    return String(a.title || '').localeCompare(String(b.title || ''), APP_LOCALE, { sensitivity:'base' });
  }

  function notificationTargetName(userId){
    if(userId === NOTIF_ALL_USERS) return 'Todos';
    return findTeam(userId)?.name || 'Usuario';
  }

  function notificationAppliesToFilter(notif, selectedUserId = ''){
    const selected = String(selectedUserId || '');
    if(!selected) return true;
    if(selected === NOTIF_ALL_USERS) return notif.userId === NOTIF_ALL_USERS;
    return notif.userId === selected || notif.userId === NOTIF_ALL_USERS;
  }

  function filterNotifications(list, { userId = '', q = '', includeDone = true } = {}){
    const needle = normalizeSearchText(q);
    return (Array.isArray(list) ? list : [])
      .filter(n=>{
        if(!notificationAppliesToFilter(n, userId)) return false;
        if(!includeDone && n.done) return false;
        if(!needle) return true;
        const haystack = [
          n.title,
          n.message,
          notificationTargetName(n.userId),
          n.remindDate,
          n.remindTime,
          n.done ? 'atendida' : 'pendiente'
        ].map(normalizeSearchText).join(' | ');
        return haystack.includes(needle);
      })
      .sort(compareNotifications);
  }

  function isNotificationDue(notif, refDate = new Date()){
    if(!notif || notif.done || !notif.remindDate) return false;
    const today = toISO(refDate);
    if(notif.remindDate < today) return true;
    if(notif.remindDate > today) return false;
    if(!notif.remindTime) return true;
    return timeToMin(notif.remindTime) <= (refDate.getHours()*60 + refDate.getMinutes());
  }

  function notificationStatus(notif, refDate = new Date()){
    if(notif.done) return { label:'Atendida', cls:'done' };
    if(!notif.remindDate) return { label:'Sin fecha', cls:'none' };

    const today = toISO(refDate);
    if(notif.remindDate < today) return { label:'Vencida', cls:'overdue' };
    if(notif.remindDate > today) return { label:'Programada', cls:'scheduled' };

    return { label:'Hoy', cls:'today' };
  }

  function formatNotificationReminder(notif){
    if(!notif.remindDate) return 'Sin fecha programada';
    const d = fmtDate(notif.remindDate);
    if(!notif.remindTime) return d;
    return `${d} ${notif.remindTime}`;
  }

  function countPendingNotifications(list){
    return (Array.isArray(list) ? list : []).filter(n=>!n.done).length;
  }

  function normalizeNotifQuery(v){
    return String(v || '')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[̀-ͯ]/g, '')
      .trim();
  }

  function applyNotificationTextFilter(scopeEl, queryText){
    const root = (typeof scopeEl === 'string') ? $(scopeEl) : scopeEl;
    if(!root) return { visible:0, pending:0, due:0, attended:0 };

    const query = normalizeNotifQuery(queryText);
    const cards = Array.from(root.querySelectorAll('.notif-card'));

    let visible = 0;
    let pending = 0;
    let due = 0;
    let attended = 0;

    cards.forEach(card=>{
      const hay = normalizeNotifQuery(card.dataset.search || card.textContent || '');
      const match = !query || hay.includes(query);
      card.style.display = match ? '' : 'none';
      if(!match) return;

      visible += 1;
      const done = card.classList.contains('done');
      if(done) attended += 1;
      else pending += 1;

      if(card.classList.contains('status-overdue') || card.classList.contains('status-today')) due += 1;
    });

    const empty = root.querySelector('.notif-empty');
    if(empty) empty.style.display = visible === 0 ? '' : 'none';

    return { visible, pending, due, attended };
  }

  function updateNotificationIndicator(){
    const infoBtn = $('btnInfo');
    if(!infoBtn) return;

    const dueCount = (state.notifications || []).filter(n=>isNotificationDue(n)).length;
    const pendingCount = countPendingNotifications(state.notifications || []);

    infoBtn.classList.toggle('has-alert', dueCount > 0);

    let tooltip = 'Notificaciones';
    if(dueCount > 0){
      tooltip += ` · ${dueCount} recordatorio(s) por fecha`;
    } else if(pendingCount > 0){
      tooltip += ` · ${pendingCount} pendiente(s)`;
    } else {
      tooltip += ' · Sin pendientes';
    }

    infoBtn.title = tooltip;
    infoBtn.setAttribute('aria-label', tooltip);
  }

  function rerenderNotifWithFocus(renderFn, inputId, value = '', caretPos = null){
    renderFn();
    requestAnimationFrame(()=>{
      const input = $(inputId);
      if(!input) return;
      if(String(input.value || '') !== String(value || '')) input.value = String(value || '');
      input.focus();
      const len = input.value.length;
      const pos = Number.isFinite(caretPos) ? Math.max(0, Math.min(caretPos, len)) : len;
      try{ input.setSelectionRange(pos, pos); }catch(_){/* noop */}
    });
  }

  function upsertNotificationDone(id, doneValue){
    const nowIso = new Date().toISOString();
    state.notifications = sanitizeNotifications(
      (state.notifications || []).map(n=> n.id === id ? { ...n, done:Boolean(doneValue), updatedAt:nowIso } : n),
      state.team
    );
    saveState();
    updateNotificationIndicator();
    if($('infoOverlay')?.classList.contains('open')) renderInfoNotifications();
  }

  function removeNotificationById(id){
    state.notifications = sanitizeNotifications((state.notifications || []).filter(n=>n.id !== id), state.team);
    saveState();
    updateNotificationIndicator();
    if($('infoOverlay')?.classList.contains('open')) renderInfoNotifications();
  }

  function renderManageNotifications(){
    const tab = $('tab_notifications');
    if(!tab) return;

    if(typeof ui.manageNotifUser !== 'string') ui.manageNotifUser = '';
    if(typeof ui.manageNotifQ !== 'string') ui.manageNotifQ = '';
    if(typeof ui.manageNotifShowDone !== 'boolean') ui.manageNotifShowDone = true;

    state.notifications = sanitizeNotifications(state.notifications, state.team);

    const users = state.team.slice();
    const userOptions = [
      `<option value="">Todos los usuarios</option>`,
      `<option value="${esc(NOTIF_ALL_USERS)}" ${ui.manageNotifUser===NOTIF_ALL_USERS?'selected':''}>Global (todos)</option>`,
      ...users.map(u=>`<option value="${esc(u.id)}" ${ui.manageNotifUser===u.id?'selected':''}>${esc(u.name)}</option>`)
    ].join('');

    const baseList = filterNotifications(state.notifications, {
      userId: ui.manageNotifUser,
      q: '',
      includeDone: ui.manageNotifShowDone
    });

    const due = baseList.filter(n=>isNotificationDue(n)).length;
    const pending = baseList.filter(n=>!n.done).length;
    const attended = baseList.filter(n=>n.done).length;

    const cards = baseList.map(n=>{
      const st = notificationStatus(n);
      const searchBlob = [
        n.title,
        n.message,
        notificationTargetName(n.userId),
        formatNotificationReminder(n),
        st.label
      ].join(' ');

      return `
        <div class="notif-card status-${st.cls} ${n.done?'done':''}" data-search="${esc(searchBlob)}">
          <div class="notif-head">
            <div>
              <div class="notif-title">${esc(n.title)}</div>
              <div class="notif-target"><i class="fa-regular fa-user" aria-hidden="true"></i> Para: ${esc(notificationTargetName(n.userId))}</div>
            </div>
            <span class="notif-pill ${st.cls}">${st.label}</span>
          </div>
          <div class="notif-msg">${n.message ? esc(n.message) : '<span class="muted">Sin detalle adicional</span>'}</div>
          <div class="notif-meta-row">
            <div class="notif-meta"><i class="fa-regular fa-calendar" aria-hidden="true"></i> Recordatorio: ${esc(formatNotificationReminder(n))}</div>
            <div class="notif-actions">
              <button class="btn notif-action-btn" data-n-toggle="${esc(n.id)}">${n.done ? 'Reabrir' : 'Atender'}</button>
              ${isAdmin() ? `<button class="btn danger" data-n-del="${esc(n.id)}">Eliminar</button>` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');

    tab.innerHTML = `
      <div class="notif-top">
        <div>
          <div class="notif-toolbar-title"><i class="fa-solid fa-bell" aria-hidden="true"></i> Centro de notificaciones</div>
          <div class="notif-toolbar-sub">Registra recordatorios por usuario, filtra rápidamente y controla vencimientos del equipo.</div>
        </div>
        <div class="notif-stats">
          <div class="notif-stat"><b id="manageNotifStatPending">${pending}</b><span>Pendientes</span></div>
          <div class="notif-stat"><b id="manageNotifStatDue">${due}</b><span>Vencidas / Hoy</span></div>
          <div class="notif-stat"><b id="manageNotifStatAttended">${attended}</b><span>Atendidas</span></div>
        </div>
      </div>

      <div class="notif-controls-wrap">
        <div class="notif-controls">
          <select class="ctrl" id="manageNotifFilterUser">${userOptions}</select>
          <input class="ctrl" id="manageNotifSearch" type="search" placeholder="Buscar notificación..." value="${esc(ui.manageNotifQ)}" autocomplete="off" enterkeyhint="search" />
          <label class="small muted" style="display:inline-flex;align-items:center;gap:6px">
            <input type="checkbox" id="manageNotifShowDone" ${ui.manageNotifShowDone?'checked':''} />
            Mostrar atendidas
          </label>
        </div>
      </div>

      ${isAdmin() ? `
      <div class="notif-form">
        <div>
          <label class="label">Título</label>
          <input class="ctrl" id="notifTitle" maxlength="120" placeholder="Ej. Enviar reporte de concentración" />
        </div>
        <div>
          <label class="label">Detalle</label>
          <input class="ctrl" id="notifMessage" maxlength="600" placeholder="Opcional" />
        </div>
        <div>
          <label class="label">Usuario destino</label>
          <select class="ctrl" id="notifUser">${[
            `<option value="${esc(NOTIF_ALL_USERS)}">Global (todos)</option>`,
            ...users.map(u=>`<option value="${esc(u.id)}">${esc(u.name)}</option>`)
          ].join('')}</select>
        </div>
        <div class="row" style="gap:8px">
          <div style="min-width:130px">
            <label class="label">Fecha</label>
            <input class="ctrl" id="notifDate" type="date" />
          </div>
          <div style="min-width:110px">
            <label class="label">Hora</label>
            <input class="ctrl" id="notifTime" type="time" />
          </div>
        </div>
        <button class="btn primary" id="notifAddBtn"><i class="fa-solid fa-plus" aria-hidden="true"></i> Agregar</button>
      </div>` : '<div class="small muted" style="margin-top:10px">Modo lectura: puedes buscar y revisar notificaciones.</div>'}

      <div class="notif-list">${cards}${baseList.length===0 ? '<div id="manageNotifEmpty" class="notif-empty">No hay notificaciones para el filtro seleccionado.</div>' : '<div id="manageNotifEmpty" class="notif-empty" style="display:none">No hay notificaciones para tu búsqueda.</div>'}</div>
    `;

    const applyManageSearch = ()=>{
      const result = applyNotificationTextFilter(tab, ui.manageNotifQ);
      const pendingEl = $('manageNotifStatPending');
      const dueEl = $('manageNotifStatDue');
      const attendedEl = $('manageNotifStatAttended');
      if(pendingEl) pendingEl.textContent = String(result.pending);
      if(dueEl) dueEl.textContent = String(result.due);
      if(attendedEl) attendedEl.textContent = String(result.attended);
    };

    $('manageNotifFilterUser')?.addEventListener('change', e=>{
      ui.manageNotifUser = String(e.target.value || '');
      renderManageNotifications();
    });

    const manageSearchInput = $('manageNotifSearch');
    if(manageSearchInput){
      const onManageSearchEvent = ()=>{
        ui.manageNotifQ = String(manageSearchInput.value || '');
        applyManageSearch();
      };
      ['input','keyup','search','change'].forEach(evt=> manageSearchInput.addEventListener(evt, onManageSearchEvent));
    }

    $('manageNotifShowDone')?.addEventListener('change', e=>{
      ui.manageNotifShowDone = Boolean(e.target.checked);
      renderManageNotifications();
    });

    tab.querySelectorAll('[data-n-toggle]').forEach(btn=>btn.addEventListener('click', ()=>{
      const id = btn.dataset.nToggle;
      const target = (state.notifications || []).find(n=>n.id===id);
      if(!target) return;
      upsertNotificationDone(id, !target.done);
      renderManageNotifications();
      toast(target.done ? 'Recordatorio reabierto.' : 'Recordatorio marcado como atendido.');
    }));

    tab.querySelectorAll('[data-n-del]').forEach(btn=>btn.addEventListener('click', ()=>{
      const id = btn.dataset.nDel;
      if(!id) return;
      if(!confirm('¿Eliminar notificación?')) return;
      removeNotificationById(id);
      renderManageNotifications();
      toast('Notificación eliminada.');
    }));

    $('notifAddBtn')?.addEventListener('click', ()=>{
      const title = String($('notifTitle')?.value || '').trim();
      if(!title){
        toast('Ingresa un título para la notificación.');
        $('notifTitle')?.focus();
        return;
      }

      let userId = String($('notifUser')?.value || NOTIF_ALL_USERS).trim() || NOTIF_ALL_USERS;
      if(userId !== NOTIF_ALL_USERS && !state.team.some(t=>t.id===userId)) userId = NOTIF_ALL_USERS;

      const remindDate = normalizeISO($('notifDate')?.value || '');
      const remindTime = normalizeOptionalHHMM($('notifTime')?.value || '');
      const message = String($('notifMessage')?.value || '').trim().slice(0,600);
      const nowIso = new Date().toISOString();

      const notif = {
        id: rid('n'),
        title: title.slice(0,120),
        message,
        userId,
        remindDate,
        remindTime,
        done: false,
        createdAt: nowIso,
        updatedAt: nowIso
      };

      state.notifications = sanitizeNotifications([...(state.notifications || []), notif], state.team);
      saveState();
      updateNotificationIndicator();
      if($('infoOverlay')?.classList.contains('open')) renderInfoNotifications();
      renderManageNotifications();
      toast('Notificación registrada.');
    });

    applyManageSearch();
  }

  function renderInfoNotifications(){
    const body = $('infoBody');
    if(!body) return;

    if(typeof ui.infoNotifUser !== 'string') ui.infoNotifUser = '';
    if(typeof ui.infoNotifQ !== 'string') ui.infoNotifQ = '';
    if(typeof ui.infoNotifShowDone !== 'boolean') ui.infoNotifShowDone = false;

    state.notifications = sanitizeNotifications(state.notifications, state.team);

    const users = state.team.slice();
    const userOptions = [
      `<option value="">Todos los usuarios</option>`,
      `<option value="${esc(NOTIF_ALL_USERS)}" ${ui.infoNotifUser===NOTIF_ALL_USERS?'selected':''}>Global (todos)</option>`,
      ...users.map(u=>`<option value="${esc(u.id)}" ${ui.infoNotifUser===u.id?'selected':''}>${esc(u.name)}</option>`)
    ].join('');

    const baseList = filterNotifications(state.notifications, {
      userId: ui.infoNotifUser,
      q: '',
      includeDone: ui.infoNotifShowDone
    });

    const due = baseList.filter(n=>isNotificationDue(n)).length;
    const pending = baseList.filter(n=>!n.done).length;
    const attended = baseList.filter(n=>n.done).length;

    const cards = baseList.map(n=>{
      const st = notificationStatus(n);
      const searchBlob = [
        n.title,
        n.message,
        notificationTargetName(n.userId),
        formatNotificationReminder(n),
        st.label
      ].join(' ');

      return `
        <div class="notif-card status-${st.cls} ${n.done?'done':''}" data-search="${esc(searchBlob)}">
          <div class="notif-head">
            <div>
              <div class="notif-title">${esc(n.title)}</div>
              <div class="notif-target"><i class="fa-regular fa-user" aria-hidden="true"></i> Para: ${esc(notificationTargetName(n.userId))}</div>
            </div>
            <span class="notif-pill ${st.cls}">${st.label}</span>
          </div>
          <div class="notif-msg">${n.message ? esc(n.message) : '<span class="muted">Sin detalle adicional</span>'}</div>
          <div class="notif-meta-row">
            <div class="notif-meta"><i class="fa-regular fa-calendar" aria-hidden="true"></i> Recordatorio: ${esc(formatNotificationReminder(n))}</div>
            <div class="notif-actions">
              <button class="btn notif-action-btn" data-info-n-toggle="${esc(n.id)}">${n.done ? 'Reabrir' : 'Atender'}</button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    body.innerHTML = `
      <div class="notif-top">
        <div>
          <div class="notif-toolbar-title"><i class="fa-solid fa-bell" aria-hidden="true"></i> Recordatorios del equipo</div>
          <div class="notif-toolbar-sub">Visualiza alertas por usuario y marca recordatorios como atendidos desde este panel.</div>
        </div>
        <div class="notif-stats">
          <div class="notif-stat"><b id="infoNotifStatPending">${pending}</b><span>Pendientes</span></div>
          <div class="notif-stat"><b id="infoNotifStatDue">${due}</b><span>Vencidas / Hoy</span></div>
          <div class="notif-stat"><b id="infoNotifStatAttended">${attended}</b><span>Atendidas</span></div>
        </div>
      </div>

      <div class="notif-controls-wrap">
        <div class="notif-controls">
          <select class="ctrl" id="infoNotifFilterUser">${userOptions}</select>
          <input class="ctrl" id="infoNotifSearch" type="search" placeholder="Buscar..." value="${esc(ui.infoNotifQ)}" autocomplete="off" enterkeyhint="search" />
          <label class="small muted" style="display:inline-flex;align-items:center;gap:6px">
            <input type="checkbox" id="infoNotifShowDone" ${ui.infoNotifShowDone?'checked':''} />
            Mostrar atendidas
          </label>
        </div>
      </div>

      <div class="notif-list">${cards}${baseList.length===0 ? '<div id="infoNotifEmpty" class="notif-empty">No hay notificaciones para el filtro seleccionado.</div>' : '<div id="infoNotifEmpty" class="notif-empty" style="display:none">No hay notificaciones para tu búsqueda.</div>'}</div>
    `;

    const footer = $('infoFooterNote');

    const applyInfoSearch = ()=>{
      const result = applyNotificationTextFilter(body, ui.infoNotifQ);

      const pendingEl = $('infoNotifStatPending');
      const dueEl = $('infoNotifStatDue');
      const attendedEl = $('infoNotifStatAttended');
      if(pendingEl) pendingEl.textContent = String(result.pending);
      if(dueEl) dueEl.textContent = String(result.due);
      if(attendedEl) attendedEl.textContent = String(result.attended);

      if(footer){
        footer.textContent = result.due > 0
          ? `${result.due} recordatorio(s) pendiente(s) por fecha`
          : (result.pending > 0 ? `${result.pending} recordatorio(s) pendiente(s)` : 'Sin recordatorios pendientes por ahora');
      }
    };

    $('infoNotifFilterUser')?.addEventListener('change', e=>{
      ui.infoNotifUser = String(e.target.value || '');
      renderInfoNotifications();
    });

    const infoSearchInput = $('infoNotifSearch');
    if(infoSearchInput){
      const onInfoSearchEvent = ()=>{
        ui.infoNotifQ = String(infoSearchInput.value || '');
        applyInfoSearch();
      };
      ['input','keyup','search','change'].forEach(evt=> infoSearchInput.addEventListener(evt, onInfoSearchEvent));
    }

    $('infoNotifShowDone')?.addEventListener('change', e=>{
      ui.infoNotifShowDone = Boolean(e.target.checked);
      renderInfoNotifications();
    });

    body.querySelectorAll('[data-info-n-toggle]').forEach(btn=>btn.addEventListener('click', ()=>{
      const id = btn.dataset.infoNToggle;
      const target = (state.notifications || []).find(n=>n.id===id);
      if(!target) return;
      upsertNotificationDone(id, !target.done);
      renderInfoNotifications();
      if($('manageOverlay')?.classList.contains('open') && ui.manageTab === 'notifications'){
        renderManageNotifications();
      }
      toast(target.done ? 'Recordatorio reabierto.' : 'Recordatorio marcado como atendido.');
    }));

    applyInfoSearch();
  }

  function renderManageData(){
    const adjusted = Number(ui.lastAdjustedBusinessDates || 0);
    if(adjusted > 0){
      toast(`Se ajustaron ${adjusted} fecha(s) de tareas al siguiente día hábil.`);
      ui.lastAdjustedBusinessDates = 0;
    }

    const hasRollback = Boolean(safeParse(localStorage.getItem(IMPORT_ROLLBACK_KEY)));
    const remoteMeta = getRemoteSyncMeta();
    const remoteStamp = formatRemoteSyncStamp(remoteMeta?.lastSuccessAt || '');

    const tab = $('tab_data');
    if(!tab) return;

    tab.innerHTML = `
      <div class="grid2">
        <div class="card" id="dataBackupCard">
          <h3>Respaldo</h3>
          <div class="small muted">Exporta o importa sin perder compatibilidad. Incluye proyectos, equipo, bloqueos, configuración manual de Equipo, feriados, notificaciones y tema visual.</div>
          <div class="row" style="margin-top:8px;flex-wrap:wrap">
            <button class="btn" id="btnExport">Exportar JSON</button>
            <label class="btn">Importar JSON <input id="importFile" type="file" accept=".json,application/json" hidden /></label>
            <button class="btn" id="btnRestoreImportBackup" ${hasRollback ? '' : 'disabled'}>Restaurar último backup automático</button>
          </div>
          <div class="small muted" style="margin-top:8px">Al importar, se crea automáticamente un respaldo previo para reversión inmediata.</div>
        </div>
        <div class="card">
          <h3>Sincronizar Datos</h3>
          <div class="small muted">Ruta configurada: <code>${esc(REMOTE_JSON_URL)}</code></div>
          <div class="row" style="margin-top:8px;flex-wrap:wrap">
            <button class="btn" id="btnSyncRemote">Actualizar desde JSON remoto</button>
          </div>
          <div class="small muted" id="remoteSyncStamp" style="margin-top:8px">${esc(remoteStamp)}</div>
          <div class="small muted" style="margin-top:6px">Sube tu JSON exportado a esa ruta en GitHub y luego usa este botón para forzar lectura sin caché.</div>
        </div>
        <div class="card">
          <h3>Reset total</h3>
          <div class="small muted">Elimina toda la data local de esta herramienta (incluye feriados).</div>
          <button class="btn danger" id="btnResetAll">Reiniciar todo</button>
        </div>
      </div>
      ${isAdmin() ? '<div class="small muted" style="margin-top:8px">Tip: guarda backups antes de cambios masivos.</div>' : ''}
    `;

    if(!isAdmin()){
      const backupCard = $('dataBackupCard');
      if(backupCard) backupCard.remove();
    }

    const btnExport = $('btnExport');
    if(btnExport){
      btnExport.addEventListener('click',()=>{
        const payload = buildBackupPayload();
        const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
        downloadBlob(blob, `banbif_workload_backup_${todayISO()}.json`);
      });
    }

    const importFile = $('importFile');
    if(importFile){
      importFile.addEventListener('change', async (e)=>{
        const f = e.target.files?.[0];
        if(!f) return;
        try{
          const text = await f.text();
          const parsed = JSON.parse(text);
          const bundle = extractImportBundle(parsed);

          try{
            localStorage.setItem(IMPORT_ROLLBACK_KEY, JSON.stringify(buildBackupPayload()));
          }catch(_backupErr){
            console.warn('No se pudo guardar backup automático previo a la importación', _backupErr);
          }

          applyImportedBundle(bundle, { restoring:false });
        }catch(err){
          console.error(err);
          toast(err?.message || 'JSON inválido');
        }finally{
          e.target.value = '';
        }
      });
    }

    const btnRestoreImportBackup = $('btnRestoreImportBackup');
    if(btnRestoreImportBackup){
      btnRestoreImportBackup.addEventListener('click',()=>{
        try{
          const raw = safeParse(localStorage.getItem(IMPORT_ROLLBACK_KEY));
          if(!raw){
            toast('No hay backup automático disponible para restaurar.');
            return;
          }
          const bundle = extractImportBundle(raw);
          applyImportedBundle(bundle, { restoring:true });
        }catch(err){
          console.error(err);
          toast(err?.message || 'No se pudo restaurar el backup automático.');
        }
      });
    }

    const btnSyncRemote = $('btnSyncRemote');
    if(btnSyncRemote){
      btnSyncRemote.addEventListener('click', async ()=>{
        const original = btnSyncRemote.textContent;
        btnSyncRemote.disabled = true;
        btnSyncRemote.textContent = 'Actualizando...';
        try{
          await syncFromRemoteJson({ source:'manual_button', silentImportToast:false });
          renderManage();
        }catch(err){
          console.error(err);
          toast(err?.message || 'No se pudo actualizar desde JSON remoto.');
        }finally{
          btnSyncRemote.disabled = false;
          btnSyncRemote.textContent = original;
        }
      });
    }

    const btnResetAll = $('btnResetAll');
    if(btnResetAll){
      btnResetAll.addEventListener('click',()=>{
        hardResetApplication();
      });
    }
  }

  function getFilteredTeam(){
    return state.team.filter(t=>!ui.filters.owner || t.id===ui.filters.owner);
  }

  function getVisibleActivityInstances(dayISO){
    if(isNonWorkingDayISO(dayISO)) return [];
    const list = [];
    state.projects.forEach(p=>{
      if(!projectVisible(p, dayISO)) return;

      const recurrenceEnabled = isRecurringProject(p);

      let occurrence = null;
      if(recurrenceEnabled){
        occurrence = getRelevantOccurrenceForDate(p, dayISO);
        if(!occurrence) return;
        if(dayISO < occurrence.startDate || dayISO > occurrence.endDate) return;
      }

      (p.activities||[]).forEach(a=>{
        if(ui.filters.owner && a.ownerId !== ui.filters.owner) return;
        let occStart = a.startDate;
        let occEnd = a.endDate;

        if(recurrenceEnabled){
          const mapped = mapRecurringDateRange(a.startDate, a.endDate, occurrence);
          if(!mapped) return;
          occStart = mapped.startDate;
          occEnd = mapped.endDate;
        }

        if(dayISO < occStart || dayISO > occEnd) return;

        const status = activityStatus({...a, startDate:occStart, endDate:occEnd}, dayISO, p);
        const projectStatusLabel = projectStatus(p, dayISO, occurrence);
        const displayStatus = (status === 'Demorado' || status === 'Finalizado') ? status : projectStatusLabel;
        list.push({
          projectId: p.id,
          taskId: a.id,
          projectName: p.name,
          taskName: a.name,
          taskDetail: a.detail || '',
          client: p.client,
          priority: p.priority,
          ownerId: a.ownerId,
          ownerName: findTeam(a.ownerId)?.name || 'Sin dueño',
          startDate: occStart,
          endDate: occEnd,
          startHour: a.startHour,
          endHour: a.endHour,
          minutes: durationMinutes(a.startHour, a.endHour),
          status,
          displayStatus
        });
      });
    });
    return list;
  }

  function projectVisible(p, refDate=todayISO()){
    if(ui.filters.priority && p.priority !== ui.filters.priority) return false;

    const client = String(p?.client || 'Interno').trim() || 'Interno';
    if(ui.filters.client && client !== ui.filters.client) return false;

    if(ui.filters.owner){
      const hasOwner = (p.activities||[]).some(a => a.ownerId === ui.filters.owner);
      if(!hasOwner) return false;
    }

    const pStatus = projectStatus(p, refDate);
    if(ui.filters.status && pStatus !== ui.filters.status) return false;

    const q = ui.filters.q;
    if(q){
      const blob = `${p.name} ${client} ${normalizeRecurrenceFrequency(p.recurrenceFrequency)} ${(p.activities||[]).map(a=>a.name).join(' ')}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  }

  function activityStatus(a, refDate=todayISO(), project=null){
    if(a.done) return 'Finalizado';
    const realDate = todayISO();
    return autoStatusByDates(a.startDate, a.endDate, false, realDate, project);
  }

  function projectStatus(p, refDate=todayISO(), occurrence=null){
    const realDate = todayISO();
    const acts = Array.isArray(p?.activities) ? p.activities : [];
    if(acts.length && acts.every(a=>Boolean(a.done))) return 'Finalizado';

    const rec = normalizeRecurrenceFrequency(p?.recurrenceFrequency);
    let occStart = normalizeISO(p?.startDate) || p?.startDate;
    let occEnd = normalizeISO(p?.endDate) || p?.endDate;
    let currentOcc = null;

    if(rec !== 'Ninguna'){
      currentOcc = occurrence || getRelevantOccurrenceForDate(p, realDate);
      if(currentOcc){
        occStart = normalizeISO(currentOcc.startDate) || occStart;
        occEnd = normalizeISO(currentOcc.endDate) || occEnd;
      }
    }

    // Regla clave: si existe al menos una actividad abierta y demorada,
    // el proyecto se considera "Demorado" (excepto si esas actividades ya están finalizadas).
    if(acts.length){
      const hasDelayedOpenActivity = acts.some(a=>{
        if(Boolean(a?.done)) return false;

        let aStart = normalizeISO(a?.startDate) || a?.startDate;
        let aEnd = normalizeISO(a?.endDate) || a?.endDate;

        if(rec !== 'Ninguna' && currentOcc){
          const mapped = mapRecurringDateRange(a.startDate, a.endDate, currentOcc);
          if(!mapped) return false;
          aStart = normalizeISO(mapped.startDate) || aStart;
          aEnd = normalizeISO(mapped.endDate) || aEnd;
        }

        const st = activityStatus({ ...a, startDate:aStart, endDate:aEnd }, realDate, p);
        return st === 'Demorado';
      });

      if(hasDelayedOpenActivity) return 'Demorado';
    }

    return autoStatusByDates(occStart, occEnd, false, realDate);
  }

  function autoStatusByDates(startDate, endDate, isDone=false, refDate=todayISO()){
    if(isDone) return 'Finalizado';
    const realDate = todayISO();
    if(realDate < startDate) return 'Programado';
    if(realDate > endDate) return 'Demorado';
    return 'En curso';
  }

  function getRiskMetrics(dayISO){
    const asNum = (v) => Number.isFinite(Number(v)) ? Number(v) : 0;

    if(isNonWorkingDayISO(dayISO)){
      return {
        dueSoon: 0,
        overdue: 0,
        conflicts: 0,
        blocked: 0,
        enRiesgo: 0,
        demorado: 0,
        bloqueado: 0
      };
    }

    let enRiesgo = 0;
    let demorado = 0;

    state.projects.forEach(p=>{
      const recurring = isRecurringProject(p);
      let occ = null;

      if(recurring){
        occ = getRelevantOccurrenceForDate(p, dayISO);
        if(!occ || dayISO < occ.startDate || dayISO > occ.endDate) return;
      }else if(dayISO < p.startDate || dayISO > p.endDate){
        return;
      }

      (p.activities || []).forEach(a=>{
        let aStart = a.startDate;
        let aEnd = a.endDate;

        if(recurring){
          const mapped = mapRecurringDateRange(a.startDate, a.endDate, occ);
          if(!mapped) return;
          aStart = mapped.startDate;
          aEnd = mapped.endDate;
        }

        if(dayISO < aStart || dayISO > aEnd) return;

        const st = activityStatus({ ...a, startDate:aStart, endDate:aEnd }, dayISO, p);
        if(st === 'Demorado') demorado++;
        if(st !== 'Finalizado' && (aEnd === dayISO || addDaysISO(dayISO,1) === aEnd)) enRiesgo++;
      });
    });

    const conflicts = asNum(detectTaskConflicts(dayISO));
    const blocked = asNum(detectBlockedConflicts(dayISO));
    const dueSoon = asNum(enRiesgo);
    const overdue = asNum(demorado);

    return {
      dueSoon,
      overdue,
      conflicts,
      blocked,
      enRiesgo: dueSoon,
      demorado: overdue,
      bloqueado: blocked
    };
  }

  function detectTaskConflicts(dayISO){
    let cnt = 0;
    const acts = getVisibleActivityInstances(dayISO);
    const byOwner = new Map();
    acts.forEach(a=>{
      if(!byOwner.has(a.ownerId)) byOwner.set(a.ownerId, []);
      byOwner.get(a.ownerId).push(a);
    });

    for(const arr of byOwner.values()){
      const sorted = arr.slice().sort((x,y)=>x.startHour.localeCompare(y.startHour));
      for(let i=0;i<sorted.length-1;i++){
        if(timeToMin(sorted[i].endHour) > timeToMin(sorted[i+1].startHour)) cnt++;
      }
    }
    return cnt;
  }

  function detectBlockedConflicts(dayISO){
    let cnt = 0;
    const acts = getVisibleActivityInstances(dayISO);

    for(const a of acts){
      const person = findTeam(a.ownerId);
      if(!person) continue;
      const intervals = blockIntervalsForDay(person, dayISO);
      const s = timeToMin(a.startHour), e = timeToMin(a.endHour);
      if(intervals.some(iv=>Math.max(iv.startMin,s) < Math.min(iv.endMin,e))) cnt++;
    }
    return cnt;
  }

  function getBlocksForDay(person, dayISO){
    if(!person || !Array.isArray(person.blocks)) return [];
    const dow = isoWeekday(dayISO);
    return person.blocks.filter(b=>{
      if(!(b.startDate <= dayISO && b.endDate >= dayISO)) return false;
      if(Array.isArray(b.weekdays) && b.weekdays.length && !b.weekdays.includes(dow)) return false;
      return true;
    });
  }

  function blockIntervalsForDay(person, dayISO, displayStartHour=null, displayEndHour=null){
    const startHour = displayStartHour==null ? person.startHour : displayStartHour;
    const endHour = displayEndHour==null ? person.endHour : displayEndHour;

    if(isNonWorkingDayISO(dayISO)){
      const reason = nonWorkingReason(dayISO) || 'No laborable';
      return [{
        id: `nw_${person.id}_${dayISO}`,
        type: reason,
        startDate: dayISO,
        endDate: dayISO,
        allDay: true,
        startHour: minToHHMM(startHour*60),
        endHour: minToHHMM(endHour*60),
        startMin: startHour*60,
        endMin: endHour*60
      }];
    }

    const blocks = getBlocksForDay(person, dayISO).map(b=>{
      let s = b.allDay ? startHour*60 : timeToMin(b.startHour);
      let e = b.allDay ? endHour*60 : timeToMin(b.endHour);
      s = clamp(s, startHour*60, endHour*60);
      e = clamp(e, startHour*60, endHour*60);
      if(e <= s) e = Math.min(endHour*60, s+30);
      return { ...b, startMin:s, endMin:e };
    });
    return mergeIntervals(blocks.map(x=>[x.startMin,x.endMin])).map(([s,e],i)=>({
      id:`m${i}`, type:'Bloqueo', allDay:false,
      startMin:s, endMin:e, startHour:minToHHMM(s), endHour:minToHHMM(e)
    }));
  }

  function sumBlockedMinutes(person, dayISO){
    const intervals = blockIntervalsForDay(person, dayISO);
    if(!intervals.length) return 0;
    const merged = mergeIntervals(intervals.map(i=>[i.startMin, i.endMin]));
    return merged.reduce((acc,[s,e])=>acc + (e-s), 0);
  }

  function mergeIntervals(arr){
    if(!arr.length) return [];
    const sorted = arr.slice().sort((a,b)=>a[0]-b[0]);
    const out = [sorted[0].slice()];
    for(let i=1;i<sorted.length;i++){
      const cur = sorted[i];
      const last = out[out.length-1];
      if(cur[0] <= last[1]) last[1] = Math.max(last[1], cur[1]);
      else out.push(cur.slice());
    }
    return out;
  }

  function getDailyCapacityMin(person, dayISO){
    if(isNonWorkingDayISO(dayISO)) return 0;
    const nominal = Math.max(0, Number(person.capacityHoursPerDay||0) * 60);
    const blocked = sumBlockedMinutes(person, dayISO);
    return Math.max(0, nominal - blocked);
  }

  function estimateDayCardHeight(e){
    const estimateLines = (txt, charsPerLine, min=0, max=12) => {
      const t = String(txt || '').trim();
      if(!t) return min;
      return clampInt(Math.ceil(t.length / Math.max(10, charsPerLine)), min, max, min);
    };

    const projectLines = estimateLines(e.projectName, 34, 1, 2);
    const nameLines = estimateLines(e.taskName, 34, 1, 3);
    const detailLines = estimateLines(e.taskDetail, 52, 0, 8);
    const base = 44;
    const total = base + (projectLines * 6) + (nameLines * 8) + (detailLines * 7);
    return clampInt(total, 44, 140, 60);
  }

  function computeDayHourHeight(events){
    const baseHourPx = 56;
    if(!Array.isArray(events) || !events.length) return baseHourPx;
    let requiredHourPx = baseHourPx;
    for(const e of events){
      const estimatedHeight = estimateDayCardHeight(e);
      let s = timeToMin(e.startHour);
      let ed = timeToMin(e.endHour);
      if(!Number.isFinite(s) || !Number.isFinite(ed)) continue;
      if(ed <= s) ed = s + 30;
      const durationMin = Math.max(30, ed - s);
      const hourNeed = (estimatedHeight * 60) / durationMin;
      if(Number.isFinite(hourNeed)) requiredHourPx = Math.max(requiredHourPx, hourNeed);
    }
    return clampInt(Math.ceil(requiredHourPx), baseHourPx, 480, baseHourPx);
  }

  function computeDayHourHeightFromDom(container){
    const baseHourPx = 56;
    if(!container) return baseHourPx;
    let requiredHourPx = baseHourPx;
    container.querySelectorAll('.task').forEach(el=>{
      const contentH = Math.ceil(el.scrollHeight + 8);
      const startHour = el.dataset.startHour || '09:00';
      const endHour = el.dataset.endHour || '09:30';
      let durationMin = timeToMin(endHour) - timeToMin(startHour);
      if(!Number.isFinite(durationMin) || durationMin <= 0) durationMin = 30;
      durationMin = Math.max(30, durationMin);
      const hourNeed = (contentH * 60) / durationMin;
      if(Number.isFinite(hourNeed)) requiredHourPx = Math.max(requiredHourPx, hourNeed);
    });
    return clampInt(Math.ceil(requiredHourPx), baseHourPx, 480, baseHourPx);
  }

  function calcLanes(events, startHour, endHour){
    const evs = events.map(e=>{
      const startMin = clamp(timeToMin(e.startHour), startHour*60, endHour*60);
      let endMin = clamp(timeToMin(e.endHour), startHour*60, endHour*60);
      if(endMin <= startMin) endMin = Math.min(endHour*60, startMin+30);
      const estimatedHeight = estimateDayCardHeight(e);
      return { ...e, startMin, endMin, estimatedHeight };
    }).sort((a,b)=>a.startMin-b.startMin || a.endMin-b.endMin);

    const lanes = [];
    const laneEnds = [];

    for(const ev of evs){
      let lane = laneEnds.findIndex(end => end <= ev.startMin);
      if(lane < 0){
        lane = laneEnds.length;
        laneEnds.push(ev.endMin);
      }else{
        laneEnds[lane] = ev.endMin;
      }
      ev.lane = lane;
      ev.totalLanes = laneEnds.length;
      lanes.push(ev);
    }

    lanes.forEach(ev=>{
      const overlap = lanes.filter(x=>!(x.endMin<=ev.startMin || x.startMin>=ev.endMin));
      ev.totalLanes = Math.max(1, ev.totalLanes, ...overlap.map(x=>x.totalLanes));
    });

    return lanes.map(ev=>{
      const top = minutesToPx(ev.startMin, startHour);
      const hFromRange = minutesToPx(ev.endMin, startHour) - top;
      const h = Math.max(22, hFromRange);
      return { ...ev, top, height:h };
    });
  }

  function openOverlay(id){
    const o = $(id);
    if(!o) return;
    o.classList.add('open');
    document.body.style.overflow = 'hidden';
    requestAnimationFrame(()=>applyStatTooltips(o));
  }

  function closeOverlay(id){
    const o = $(id);
    if(!o) return;
    o.classList.remove('open');
    if(!$('accessOverlay') && !document.querySelector('.overlay.open')) document.body.style.overflow = '';
    if($('accessOverlay') && $('accessOverlay').classList.contains('open')) document.body.style.overflow = 'hidden';
  }

  function shiftDate(step){
    const current = ui.date;
    if(ui.view === 'roadmap'){
      const zoom = ui.roadmapZoom || 'month';
      if(zoom === 'year') ui.date = addMonthsISO(current, step*12);
      else if(zoom === 'week') ui.date = addDaysISO(current, step*7);
      else ui.date = addMonthsISO(current, step);
    }else if(ui.view === 'week' || ui.view === 'availability'){
      ui.date = addDaysISO(current, step*7);
    }else if(ui.view === 'month'){
      ui.date = addMonthsISO(current, step);
    }else{
      ui.date = addDaysISO(current, step);
    }
    render();
  }

  function labelView(v){
    if(v==='day') return 'Día';
    if(v==='week') return 'Semana';
    if(v==='month') return 'Mensual';
    if(v==='roadmap') return 'Roadmap';
    return 'Disponibilidad';
  }
  function rangeLabel(){
    if(ui.view === 'day') return fmtDate(ui.date);
    if(ui.view === 'week' || ui.view === 'availability'){
      const s = startOfWeekISO(ui.date), e = addDaysISO(s,4);
      return `${fmtDate(s)} → ${fmtDate(e)}`;
    }
    if(ui.view === 'month'){
      const s = startOfMonthISO(ui.date);
      const e = addDaysISO(addMonthsISO(s,1), -1);
      return `${fmtDate(s)} → ${fmtDate(e)}`;
    }
    const zoom = ui.roadmapZoom || 'month';
    if(zoom === 'week'){
      const s = startOfWeekISO(ui.date);
      const e = addDaysISO(s,4);
      return `${fmtDate(s)} → ${fmtDate(e)}`;
    }
    if(zoom === 'year'){
      return `Año ${parseISO(ui.date).getFullYear()}`;
    }
    const s = startOfMonthISO(ui.date);
    const e = addDaysISO(addMonthsISO(s,6), -1);
    return `${fmtDate(s)} → ${fmtDate(e)}`;
  }

  function toggleTheme(){
    const root = document.documentElement;
    const now = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    applyTheme(now);
  }

  function applyTheme(theme){
    const t = theme === 'dark' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', t);
    try{ localStorage.setItem(THEME_KEY, t); }catch(_e){}
    $('btnTheme').textContent = t === 'dark' ? '☀' : '☾';
  }

  function severity(util){
    if(util >= 100) return {label:'Crítico', className:'danger'};
    if(util >= 85) return {label:'Alto', className:'warn'};
    if(util >= 60) return {label:'Medio', className:'warn'};
    return {label:'Equilibrado', className:'ok'};
  }

  function findTeam(id){ return state.team.find(t=>t.id===id); }

  function priorityRank(p){ return p==='Alta'?1:p==='Media'?2:3; }

  function hashString(value){
    const s = String(value || '');
    let h = 0;
    for(let i=0;i<s.length;i++){
      h = ((h << 5) - h) + s.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }

  function projectToneIndex(projectId){
    return hashString(projectId) % 8;
  }

  function statusClassName(s){ return `status-${String(s||'').replace(/\s+/g,'_')}`; }

  function minutesToPx(minute, startHour){
    const pxHour = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--hour-h')) || 56;
    const startMinRange = startHour*60;
    return ((minute - startMinRange)/60) * pxHour;
  }

  function parseISO(s){
    const [y,m,d] = String(s||'').split('-').map(Number);
    return new Date(y||1970, (m||1)-1, d||1, 12,0,0);
  }

  function toISO(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function todayISO(){ return toISO(new Date()); }

  function normalizeISO(s){
    const raw = String(s||'').trim();
    if(!raw) return '';

    // ISO: yyyy-mm-dd
    if(/^\d{4}-\d{2}-\d{2}$/.test(raw)){
      const d = parseISO(raw);
      if(Number.isNaN(d.getTime())) return '';
      return toISO(d);
    }

    // Local: dd/mm/yyyy o dd-mm-yyyy
    const m = raw.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
    if(m){
      const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
      if(mm < 1 || mm > 12 || dd < 1 || dd > 31) return '';
      const d = new Date(yy, mm-1, dd, 12, 0, 0);
      if(
        Number.isNaN(d.getTime()) ||
        d.getFullYear() !== yy ||
        d.getMonth() !== mm-1 ||
        d.getDate() !== dd
      ) return '';
      return toISO(d);
    }

    return '';
  }

  function addDaysISO(iso,n){ const d=parseISO(iso); d.setDate(d.getDate()+n); return toISO(d); }
  function minISO(a,b){ return a<=b?a:b; }
  function maxISO(a,b){ return a>=b?a:b; }

  function clampISO(v,min,max){ if(v<min) return min; if(v>max) return max; return v; }

  function normalizeHHMM(v,fallback='09:00'){
    const s = String(v||'').trim();
    if(!/^\d{2}:\d{2}$/.test(s)) return fallback;
    const [h,m] = s.split(':').map(Number);
    if(h<0||h>23||m<0||m>59) return fallback;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }

  function timeToMin(hhmm){
    const [h,m] = normalizeHHMM(hhmm,'00:00').split(':').map(Number);
    return h*60+m;
  }

  function minToHHMM(min){
    const m = clamp(Math.round(min),0,1439);
    const h = Math.floor(m/60), mm = m%60;
    return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
  }

  function durationMinutes(s,e){
    const a = timeToMin(s), b = timeToMin(e);
    return Math.max(0,b-a);
  }

  function fmtH(min){
    const h = min/60;
    return `${(Math.round(h*10)/10).toFixed(h%1?1:0)}h`;
  }

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function clampInt(v,min,max,def){
    const n = parseInt(v,10);
    if(Number.isNaN(n)) return def;
    return clamp(n,min,max);
  }

  function fmtDate(iso){
    if(!iso) return '';
    const d = typeof iso === 'string' ? parseISO(iso) : iso;
    if(!(d instanceof Date) || Number.isNaN(d.getTime())) return '';
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
  }

  function formatDateTime(d){
    if(!(d instanceof Date)) d = parseISO(d);
    return `${fmtDate(d)} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }

  function dayLabel(iso){
    const d = parseISO(iso);
    return d.toLocaleDateString(APP_LOCALE,{weekday:'short',day:'2-digit',month:'short'});
  }

  function flowDayLabel(iso){
    const d = parseISO(iso);
    return `FLUJO ${d.toLocaleDateString(APP_LOCALE,{weekday:'long'}).toLocaleUpperCase(APP_LOCALE)}`;
  }

  function isoWeekday(iso){
    const d = parseISO(iso).getDay();
    return d===0 ? 7 : d;
  }

  function startOfWeekISO(iso){
    const d = parseISO(iso), dow = d.getDay() || 7;
    d.setDate(d.getDate() - (dow-1));
    return toISO(d);
  }

  function isLeapYear(y){ return (y%4===0 && y%100!==0) || (y%400===0); }

  function dayOfYear(iso){
    const d = parseISO(iso), y = d.getFullYear(), start = new Date(y,0,1);
    return Math.floor((d-start)/86400000)+1;
  }

  function daysDiff(fromISO,toISO_){
    const a = parseISO(fromISO), b=parseISO(toISO_);
    return Math.floor((b-a)/86400000);
  }

  function multiDayProgress(startISO,endISO,dayISO){
    if(startISO===endISO) return '';
    const total = daysDiff(startISO,endISO)+1;
    const cur = daysDiff(startISO,dayISO)+1;
    return `(D${cur}/${total})`;
  }

  function toast(msg){
    const t = $('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=>t.classList.remove('show'), 1800);
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1800);
  }

  window.addEventListener('error', (e)=>{
    console.error('[runtime]', e.error || e.message);
    toast('Se detectó un error. Recuperando...');
    try{ state = sanitizeState(state); render(); }catch(_){ /* no-op */ }
  });

  init();
})();

  </script>
</body>
</html>
